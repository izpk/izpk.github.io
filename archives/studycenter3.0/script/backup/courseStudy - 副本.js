define(["jquery","underscore","backbone","storage","layer"],function(e,r,s,t,n){"use strict";var o=s.View.extend({el:"body #right",template:r.template(e("#template-course-courseStudy").html()),events:{"click .js-course-list-link":"openVideo","click .course-list-title-a":"courseNavToggle","click .course-change":"courseChange","click .option-a":"optionCourse","click .courseVersion-list-a":"courseVersionListA","click .courseVersion-show-btn":"courseVersionListShow"},render:function(s){CAICUI.render.$this=this,this.$header=this.$(".courseIndex-header"),this.$courseNavUl=this.$(".courseIndex-ul"),this.$courseNavLi=this.$(".courseIndex-li"),this.$courseIndexActiveBox=this.$(".courseIndex-active-box"),this.courseNavPreDefault=0,this.courseNavPre=0,this.courseNavAnimateTime=300,CAICUI.render.lastLearnChapter="",CAICUI.render.courseId=s,CAICUI.render.courseName="",CAICUI.render.serverTotal=7,CAICUI.render.serverNum=0,this.$learningcourse="",this.learningcourse(),this.$courseDetail="",this.courseDetail(s),this.$getTasksProgress="",this.getTasksProgress(),this.$handout="",this.handout(),this.$course_info="",this.course_info(),this.$courseActiveState="",CAICUI.render.versionId="",CAICUI.render.$courseInfo="",CAICUI.render.courseVersion="",CAICUI.render.courseActiveTime="",CAICUI.render.timer=setInterval(function(){if(CAICUI.render.serverTotal==CAICUI.render.serverNum){clearInterval(CAICUI.render.timer),r.each(CAICUI.CACHE.Learningcourse,function(e,r,s){return e.courseId==CAICUI.render.courseId?(CAICUI.render.$courseInfo=s[r],!1):void 0}),CAICUI.render.$this.setTasksProgress();var s=CAICUI.render.$this.filterLearningcourse(CAICUI.CACHE.Learningcourse);CAICUI.render.$this.$getTasksProgress&&CAICUI.render.$this.$getTasksProgress.length&&(CAICUI.render.lastLearnChapter=r.max(CAICUI.render.$this.$getTasksProgress,function(e){return e.createDate})),CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId,learningcourse:s,courseDetail:CAICUI.render.$this.$courseDetail,getTasksProgress:CAICUI.render.$this.$getTasksProgress,lastLearnChapter:CAICUI.render.lastLearnChapter,lastLearnChapterName:CAICUI.render.lastLearnChapterName,lastLearnChapterLink:CAICUI.render.lastLearnChapterLink,courseInfo:CAICUI.render.$courseInfo,handout:CAICUI.render.$this.$handout,course_info:CAICUI.render.$this.$course_info,courseVersion:CAICUI.render.courseVersion,courseActiveTime:CAICUI.render.courseActiveTime}})),CAICUI.render.courseIndexTips=setTimeout(function(){e("body .courseIndex-content-tips").animate({height:0},500,function(){e("body .courseIndex-content-tips").remove(),window.CAICUI.myScroll.refresh()})},2e4);var t=e(".course-progress-show").attr("data-course-progress");e(".course-progress-show").animate({width:t+"%"},1e3),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")}},500)},learningcourse:function(){CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(e){console.log(e),CAICUI.render.serverNum++,CAICUI.CACHE.Learningcourse=e.data.courselist},fail:function(){CAICUI.render.serverNum++,CAICUI.CACHE.Learningcourse={},CAICUI.CACHE.RecentCourse={}}})},courseDetail:function(e){var r=t.get("courseProgress-"+CAICUI.render.courseId);r?(CAICUI.render.serverNum++,CAICUI.render.courseName=r.courseName,CAICUI.render.$this.$courseDetail=r,CAICUI.render.versionId=r.versionId,CAICUI.render.$this.courseActiveState(r.versionId),CAICUI.render.$this.courseVersionData(r.versionId)):CAICUI.Request.ajax({server:"courseDetail",data:{courseId:e},done:function(r){CAICUI.render.serverNum++,CAICUI.render.courseName=r.data[0].courseName,CAICUI.render.$this.$courseDetail=r.data[0],t.setsingle("course-"+e,r.data[0]),CAICUI.render.versionId=r.data[0].versionId,CAICUI.render.$this.courseActiveState(),CAICUI.render.$this.courseVersionData(CAICUI.render.versionId)}})},getTasksProgress:function(){CAICUI.Request.ajax({server:"getTasksProgress",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId},done:function(e){CAICUI.render.serverNum++;e.data;CAICUI.CACHE.getTasksProgress=e.data,CAICUI.render.$this.$getTasksProgress=e.data},fail:function(){CAICUI.render.serverNum++,CAICUI.CACHE.getTasksProgress={},CAICUI.render.$this.$getTasksProgress={}}})},course_info:function(){CAICUI.Request.ajax({server:"course_info",data:{token:CAICUI.User.token,id:CAICUI.render.courseId},done:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.course_info=e.data,CAICUI.render.$this.$course_info=e.data},fail:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.course_info={},CAICUI.render.$this.$course_info={}}})},handout:function(){CAICUI.Request.ajax({server:"handout",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId},done:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.handout=e.data,CAICUI.render.$this.$handout=e.data},fail:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.handout={},CAICUI.render.$this.$handout={}}})},courseActiveState:function(e){CAICUI.Request.ajax({server:"coursestatus",data:{token:CAICUI.User.token,versionId:e?e:CAICUI.render.versionId},done:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.coursestatus=e.data,"success"==e.state?(CAICUI.render.$this.courseByInFo(e.data),e.data&&e.data.length):(n.msg("Sorry~ 获取课程授权信息失败，请刷新页面重试。",function(){}),course.courseActiveState=999)},fail:function(e){n.msg("Sorry~ 获取课程授权信息失败，请刷新页面重试。",function(){})}})},courseVersionData:function(e){CAICUI.Request.ajax({server:"version",data:{versionId:e},done:function(e){CAICUI.render.serverNum++,CAICUI.render.courseVersion=e.data},fail:function(e){CAICUI.render.serverNum++,n.msg("Sorry~ 网络错误，请刷新页面重试。",function(){})}})},setTasksProgress:function(){var e="",s=t.get("courseProgress-"+CAICUI.render.courseId);if(s)CAICUI.render.$this.$courseDetail=s;else{e=CAICUI.render.$this.$courseDetail;CAICUI.render.$this.$getTasksProgress;r.each(e.chapters,function(s,t){s.children?r.each(s.children,function(s,n){s.children?r.each(s.children,function(s,o){s.tasks&&r.each(s.tasks,function(s,a){r.each(CAICUI.CACHE.getTasksProgress,function(r,i){s.taskId==r.taskId&&(e.chapters[t].children[n].children[o].tasks[a].progress=r.progress,e.chapters[t].children[n].children[o].tasks[a].total=r.total)})})}):s.tasks&&r.each(s.tasks,function(s,o){r.each(CAICUI.CACHE.getTasksProgress,function(r,a){s.taskId==r.taskId&&(e.chapters[t].children[n].tasks[o].progress=r.progress,e.chapters[t].children[n].tasks[o].total=r.total)})})}):s.tasks&&r.each(s.tasks,function(s,n){r.each(CAICUI.CACHE.getTasksProgress,function(r,o){s.taskId==r.taskId&&(e.chapters[t].tasks[n].progress=r.progress,e.chapters[t].tasks[n].total=r.total)})})}),t.setsingle("courseProgress-"+CAICUI.render.courseId,e)}},courseByInFo:function(r){var s=0;if(e.isArray(r)){for(var n=0;n<r.length;n++)r[n].courseId==CAICUI.render.courseId&&"init"!=r[n].activeState&&(CAICUI.render.courseActiveTime=r[n].activeTime);for(var o=Date.parse(new Date)/1e3,n=0;n<r.length;n++){if("acitve"==r[n].activeState&&r[n].expirationTime>o&&3>s){s=3;break}"init"==r[n].activeState&&2>s?s=2:"acitve"==r[n].activeState&&r[n].expirationTime<o&&1>s&&(s=1)}}CAICUI.render.$this.$courseDetail.courseActiveState=s,console.log(CAICUI.render.$this.$courseDetail),t.setsingle("course-"+CAICUI.render.courseId,CAICUI.render.$this.$courseDetail)},addRecentCourse:function(e){if(CAICUI.CACHE.Learningcourse&&CAICUI.CACHE.RecentCourse)for(var r=0;r<CAICUI.CACHE.Learningcourse.length;r++)if(CAICUI.CACHE.Learningcourse[r].courseId==e){for(var s=!0,t=0;t<CAICUI.CACHE.RecentCourse.length;t++)CAICUI.CACHE.RecentCourse[t].courseId==e&&(s=!1);return s&&CAICUI.CACHE.RecentCourse.push(CAICUI.CACHE.Learningcourse[r]),void(CAICUI.CACHE.RecentCourse.length>2&&CAICUI.CACHE.RecentCourse.splice(0,1))}},filterLearningcourse:function(e){for(var s=r.chain(e).map(function(e){return e.categoryName}).uniq().value(),t=r.chain(e).map(function(e){return e.categoryIndex}).uniq().value(),n=[],o=0;o<s.length;o++)n.push({categoryName:s[o],categoryIndex:t[o],list:[]}),r.each(e,function(e,r,t){e.categoryName==s[o]&&(n&&n[o]&&n[o].list?n[o].list.push(e):n[o].list=[e])});for(var o=0;o<n.length;o++){n[o].newList=[];for(var a=n[o].list,i=r.chain(a).map(function(e){return e.subjectName}).uniq().value(),C=r.chain(a).map(function(e){return e.subjectIndex}).uniq().value(),I=0;I<i.length;I++)n[o].newList.push({subjectName:i[I],subjectIndex:C[I],list:[]}),r.each(n[o].list,function(e,s,t){if(e.subjectName==i[I])if(n[o].newList[I].list){var a=!0;r.each(n[o].newList[I].list,function(r,s,t){e.courseId==r.courseId&&(a=!1)}),a&&n[o].newList[I].list.push(e)}else n[o].newList[I].list=[e]})}var n=r.sortBy(n,"categoryIndex");return r.each(n,function(e,s){n[s].newList=r.sortBy(e.newList,"subjectIndex"),r.each(n[s].newList,function(e,t){n[s].newList[t].list=r.sortBy(e.list,"courseIndex")})}),n},courseVersionListShow:function(r){var s=(CAICUI.iGlobal.getThat(r),e(".courseVersion-list"));s.hasClass("active")?s.removeClass("active"):s.addClass("active")},courseVersionListA:function(r){var s=CAICUI.iGlobal.getThat(r);if(!s.hasClass("active")){var t=s.siblings();t.removeClass("active"),s.addClass("active")}e(".courseVersion-list").removeClass("active")},optionCourse:function(e){CAICUI.iGlobal.getThat(e);CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink=""},courseChange:function(r){var s=CAICUI.iGlobal.getThat(r);s.toggleClass("active"),e(".option-ul").toggleClass("active")},openVideo:function(r){var s=CAICUI.render.$this.$courseDetail.courseActiveState,o=CAICUI.iGlobal.getThat(r),a=o.attr("link");"javascript:;"!=a?(CAICUI.NavVideo=!1,e("body .course-desc").attr("href",a),CAICUI.render.lastLearnChapterName=o.find(".course-list-desc").text(),CAICUI.render.lastLearnChapterLink=a,t.setsingle("playlist-index"+CAICUI.render.courseId,"c|"+o.attr("data-index")),window.location.hash=a):2==s?n.msg("Sorry~ 您当前的课程未激活",function(){}):1==s?n.msg("Sorry~ 您当前的课程已过期",function(){}):0==s&&n.msg("Sorry~ 您未购买当前的课程",function(){})},courseNavToggle:function(r){var s=r.currentTarget,t=e(s),n=t.parent();CAICUI.render.courseId=t.attr("data-courseid"),n.toggleClass("active"),window.CAICUI.myScroll.refresh()},courseNavUlLeave:function(e){CAICUI.iGlobal.getThat(e);this.courseNavPreAnimate(this.courseNavPre),this.courseNavPre=this.courseNavPreDefault,this.$courseNavLi.eq(this.courseNavPre).addClass("hover"),this.courseNavAnimate(this.$(".courseIndex-active-box").eq(this.courseNavPre),this.courseNavPre),CAICUI.render.$this.$(".courseIndex-ul").removeClass("hover")},courseNavLiLeave:function(e){},courseNavLiEnter:function(e){var r=CAICUI.iGlobal.getThat(e),s=r.index(),t=r.find(".courseIndex-active-box");return s==this.courseNavPre?!1:(r.addClass("hover"),this.courseNavPreAnimate(this.courseNavPre),this.courseNavAnimate(t,s),void(this.courseNavPre=s))},courseNavPreAnimate:function(e){var r=this.$(".courseIndex-li").eq(e),s=!1;CAICUI.render.$this.$(".courseIndex-ul").hasClass("hover")||(s=!0),this.$(".courseIndex-active-box").eq(e).stop(!0,!1).animate({width:34,marginLeft:0},this.courseNavAnimateTime,function(){r.removeClass("hover"),s&&(CAICUI.render.$this.$(".courseIndex-ul").addClass("hover"),s=!1)})},courseNavAnimate:function(e,r){e.stop(!0,!1).animate({width:"148px"},this.courseNavAnimateTime)}});return o});