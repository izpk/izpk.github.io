$.fn.dialog=function(e){return e?"open"==e?e={open:!0}:"close"==e?e={open:!1}:"destory"==e&&(e={open:!1,closedestory:!0}):e={},this.each(function(){if(this.dialog){var t=e?e.body:"";""==t&&(e.body=""),0===e.position&&(e.position=this.dialog.settings.position),this.dialog.settings=$.extend(this.dialog.settings,e),this.dialog.set(e)}else{if(e.open===!1&&e.closedestory===!0)return;e=$.extend({width:e.width?e.width:$(this).width(),height:"auto",modal:!0,open:!0,closedestory:!1,drag:!0,position:"center",fullscreen:!1,timeout:0,showtitle:!0,title:"",body:"",zindex:100,onclose:null,pos_element:null},e),this.dialog=new $.dialog(this,e),this.dialog.init(),this.dialog.set(e)}}),this},$.joverlay=null,$.dialog=function(e,t){function i(e){var e=e?e:window.event,t=e.keyCode?e.keyCode:e.charCode;return 27==t&&o.close(),!0}var o=this,s=$(e);e.id||(e.id=Math.random()),this.settings=t,this.width=t.width,this.height=t.height,this.last_height=t.height;var n=$(window).width(),l=$(document).height();return this.init=function(){function i(e){if(u.startdrag){var t=e.pageX-u.mouse_offset_x,i=e.pageY-u.mouse_offset_y;o.width+t>n&&(t=n-o.width),o.height+i>l&&(i=l-o.height),0>t&&(t=0),0>i&&(i=0),s.css({left:t,top:i})}}function a(){$(document).off("mousemove.dialog_"+e.id),$(document).off("mouseup.dialog_"+e.id),u.startdrag=0,document.unselectable="off",$("body").removeClass("unselect")}function d(t){return o.settings.drag?(u.startdrag=1,document.unselectable="on",$("body").addClass("unselect"),u.mouse_offset_x=t.pageX-s[0].offsetLeft,u.mouse_offset_y=t.pageY-s[0].offsetTop,$(document).on("mousemove.dialog_"+e.id,function(e){i(e)}),void $(document).on("mouseup.dialog_"+e.id,function(e){a(e)})):(u.startdrag=0,!1)}$.joverlay=$("#dialog_overlay"),0==$.joverlay.length&&($.joverlay=$('<div class="dialog-overlay" id="dialog_overlay" ref="0" unselectable="on" onselect="return false;"></div>').hide().appendTo("body")),$.joverlay.height($(window).height()).keydown(function(e){e.stopPropagation()}).keyup(function(e){e.stopPropagation()});var c=(s.html(),'<div class="header"'+(t.showtitle?"":' style="display: none;"')+'><a href="javascript: void(0)" class="icon close" style="float:right; margin-right: 0px; margin-top: 0px;" title="关闭"></a><a href="javascript: void(0)" class="icon icon-max" style="float:right; margin-right: 4px; margin-top: 2px; display: none;" title="最大/小化"></a><span>'+e.title+'</span></div><div class="body"></div>'),r=$(c).appendTo("body"),h=s.contents(),g=r[1];h.appendTo(g),r.appendTo(s),this.set(o.settings);var u=r[0],p=$(u);p.css("cursor","move"),p.on("mousedown",function(e){d(e)});var f=s.children("div.header");return f.length>0&&(f.eq(0).find("a.close").click(function(){(!o.settings.onclose||o.settings.onclose&&o.settings.onclose()!==!1)&&o.close()}),f.eq(0).find("a.icon-max").click(function(){o.set_fullscreen($(this).hasClass("icon-max")),$(this).toggleClass("icon-max"),$(this).toggleClass("icon-min")})),!0},this.set=function(e){e.title&&this.set_title(e.title),e.body&&this.set_body(e.body),e.width&&this.set_width(e.width),e.height&&this.set_height(e.height),isset(e.modal)&&(o.settings.modal=e.modal),e.position&&o.set_position(e.position),e.timeout&&this.set_timeout(),e.zindex&&this.set_zindex(e.zindex),e.open===!0&&this.open(),e.open===!1&&this.close()},this.open=function(){if(e.htime&&(clearTimeout(e.htime),e.htime=null),"none"==s.css("display")){if(o.settings.modal){var t=parseInt($.joverlay.attr("ref"))+1;$.joverlay.width("100%").height($(document).height()).show().attr("ref",t)}this.set_zindex(),s.show()}},this.close=function(i){if(o.settings.modal&&s&&"none"!=s.css("display")){var n=parseInt($.joverlay.attr("ref"));$.joverlay.attr("ref",Math.max(0,--n)),1>n&&$.joverlay.width(0).hide()}s.off("DOMSubtreeModified"),i||t.closedestory?(e.dialog=null,$(document).off(".dialog_"+e.id),s&&(s.removeDeep(),s=null)):s.hide()},this.set_position=function(e){o.settings.pos_element||(e="center"),"center"==e&&s.appendTo(document.body);var t=$.link_div_position($(o.settings.pos_element),s,e);t&&s.css(t)},this.set_width=function(e){s.width(e),o.width=s.width()},this.set_height=function(e){s.height(e),o.height=s.height()},this.set_title=function(e){s.children("div.header").eq(0).children("span").html(e)},this.set_body=function(t){try{"string"==typeof t?$("div.body",e).html(t):is_element(t)&&$("div.body",e).replaceWith(t),setTimeout(function(){o.set_position(o.settings.position)},10)}catch(i){alert("dialog.set_body() error: "+i.message+"\nbody:"+t)}},this.get_body=function(){return $("div.body",e).html()},this.set_zindex=function(t){var i=1,o=s.css("z-index");if(!t){var t=o;$("div.dialog").each(function(){$(this).not(e).css("z-index")>=i&&(i=$(this).css("z-index")+1)}),i>o&&(t=i+1)}s.css("z-index",t)},this.set_timeout=function(){o.settings.timeout&&(s.on("mouseover",function(){return e.htime&&(clearTimeout(e.htime),e.htime=null),!0}),s.on("mouseout",function(){return e.htime||(e.htime=setTimeout(function(){o.close(),e.htime=null},o.settings.timeout)),!0}))},this.close_other=function(){$("div.dialog").not(e).dialog("close")},$(document).on("keyup.dialog_"+e.id,i),this},$.box=function(e,t,i){t||(t="info-circle yellow"),"ok"==t&&(t="check-circle green"),"error"==t&&(t="times-circle red"),e='<p class="center body">'+(t?'<span class="icon '+t+'"></span>':"")+e+"</p>",document.getElementById("dialog_box")||$('<div class="dialog border shadow" title="提示信息" id="dialog_box" style="display: none;"></div>').appendTo("body");var o=$("#dialog_box");return"close"==e?(!i||i&&i()!==!1)&&o.dialog("close"):o.dialog({open:!0,body:e,onclose:i}),o},$.ajax_dialog_url={},$.ajax_dialog=function(e,t,i){void 0===t&&(t=!0),i||(i={});var o='<div style="text-align: center;"><div class="loading"><img src="static/loading.gif" /></div></div> <p class="center"><button type="button" class="button grey cancel">取消</button></p>';$.ajax_dialog_remove_pre_url(e);var s=$.ajax_dialog_url[e];if(s&&t&&s.cache)i.pos_element&&i.pos_element!==s.pos_element?s.dialog({open:!0,position:i.position,pos_element:i.pos_element}):s.dialog({open:!0}),s.script_sections&&eval_script(s.script_sections,e,s);else{s&&s.removeDeep();var s=$('<div class="dialog border shadow" title="提示信息" style="width: 400px;"></div>').appendTo("body");$.ajax_dialog_url[e]=s,i.open=!0,i.title="提示信息",i.body=o,i.onclose=null,i.closedestory=!t,s.dialog(i),s.attr("url",e),s.find("button.cancel").on("click",function(){s.dialog("close")}),$.xget(e,function(t,o){if(t>0)return $.alert(o),void s.dialog("close");var n=null;if(0==t)if("object"==typeof o){if(!o.body)return;n=get_title_body_script_css(o.body),n.title=o.title}else n=get_title_body_script_css(o);else if(0>t){if(-1==o.indexOf("<body"))return s.dialog("close"),$.alert(o),void(s.cache=!1);n=get_title_body_script_css(o)}n&&(eval_stylesheet(n.stylesheet_links),s.script_sections=n.script_sections,i.title=n.title,i.body=n.body,i.width="auto",s.dialog(i),n.script_srcs.length>0?$.require(n.script_srcs,function(){eval_script(n.script_sections,e,s)}):eval_script(n.script_sections,e,s),s.cache=!0)})}return i.pos_element&&(s.pos_element=i.pos_element),window.jdialog=s,s},$.ajax_dialog_close=function(e,t){if($.ajax_dialog_url[e]){var i=$.ajax_dialog_url[e];i&&i.dialog("close"),t[0].dialog.settings.onclose=i[0].dialog.settings.onclose}},$.ajax_dialog_remove_pre_url=function(e){e+="";var t=e.indexOf("-",e.indexOf("-")+1);if(-1!=t){t=substr(e,0,t+1);for(k in $.ajax_dialog_url)if(k!=e&&-1!=k.indexOf(t)){var i=$.ajax_dialog_url[k];i.dialog("destory"),i=null,delete $.ajax_dialog_url[k]}}};