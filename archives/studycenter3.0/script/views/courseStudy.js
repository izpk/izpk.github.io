define(["jquery","underscore","backbone","storage","layer"],function(e,r,s,t,n){"use strict";var a=s.View.extend({el:"body #right",template:r.template(e("#template-course-courseStudy").html()),events:{"click .js-course-list-link":"openVideo","click .course-list-title-a":"courseNavToggle","click .course-change":"courseChange","click .option-a":"optionCourse","click .courseVersion-list-a":"courseVersionListA","click .courseVersion-show-btn":"courseVersionListShow"},render:function(r){CAICUI.render.$this=this,this.courseNavPreDefault=0,this.courseNavPre=0,this.courseNavAnimateTime=300,CAICUI.render.courseId=r,CAICUI.render.isCoursePay=!1,CAICUI.render.courseName="",CAICUI.render.courseNameArray=[],CAICUI.render.courseDetail="",CAICUI.render.getTasksProgress="",CAICUI.render.handout="",CAICUI.render.course_info="",CAICUI.render.courseInfoExamTime="",CAICUI.render.courseInfoDueTime="",CAICUI.render.versionId="",CAICUI.render.courseInfo="",CAICUI.render.courseVersion="",CAICUI.render.courseActiveTime="",CAICUI.render.lastLearnChapter="",CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink="",CAICUI.render.percentage=0,CAICUI.render.lockStatus=!1,CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId}})),CAICUI.render.$this.handoutAjax(function(){e("body .icon-handout-down").attr("href",CAICUI.Common.host.img+CAICUI.render.handout.path)}),CAICUI.render.$this.courseInfoAjax(function(){e("body .course-info-examTime").html(CAICUI.render.courseInfoExamTime)}),CAICUI.render.$this.learningcourseAjax(function(){e("body .course-info-dueTime").html(CAICUI.render.courseInfoDueTime),e("body .course-progress-show").attr("data-course-progress",CAICUI.render.percentage),e("body .course-percentage").html(CAICUI.render.percentage),e("body .course-progress-show").animate({width:CAICUI.render.percentage+"%"},1e3);var r=e("#template-courseStudy-courseList").html(),s=CAICUI.iGlobal.getTemplate(r,{courseNameArray:CAICUI.render.courseNameArray});e("body .course-change-ul").html(s),CAICUI.render.$this.courseDetailAjax(function(){e("body .course-name").html(CAICUI.render.courseName),CAICUI.render.$this.courseActiveStateAjax(function(){var r=e("#template-courseStudy-taskList").html(),s=CAICUI.iGlobal.getTemplate(r,{data:{courseId:CAICUI.render.courseId,courseDetail:CAICUI.render.courseDetail}});e("body .scroller").html(s),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),CAICUI.render.courseIndexTips=setTimeout(function(){e("body .courseIndex-content-tips").animate({height:0},500,function(){e("body .courseIndex-content-tips").remove(),window.CAICUI.myScroll.refresh()})},2e4)}),CAICUI.render.$this.courseVersionDataAjax(function(){var r=e("#template-courseStudy-courseVersionList").html(),s=CAICUI.iGlobal.getTemplate(r,{courseVersion:CAICUI.render.courseVersion,courseActiveTime:CAICUI.render.courseActiveTime});e("body .courseVersion-list").html(s)}),CAICUI.render.$this.getTasksProgressAjax(function(){e(".lastLearn").attr("href",CAICUI.render.lastLearnChapterLink),e(".lastLearn").html(CAICUI.render.lastLearnChapterName),e(".continue-learning").attr("href",CAICUI.render.lastLearnChapterLink)})})})},learningcourseAjax:function(e){CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(s){CAICUI.CACHE.Learningcourse=s.data.courselist;var t=CAICUI.render.$this.filterLearningcourse(CAICUI.CACHE.Learningcourse);r.each(t,function(e,t,n){r.each(e.newList,function(e,t){r.each(e.list,function(e,r){e.courseId==s.courseId&&(CAICUI.render.isCoursePay=!0),CAICUI.render.courseNameArray.push({courseId:e.courseId,courseName:e.courseName})})})}),r.each(CAICUI.CACHE.Learningcourse,function(e,r,s){if(e.courseId==CAICUI.render.courseId){CAICUI.render.courseInfo=s[r],CAICUI.render.courseInfoDueTime=CAICUI.iGlobal.getDate(s[r].expirationTime);var t=CAICUI.render.courseInfo.taskprogress?CAICUI.render.courseInfo.taskprogress:0,n=CAICUI.render.courseInfo.taskTotal?CAICUI.render.courseInfo.taskTotal:0,a=0;CAICUI.render.courseInfo.lastProgress;if(t&&n){var o=t/n;o>0&&.01>o&&(o=.01),a=parseInt(100*o)}return CAICUI.render.percentage=a,!1}}),e&&e()},fail:function(){CAICUI.CACHE.Learningcourse={},CAICUI.CACHE.RecentCourse={}}})},courseDetailAjax:function(e){var r=t.get("courseProgress-"+CAICUI.render.courseId);r?CAICUI.render.$this.courseDetailDone(r,e):CAICUI.Request.ajax({server:"courseDetail",data:{courseId:CAICUI.render.courseId},done:function(r){t.setsingle("course-"+CAICUI.render.courseId,r.data[0]),CAICUI.render.$this.courseDetailDone(r.data[0],e)}})},courseDetailDone:function(e,r){CAICUI.render.courseDetail=e,CAICUI.render.courseName=e.courseName,CAICUI.render.courseDetail=e,CAICUI.render.versionId=e.versionId,r&&r()},courseActiveStateAjax:function(e){CAICUI.Request.ajax({server:"coursestatus",data:{token:CAICUI.User.token,versionId:CAICUI.render.versionId},done:function(r){0!==r.data[0].lockStatus&&(CAICUI.render.lockStatus=!0),CAICUI.CACHE.coursestatus=r.data,CAICUI.render.$this.courseByInFo(r.data),console.log(r.data[0].lockStatus),e&&e()},fail:function(e){n.msg("Sorry~ 获取课程授权信息失败，请刷新页面重试。",function(){})}})},courseVersionDataAjax:function(e){CAICUI.Request.ajax({server:"version",data:{versionId:CAICUI.render.versionId},done:function(r){CAICUI.render.courseVersion=r.data,e&&e()},fail:function(e){n.msg("Sorry~ 网络错误，请刷新页面重试。",function(){})}})},getTasksProgressAjax:function(e){CAICUI.Request.ajax({server:"getTasksProgress",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId},done:function(s){s.data;if(CAICUI.CACHE.getTasksProgress=s.data,CAICUI.render.getTasksProgress=s.data,CAICUI.render.getTasksProgress&&CAICUI.render.getTasksProgress.length){CAICUI.render.lastLearnChapter=r.max(CAICUI.render.getTasksProgress,function(e){return e.createDate});var t="",n="";CAICUI.render.lastLearnChapter&&!CAICUI.render.lastLearnChapterName?(t="#video/"+CAICUI.render.courseId+"/"+CAICUI.render.lastLearnChapter.chapterId+"/"+CAICUI.render.lastLearnChapter.taskId+"/"+CAICUI.render.lastLearnChapter.progress+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on",n='上次学到：<span class="lastLearn-chapterName">'+CAICUI.render.lastLearnChapter.chapterName+' </span><i class="icon icon-course-arrow-right"></i>'):(t=CAICUI.render.lastLearnChapterLink?s.lastLearnChapterLink:CAICUI.render.courseDetail.chapters[0].children?"#video/"+CAICUI.render.courseId+"/"+CAICUI.render.courseDetail.chapters[0].children[0].chapterId+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on":"#video/"+CAICUI.render.courseId+"/"+CAICUI.render.courseDetail.chapters[0].chapterId+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on",n=CAICUI.render.lastLearnChapterName?'上次学到：<span class="lastLearn-chapterName">'+CAICUI.render.lastLearnChapterName+' </span><i class="icon icon-course-arrow-right"></i>':'<i class="icon icon-course-arrow-right"></i><span class="lastLearn-chapterName">开始学习本课程</span>'),CAICUI.render.lastLearnChapterLink=t,CAICUI.render.lastLearnChapterName=n}e&&e()},fail:function(){CAICUI.CACHE.getTasksProgress={},CAICUI.render.getTasksProgress={}}})},courseInfoAjax:function(e){CAICUI.Request.ajax({server:"course_info",data:{token:CAICUI.User.token,id:CAICUI.render.courseId},done:function(r){var r=r.data;CAICUI.CACHE.course_info=r.data,CAICUI.render.course_info=r.data,r.days<0?CAICUI.render.courseInfoExamTime="本科目考试时间未确定":0==r.days?CAICUI.render.courseInfoExamTime="请留意,本科目<strong>今天</strong>开始考试":CAICUI.render.courseInfoExamTime="距本科目考试还有<strong>"+r.days+"</strong>天",e&&e()},fail:function(e){CAICUI.CACHE.course_info={},CAICUI.render.course_info={}}})},handoutAjax:function(e){CAICUI.Request.ajax({server:"handout",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId},done:function(r){CAICUI.CACHE.handout=r.data,CAICUI.render.handout=r.data,e&&e()},fail:function(e){CAICUI.CACHE.handout={},CAICUI.render.handout={}}})},setTasksProgress:function(){var e="",s=t.get("courseProgress-"+CAICUI.render.courseId);if(s)CAICUI.render.courseDetail=s;else{e=CAICUI.render.courseDetail;CAICUI.render.getTasksProgress;r.each(e.chapters,function(s,t){s.children?r.each(s.children,function(s,n){s.children?r.each(s.children,function(s,a){s.tasks&&r.each(s.tasks,function(s,o){r.each(CAICUI.CACHE.getTasksProgress,function(r,C){s.taskId==r.taskId&&(e.chapters[t].children[n].children[a].tasks[o].progress=r.progress,e.chapters[t].children[n].children[a].tasks[o].total=r.total)})})}):s.tasks&&r.each(s.tasks,function(s,a){r.each(CAICUI.CACHE.getTasksProgress,function(r,o){s.taskId==r.taskId&&(e.chapters[t].children[n].tasks[a].progress=r.progress,e.chapters[t].children[n].tasks[a].total=r.total)})})}):s.tasks&&r.each(s.tasks,function(s,n){r.each(CAICUI.CACHE.getTasksProgress,function(r,a){s.taskId==r.taskId&&(e.chapters[t].tasks[n].progress=r.progress,e.chapters[t].tasks[n].total=r.total)})})}),t.setsingle("courseProgress-"+CAICUI.render.courseId,e)}},courseByInFo:function(r){var s=0;if(e.isArray(r)){for(var n=0;n<r.length;n++)r[n].courseId==CAICUI.render.courseId&&"init"!=r[n].activeState&&(CAICUI.render.courseActiveTime=r[n].activeTime);for(var a=Date.parse(new Date)/1e3,n=0;n<r.length;n++){if("acitve"==r[n].activeState&&r[n].expirationTime>a&&3>s){s=3;break}"init"==r[n].activeState&&2>s?s=2:"acitve"==r[n].activeState&&r[n].expirationTime<a&&1>s&&(s=1)}console.log(CAICUI.render.lockStatus),CAICUI.render.lockStatus&&(s=4)}CAICUI.render.courseDetail.courseActiveState=s,console.log(CAICUI.render.courseDetail),t.setsingle("course-"+CAICUI.render.courseId,CAICUI.render.courseDetail)},openVideo:function(r){var s=CAICUI.render.courseDetail.courseActiveState,a=CAICUI.iGlobal.getThat(r),o=a.attr("link");"javascript:;"!=o?(CAICUI.NavVideo=!1,e("body .course-desc").attr("href",o),CAICUI.render.lastLearnChapterName=a.find(".course-list-desc").text(),CAICUI.render.lastLearnChapterLink=o,t.setsingle("playlist-index"+CAICUI.render.courseId,"c|"+a.attr("data-index")),window.location.hash=o):4==s?n.msg("Sorry~ 您当前的课程已锁定",function(){}):2==s?n.msg("Sorry~ 您当前的课程未激活",function(){}):1==s?n.msg("Sorry~ 您当前的课程已过期",function(){}):0==s&&n.msg("Sorry~ 您未购买当前的课程",function(){})},addRecentCourse:function(e){if(CAICUI.CACHE.Learningcourse&&CAICUI.CACHE.RecentCourse)for(var r=0;r<CAICUI.CACHE.Learningcourse.length;r++)if(CAICUI.CACHE.Learningcourse[r].courseId==e){for(var s=!0,t=0;t<CAICUI.CACHE.RecentCourse.length;t++)CAICUI.CACHE.RecentCourse[t].courseId==e&&(s=!1);return s&&CAICUI.CACHE.RecentCourse.push(CAICUI.CACHE.Learningcourse[r]),void(CAICUI.CACHE.RecentCourse.length>2&&CAICUI.CACHE.RecentCourse.splice(0,1))}},filterLearningcourse:function(e){for(var s=r.chain(e).map(function(e){return e.categoryName}).uniq().value(),t=r.chain(e).map(function(e){return e.categoryIndex}).uniq().value(),n=[],a=0;a<s.length;a++)n.push({categoryName:s[a],categoryIndex:t[a],list:[]}),r.each(e,function(e,r,t){e.categoryName==s[a]&&(n&&n[a]&&n[a].list?n[a].list.push(e):n[a].list=[e])});for(var a=0;a<n.length;a++){n[a].newList=[];for(var o=n[a].list,C=r.chain(o).map(function(e){return e.subjectName}).uniq().value(),I=r.chain(o).map(function(e){return e.subjectIndex}).uniq().value(),i=0;i<C.length;i++)n[a].newList.push({subjectName:C[i],subjectIndex:I[i],list:[]}),r.each(n[a].list,function(e,s,t){if(e.subjectName==C[i])if(n[a].newList[i].list){var o=!0;r.each(n[a].newList[i].list,function(r,s,t){e.courseId==r.courseId&&(o=!1)}),o&&n[a].newList[i].list.push(e)}else n[a].newList[i].list=[e]})}var n=r.sortBy(n,"categoryIndex");return r.each(n,function(e,s){n[s].newList=r.sortBy(e.newList,"subjectIndex"),r.each(n[s].newList,function(e,t){n[s].newList[t].list=r.sortBy(e.list,"courseIndex")})}),n},courseVersionListShow:function(r){var s=(CAICUI.iGlobal.getThat(r),e(".courseVersion-list"));s.hasClass("active")?s.removeClass("active"):s.addClass("active")},courseVersionListA:function(r){var s=CAICUI.iGlobal.getThat(r);if(!s.hasClass("active")){var t=s.siblings();t.removeClass("active"),s.addClass("active")}e(".courseVersion-list").removeClass("active")},optionCourse:function(e){CAICUI.iGlobal.getThat(e);CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink=""},courseChange:function(r){var s=CAICUI.iGlobal.getThat(r);s.toggleClass("active"),e(".option-ul").toggleClass("active")},courseNavToggle:function(r){var s=r.currentTarget,t=e(s),n=t.parent();CAICUI.render.courseId=t.attr("data-courseid"),n.toggleClass("active"),window.CAICUI.myScroll.refresh()},courseNavUlLeave:function(e){CAICUI.iGlobal.getThat(e);this.courseNavPreAnimate(this.courseNavPre),this.courseNavPre=this.courseNavPreDefault,CAICUI.render.$this.$(".courseIndex-li").eq(this.courseNavPre).addClass("hover"),this.courseNavAnimate(this.$(".courseIndex-active-box").eq(this.courseNavPre),this.courseNavPre),CAICUI.render.$this.$(".courseIndex-ul").removeClass("hover")},courseNavLiLeave:function(e){},courseNavLiEnter:function(e){var r=CAICUI.iGlobal.getThat(e),s=r.index(),t=r.find(".courseIndex-active-box");return s==this.courseNavPre?!1:(r.addClass("hover"),this.courseNavPreAnimate(this.courseNavPre),this.courseNavAnimate(t,s),void(this.courseNavPre=s))},courseNavPreAnimate:function(e){var r=this.$(".courseIndex-li").eq(e),s=!1;CAICUI.render.$this.$(".courseIndex-ul").hasClass("hover")||(s=!0),this.$(".courseIndex-active-box").eq(e).stop(!0,!1).animate({width:34,marginLeft:0},this.courseNavAnimateTime,function(){r.removeClass("hover"),s&&(CAICUI.render.$this.$(".courseIndex-ul").addClass("hover"),s=!1)})},courseNavAnimate:function(e,r){e.stop(!0,!1).animate({width:"148px"},this.courseNavAnimateTime)}});return a});