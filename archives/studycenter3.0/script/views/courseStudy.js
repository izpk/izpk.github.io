define(["jquery","underscore","backbone","storage","views/questions","layer"],function(e,r,t,n,a,s){"use strict";var o=t.View.extend({el:"body #right",template:r.template(e("#template-course-courseStudy").html()),events:{"click .js-course-list-link":"openVideo","click .js-course-questions":"openQuestions","click .course-list-title-a":"courseNavToggle","click .course-change":"courseChange","click .option-a":"optionCourse","click .courseVersion-list-a":"courseVersionListA","click .courseVersion-show-btn":"courseVersionListShow"},render:function(t){CAICUI.render.$this=this,this.courseNavPreDefault=0,this.courseNavPre=0,this.courseNavAnimateTime=300,CAICUI.render.subjectId="",CAICUI.render.categoryId="",CAICUI.render.courseId=t,CAICUI.render.chapterId="",CAICUI.render.isCoursePay=!1,CAICUI.render.questions=a,CAICUI.render.courseName="",CAICUI.render.courseNameArray=[],CAICUI.render.courseDetail="",CAICUI.render.getTasksProgress="",CAICUI.render.handout="",CAICUI.render.course_info="",CAICUI.render.courseInfoExamTime="",CAICUI.render.courseInfoDueTime="",CAICUI.render.versionId="",CAICUI.render.courseInfo="",CAICUI.render.courseVersion="",CAICUI.render.courseActiveTime="",CAICUI.render.lastLearnChapter="",CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink="",CAICUI.render.percentage=0,CAICUI.render.lockStatus=!1,CAICUI.render.chaptersIdArray=[],CAICUI.render.chapterName="",CAICUI.render.exerciseCount="",CAICUI.render.exerciseKnowledgeMemberStatus={},CAICUI.render.knowledgepointid="",CAICUI.render.lastExerciseNid="",CAICUI.render.ExerciseProgress="",CAICUI.render.ExerciseTotalTime="",CAICUI.render.cacheKnowledgeLevel1Id="",CAICUI.render.cacheKnowledgeLevel2Id="",CAICUI.render.cacheKnowledgePath="",CAICUI.render.errorNum="",CAICUI.render.exerciseFilename="",CAICUI.render.questionsIndex=0,CAICUI.render.exerciseCount="",CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId}})),CAICUI.render.$this.handoutAjax(function(){e("body .icon-handout-down").attr("href",CAICUI.Common.host.img+CAICUI.render.handout.path)}),CAICUI.render.$this.courseInfoAjax(function(){e("body .course-info-examTime").html(CAICUI.render.courseInfoExamTime)}),CAICUI.render.$this.learningcourseAjax(function(){e("body .course-info-dueTime").html(CAICUI.render.courseInfoDueTime),e("body .course-progress-show").attr("data-course-progress",CAICUI.render.percentage),e("body .course-percentage").html(CAICUI.render.percentage),e("body .course-progress-show").animate({width:CAICUI.render.percentage+"%"},1e3);var t=e("#template-courseStudy-courseList").html(),n=CAICUI.iGlobal.getTemplate(t,{courseNameArray:CAICUI.render.courseNameArray});e("body .course-change-ul").html(n),CAICUI.render.$this.courseDetailAjax(function(){e("body .course-name").html(CAICUI.render.courseName),CAICUI.render.$this.courseActiveStateAjax(function(){CAICUI.render.$this.getTasksProgressAjax(function(){CAICUI.render.$this.setTasksProgress();var t=e("#template-courseStudy-taskList").html(),n=CAICUI.iGlobal.getTemplate(t,{data:{courseId:CAICUI.render.courseId,courseDetail:CAICUI.render.courseDetail}});e("body .scroller").html(n),CAICUI.render.$this.exercisePointCountCacheAjax(function(t){r.each(t,function(r,t){e("body .knowledge-point-total-"+r.knowledge_point_id).parents(".course-list-link").addClass("course-list-questions"),e("body .knowledge-point-total-"+r.knowledge_point_id).html(r.exercise_count),e("body #course-list-questions-box-"+r.knowledge_point_id).addClass("active"),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-exercise-count",r.exercise_count),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-exercise-filename","questions-id.html"),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-cache-knowledge-level1-id",r.knowledge_path_level_one_id),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-cache-knowledge-level2-id",r.knowledge_path_level_two_id),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-cache-knowledge-path",r.knowledge_path_level_one_id+","+r.knowledge_path_level_two_id)})}),CAICUI.render.$this.exerciseKnowledgeMemberStatusAjax(function(t){r.each(t,function(r,t){e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-last-exercise-nid",r.last_exercise_nid);var n=0;r.progress&&(n=r.progress),e("body .knowledge-point-number-"+r.knowledge_point_id).html(n),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-exercise-progress",n),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-exercise-total-time",r.total_time);var a=0;r.error_num&&(a=r.error_num),e("body #knowledge-point-btn-"+r.knowledge_point_id).attr("data-errornum",a)})}),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),CAICUI.render.courseIndexTips=setTimeout(function(){e("body .courseIndex-content-tips").animate({height:0},500,function(){e("body .courseIndex-content-tips").remove(),window.CAICUI.myScroll.refresh()})},2e4),e(".lastLearn").attr("href",CAICUI.render.lastLearnChapterLink),e(".lastLearn").html(CAICUI.render.lastLearnChapterName),e(".continue-learning").attr("href",CAICUI.render.lastLearnChapterLink)})}),CAICUI.render.$this.courseVersionDataAjax(function(){var r=e("#template-courseStudy-courseVersionList").html(),t=CAICUI.iGlobal.getTemplate(r,{courseVersion:CAICUI.render.courseVersion,courseActiveTime:CAICUI.render.courseActiveTime});e("body .courseVersion-list").html(t)})})})},learningcourseAjax:function(e){CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(t){CAICUI.CACHE.Learningcourse=t.data.courselist;var n=CAICUI.render.$this.filterLearningcourse(CAICUI.CACHE.Learningcourse);r.each(n,function(e,n,a){r.each(e.newList,function(e,n){r.each(e.list,function(e,r){e.courseId==t.courseId&&(CAICUI.render.isCoursePay=!0),CAICUI.render.courseNameArray.push({courseId:e.courseId,courseName:e.courseName})})})}),r.each(CAICUI.CACHE.Learningcourse,function(e,r,t){if(e.courseId==CAICUI.render.courseId){CAICUI.render.courseInfo=t[r],CAICUI.render.courseInfoDueTime=CAICUI.iGlobal.getDate(t[r].expirationTime);var n=CAICUI.render.courseInfo.taskprogress?CAICUI.render.courseInfo.taskprogress:0,a=CAICUI.render.courseInfo.taskTotal?CAICUI.render.courseInfo.taskTotal:0,s=0;CAICUI.render.courseInfo.lastProgress;if(n&&a){var o=n/a;o>0&&.01>o&&(o=.01),s=parseInt(100*o)}return CAICUI.render.percentage=s,!1}}),e&&e()},fail:function(){CAICUI.CACHE.Learningcourse={},CAICUI.CACHE.RecentCourse={}}})},courseDetailAjax:function(e){var r=n.get("courseProgress-"+CAICUI.render.courseId);r?(CAICUI.render.courseDetail=r,CAICUI.render.$this.courseDetailDone(r,e)):CAICUI.Request.ajax({hostName:"http://192.168.10.112:8081",server:"courseDetail",data:{courseId:CAICUI.render.courseId},done:function(r){CAICUI.render.courseDetail=r.data[0],console.log(CAICUI.render.courseDetail),CAICUI.render.knowledgePointIdTotal=CAICUI.render.courseDetail.knowledgePointId,console.log(CAICUI.render.courseDetail),CAICUI.render.$this.courseDetailDone(CAICUI.render.courseDetail,e)}})},courseDetailDone:function(e,r){CAICUI.render.subjectId=e.subjectId,CAICUI.render.categoryId=e.categoryId,CAICUI.render.courseName=e.courseName,CAICUI.render.versionId=e.versionId,r&&r()},getChaptersIdArray:function(e){e.chapterNum;r.each(e.chapters,function(e,t){CAICUI.render.chaptersIdArray.push(e.chapterId),e.children&&e.children.length&&r.each(e.children,function(e,t){CAICUI.render.chaptersIdArray.push(e.chapterId),e.children&&e.children.length&&r.each(e.children,function(e,r){CAICUI.render.chaptersIdArray.push(e.chapterId)})})}),CAICUI.render.chaptersIdArray=CAICUI.render.chaptersIdArray.toString()},exercisePointCountCacheAjax:function(e){console.log(CAICUI.render.knowledgePointIdTotal),CAICUI.Request.ajax({hostName:"http://192.168.10.134:8080",server:"exercisePointCountCache",data:{knowledge_points:CAICUI.render.knowledgePointIdTotal,type:6},done:function(r){e&&e(r.data)}})},exerciseKnowledgeMemberStatusAjax:function(e){CAICUI.Request.ajax({hostName:"http://192.168.10.134:8080",server:"exerciseKnowledgeMemberStatus",data:{knowledge_points:CAICUI.render.knowledgePointIdTotal,type:3,member_id:CAICUI.User.memberId},done:function(r){e&&e(r.data)}})},courseActiveStateAjax:function(e){CAICUI.Request.ajax({server:"coursestatus",data:{token:CAICUI.User.token,versionId:CAICUI.render.versionId},done:function(r){r.data[0]&&0!==r.data[0].lockStatus&&(CAICUI.render.lockStatus=!0),CAICUI.CACHE.coursestatus=r.data,CAICUI.render.$this.courseByInFo(r.data),e&&e()},fail:function(e){s.msg("Sorry~ 获取课程授权信息失败，请刷新页面重试。",function(){})}})},courseVersionDataAjax:function(e){CAICUI.Request.ajax({server:"version",data:{versionId:CAICUI.render.versionId},done:function(r){CAICUI.render.courseVersion=r.data,e&&e()},fail:function(e){s.msg("Sorry~ 网络错误，请刷新页面重试。",function(){})}})},getTasksProgressAjax:function(e){CAICUI.Request.ajax({server:"getTasksProgress",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId},done:function(t){t.data;if(CAICUI.CACHE.getTasksProgress=t.data,CAICUI.render.getTasksProgress=t.data,CAICUI.render.getTasksProgress&&CAICUI.render.getTasksProgress.length){CAICUI.render.lastLearnChapter=r.max(CAICUI.render.getTasksProgress,function(e){return e.createDate});var n="",a="";CAICUI.render.lastLearnChapter&&!CAICUI.render.lastLearnChapterName?(n="#video/"+CAICUI.render.courseId+"/"+CAICUI.render.lastLearnChapter.chapterId+"/"+CAICUI.render.lastLearnChapter.taskId+"/"+CAICUI.render.lastLearnChapter.progress+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on",a='上次学到：<span class="lastLearn-chapterName">'+CAICUI.render.lastLearnChapter.chapterName+' </span><i class="icon icon-course-arrow-right"></i>'):(n=CAICUI.render.lastLearnChapterLink?t.lastLearnChapterLink:CAICUI.render.courseDetail.chapters[0].children?"#video/"+CAICUI.render.courseId+"/"+CAICUI.render.courseDetail.chapters[0].children[0].chapterId+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on":"#video/"+CAICUI.render.courseId+"/"+CAICUI.render.courseDetail.chapters[0].chapterId+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on",a=CAICUI.render.lastLearnChapterName?'上次学到：<span class="lastLearn-chapterName">'+CAICUI.render.lastLearnChapterName+' </span><i class="icon icon-course-arrow-right"></i>':'<i class="icon icon-course-arrow-right"></i><span class="lastLearn-chapterName">开始学习本课程</span>'),CAICUI.render.lastLearnChapterLink=n,CAICUI.render.lastLearnChapterName=a}e&&e()},fail:function(){CAICUI.CACHE.getTasksProgress={},CAICUI.render.getTasksProgress={}}})},courseInfoAjax:function(e){CAICUI.Request.ajax({server:"course_info",data:{token:CAICUI.User.token,id:CAICUI.render.courseId},done:function(r){var r=r.data;CAICUI.CACHE.course_info=r.data,CAICUI.render.course_info=r.data,r.days<0?CAICUI.render.courseInfoExamTime="本科目考试时间未确定":0==r.days?CAICUI.render.courseInfoExamTime="请留意,本科目<strong>今天</strong>开始考试":CAICUI.render.courseInfoExamTime="距本科目考试还有<strong>"+r.days+"</strong>天",e&&e()},fail:function(e){CAICUI.CACHE.course_info={},CAICUI.render.course_info={}}})},handoutAjax:function(e){CAICUI.Request.ajax({server:"handout",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId},done:function(r){CAICUI.CACHE.handout=r.data,CAICUI.render.handout=r.data,e&&e()},fail:function(e){CAICUI.CACHE.handout={},CAICUI.render.handout={}}})},setTasksProgress:function(){var e="",t=n.get("courseProgress-"+CAICUI.render.courseId);if(t)CAICUI.render.courseDetail=t;else{e=CAICUI.render.courseDetail;CAICUI.render.getTasksProgress;r.each(e.chapters,function(t,n){t.children?r.each(t.children,function(t,a){t.children?r.each(t.children,function(t,s){t.tasks&&r.each(t.tasks,function(t,o){r.each(CAICUI.CACHE.getTasksProgress,function(r,i){t.taskId==r.taskId&&(e.chapters[n].children[a].children[s].tasks[o].progress=r.progress,e.chapters[n].children[a].children[s].tasks[o].total=r.total)})})}):t.tasks&&r.each(t.tasks,function(t,s){r.each(CAICUI.CACHE.getTasksProgress,function(r,o){t.taskId==r.taskId&&(e.chapters[n].children[a].tasks[s].progress=r.progress,e.chapters[n].children[a].tasks[s].total=r.total)})})}):t.tasks&&r.each(t.tasks,function(t,a){r.each(CAICUI.CACHE.getTasksProgress,function(r,s){t.taskId==r.taskId&&(e.chapters[n].tasks[a].progress=r.progress,e.chapters[n].tasks[a].total=r.total)})})}),CAICUI.render.courseDetail=e,n.setsingle("courseProgress-"+CAICUI.render.courseId,e)}},courseByInFo:function(r){var t=0;if(e.isArray(r)){for(var n=0;n<r.length;n++)r[n].courseId==CAICUI.render.courseId&&"init"!=r[n].activeState&&(CAICUI.render.courseActiveTime=r[n].activeTime);for(var a=Date.parse(new Date)/1e3,n=0;n<r.length;n++){if("acitve"==r[n].activeState&&r[n].expirationTime>a&&3>t){t=3;break}"init"==r[n].activeState&&2>t?t=2:"acitve"==r[n].activeState&&r[n].expirationTime<a&&1>t&&(t=1)}CAICUI.render.lockStatus&&(t=4)}CAICUI.render.courseDetail.courseActiveState=t},openVideo:function(r){var t=CAICUI.render.courseDetail.courseActiveState,a=CAICUI.iGlobal.getThat(r),o=a.attr("link");"javascript:;"!=o?(CAICUI.NavVideo=!1,e("body .course-desc").attr("href",o),CAICUI.render.lastLearnChapterName=a.find(".course-list-desc").text(),CAICUI.render.lastLearnChapterLink=o,n.setsingle("playlist-index"+CAICUI.render.courseId,"c|"+a.attr("data-index")),window.location.hash=o):4==t?s.msg("Sorry~ 您当前的课程已锁定",function(){}):2==t?s.msg("Sorry~ 您当前的课程未激活",function(){}):1==t?s.msg("Sorry~ 您当前的课程已过期",function(){}):0==t&&s.msg("Sorry~ 您未购买当前的课程",function(){})},openQuestions:function(e){e.stopPropagation();var r=CAICUI.iGlobal.getThat(e);CAICUI.render.chapterId=r.attr("data-chapterId"),CAICUI.render.chapterName=r.attr("data-chapterName"),CAICUI.render.knowledgepointid=r.attr("data-knowledgepointid"),CAICUI.render.cacheKnowledgeLevel1Id=r.attr("data-cache-knowledge-level1-id"),CAICUI.render.cacheKnowledgeLevel2Id=r.attr("data-cache-knowledge-level2-id"),CAICUI.render.cacheKnowledgePath=r.attr("data-cache-knowledge-path"),CAICUI.render.errorNum=r.attr("data-errornum"),CAICUI.render.lastExerciseNid=r.attr("data-last-exercise-nid"),CAICUI.render.ExerciseProgress=r.attr("data-exercise-progress"),CAICUI.render.ExerciseTotalTime=r.attr("data-exercise-total-time"),CAICUI.render.exerciseFilename=r.attr("data-exercise-filename"),CAICUI.render.exerciseCount=r.attr("data-exercise-count"),this.addAnimate(function(){var e=new a;e.render()})},addAnimate:function(r){var t=e(window).width(),n=e(window).height();e("body").prepend('<div id="animate" style="width:'+t+'px;"></div>'),e("#animate").animate({height:n,top:"0"},300,function(){r&&r()})},addRecentCourse:function(e){if(CAICUI.CACHE.Learningcourse&&CAICUI.CACHE.RecentCourse)for(var r=0;r<CAICUI.CACHE.Learningcourse.length;r++)if(CAICUI.CACHE.Learningcourse[r].courseId==e){for(var t=!0,n=0;n<CAICUI.CACHE.RecentCourse.length;n++)CAICUI.CACHE.RecentCourse[n].courseId==e&&(t=!1);return t&&CAICUI.CACHE.RecentCourse.push(CAICUI.CACHE.Learningcourse[r]),void(CAICUI.CACHE.RecentCourse.length>2&&CAICUI.CACHE.RecentCourse.splice(0,1))}},filterLearningcourse:function(e){for(var t=r.chain(e).map(function(e){return e.categoryName}).uniq().value(),n=r.chain(e).map(function(e){return e.categoryIndex}).uniq().value(),a=[],s=0;s<t.length;s++)a.push({categoryName:t[s],categoryIndex:n[s],list:[]}),r.each(e,function(e,r,n){e.categoryName==t[s]&&(a&&a[s]&&a[s].list?a[s].list.push(e):a[s].list=[e])});for(var s=0;s<a.length;s++){a[s].newList=[];for(var o=a[s].list,i=r.chain(o).map(function(e){return e.subjectName}).uniq().value(),I=r.chain(o).map(function(e){return e.subjectIndex}).uniq().value(),C=0;C<i.length;C++)a[s].newList.push({subjectName:i[C],subjectIndex:I[C],list:[]}),r.each(a[s].list,function(e,t,n){if(e.subjectName==i[C])if(a[s].newList[C].list){var o=!0;r.each(a[s].newList[C].list,function(r,t,n){e.courseId==r.courseId&&(o=!1)}),o&&a[s].newList[C].list.push(e)}else a[s].newList[C].list=[e]})}var a=r.sortBy(a,"categoryIndex");return r.each(a,function(e,t){a[t].newList=r.sortBy(e.newList,"subjectIndex"),r.each(a[t].newList,function(e,n){a[t].newList[n].list=r.sortBy(e.list,"courseIndex")})}),a},courseVersionListShow:function(r){var t=(CAICUI.iGlobal.getThat(r),e(".courseVersion-list"));t.hasClass("active")?t.removeClass("active"):t.addClass("active")},courseVersionListA:function(r){var t=CAICUI.iGlobal.getThat(r);if(!t.hasClass("active")){var n=t.siblings();n.removeClass("active"),t.addClass("active")}e(".courseVersion-list").removeClass("active")},optionCourse:function(e){CAICUI.iGlobal.getThat(e);CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink=""},courseChange:function(r){var t=CAICUI.iGlobal.getThat(r);t.toggleClass("active"),e(".option-ul").toggleClass("active")},courseNavToggle:function(r){var t=r.currentTarget,n=e(t),a=n.parent();CAICUI.render.courseId=n.attr("data-courseid"),a.toggleClass("active"),window.CAICUI.myScroll.refresh()},courseNavUlLeave:function(e){CAICUI.iGlobal.getThat(e);this.courseNavPreAnimate(this.courseNavPre),this.courseNavPre=this.courseNavPreDefault,CAICUI.render.$this.$(".courseIndex-li").eq(this.courseNavPre).addClass("hover"),this.courseNavAnimate(this.$(".courseIndex-active-box").eq(this.courseNavPre),this.courseNavPre),CAICUI.render.$this.$(".courseIndex-ul").removeClass("hover")},courseNavLiLeave:function(e){},courseNavLiEnter:function(e){var r=CAICUI.iGlobal.getThat(e),t=r.index(),n=r.find(".courseIndex-active-box");return t==this.courseNavPre?!1:(r.addClass("hover"),this.courseNavPreAnimate(this.courseNavPre),this.courseNavAnimate(n,t),void(this.courseNavPre=t))},courseNavPreAnimate:function(e){var r=this.$(".courseIndex-li").eq(e),t=!1;CAICUI.render.$this.$(".courseIndex-ul").hasClass("hover")||(t=!0),this.$(".courseIndex-active-box").eq(e).stop(!0,!1).animate({width:34,marginLeft:0},this.courseNavAnimateTime,function(){r.removeClass("hover"),t&&(CAICUI.render.$this.$(".courseIndex-ul").addClass("hover"),t=!1)})},courseNavAnimate:function(e,r){e.stop(!0,!1).animate({width:"148px"},this.courseNavAnimateTime)}});return o});