define(["jquery","underscore","backbone","views/ac-list","views/ac-new","views/ac-desc","views/pagination","swiper","storage","layer","layerExt"],function(e,r,t,a,n,i,o,s,C){"use strict";var c=t.View.extend({el:"body #right",template:r.template(e("#template-course-ac").html()),events:{"click .ac-new":"acNew","click .option-li-newAcType":"optionLiNewAcType","keyup .newAc-title":"newAcTitle","mouseleave .ac-select-box":"selectBoxLeave","click .ac-select-a":"acSelectA","click .ac-option-li":"addActive","click .js-ac-list-active":"acListActive","click .ac-Ad-close":"acAdClose","click .ac-editor-select":"acSelectA","click .course-change":"courseChange","click .option-li":"acOptionChoose","click .js-pagination-li":"paginationChange","click .js-pagination-prev":"paginationPrev","click .js-pagination-next":"paginationNext","click .ac-desc-like-a":"likeAc","click .ac-search-a":"searchAc","click .editor-button-box":"editorButtonBox","click .ac-list-info-video":"acVideoLink","click .ac-list-remove":"acRemove","click .ac-list":"acListShow","click .ac-answer-replys":"acAnswerReplys","click .js-ac-load-cancel":"acLoadCancel","click .js-ac-load-confirm":"acLoadConfirm","click .js-acReply-load-cancel":"acReplyLoadCancel","click .js-acReply-load-confirm":"acReplyLoadConfirm"},render:function(r){CAICUI.render.layer=layer,this.$header=this.$(".courseIndex-header"),this.$courseNavUl=this.$(".courseIndex-ul"),this.$courseNavLi=this.$(".courseIndex-li"),this.$courseIndexActiveBox=this.$(".courseIndex-active-box"),this.$scroller=this.$("#scroller"),this.$acRight=this.$(".ac-right"),this.courseNavPreDefault=1,this.courseNavPre=1,this.courseNavAnimateTime=300,CAICUI.render.subjectId="",CAICUI.render.courseId=r,CAICUI.render.$this=this,CAICUI.render.serverTotal=5,CAICUI.render.serverNum=0,CAICUI.render.self=0,CAICUI.render.type=3,CAICUI.render.ordertype=1,CAICUI.render.pageNo=1,CAICUI.render.pageSize=20,CAICUI.render.search="",CAICUI.render.totalCount="",CAICUI.render.pageTotal=0,CAICUI.render.bbsId="",CAICUI.render.bbsType=0,CAICUI.render.listActive="",CAICUI.render.replayId="",CAICUI.render.replayContent="",CAICUI.render.parentsAcListActive="",CAICUI.render.acRemoveLoad="",CAICUI.render.parentLi="",CAICUI.render.acReplayRemoveLoad="",this.$learningcourse="",this.learningcourse(),this.$bbslist="",this.$ad_discuss="",this.ad_discuss(),this.$courseBaseInfo="",this.$bbs_forumlistShow="",this.bbs_forumlistShow(),this.$newtids=[],CAICUI.render.timer=setInterval(function(){if(CAICUI.render.serverTotal==CAICUI.render.serverNum){clearInterval(CAICUI.render.timer);var r=Math.floor(Math.random()*CAICUI.render.$this.$bbslist.length+1);CAICUI.render.$this.$bbslist.splice(r,0,{isAd:!0,ad_discuss:CAICUI.render.$this.$ad_discuss}),CAICUI.render.$this.getForumlistShow();var t=CAICUI.render.$this.filterLearningcourse(CAICUI.CACHE.Learningcourse);CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId,learningcourse:t,courseBaseInfo:CAICUI.render.$this.$courseBaseInfo,bbslist:CAICUI.render.$this.$bbslist,ad_discuss:CAICUI.render.$this.$ad_discuss,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,totalCount:CAICUI.render.totalCount,bbs_forumlistShow:CAICUI.render.$this.$bbs_forumlistShow,newtids:CAICUI.render.$this.$newtids}})),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),e("body .ac-list-li-content").eq(0).trigger("click");new s(".ac-swiper-container",{autoplay:2500,loop:!0})}},CAICUI.render.time)},ad_discuss:function(){CAICUI.Request.ajax({server:"ad_discuss",data:{token:CAICUI.User.token,number:3},done:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$ad_discuss=e.data},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$ad_discuss={}}})},bbs_forumlistShow:function(){CAICUI.Request.ajax({server:"bbs_forumlistShow",data:{token:CAICUI.User.token},done:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$bbs_forumlistShow=e},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$bbs_forumlistShow={}}})},learningcourse:function(){if(CAICUI.CACHE.Learningcourse&&CAICUI.CACHE.Learningcourse.length){var e=!0;r.each(CAICUI.CACHE.Learningcourse,function(r,t){r.courseId==CAICUI.render.courseId&&(e=!1,CAICUI.render.subjectId=r.subjectID)}),e?this.courseBaseInfo(CAICUI.render.courseId):CAICUI.render.serverNum++,CAICUI.render.serverNum++,CAICUI.render.$this.bbslist()}else CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:1,pageSize:CAICUI.defaultPageSize},done:function(e){console.log(e);var t=!0;r.each(e.data.courselist,function(e,r){e.courseId==CAICUI.render.courseId&&(t=!1,CAICUI.render.subjectId=e.subjectID)}),t?CAICUI.render.$this.courseBaseInfo(CAICUI.render.courseId):CAICUI.render.serverNum++,CAICUI.render.serverNum++,CAICUI.CACHE.Learningcourse=e.data.courselist,CAICUI.CACHE.RecentCourse=e.data.courselist.slice(0,2),CAICUI.render.$this.bbslist()},fail:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.Learningcourse={},CAICUI.CACHE.RecentCourse={},CAICUI.render.$this.bbslist()}})},courseBaseInfo:function(e){CAICUI.Request.ajax({server:"courseBaseInfo",data:{token:CAICUI.User.token,courseIds:e},done:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$courseBaseInfo=e.data[0]},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$courseBaseInfo={}}})},bbslist:function(e){CAICUI.Request.ajax({server:"bbslist",data:{token:CAICUI.User.token,type:CAICUI.render.type,subjectId:CAICUI.render.subjectId,keyWords:CAICUI.render.search,self:CAICUI.render.self,ordertype:CAICUI.render.ordertype,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize},done:function(r){e?e(r):(CAICUI.render.serverNum++,CAICUI.render.$this.$bbslist=r.data,CAICUI.render.pageNo=r.pageNo,CAICUI.render.pageSize=r.pageSize,CAICUI.render.totalCount=r.totalCount,CAICUI.render.pageTotal=Math.ceil(r.totalCount/r.pageSize))},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$bbslist={},layer.msg("Sorry~ 网络错误，请刷新页面！",function(){})}})},bbsdetail:function(e){CAICUI.Request.ajax({server:"bbsdetail",data:{token:CAICUI.User.token,id:CAICUI.render.replayId,pageNo:1,pageSize:20},done:function(r){e(r.data)},fail:function(r){e({})}})},likeAc:function(){CAICUI.Request.ajax({server:"bbs_praise",data:{token:CAICUI.User.token,id:CAICUI.render.replayId,action:2},done:function(r){CAICUI.render.listActive.find(".ac-list-info-like-num").text(r.data.totalCount),e(".ac-desc-like-num").text(r.data.totalCount)},fail:function(e){layer.msg("Sorry~ ",function(){})}})},bbs_del:function(e){CAICUI.Request.ajax({server:"bbs_del",data:{token:CAICUI.User.token,id:CAICUI.render.bbsId,type:CAICUI.render.bbsType},done:function(r){e&&e()},fail:function(e){layer.msg("Sorry~ 您没有当前帖子的删除权限",function(){})}})},acListActive:function(r){r.stopPropagation(),CAICUI.iGlobal.loading(".ac-right");var t=CAICUI.iGlobal.getThat(r),a=t.attr("data-id"),n=t.attr("data-isme"),o=t.attr("data-isnew"),s=t.parents(".ac-list-li");CAICUI.render.listActive=t,s.siblings().removeClass("active"),s.addClass("active"),CAICUI.render.replayId=s.attr("data-id"),this.bbsdetail(function(r){var s=new i;e(".ac-content").find(".ac-right").remove(),e(".ac-content").append(s.render({data:r,isme:n}).el),"true"==o&&(t.attr("data-isnew","false"),t.find(".icon-post-type-2").remove(),CAICUI.render.$this.addForumlistShowStorage({id:a,time:parseInt((new Date).getTime()/1e3)})),window.CAICUI.acScroll=CAICUI.iGlobal.iScroll("body #wrapper-ac"),layer.photos({photos:".discussQA-imgPath",shift:0})})},acList:function(e){var r=new a;this.$scroller.html(r.render(e).el)},getThat:function(r){return e(r.currentTarget)},courseNavAnimate:function(e,r){e.stop(!0,!1).animate({width:"148px"},this.courseNavAnimateTime)},courseNavPreAnimate:function(e){var r=this.$(".courseIndex-li").eq(e),t=!1;CAICUI.render.$this.$(".courseIndex-ul").hasClass("hover")||(t=!0),this.$(".courseIndex-active-box").eq(e).stop(!0,!1).animate({width:34,marginLeft:0},this.courseNavAnimateTime,function(){r.removeClass("hover"),t&&(CAICUI.render.$this.$(".courseIndex-ul").addClass("hover"),t=!1)})},courseNavLiEnter:function(e){var r=CAICUI.iGlobal.getThat(e),t=r.index(),a=r.find(".courseIndex-active-box");return t==this.courseNavPre?!1:(r.addClass("hover"),this.courseNavPreAnimate(this.courseNavPre),this.courseNavAnimate(a,t),void(this.courseNavPre=t))},courseNavUlLeave:function(e){CAICUI.iGlobal.getThat(e);this.courseNavPreAnimate(this.courseNavPre),this.courseNavPre=this.courseNavPreDefault,this.$courseNavLi.eq(this.courseNavPre).addClass("hover"),this.courseNavAnimate(this.$(".courseIndex-active-box").eq(this.courseNavPre),this.courseNavPre),CAICUI.render.$this.$(".courseIndex-ul").removeClass("hover")},courseNavLiLeave:function(e){},acNew:function(r){if(this.$courseBaseInfo)layer.msg("Sorry~ 您没有当前课程的发帖权限",function(){});else{CAICUI.render.newAcType=1,CAICUI.render.newAcTitle="",CAICUI.render.listActive?CAICUI.render.listActive.removeClass("active"):"";var t=(CAICUI.iGlobal.getThat(r),new n);e(".ac-content").find(".ac-right").remove(),e(".ac-content").append(t.render().el)}},optionLiNewAcType:function(e){var r=CAICUI.iGlobal.getThat(e);CAICUI.render.newAcType=r.attr("data-type"),console.log(CAICUI.render.newAcType)},newAcTitle:function(r){var t=CAICUI.iGlobal.getThat(r),a=t.val(),n=a.length;n>50?(CAICUI.render.newAcTitle=a.substr(0,50),e(".ac-editor-num").text("还可以输入0字"),t.val(CAICUI.render.newAcTitle)):(CAICUI.render.newAcTitle=a,e(".ac-editor-num").text("还可以输入"+(50-n)+"字"))},nextDomShow:function(e){var r=CAICUI.iGlobal.getThat(e);r.next().toggleClass("active")},addActive:function(e){var r=CAICUI.iGlobal.getThat(e);r.siblings().removeClass("active"),r.addClass("active")},acSelectA:function(e){var r=CAICUI.iGlobal.getThat(e);r.toggleClass("active"),r.next().toggleClass("active")},acSelectAChange:function(e){var r=CAICUI.iGlobal.getThat(e);r.toggleClass("active"),r.next().toggleClass("active")},selectBoxLeave:function(e){var r=CAICUI.iGlobal.getThat(e);r.find("a").removeClass("active"),r.find("ul").removeClass("active")},acAdClose:function(e){var r=CAICUI.iGlobal.getThat(e),t=r.parents("li");t.remove(),window.CAICUI.myScroll.refresh()},acEditorSelect:function(e){CAICUI.iGlobal.getThat(e)},courseChange:function(r){var t=CAICUI.iGlobal.getThat(r);t.toggleClass("active"),e(".course-change-ul").toggleClass("active")},acOptionChoose:function(e){var r=CAICUI.iGlobal.getThat(e),t=r.find(".option-a").text();r.siblings().removeClass("active"),r.addClass("active"),r.parent().removeClass("active"),r.parent().prev().removeClass("active"),r.parent().prev().find(".ac-select-text").text(t),r.hasClass("option-li-render")&&(CAICUI.render.type=r.attr("data-type")?r.attr("data-type"):CAICUI.render.type,CAICUI.render.ordertype=r.attr("data-ordertype")?r.attr("data-ordertype"):CAICUI.render.ordertype,this.acOptionChooseRender())},acOptionChooseRender:function(){CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh(),CAICUI.render.pageNo=1,this.bbslist(function(r){var t=new a;e("body #scroller").html(t.render({data:{type:0,bbslist:r.data,newtids:CAICUI.render.$this.$newtids,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}}).el),window.CAICUI.myScroll.refresh()})},paginationChange:function(r){CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh();var t=CAICUI.iGlobal.getThat(r);CAICUI.render.pageNo=t.attr("data-pageno"),this.bbslist(function(r){var t=new a;e("body #scroller").html(t.render({data:{type:0,bbslist:r.data,newtids:CAICUI.render.$this.$newtids,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}}).el),window.CAICUI.myScroll.refresh()})},paginationPrev:function(r){CAICUI.render.pageNo>1&&(CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh(),CAICUI.render.pageNo=+CAICUI.render.pageNo-1,this.bbslist(function(r){var t=new a;e("body #scroller").html(t.render({data:{type:0,bbslist:r.data,newtids:CAICUI.render.$this.$newtids,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}}).el),window.CAICUI.myScroll.refresh()}))},paginationNext:function(r){CAICUI.render.pageNo<=CAICUI.render.pageTotal-1&&(CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh(),CAICUI.render.pageNo=+CAICUI.render.pageNo+1,this.bbslist(function(r){var t=new a;e("body #scroller").html(t.render({data:{type:0,bbslist:r.data,newtids:CAICUI.render.$this.$newtids,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}}).el),window.CAICUI.myScroll.refresh()}))},searchAc:function(r){var t=CAICUI.iGlobal.getThat(r),n=t.prev(),i=n.val();CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh(),CAICUI.render.pageNo=1,CAICUI.render.search=i,this.bbslist(function(r){var t=new a;e("body #scroller").html(t.render({data:{search:!0,type:0,bbslist:r.data,newtids:CAICUI.render.$this.$newtids,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}}).el),n.val(""),CAICUI.render.search="",window.CAICUI.myScroll.refresh()})},editorButtonBox:function(e){console.log(123)},acVideoLink:function(e){e.stopPropagation(),CAICUI.NavVideo=!1,CAICUI.domRender=!1;var r=CAICUI.iGlobal.getThat(e);window.location.hash=r.attr("link")},acRemove:function(r){r.stopPropagation();var t=CAICUI.iGlobal.getThat(r);CAICUI.render.bbsType=t.attr("data-type");var a=t.parents(".ac-list-li");CAICUI.render.bbsId=a.attr("data-id"),CAICUI.render.parentsAcListActive=a,CAICUI.render.acRemoveLoad=layer.load(1,{type:1,title:!1,content:e("#remove-ac-load"),closeBtn:0,shade:[.5,"#000"]})},acLoadCancel:function(){layer.close(CAICUI.render.acRemoveLoad)},acLoadConfirm:function(){this.bbs_del(function(){CAICUI.render.parentsAcListActive.remove(),e("body .ac-right").empty(),window.CAICUI.acScroll.refresh(),window.CAICUI.myScroll.refresh(),layer.close(CAICUI.render.acRemoveLoad)})},acListShow:function(r){CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),CAICUI.render.ordertype=1,CAICUI.render.pageNo=1,CAICUI.render.search="",this.bbslist(function(r){var t=new a;e("body #scroller").html(t.render({data:{search:!0,type:0,bbslist:r.data,newtids:CAICUI.render.$this.$newtids,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}}).el),window.CAICUI.myScroll.refresh()})},acAnswerReplys:function(r){var t=CAICUI.iGlobal.getThat(r),a=t.parents(".ac-answer-li");CAICUI.render.bbsId=t.attr("data-pid"),CAICUI.render.bbsType=t.attr("data-type"),CAICUI.render.parentLi=a,CAICUI.render.acReplayRemoveLoad=layer.load(1,{type:1,title:!1,content:e("#remove-acReply-load"),closeBtn:0,shade:[.5,"#000"]})},acReplyLoadCancel:function(){layer.close(CAICUI.render.acReplayRemoveLoad)},acReplyLoadConfirm:function(){this.bbs_del(function(){if(CAICUI.render.parentLi.siblings().length){CAICUI.render.parentLi.remove();var r=e(".ac-answer-li");r.each(function(r){var t=e(this);t.find(".ac-answer-floor").text(r+1)})}else CAICUI.render.parentLi.parent().remove(),CAICUI.render.parentLi.remove();var t=CAICUI.render.$this.$(".ac-list-ul .ac-list-li.active").find(".ac-list-info-discuss-num"),a=t.text();t.text(+a-1),window.CAICUI.acScroll.refresh(),layer.close(CAICUI.render.acReplayRemoveLoad)})},getForumlistShow:function(){var e=0,r=CAICUI.render.$this.$bbs_forumlistShow,t="";CAICUI.render.$this.$bbslist&&CAICUI.render.$this.$bbslist.length&&(e=CAICUI.render.$this.$bbslist[0].fid),console.log(e);for(var a in r)if(+r[a].fid==e){t=r[a];break}console.log(t);for(var a in t.newtids)CAICUI.render.$this.$newtids.push({id:a,time:t.newtids[a]});console.log(CAICUI.render.$this.$newtids)},addForumlistShowStorage:function(e){var r=CAICUI.Storage.getStorage("acActive");r?(r.push(e),CAICUI.Storage.setStorage({acActive:r})):CAICUI.Storage.setStorage({acActive:[e]})},removeOldForumlistShowStorage:function(){var e=CAICUI.Storage.getStorage("acActive");console.log(e);var r=parseInt((new Date).getTime()/1e3);for(var t in e){var a=parseInt(r-e[t].time);0>a&&(a=1);var n=Math.ceil(a/86400);console.log(n)}CAICUI.iGlobal.stringData()},filterLearningcourse:function(e){for(var t=r.chain(e).map(function(e){return e.categoryName}).uniq().value(),a=r.chain(e).map(function(e){return e.categoryIndex}).uniq().value(),n=[],i=0;i<t.length;i++)n.push({categoryName:t[i],categoryIndex:a[i],list:[]}),r.each(e,function(e,r,a){e.categoryName==t[i]&&(n&&n[i]&&n[i].list?n[i].list.push(e):n[i].list=[e])});for(var i=0;i<n.length;i++){n[i].newList=[];for(var o=n[i].list,s=r.chain(o).map(function(e){return e.subjectName}).uniq().value(),C=r.chain(o).map(function(e){return e.subjectIndex}).uniq().value(),c=0;c<s.length;c++)n[i].newList.push({subjectName:s[c],subjectIndex:C[c],list:[]}),r.each(n[i].list,function(e,t,a){if(e.subjectName==s[c])if(n[i].newList[c].list){var o=!0;r.each(n[i].newList[c].list,function(r,t,a){e.courseId==r.courseId&&(o=!1)}),o&&n[i].newList[c].list.push(e)}else n[i].newList[c].list=[e]})}var n=r.sortBy(n,"categoryIndex");return r.each(n,function(e,t){n[t].newList=r.sortBy(e.newList,"subjectIndex"),r.each(n[t].newList,function(e,a){n[t].newList[a].list=r.sortBy(e.list,"courseIndex")})}),n}});return c});