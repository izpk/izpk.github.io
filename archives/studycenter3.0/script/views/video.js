function on_cc_player_init(e,o){nowcc_vid=e,nowcc_objectID=o,$(".video-play div.dummy").html("finish"),WINAPI.log("获得iframe发送的消息视频初始化完成:---on_cc_player_init")}function on_spark_player_start(){videoController.taskProgress?videoController.cc_seek(videoController.taskProgress):videoController.cc_seek(videoController.currentTask.progress)}function on_spark_player_pause(){$(".glyphicon.plays.glyphicon-pause").addClass("glyphicon-play").removeClass("glyphicon-pause")}function on_spark_player_resume(){$(".glyphicon.plays.glyphicon-play").addClass("glyphicon-pause").removeClass("glyphicon-play")}function on_spark_player_stop(){$(".glyphicon.plays.glyphicon-pause").addClass("glyphicon-play").removeClass("glyphicon-pause"),$(".video-play div.dummy").html("stop")}function on_player_seek(e,o){console.log("on_player_seek:"+e+"|"+o+"|"+userOPTime),$(".video-play div.dummy").html("seek"),parseInt(o)==parseInt(userOPTime)&&(userOPCCCallBackTime=userOPTime,userOP=!1)}function on_player_start(){videoController.taskProgress?videoController.cc_seek(videoController.taskProgress):videoController.cc_seek(videoController.currentTask.progress)}define(["jquery","underscore","ajax","storage","layer","iMobile","slimscroll","jqueryUI"],function(e,o,r,t,a,n){return window.videoController={player:null,playerType:0,courseData:"",courseActiveState:0,ccSetConfig:{control_enable:0,bigbutton_enable:0,keyboard_enable:0,fullscreen_enable:1,on_player_seek:"on_player_seek",on_player_start:"on_player_start"},courseId:"",chapterId:"",taskId:"",taskProgress:"",load:"",payInfoDialog:"",init:function(e,r,a,n){console.log(e+";"+r+";"+a+";"+n),videoController.courseId=e,CAICUI.render.chapterId=videoController.chapterId=r,a&&(CAICUI.render.taskId=videoController.taskId=a),n&&(CAICUI.render.taskProgress=videoController.taskProgress=n),videoController.courseNode={},videoController.courseNode.isPublic=1,videoController.courseNode.imgPathArray=[],videoController.courseId=e,CAICUI.Request.ajax({server:"courseDetail",data:{courseId:e},done:function(a){console.log(a),CAICUI.render.subjectId=a.data[0].subjectId,videoController.courseData=a.data[0];var n="";console.log(r),o.each(a.data[0].chapters,function(e,t,a){e.chapterId==r?n=t:e.children&&o.each(e.children,function(e,a,i){e.chapterId==r?n=t+"|"+a:e.children&&o.each(e.children,function(e,o){e.chapterId==r&&(n=t+"|"+a+"|"+o)})})}),t.setsingle("playlist-index"+e,"c|"+n),videoController.courseActiveState(a.data[0].versionId,function(){videoController.initData(e,r)})}})},initData:function(e,o){if(t.get("playlist-index"+e)&&t.get("course-"+e)){if(videoController.indexList=t.get("playlist-index"+e).split("|"),videoController.courseData=t.get("course-"+e),4==videoController.indexList.length&&"c"==videoController.indexList[0]){videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]].children[videoController.indexList[2]].children[videoController.indexList[3]];var r=videoController.currentChapter.tasks.length,a=0,n=0;videoController.currentChapter.tasks[0].modifyDate&&(n=videoController.currentChapter.tasks[0].modifyDate);for(var i=1;r>i;i++)videoController.currentChapter.tasks[i].modifyDate&&videoController.currentChapter.tasks[i].modifyDate>n&&(a=i,n=videoController.currentChapter.tasks[i].modifyDate);videoController.lasttaskindex=a}else if(3==videoController.indexList.length&&"c"==videoController.indexList[0]){videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]].children[videoController.indexList[2]];var r=videoController.currentChapter.tasks.length,a=0,n=0;videoController.currentChapter.tasks[0].modifyDate&&(n=videoController.currentChapter.tasks[0].modifyDate);for(var i=1;r>i;i++)videoController.currentChapter.tasks[i].modifyDate&&videoController.currentChapter.tasks[i].modifyDate>n&&(a=i,n=videoController.currentChapter.tasks[i].modifyDate);videoController.lasttaskindex=a}else if(4==videoController.indexList.length&&"t"==videoController.indexList[0])videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]].children[videoController.indexList[2]],videoController.lasttaskindex=videoController.indexList[3];else if(2==videoController.indexList.length&&"c"==videoController.indexList[0]){videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]];var r=videoController.currentChapter.tasks.length,a=0,n=0;videoController.currentChapter.tasks[0].modifyDate&&(n=videoController.currentChapter.tasks[0].modifyDate);for(var i=1;r>i;i++)videoController.currentChapter.tasks[i].modifyDate&&videoController.currentChapter.tasks[i].modifyDate>n&&(a=i,n=videoController.currentChapter.tasks[i].modifyDate);videoController.lasttaskindex=a}else{if(3!=videoController.indexList.length||"t"!=videoController.indexList[0])return void(window.location.href="#/courseIndex/"+e);videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]],videoController.lasttaskindex=videoController.indexList[2]}if(videoController.taskId)for(var i=0;i<videoController.currentChapter.tasks.length;i++)videoController.currentChapter.tasks[i].taskId==videoController.taskId&&(videoController.lasttaskindex=i);videoController.currentTask=videoController.currentChapter.tasks[videoController.lasttaskindex],CAICUI.render.chapterName=videoController.currentChapter.chapterTitle,CAICUI.render.taskCount=videoController.currentChapter.tasks.length,CAICUI.render.taskCurrent=videoController.lasttaskindex,videoController.addAnimate(function(){videoController.initDom()})}else window.location.href="#/courseIndex/"+e},courseActiveState:function(e,o){CAICUI.Request.ajax({server:"coursestatus",data:{token:CAICUI.User.token,versionId:e},done:function(e){if(console.log(e),"success"==e.state){0!==e.data[0].lockStatus&&(CAICUI.render.lockStatus=!0);var r=e.data;videoController.courseByInFo(r),o&&o()}else alert("获取课程授权信息失败，请刷新页面重试。"),course.courseActiveState=999}})},courseByInFo:function(o){var r=0;if(e.isArray(o)){for(var a=Date.parse(new Date)/1e3,n=0;n<o.length;n++){if("acitve"==o[n].activeState&&o[n].expirationTime>a&&3>r){r=3;break}"init"==o[n].activeState&&2>r?r=2:"acitve"==o[n].activeState&&o[n].expirationTime<a&&1>r&&(r=1)}CAICUI.render.lockStatus&&(r=4)}videoController.courseData.courseActiveState=r,t.setsingle("course-"+videoController.courseId,videoController.courseData)},addAnimate:function(o){var r=e(window).width(),t=e(window).height();e("body").prepend('<div id="animate" style="width:'+r+'px;"></div>'),e("#animate").animate({height:t,top:"0"},300,function(){o&&o()})},removeAnimate:function(o){e("#animate").animate({height:"0",top:"50%"},300,function(){e("#animate").remove(),o&&o()})},tasksStars:function(o){var r=e(this),t=(r.index(),r.prevAll()),a=r.nextAll(),n=r.siblings();"mouseenter"==o.type?(t.addClass("active"),r.addClass("active"),a.removeClass("active")):"mouseleave"==o.type&&(n.removeClass("active"),r.removeClass("active"))},tasksStarsMouseenter:function(){var o=e(this);o.index()},tasksIsEnd:function(){},taskNext:function(){var o=videoController.lasttaskindex+1;console.log(o),videoController.lasttaskindex=o,e(".studycenter-video-task-a").eq(o).click();var r=e(".studycenter-video-task-a").length-1,t=0;e(".studycenter-video-task-a").each(function(){e(this).hasClass("video-icon-task-success")&&t++}),t==r?(e(".studycenter-video-tasks-center").addClass("active"),e(".video-icon-task-next").hide()):e(".studycenter-video-task-a").eq(o).click()},initDom:function(){console.log({courseId:videoController.courseData.courseId,chapterId:videoController.currentChapter.chapterId,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,taskIndex:videoController.lasttaskindex,taskData:videoController.currentChapter});var r=o.template(e("#video").html());e(".studycenter-video").remove(),e("body").append(r({courseId:videoController.courseData.courseId,chapterId:videoController.currentChapter.chapterId,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,taskIndex:videoController.lasttaskindex,taskData:videoController.currentChapter})),videoController.initView(),videoController.initPower(),videoController.initEvent(),videoController.realUpdateProgress(),CAICUI.Request.ajax({server:"getTasksProgress",data:{token:CAICUI.User.token,courseId:videoController.courseData.courseId},done:function(r){for(var t=0;t<videoController.currentChapter.tasks.length;t++)o.each(r.data,function(o,r){o.taskId==videoController.currentChapter.tasks[t].taskId&&"1"==o.state&&(e("#"+o.taskId).removeClass(["active"]),e("#"+o.taskId).addClass("video-icon-task-success"))})},fail:function(e){}}),videoController.saveProgress("init")},initPower:function(){var e=videoController.currentChapter.tasks[videoController.lasttaskindex];if(4==videoController.courseData.courseActiveState)return videoController.payInfoDialog=a.confirm("你购买的此课程已锁定",{icon:3,closeBtn:!1},function(e){CAICUI.NavVideo=!0,CAICUI.domRender=!0,videoController.videoClose("courseActivated")},function(){videoController.videoClose()}),!1;if("true"==videoController.currentChapter.isFree)videoController.cc_taskStatus(),videoController.showTask(e.taskType,e);else{if(3!=videoController.courseData.courseActiveState)return 2==videoController.courseData.courseActiveState?(videoController.payInfoDialog=a.confirm("你购买的该课程还没激活",{icon:3,closeBtn:!1},function(e){CAICUI.NavVideo=!0,CAICUI.domRender=!0,videoController.videoClose("courseNotActivated")},function(){videoController.videoClose()}),!1):1==videoController.courseData.courseActiveState?(videoController.payInfoDialog=a.confirm("你购买的此课程已过期",{icon:3,closeBtn:!1},function(e){CAICUI.NavVideo=!0,CAICUI.domRender=!0,videoController.videoClose("courseActivated")},function(){videoController.videoClose()}),!1):(videoController.payInfoDialog=a.confirm("你还没有购买此课程,现在购买？",{icon:3,closeBtn:!1},function(e){window.location.href="http://www.caicui.com/"},function(){videoController.videoClose()}),!1);videoController.cc_taskStatus(),videoController.showTask(e.taskType,e)}},initView:function(){e(".studycenter-video-right-content").slimScroll({height:"100%",railOpacity:.4,wheelStep:10}),e("#playCtr").css("width","100%")},videoClose:function(o){if(a.close(videoController.payInfoDialog),0==videoController.playerType);else if(2==videoController.playerType)WINAPI.SetPlayerHide(1),WINAPI.SetPlayerPause();else if(3==videoController.playerType){cc_winplayer.SetIframePlayerHide(1);var r={type:101};cc_winplayer.sendMessageToIframe(JSON.stringify(r))}e(".studycenter-video").remove(),videoController.removeAnimate(),videoController.saveProgress(),clearInterval(videoController.slideIntervalstop),clearInterval(videoController.saveVideoProgressSetinterval);var t="";t=o?o:CAICUI.iGlobal.getUrlPara("return_link"),"on"==CAICUI.iGlobal.getUrlPara("return_hash")?window.location.hash=t:window.location.href=t},initEvent:function(){e(".js-studycenter-video-task-end").on("click",videoController.tasksIsEnd),e(".studycenter-video-tasks-stars").on("click mouseenter",videoController.tasksStars),e(".video-icon-task-courselist").on("click",function(){videoController.videoClose()}),e(".video-icon-task-continue").on("click",videoController.continuetask),e(".studycenter-video-task-a").on("click",videoController.taskChange),e(".studycenter-video-task-next").on("click",videoController.taskNext),e(".js-close-sidebar").on("click",videoController.closeSidebar),e(".js-open-sidebar").on("click",videoController.openSidebar),e(".speedCtrBtn").on("click",function(){var o=e(this).attr("data-speed");WINAPI.SetPlaySpeed(o),e(".speedCtrBtn").removeClass("active"),e(this).addClass("active")}),e(".soundIos").on("click",videoController.videoSound),e("#volumeCtrly").slider({orientation:"vertical",value:"50",range:"min",animate:"fast",max:100,change:function(o,r){if(r.value>0){if(e(this).parents(".volumeCtr").prev(".soundIos").html('<i class="glyphicon glyphicon-volume-down"></i>'),0==videoController.playerType)videoController.cc_setVolume(r.value/100);else if(2==videoController.playerType)WINAPI.SetPlayerVolume(120*r.value/100);else if(3==videoController.playerType){var t={type:110,data:{volume:r.value/100}};cc_winplayer.sendMessageToIframe(JSON.stringify(t))}}else if(0==r.value)if(e(this).parents(".volumeCtr").prev(".soundIos").html('<i class="glyphicon glyphicon-volume-off"></i>'),0==videoController.playerType)videoController.cc_setVolume(0);else if(2==videoController.playerType)WINAPI.SetPlayerVolume(0);else if(3==videoController.playerType){var t={type:110,data:{volume:0}};cc_winplayer.sendMessageToIframe(JSON.stringify(t))}}}),videoController.playController(),e(".plays").on("click",function(){if(e(this).hasClass("glyphicon-pause")){if(e(this).addClass("glyphicon-play").removeClass("glyphicon-pause"),0==videoController.playerType)videoController.cc_pause();else if(2==videoController.playerType)WINAPI.SetPlayerPause();else if(3==videoController.playerType){var o={type:101};cc_winplayer.sendMessageToIframe(JSON.stringify(o))}}else if(e(this).addClass("glyphicon-pause").removeClass("glyphicon-play"),0==videoController.playerType)videoController.cc_play();else if(2==videoController.playerType)WINAPI.SetPlayerPlay();else if(3==videoController.playerType){var o={type:102};cc_winplayer.sendMessageToIframe(JSON.stringify(o))}}),e(".js-save-quiz").on("click",function(){videoController.saveNoteAndQuiz(this,"quiz")}),e(".js-save-note").on("click",function(){videoController.saveNoteAndQuiz(this,"note")}),e(".node-editor-cancel").on("click",videoController.closeSidebar),e(".node-editor-confirm").on("click",function(){var o=e("#node-editor-textarea").val();if(!o)return a.msg("Sorry~ 请输入内容！",function(){}),!1;if(videoController.courseNode.imgPath="",videoController.courseNode.imgPathArray.length)for(var r=0;r<videoController.courseNode.imgPathArray.length;r++)r?videoController.courseNode.imgPath+=","+videoController.courseNode.imgPathArray[r]:videoController.courseNode.imgPath+=videoController.courseNode.imgPathArray[r];else videoController.courseNode.imgPath="";CAICUI.Request.ajax({server:"nodesave",data:{token:CAICUI.User.token,id:"",content:o,clientType:CAICUI.render.clientType,title:videoController.currentChapter.tasks[videoController.lasttaskindex].title,isPublic:videoController.courseNode.isPublic,courseId:videoController.courseData.courseId,subjectId:videoController.courseData.subjectId,categoryId:videoController.courseData.categoryId,chapterId:videoController.currentChapter.chapterId,subjectName:videoController.courseData.subjectName,categoryName:videoController.courseData.categoryName,courseName:videoController.courseData.courseName,chapterName:videoController.currentChapter.chapterTitle,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,taskName:videoController.currentChapter.tasks[videoController.lasttaskindex].title,taskProgress:parseInt(videoController.currentChapter.tasks[videoController.lasttaskindex].progress),taskType:videoController.currentChapter.tasks[videoController.lasttaskindex].taskType,imgPath:videoController.courseNode.imgPath,clientType:"pc"},done:function(o){"success"==o.state&&(a.close(videoController.load),a.msg("保存成功！",{shade:!0,icon:1,time:500},function(){videoController.closeSidebar(),e(".right-title-input").val("")}))},fail:function(e){a.msg("Sorry~ 笔记保存失败",function(){})}})}),e(".add-photo-box").on("click",".add-photo-remove",videoController.addPhotoRemove),e("#uploadForm-file").on("change",function(){var o=new FormData(e("#uploadForm")[0]);e.ajax({url:"http://api.caicui.com/api/v2.1/commons/fileUpload",type:"POST",data:o,async:!1,cache:!1,contentType:!1,processData:!1,success:function(o){videoController.courseNode.imgPathArray.push(o.data.path);var r=e('<div class="add-photo-show"><img class="add-photo-img" src="'+CAICUI.Common.host.img+o.data.path+'"><a class="add-photo-remove" data-src="'+o.data.path+'"  href="javascript:;"><i class="icon icon-add-remove"></i></a></div>');r.find("img");e("body #uploadForm").before(r),e("body .add-photo-show").length>=5&&e("body #uploadForm").hide()},error:function(e){}})}),e(".node-editor-isOpen").on("click",".node-editor-isOpen-button",function(e){var o=CAICUI.iGlobal.getThat(e),r=o.prev();o.hasClass("active")?(o.removeClass("active"),r.text("私有"),videoController.courseNode.isPublic=1):(o.addClass("active"),r.text("公开"),videoController.courseNode.isPublic=0)}),document.onkeyup=function(e){var e=e||window.event,o=videoController.currentTask.progress;if(o){var r=0,t=0;"video"==videoController.currentTask.taskType&&(t=parseInt(videoController.currentTask.videoTime)),37==e.keyCode?(r=o-5,r?videoController.cc_seek(r):videoController.cc_seek(0)):39==e.keyCode&&(r=o+5,r>t?videoController.cc_seek(t):videoController.cc_seek(r))}}},addPhotoButton:function(){var o,r=e("#add-photo-button"),t=window.devicePixelRatio||1,a=100*t,n=100*t;o=WebUploader.create({disableGlobalDnd:!0,fileNumLimit:5,server:"http://www.caicui.com/api/v2.1/commons/fileUpload",method:"POST",formData:{token:CAICUI.User.token},pick:"#add-photo-button",duplicate:!1,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"}}),o.on("fileQueued",function(t){var i=new FormData(e("#uploadForm")[0]);e.ajax({url:"http://api.caicui.com/api/v2.1/commons/fileUpload",type:"POST",data:i,async:!1,cache:!1,contentType:!1,processData:!1,success:function(i){videoController.courseNode.imgPathArray.push(i.data.path);var l=e('<div class="add-photo-show"><img class="add-photo-img"><a class="add-photo-remove" data-id="'+t.id+'" href="javascript:;"><i class="icon icon-add-remove"></i></a></div>'),s=l.find("img");r.before(l),o.makeThumb(t,function(e,o){return e?void s.replaceWith("<span>不能预览</span>"):void s.attr("src",o)},a,n),e("body .add-photo-show").length>=5&&e("body .add-photo-button").hide()},error:function(e){}})}),o.on("uploadProgress",function(o,r){console.log(3);var t=e("#"+o.id),a=t.find(".progress span");a.length||(a=e('<p class="progress"><span></span></p>').appendTo(t).find("span")),a.css("width",100*r+"%")}),o.on("uploadSuccess",function(o){e("#"+o.id).addClass("upload-state-done")}),o.on("uploadError",function(o){var r=e("#"+o.id),t=r.find("div.error");t.length||(t=e('<div class="error"></div>').appendTo(r)),t.text("上传失败")}),o.on("uploadComplete",function(o){e("#"+o.id).find(".progress").remove()}),this.$uploader=o},addPhotoRemove:function(o){console.log(4);for(var r=CAICUI.iGlobal.getThat(o),t=(r.prev(),r.attr("data-src")),a=0;a<videoController.courseNode.imgPathArray.length;a++)if(videoController.courseNode.imgPathArray[a]==t){videoController.courseNode.imgPathArray.splice(a,1);break}var n=r.parent();n.remove(),e("body .add-photo-show").length<5&&e("body #uploadForm").show()},saveNoteAndQuiz:function(o,t){var n=e(o).parents(".contentText").find("textarea"),i=n.val(),l=e(o).parents(".contentText").find(".right-time").html();if("video"==this.taskType)if(l.indexOf(":")>0){var s=l.split(":");l=0,2==s.length?l=parseInt(s[1])+60*parseInt(s[0]):3==s.length&&(l=parseInt(s[2])+60*parseInt(s[1])+60*parseInt(s[0])*60)}else l=parseInt(l);else"exam"==this.taskType&&(l=l.replace(/第/g,""),l=l.replace(/题/g,""),l=parseInt(l));if(""==i)return a.msg("内容不能为空",function(){}),!1;if(videoController.courseNode.imgPath="",videoController.courseNode.imgPathArray.length)for(var d=0;d<videoController.courseNode.imgPathArray.length;d++)d?videoController.courseNode.imgPath+=","+videoController.courseNode.imgPathArray[d]:videoController.courseNode.imgPath+=videoController.courseNode.imgPathArray[d];else videoController.courseNode.imgPath="";var c={token:CAICUI.User.token,content:i,categoryId:videoController.courseData.categoryId,subjectId:videoController.courseData.subjectId,courseId:videoController.courseData.courseId,chapterId:videoController.currentChapter.chapterId,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,categoryName:videoController.courseData.categoryName,subjectName:videoController.courseData.subjectName,courseName:videoController.courseData.courseName,chapterName:videoController.currentChapter.chapterTitle,taskName:videoController.currentChapter.tasks[videoController.lasttaskindex].title,taskProgress:parseInt(videoController.currentChapter.tasks[videoController.lasttaskindex].progress),taskType:videoController.currentChapter.tasks[videoController.lasttaskindex].taskType,imgPath:videoController.courseNode.imgPath,clientType:"pc"};if("quiz"==t){c.title=e(o).parents(".contentText").find(".right-title-input").val(),c.task=videoController.currentChapter.tasks[videoController.lasttaskindex].title;var v="studytools/questionsave";if(""==c.title)return a.msg('"标题不能为空',function(){}),!1}else if("note"==t){c.title="笔记",c.isPublic=e(o).parents(".contentText").find('div.imgUpLoad input[type="checkbox"]').is(":checked")?0:1;var v="studytools/nodesave"}videoController.load=a.load(1,{shade:[.5,"#000"]}),r.ajax({version:"2.1",server:v,type:"POST",data:c,done:function(o){"success"==o.state&&(a.close(videoController.load),a.msg("保存成功！",{shade:!0,icon:1,time:500},function(){videoController.closeSidebar(),e(".right-title-input").val(""),n.val("")}))},fail:function(e){a.msg("Sorry~ 笔记保存失败",function(){})}}),imgPath=""},showTask:function(o,r){switch(this.currenttaskType=o,o){case"video":e(".ctrLeft1").show(),e(".video-play").show(),e(".myExercises").hide(),e(".ctrLeft2").hide(),this.doVideo();break;case"exam":e(".video-play").hide(),e(".ctrLeft1").hide(),e(".myExercises").show(),e(".ctrLeft2").show(),videoController.exercisePege();break;case"doc":break;case"vocabulary":}},doVideo:function(){if(this.player=null,nowcc_vid="",nowcc_objectID="","exe"==window.clientType){var o=1;if(parseInt(o[5])>99){videoController.playerType=2;var r=WINAPI.GetProjectPath("#")+"playcode.txt";if(WINAPI.GetFileSize(r))if(1e5<WINAPI.GetFileSize(WINAPI.GetProjectPath()+"mainfile#download#"+parseInt(o[0])+".caicui")){var t=cc_winplayer.beginPlay(WINAPI.GetProjectPath()+"mainfile#download#"+parseInt(o[0])+".caicui",1);"true"==t||1==t||(e(".video-play div.content").show(),e(".video-play div.content").html("<p style='color:#dddddd;text-align:left;margin-left:8px;'>您的授权已失效，无法播放缓存的视频文件。<br/>如有疑问，请联系客服。</p>"))}else e(".video-play div.content").show(),e(".video-play div.content").html("<p style='color:#dddddd;text-align:left;margin-left:8px;'>您缓存的视频文件已不存在，请删除重新下载。<br/>如有疑问，请联系客服。</p>");else e(".video-play div.content").show(),e(".video-play div.content").html("<p style='color:#dddddd;text-align:left;margin-left:8px;'>您下载的财萃课堂还没有获得授权，无法播放本地缓存的视频文件。<br/>通常您的账号在第一次登陆后的24小时之内自动获得授权。<br/>如有疑问，请联系客服。</p>")}else{videoController.playerType=3,e(".video-play div.content").hide();var t=cc_winplayer.beginPlay("http://www.caicui.com/studycenter2.2/scripts/html/videoframe.html?videoCcid="+videoController.currentTask.videoCcid+"&videoSiteId="+videoController.currentTask.videoSiteId,2)}}else{"http://www.caicui.com"!==window.location.origin?(videoController.currentTask.videoCcid="313A5C7994F57292",e(".video-play div.content").html('<script src="http://union.bokecc.com/player?vid=313A5C7994F57292&siteid=07552B247EACAED4&autoStart=false&width=848&height=450&playerid=55295D704B531A0D&playertype=1" type="text/javascript">')):e(".video-play div.content").html('<script  src="http://p.bokecc.com/player?vid='+videoController.currentTask.videoCcid+"&siteid="+videoController.currentTask.videoSiteId+"&autoStart=true&width=100%&height=100%&playerid=cc_"+videoController.currentTask.videoCcid+'&playertype=1" > </script>');for(var a=document.getElementsByTagName("script"),n=-1,i=0;i<a.length;i+=1){var l=a[i];-1!=l.src.indexOf("http://union.bokecc.com/player")&&-1!=l.src.indexOf("http://p.bokecc.com/player")||(-1!=n&&(a[n].src=""),n=i)}}CAICUI.render.videoCcid=videoController.currentTask.videoCcid,videoController.saveVideo()},doDoc:function(){},doVocabulary:function(){},saveVideo:function(e){"stop"==e?clearInterval(videoController.saveVideoProgressSetinterval):"finish"==e?(clearInterval(videoController.saveVideoProgressSetinterval),videoController.oldProgress!=videoController.currentTask.progress&&(videoController.currentTask.progress=videoController.currentTask.videoTime,videoController.oldProgress=videoController.currentTask.progress,videoController.saveProgress())):(videoController.oldProgress=0,videoController.saveVideoProgressSetinterval=setInterval(function(){videoController.oldProgress<videoController.currentTask.progress&&(videoController.oldProgress=videoController.currentTask.progress,videoController.saveProgress())},12e4))},saveProgress:function(e){if(videoController.currentTask.videoTime>0||videoController.currentTask.totalCount>0){var o="init";(videoController.currentTask.progress/videoController.currentTask.videoTime>.9||videoController.currentTask.progress/videoController.currentTask.totalCount>.9)&&(o="complate",videoController.currentTask.progressstate="1");var t=0;videoController.currentTask.progress&&(t=parseInt(videoController.currentTask.progress)),"init"==e&&0==t&&(t=1);var a=0;"video"==videoController.currentTask.taskType?a=parseInt(videoController.currentTask.videoTime):"exam"==videoController.currentTask.taskType&&(a=parseInt(videoController.currentTask.totalCount)),r.ajax({server:"chapter/taskProgress",type:"POST",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,progress:t,total:a,taskId:videoController.currentTask.taskId,chapterId:videoController.currentChapter.chapterId,courseId:videoController.courseData.courseId,categoryId:videoController.courseData.categoryId,taskName:videoController.currentTask.title,chapterName:videoController.currentChapter.chapterTitle,courseName:videoController.courseData.courseName,subjectName:videoController.courseData.subjectName,categoryName:videoController.courseData.categoryName,memberName:CAICUI.User.nickname,state:o},done:function(e){},fail:function(e){console.log(e)}})}},saveExam:function(e){videoController.currentTask.progress=e,videoController.saveProgress()},exercisePege:function(){function o(){e(window).width()>1200?videoController.notAllowed():e(window).width()>768&&videoController.notAllowed()}var r=e(".spans");ctrUl=e(".ctrRight"),iframeSite="http://www.caicui.com"+videoController.currentTask.examUrl,exerciseId=videoController.currentTask.taskId,spanLength=videoController.currentTask.totalCount;var t=0;t=videoController.currentTask.progress,t=t>spanLength?spanLength:t,console.log("完成题数"+t+"/总题数"+spanLength),e("#exercisText").attr("src",iframeSite),r.children().remove();for(var a=0;a<spanLength;a++){var n=e("<span>");n.html(a+1),r.append(n)}r.css("width",40*spanLength),t>0?(r.children("span").eq(t-1).addClass("active").prevAll().addClass("over"),r.children("span").eq(t-1).nextAll().removeClass("active")):void 0!=t&&""!=t&&null!=t||r.children("span").first().addClass("active"),o(),e(window).resize(function(){e(".myExercises").is(":visible")&&o()}),e(".myExercises").is(":visible")?(e('.ctrOption[control="handout"]').hide(),e(".ctrRight").css("width","133px")):e('.ctrOption[control="handout"]').show();var i=document.getElementById("exercisText");i&&i.attachEvent?i.attachEvent("onload",function(){videoController.listIndex()}):i&&(i.onload=function(){videoController.listIndex()}),videoController.ExerciseController()},listIndex:function(){var o=e(".spans span.active").index(),r={type:201,data:{number:o}},t=document.getElementById("exercisText");t.contentWindow.postMessage(JSON.stringify(r),"http://www.caicui.com")},saveTest:function(){videoController.saveProgress(),e("#"+videoController.currentTask.taskId).addClass("video-icon-task-success");var o={type:202},r=document.getElementById("exercisText");r.contentWindow.postMessage(JSON.stringify(o),"http://www.caicui.com")},correctNum:function(){},notAllowed:function(){0==e(".spans span.active").index()?(e(".prevs").addClass("disableBut").removeClass("readyBut"),e(".prev").addClass("disableBut").removeClass("readyBut"),e(".nexts").addClass("readyBut").removeClass("disableBut"),e(".nexts").css({display:"inline-block"}),e(".next").addClass("readyBut").removeClass("saveTest disableBut").html('下一题<i class="glyphicon glyphicon-chevron-right"></i>')):e(".spans span.active").index()==e(".spans span").length-1?(e(".nexts").addClass("disableBut").removeClass("readyBut"),e(".nexts").css({display:"none"}),e(".next").addClass("saveTest").removeClass("readyBut").html("交卷"),e(".prevs").addClass("readyBut").removeClass("disableBut"),e(".prev").addClass("readyBut").removeClass("disableBut")):0!=e(".spans span.active").index()&&e(".spans span.active").index()!=e(".spans span").length-1&&(e(".prevs").addClass("readyBut").removeClass("disableBut"),e(".prev").addClass("readyBut").removeClass("disableBut"),e(".nexts").addClass("readyBut").removeClass("disableBut"),e(".nexts").css({display:"inline-block"}),e(".next").removeClass("saveTest disableBut").addClass("readyBut").html('下一题<i class="glyphicon glyphicon-chevron-right"></i>')),1==e(".spans span").length&&(e(".prevs").addClass("disableBut").removeClass("readyBut"),e(".prev").addClass("disableBut").removeClass("readyBut"),e(".nexts").addClass("disableBut").removeClass("readyBut"),e(".nexts").css({display:"none"}),e(".next").removeClass("saveTest").addClass("disableBut").html('下一题<i class="glyphicon glyphicon-chevron-right"></i>'))},ExerciseController:function(){function o(){var o=e(".spans span").length,r=e(".spans span").eq(0).outerWidth(!0),t=e(".spanIocn").width(),a=e(".spans span.active");r*o>t?0!=a.prev().length&&(e(".spans").animate({left:"+=37px"},"fast"),a.prev().addClass("active").siblings().removeClass("active")):0!=a.prev().length&&(a.removeClass("active"),a.prev().addClass("active"))}function r(){var o=e(".spans span").length,r=e(".spans span").eq(0).outerWidth(!0),t=e(".spanIocn").width(),a=e(".spans span.active");r*o>t?0!=a.next().length&&(e(".spans").animate({left:"-=37px"},"fast"),a.next().addClass("active").siblings().removeClass("active")):0!=a.next().length&&(a.removeClass("active"),a.next().addClass("active"))}function t(){return e(".spans .active").index()+1}function a(){var o=e(".spans").children(".active").index(),r=e(".spanIocn").width(),t=e(".spans span").eq(0).outerWidth(!0);e(".spans").width()>r?e(".spans").css("left",-(o*t)):e(".spans").css("left","")}function n(){e(".prevs").on("click",function(){"saveTest"==i?i="test":o(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(t())}),e(".nexts").on("click",function(){r(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(t())}),e(".ctrIocn .prev").click(function(){o(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(t())}),e(".ctrIocn .next").click(function(){e(this).hasClass("saveTest")?(i="saveTest",videoController.saveTest()):(r(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(t()))}),e(document).on("keyup",function(e){39==e.keyCode&&(r(),videoController.notAllowed(),videoController.listIndex()),37==e.keyCode&&(o(),videoController.notAllowed(),videoController.listIndex())})}var i="test";e(".spans").on("click","span",function(){e(this).addClass("active").siblings().removeClass("active"),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(t())}),a(),e(window).resize(function(){a()}),n(),videoController.notAllowed(),e(".analysis").click(function(){var o=e(".spans span.active").index(),r={type:203,data:{number:o}},t=document.getElementById("exercisText");t.contentWindow.postMessage(JSON.stringify(r),"http://www.caicui.com")})},taskChange:function(){if(videoController.cc_taskStatus(),0==videoController.playerType);else if(2==videoController.playerType)WINAPI.SetPlayerHide(1),WINAPI.SetPlayerPause();else if(3==videoController.playerType){cc_winplayer.SetIframePlayerHide(1);var o={type:101};cc_winplayer.sendMessageToIframe(JSON.stringify(o))}var r=e(this);if(r.hasClass("active"))return!1;if(r.siblings().removeClass("active"),e("studycenter-video-task-next").removeClass("box-visibility"),
r.addClass("active"),e(".studycenter-video-tasks-center").addClass("hidden"),console.log(e(r).attr("data-index")),parseInt(e(r).attr("data-index"))==videoController.currentChapter.tasks.length){e(".studycenter-video-task-end").addClass("active"),e(".studycenter-video-task-next").addClass("box-visibility"),e(".studycenter-video-tasks-center").removeClass("hidden"),e(".studycenter-video-tasks-unfinished").addClass("hidden"),e(".studycenter-video-tasks-finished").addClass("hidden"),console.log("videoController.currentChapter:"),console.log(videoController.currentChapter);for(var t=!0,a=0;a<videoController.currentChapter.tasks.length;a++)"0"==videoController.currentChapter.tasks[a].progressstate&&(t=!1);t?e(".studycenter-video-tasks-finished").removeClass("hidden"):e(".studycenter-video-tasks-unfinished").removeClass("hidden"),e(".studycenter-video-main").remove()}else videoController.lasttaskindex=parseInt(e(r).attr("data-index")),videoController.currentTask=videoController.currentChapter.tasks[videoController.lasttaskindex],videoController.initDom()},continuetask:function(){e(".studycenter-video-task-a").eq(videoController.lasttaskindex).click()},closeSidebar:function(){var o=e(".studycenter-video-right");o.siblings().addClass("hidden"),videoController.cc_play(),videoController.animateSidebar(0,500),2!=videoController.playerType&&3!=videoController.playerType||cc_winplayer.ChangePlayerWH()},openSidebar:function(){var o=e(this).index(),r=e(".studycenter-video-right").eq(o);if(videoController.cc_pause(),r.hasClass("hidden"))switch(r.siblings().addClass("hidden"),r.removeClass("hidden"),videoController.animateSidebar(400,500),CAICUI.render.taskId=videoController.currentTask.taskId,CAICUI.render.progerss=videoController.currentTask.progress,e(".right-time").html(videoController.formatSeconds(videoController.currentTask.progress)),o){case 0:videoController.showQuestions();break;case 1:videoController.showNode();break;case 2:videoController.showHandout();break;case 3:2==videoController.playerType?e(".speedCtr").show():e(".speedCtr").hide()}else videoController.animateSidebar(0,500),r.addClass("hidden");2!=videoController.playerType&&3!=videoController.playerType||cc_winplayer.ChangePlayerWH()},animateSidebar:function(o,r){e(".studycenter-video-main").css({"padding-right":o}),e(".studycenter-video-main-right").css({right:-(400-o)})},showQuestions:function(){videoController.imgUpLoad("quiz"),e("#ac-new-video").attr("src","script/libs/xneditor/ac-new-video.html")},showNode:function(){e("body .node-editor-textarea").val(""),e("body .add-photo-show").remove(),videoController.imgUpLoad()},showHandout:function(){videoController.handout()},imgUpLoad:function(o){if(e("#imgUpLoadNote").html(""),e("#imgUpLoadQuiz").html(""),"quiz"==o);else;e(".add_upload .uploadImg").text("+")},handout:function(){e("#scanImg").html(""),""==videoController.currentTask.attachmentPath?(e("#scanImg").next().html("当前视频暂无讲义下载"),e(".downloadList").html("")):(e("#scanImg").html('<img src="'+CAICUI.Common.host.IPLocation+"commons/qrCode?v="+CAICUI.Common.host.img+videoController.currentTask.attachmentPath+'" />'),e(".downloadList").html('<li><a href="'+CAICUI.Common.host.img+videoController.currentTask.attachmentPath+'" target="_blank"><span></span>'+videoController.currentTask.title+"</a></li>"))},videoSound:function(){var o=e(this).next(".volumeCtr");o.is(":hidden")?(o.show(),e(this).addClass("active"),setTimeout(function(){e(".volumeCtr").hide()},5e3)):(o.hide(),e(this).removeClass("active"))},playController:function(){e("#playCtr").slider({range:"min",animate:"fast",max:100,start:function(e,o){console.log("ctrl get start"),userOP=!0},stop:function(e,o){var r=videoController.currentTask.videoTime,t=r*(o.value/100);if(userOPTime=t,0==videoController.playerType)videoController.cc_seek(t);else if(2==videoController.playerType)WINAPI.log("设置视频指定播放时间："+t),WINAPI.SetPlayerBegin(t),on_player_seek(0,t);else if(3==videoController.playerType){WINAPI.log("设置视频指定播放时间："+t);var a={type:100,data:{time:t}};cc_winplayer.sendMessageToIframe(JSON.stringify(a))}console.log("ctrl get stop:"+t)}})},cc_player_init:function(o,r){e("head div[id^=cc_video_]").remove();var t=this.cc_getSWF(r);try{o==videoController.currentTask.videoCcid&&(t.length>1?videoController.player=t[t.length-1]:videoController.player=t,videoController.playerType=0,videoController.player.setConfig(videoController.ccSetConfig),videoController.cc_play(),videoController.currentTask.videoTime=videoController.player.getDuration())}catch(a){console.log("can't get player obj")}},cc_getSWF:function(e){return window.document[e]?window.document[e]:-1!=navigator.appName.indexOf("Microsoft")?document.getElementById(e):document.embeds&&document.embeds[e]?document.embeds[e]:void 0},cc_play:function(){videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.start()},cc_pause:function(){videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.pause()},cc_setVolume:function(e){videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.setVolume(e)},cc_seek:function(e){videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.seek(e)},exe_player_init:function(){videoController.playerType=2,videoController.currentTask.videoTime=WINAPI.PlayerDuration(),WINAPI.log("视频总时长："+videoController.currentTask.videoTime),videoController.currentTask.progress>20&&WINAPI.SetPlayerBegin(videoController.currentTask.progress)},cciframe_player_init:function(){if(videoController.playerType=3,videoController.currentTask.videoTime=window.videototaltime,WINAPI.log("视频总时长："+videoController.currentTask.videoTime),videoController.currentTask.progress>20){var e={type:100,data:{time:videoController.currentTask.progress}};cc_winplayer.sendMessageToIframe(JSON.stringify(e))}},cc_taskStatus:function(){videoController.slideIntervalstop&&clearInterval(videoController.slideIntervalstop);var o=this,r=1e3;videoController.slideIntervalstop=setInterval(function(){if(userOPTime!=userOPCCCallBackTime||userOP)return console.log("slideIntervalstop:"+userOPTime+"|"+userOPCCCallBackTime),void(r=5e3);switch(r=1e3,videoController.currentTask.taskType){case"video":if("finish"==e(".video-play div.dummy").html()&&0==videoController.playerType&&(videoController.cc_player_init(nowcc_vid,nowcc_objectID),e(".video-play div.dummy").html("play")),"finish"==e(".video-play div.dummy").html()&&3==videoController.playerType&&(videoController.cciframe_player_init(),e(".video-play div.dummy").html("play")),"exe"==window.clientType&&"load"==e(".video-play div.dummy").html()&&2==videoController.playerType){var t=WINAPI.GetPlayTime();t>1&&(videoController.exe_player_init(),e(".video-play div.dummy").html("play"))}if("stop"==e(".video-play div.dummy").html()&&(videoController.saveVideo("finish"),e("#"+videoController.currentTask.taskId).removeClass(["active"]),e("#"+videoController.currentTask.taskId).addClass("video-icon-task-success"),clearInterval(videoController.videoSetinterval)),0==videoController.playerType&&null==videoController.player&&""!=videoController.currentTask.videoCcid&&""!=videoController.currentTask.videoSiteId){o.initvideo(videoController.currentTask.videoCcid,videoController.currentTask.videoSiteId);break}var a=0,n=100;0==videoController.playerType?(a=videoController.player.getPosition(),n=videoController.player.getDuration()):2==videoController.playerType?(a=WINAPI.GetPlayTime(),n=WINAPI.PlayerDuration()):3==videoController.playerType&&(a=window.videocurrentime,n=window.videototaltime),"number"==typeof a&&"number"==typeof n?videoController.currentTask.progress=a:(console.log("获取视频时间异常ct:"+a),console.log("获取视频时间异常tt:"+n)),o.cc_slide();break;case"exam":}},r)},initvideo:function(o,r){e("head div[id^=cc_video_]").remove(),videoController.player=document.getElementById("cc_"+o),videoController.player&&(videoController.player.controls=!1,videoController.playerType=0)},cc_slide:function(){var o=videoController.currentTask.progress,r=videoController.currentTask.videoTime,t=parseInt(o/r*100),a=e("#playCtr").slider("option","value");a-t>0&&5>a-t?console.log("playerCTLValue:"+a+"|"+t):e("#playCtr").slider("value",t),e("div.ControlBar span.beforeTime").html(this.formatSeconds(o)),e("div.ControlBar span.afterTime").html(this.formatSeconds(r))},automaticSwitch:function(){var o=this,r=e("li[data-id='"+o.taskTypeId+"']").attr("taskTotal"),t=e("li[data-id='"+o.taskTypeId+"']").attr("taskNum");if(t==r)var n="下章节任务",i=e("span.nextChapter");else var n="下一任务",i=e("li[data-id='"+o.taskTypeId+"']").next();a.confirm('当前任务结束,<span class="layerConfirm">5秒后自动进入下一个任务</span>',{title:["信息","background: #ffffff"],btn:["重学本任务",n],closeBtn:1,time:5e3},function(e){a.close(e)},function(e){a.close(e)});e(".layui-layer-btn0").on("click",function(){console.log(1),e("li[data-id='"+o.taskTypeId+"']").trigger("click")}),e(".layui-layer-btn1").on("click",function(){console.log(2),i.trigger("click")}),e(".layui-layer-setwin .layui-layer-close1").html('<div style="color:#b9b9b9;font-size:18px; line-height: 15px;">X</div>'),e(".layerConfirm").css("color","#00a085"),e(".layui-layer-btn").css("background","#fafafa"),e(".layui-layer-btn0").css({background:"#ffffff",color:"#515151",border:"1px #d8d8d8 ridge","line-height":"27px"}),e(".layui-layer-btn1").css({background:"#169f81",color:"#ffffff","line-height":"29px"}),e(".layui-layer-btn a").css({"-moz-border-radius":"3px","-webkit-border-radius":"3px","border-radius":"3px","font-weight":"normal"})},formatSeconds:function(e){var o=parseInt(e),r=0,t=0;o>60&&(r=parseInt(o/60),o=parseInt(o%60),r>60&&(t=parseInt(r/60),r=parseInt(r%60)));var a="";return a=o>9?parseInt(o):o>0?"0"+parseInt(o):"00",t>0&&(r+=60*t),a=r>9?parseInt(r)+":"+a:r>0?"0"+parseInt(r)+":"+a:"00:"+a},realUpdateProgress:function(){var e=t.get("courseProgress-"+videoController.courseId);e?videoController.intervalTasksProgress():videoController.getTasksProgress(function(){videoController.intervalTasksProgress()})},getTasksProgress:function(e){CAICUI.Request.ajax({server:"getTasksProgress",data:{token:CAICUI.User.token,courseId:videoController.courseId},done:function(r){CAICUI.CACHE.getTasksProgress=r.data,CAICUI.Request.ajax({server:"courseDetail",data:{courseId:videoController.courseId},done:function(r){var a=CAICUI.CACHE.getTasksProgress,n=r.data[0];o.each(n.chapters,function(e,r){e.children&&o.each(e.children,function(e,t){e.tasks&&o.each(e.tasks,function(e,i){o.each(a,function(o,a){e.taskId==o.taskId&&(n.chapters[r].children[t].tasks[i].progress=o.progress,n.chapters[r].children[t].tasks[i].total=o.total)})})})}),t.setsingle("courseProgress-"+videoController.courseId,n),e&&e()}})},fail:function(e){CAICUI.CACHE.getTasksProgress={}}})},intervalTasksProgress:function(){CAICUI.render.intervalTasksProgress=setInterval(function(){var e=t.get("courseProgress-"+videoController.courseId),r=parseInt(videoController.currentTask.progress),a=0;if("video"==videoController.currentTask.taskType?a=parseInt(videoController.currentTask.videoTime):"exam"==videoController.currentTask.taskType&&(a=parseInt(videoController.currentTask.totalCount)),r&&a){var n=e;o.each(n.chapters,function(e,t){e.children?o.each(e.children,function(e,i){e.children?o.each(e.children,function(e,l){e.tasks&&o.each(e.tasks,function(e,o){if(e.taskId==videoController.currentTask.taskId){var s=n.chapters[t].children[i].children[l].tasks[o].progress;(!s||r>s)&&(n.chapters[t].children[i].children[l].tasks[o].progress=r),n.chapters[t].children[i].children[l].tasks[o].total=a}})}):e.tasks&&o.each(e.tasks,function(e,o){if(e.taskId==videoController.currentTask.taskId){var l=n.chapters[t].children[i].tasks[o].progress;(!l||r>l)&&(n.chapters[t].children[i].tasks[o].progress=r),n.chapters[t].children[i].tasks[o].total=a}})}):e.tasks&&o.each(e.tasks,function(e,o){if(e.taskId==videoController.currentTask.taskId){var i=n.chapters[t].tasks[o].progress;(!i||r>i)&&(n.chapters[t].tasks[o].progress=r),n.chapters[t].tasks[o].total=a}})}),t.setsingle("courseProgress-"+videoController.courseId,n)}},3e3)}},{init:videoController.init}});var nowcc_vid="",nowcc_objectID="";userOP=!1,userOPTime=0,userOPCCCallBackTime=0,imgPath="",window.addEventListener("message",function(e){var o=e.data;WINAPI.log("获得iframe发送的消息:"+o);var r=JSON.parse(o);switch(r.type){case 1:window.videototaltime=r.data.totaltime,on_cc_player_init(r.data.vid,r.data.objectID),WINAPI.log("获得iframe发送的消息视频初始化完成:"+r.data.totaltime);break;case 5:var t=r.data.from,a=r.data.to;on_player_seek(t,a),WINAPI.log("获得iframe发送的消息 定点播放完成");break;case 10:window.videocurrentime=r.data.second;break;case 20:$("span.active").addClass("over");break;case 21:$("span.active").removeClass("over")}},!1);