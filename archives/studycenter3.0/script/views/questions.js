define(["jquery","underscore","backbone"],function(e,t,r){"use strict";var n=r.View.extend({el:"body",template:t.template(e("#template-questions").html()),events:{"click .questions-card-button":"toggleCards","click .js-card-btn":"cardBtn","click .js-questions-btn-prev":"questionsPrev","click .js-questions-btn-next":"questionsNext","click .questions-btn-analysis":"analysis","click .js-questions-option-click":"questionsOptionClick","keyup .js-questions-option-keyup":"questionsOptionKeyup","click .questions-exit":"exit"},render:function(){CAICUI.render.answerArr=["A","B","C","D","E","F","G","H"],CAICUI.render["this"]=this,CAICUI.render.typeHtml="",CAICUI.render.questionsType="",CAICUI.render.pushContext="",CAICUI.render.isDone="false",CAICUI.render.exerciseId="",CAICUI.render.questionsDataCache="",CAICUI.render.questionsDataCacheArray="",CAICUI.render.exerciseFilenameArray=[],CAICUI.render.isMyChecked="",CAICUI.render.cardOpen=!1,CAICUI.render.exerciseDoneCount="",CAICUI.render.exerciseNoDoneCount="",CAICUI.render.exerciseRightCount="",CAICUI.render["this"].$el.append(CAICUI.render["this"].template()),CAICUI.render["this"].clockTime(),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body .questions #wrapper"),this.exerciseFilenameAjax(function(r){var n=e("#template-questions-cards").html(),s=CAICUI.iGlobal.getTemplate(n,{data:CAICUI.render.exerciseFilenameArray});e("body .questions-header").append(s),CAICUI.render["this"].userKnowledgePointExerciseListAjax(function(r){CAICUI.render.questionsDataCacheArray=r,CAICUI.render.exerciseDoneCount=r.length,CAICUI.render.exerciseNoDoneCount=CAICUI.render.exerciseCount-CAICUI.render.exerciseDoneCount,CAICUI.render.exerciseRightCount=CAICUI.render.exerciseDoneCount-CAICUI.render.errorNum;var n=(CAICUI.render.exerciseRightCount/CAICUI.render.exerciseCount*100).toFixed(0),s=(CAICUI.render.exerciseDoneCount/CAICUI.render.exerciseCount*100).toFixed(0);e("body .questions-progress-show").attr("data-course-progress",s),e("body .questions-percentage").html(s),e("body .questions-progress-show").animate({width:s+"%"},1e3),e(".exercise-done-count").text(CAICUI.render.exerciseDoneCount),e(".exercise-nodone-count").text(CAICUI.render.exerciseNoDoneCount),e(".progress-round-count").text(n),e("#progress-round-question").attr("data-progress",n),CAICUI.iGlobal.canvasRound("progress-round-question",{borderColor:"#00A184",borderWidth:3,bg:!0,bgBorderColor:"#bgBorderWidth"}),t.each(r,function(t,r){console.log(t.status);var n="questions-cards-info";"0"==t.status?n="questions-cards-info":"1"==t.status?n="questions-cards-success":"2"==t.status&&(n="questions-cards-danger"),e("#questions-card-"+t.exercise_id).addClass(n),e("#questions-card-"+t.exercise_id).attr("data-isdone","true")}),CAICUI.render.lastExerciseNid&&(CAICUI.render.questionsIndex=CAICUI.render.lastExerciseNid),CAICUI.render.exerciseId=e(".js-card-btn").eq(CAICUI.render.questionsIndex).attr("data-exerciseid"),CAICUI.render.isDone=e("#questions-card-"+CAICUI.render.exerciseId).attr("data-isdone"),CAICUI.render["this"].getNidExerciseDetailAjax(function(){})})})},exerciseFilenameAjax:function(e){CAICUI.render.exercise_filename="questions-id.html",this.getExerciseId(CAICUI.render.exercise_filename,function(t){CAICUI.render.exerciseFilenameArray=t,e&&e()})},userKnowledgePointExerciseListAjax:function(e){CAICUI.Request.ajax({hostName:"http://192.168.10.134:8080",server:"userKnowledgePointExerciseList",data:{knowledge_point_id:CAICUI.render.knowledgepointid,member_id:CAICUI.User.memberId},done:function(t){e&&e(t.data)}})},getNidExerciseDetailAjax:function(e){CAICUI.Request.ajax({hostName:"http://192.168.10.112:8083",server:"getNidExerciseDetail",data:{exerciseId:CAICUI.render.exerciseId},done:function(t){CAICUI.render["this"].addDOMNidExerciseDetail(t.data[0]),e&&e(t.data)}})},addDOMNidExerciseDetail:function(t){var r=t,n=e("#template-questions-content").html(),s=CAICUI.iGlobal.getTemplate(n,{item:r});e("body .questions .scroller").html(s),window.CAICUI.myScroll.refresh(),window.CAICUI.myScroll.scrollTo(0,0),CAICUI.render["this"].$el.find("img").each(function(t){var r=e(this).attr("src");e(this).attr("src","http://192.168.10.112:8081"+r)})},setMemberExerciseLogAjax:function(e){this.questionsStatus(),CAICUI.render.isMyChecked?(CAICUI.render.isMyChecked="",CAICUI.Request.ajax({hostName:"http://192.168.10.112:8083",server:"setMemberExerciseLog",data:{knowledgePointId:CAICUI.render.knowledgepointid,exerciseId:CAICUI.render.exerciseId,memberId:CAICUI.User.memberId,context:JSON.stringify(CAICUI.render.pushContext),status:CAICUI.render.status,subjectId:CAICUI.render.subjectId,categoryId:CAICUI.render.categoryId,courseId:CAICUI.render.courseId,chapterId:CAICUI.render.chapterId,cacheKnowledgeLevel1Id:CAICUI.render.cacheKnowledgeLevel1Id,cacheKnowledgeLevel2Id:CAICUI.render.cacheKnowledgeLevel2Id,cacheKnowledgePath:CAICUI.render.cacheKnowledgePath,progress:CAICUI.render.ExerciseProgress,lastExerciseNid:CAICUI.render.lastExerciseNid,errorNum:CAICUI.render.errorNum,totalTime:CAICUI.render.ExerciseTotalTime},done:function(t){CAICUI.render["this"].doneChange(),e&&e(t)}})):(CAICUI.render.status=0,e&&e())},doneChange:function(){var t=e("body .js-card-btn").eq(CAICUI.render.questionsIndex).attr("data-isdone");"true"!=t&&(CAICUI.render.exerciseDoneCount=+CAICUI.render.exerciseDoneCount+1,CAICUI.render.exerciseNoDoneCount=+CAICUI.render.exerciseNoDoneCount-1),1==CAICUI.render.status||2==CAICUI.render.status&&(CAICUI.render.errorNum=+CAICUI.render.errorNum+1),e(".exercise-done-count").text(CAICUI.render.exerciseDoneCount),e(".exercise-nodone-count").text(CAICUI.render.exerciseNoDoneCount),CAICUI.render.exerciseRightCount=CAICUI.render.exerciseDoneCount-CAICUI.render.errorNum;var r=(CAICUI.render.exerciseRightCount/CAICUI.render.exerciseCount*100).toFixed(0),n=(CAICUI.render.exerciseDoneCount/CAICUI.render.exerciseCount*100).toFixed(0);e("body .questions-progress-show").attr("data-course-progress",n),e("body .questions-percentage").html(n),e("body .questions-progress-show").animate({width:n+"%"},1e3),e(".progress-round-count").text(r),e("#progress-round-question").attr("data-progress",r),CAICUI.iGlobal.canvasRound("progress-round-question",{borderColor:"#00A184",borderWidth:3,bg:!0,bgBorderColor:"#bgBorderWidth"}),e("body .js-card-btn").eq(CAICUI.render.questionsIndex).attr("data-isdone","true")},cardBtn:function(t){var r=CAICUI.iGlobal.getThat(t),n=(r.find("button"),r.attr("data-index"));this.setMemberExerciseLogAjax(function(t){1==CAICUI.render.status?e("#questions-card-"+CAICUI.render.exerciseId).removeClass("questions-cards-danger").addClass("questions-cards-success"):2==CAICUI.render.status&&e("#questions-card-"+CAICUI.render.exerciseId).removeClass("questions-cards-success").addClass("questions-cards-danger"),console.log(CAICUI.render.questionsIndex),CAICUI.render.exerciseId=r.attr("data-exerciseid"),CAICUI.render.lastExerciseNid=n,CAICUI.render.ExerciseProgress&&CAICUI.render.ExerciseProgress<n&&(CAICUI.render.ExerciseProgress=n),CAICUI.render.questionsIndex=n,CAICUI.render.isDone=r.attr("data-isdone"),CAICUI.render["this"].getNidExerciseDetailAjax(function(){CAICUI.render.cardOpen&&(e("body .questions-card-button").trigger("click"),CAICUI.render.cardOpen=!1)}),"true"==CAICUI.render.isDone})},questionsPrev:function(t){if(CAICUI.render.questionsIndex>0){var r=+CAICUI.render.questionsIndex-1;e("body .js-card-btn").eq(r).trigger("click")}},questionsNext:function(t){if(CAICUI.render.questionsIndex<CAICUI.render.exerciseCount-1){var r=+CAICUI.render.questionsIndex+1;e("body .js-card-btn").eq(r).trigger("click")}},getQuestionsDataCacheIndex:function(e){console.log(CAICUI.render.exerciseId),t.each(CAICUI.render.questionsDataCacheArray,function(e,t){return e.exercise_id===CAICUI.render.exerciseId?void(CAICUI.render.questionsDataCache=e):void 0})},questions:function(e,r,n){return CAICUI.render.typeHtml="",CAICUI.render.questionsType=e,"true"==CAICUI.render.isDone?(this.getQuestionsDataCacheIndex(),CAICUI.render.pushContext=JSON.parse(CAICUI.render.questionsDataCache.context)):CAICUI.render.pushContext=JSON.parse(r),"multiTask"===e?t.each(CAICUI.render.pushContext,function(e,t){CAICUI.render.typeHtml+='<div class="questions-options-box"><div class="questions-options-title">'+e.title+"</div>",CAICUI.render["this"].questionsTypes(e.type,e.data,t),CAICUI.render.typeHtml+="</div>"}):(CAICUI.render.typeHtml+='<div class="questions-options-box">',CAICUI.render["this"].questionsTypes(e,CAICUI.render.pushContext,0),CAICUI.render.typeHtml+="</div>"),CAICUI.render.typeHtml},questionsTypes:function(e,t,r){switch(e){case"checkbox":CAICUI.render["this"].checkbox(t,r);break;case"radio":CAICUI.render["this"].radio(t,r);break;case"question":CAICUI.render["this"].question(t,r);break;case"blank":CAICUI.render["this"].blank(t,r);break;case"matrixRadio":CAICUI.render["this"].matrix("radio",t,r);break;case"matrixCheckbox":CAICUI.render["this"].matrix("checkbox",t,r);break;case"matrixBlank":CAICUI.render["this"].matrix("blank",t,r)}},checkbox:function(e,r){t.each(e,function(e,t){var n="";e.myChecked&&(n="active"),CAICUI.render.typeHtml+='<div data-number="'+r+"-"+t+'" class="questions-hover questions-checkbox js-questions-option-click '+n+'"  data-mychecked='+e.myChecked+" data-ischecked="+e.isChecked+'><label><input class="questions-checkbox-input" type="checkbox"><div>'+e.title+"</div></label></div>"})},radio:function(e,r){t.each(e,function(e,t){var n="";e.myChecked&&(n="active"),CAICUI.render.typeHtml+='<div data-number="'+r+"-"+t+'" class="questions-hover questions-radio js-questions-option-click '+n+'" data-mychecked='+e.myChecked+" data-ischecked="+e.isChecked+'><label><input class="questions-radio-input" type="radio"><div>'+e.title+"</div></label></div>"})},question:function(e,t){CAICUI.render.typeHtml+='<div data-number="'+t+'-0" class="questions-question js-questions-option-keyup"><textarea>'+e[0].myBlank+"</textarea></div>"},blank:function(e,t){CAICUI.render.typeHtml+='<div data-number="'+t+'-0" class="questions-blank js-questions-option-keyup"><input type="input" val='+e[0].myBlank+"></div>"},matrix:function(e,t,r){var n=t[0],s=(n.items.length,n.cols),i=n.rows;CAICUI.render.typeHtml+='<table class="questions-table questions-matrix questions-matrix-'+e+'"><tbody class="questions-tbody">';for(var a=0;i>a;a++){CAICUI.render.typeHtml+='<tr class="questions-tr">';for(var o=[],C=1;s>C;C++)o.push(C+a*s);for(var d=0;s>d;d++){var I=d+a*s,c=n.items[I];if(c.title&&I)CAICUI.render.typeHtml+='<td class="questions-td">'+c.title+"</td>";else if(I){switch(e){case"radio":CAICUI.render.typeHtml+="<td data-rowsArray="+o+' data-number="'+r+"-"+I+'" class="questions-td js-questions-option-click questions-radio" data-ischecked='+c.isChecked+">",CAICUI.render.typeHtml+='<input class="questions-radio-input" type="radio">';break;case"checkbox":CAICUI.render.typeHtml+='<td data-number="'+r+"-"+I+'" class="questions-td js-questions-option-click questions-checkbox" data-ischecked='+c.isChecked+">",CAICUI.render.typeHtml+='<input class="questions-checkbox-input" type="checkbox">';break;case"blank":CAICUI.render.typeHtml+='<td data-number="'+r+"-"+I+'" class="questions-td js-questions-option-keyup">',CAICUI.render.typeHtml+='<input type="text">'}CAICUI.render.typeHtml+="</td>"}else CAICUI.render.typeHtml+='<td class="questions-td"></td>'}CAICUI.render.typeHtml+="</tr>"}CAICUI.render.typeHtml+="</tbody></table>"},questionsOptionClick:function(e){e.preventDefault();var t=CAICUI.iGlobal.getThat(e),r=t.attr("data-mychecked"),n=t.attr("data-number"),s=n.split("-");"true"==r?(t.removeClass("active"),r=!1,t.attr("data-mychecked",r)):(t.hasClass("questions-radio")&&(t.siblings().attr("data-mychecked","false"),t.siblings().removeClass("active")),t.addClass("active"),r=!0,t.attr("data-mychecked",r)),"multiTask"==CAICUI.render.questionsType?this.changeMultiTaskQuestionsDataClick(CAICUI.render.pushContext[s[0]].type,s,r,t):this.changeQuestionsDataClick(CAICUI.render.questionsType,s,r,t)},changeQuestionsDataClick:function(e,r,n,s){switch(e){case"radio":t.each(CAICUI.render.pushContext,function(e,t){e.myChecked=!1}),CAICUI.render.pushContext[r[1]].myChecked=n;break;case"checkbox":CAICUI.render.pushContext[r[1]].myChecked=n;break;case"matrixRadio":var i=s.attr("data-rowsarray").split(",");t.each(i,function(e,t){CAICUI.render.pushContext[0].items[e].myChecked=!1}),CAICUI.render.pushContext[0].items[r[1]].myChecked=n;break;case"matrixCheckbox":CAICUI.render.pushContext[0].items[r[1]].myChecked=n}console.log(CAICUI.render.pushContext)},changeMultiTaskQuestionsDataClick:function(e,r,n,s){switch(e){case"radio":t.each(CAICUI.render.pushContext[r[0]].data,function(e,t){e.myChecked=!1}),CAICUI.render.pushContext[r[0]].data[r[1]].myChecked=n;break;case"checkbox":CAICUI.render.pushContext[r[0]].data[r[1]].myChecked=n;break;case"matrixRadio":var i=s.attr("data-rowsarray").split(",");t.each(i,function(e,t){CAICUI.render.pushContext[r[0]].data[0].items[e].myChecked=!1}),CAICUI.render.pushContext[r[0]].data[0].items[r[1]].myChecked=n;break;case"matrixCheckbox":CAICUI.render.pushContext[r[0]].data[0].items[r[1]].myChecked=n}console.log(CAICUI.render.pushContext)},questionsOptionKeyup:function(e){e.preventDefault();var t=CAICUI.iGlobal.getThat(e),r=t.attr("data-number"),n=r.split("-"),s=t.children().val();"multiTask"==CAICUI.render.questionsType?this.changeMultiTaskQuestionsDataKeyup(CAICUI.render.pushContext[n[0]].type,n,s,t):this.changeQuestionsDataKeyup(CAICUI.render.questionsType,n,s,t)},changeQuestionsDataKeyup:function(e,t,r,n){switch(e){case"blank":CAICUI.render.pushContext[t[1]].myBlank=r;break;case"question":CAICUI.render.pushContext[t[1]].myBlank=r;break;case"matrixQuestion":CAICUI.render.pushContext[0].items[t[1]].myBlank=r;break;case"matrixBlank":CAICUI.render.pushContext[0].items[t[1]].myBlank=r}console.log(CAICUI.render.pushContext)},changeMultiTaskQuestionsDataKeyup:function(e,t,r,n){switch(e){case"blank":CAICUI.render.pushContext[t[0]].data[0].myBlank=r;break;case"question":CAICUI.render.pushContext[t[0]].data[0].myBlank=r;break;case"matrixQuestion":CAICUI.render.pushContext[0].items[t[1]].myBlank=r;break;case"matrixBlank":CAICUI.render.pushContext[t[0]].data[0].items[t[1]].myBlank=r}console.log(CAICUI.render.pushContext)},questionsStatus:function(){if("multiTask"==CAICUI.render.questionsType){var e="";t.each(CAICUI.render.pushContext,function(t,r){e=CAICUI.render["this"].questionsStatusMultiTask(t.type,r),e||(e?CAICUI.render.status=1:CAICUI.render.status=2)})}else{var r=CAICUI.render["this"].questionsStatusOther(CAICUI.render.questionsType);r?CAICUI.render.status=1:CAICUI.render.status=2}},questionsStatusMultiTask:function(e,r){var n="",s=CAICUI.render.pushContext;if("matrixRadio"==e||"matrixCheckbox"==e)n=!0,t.each(s[r].data[0].items,function(e,t){e.isChecked&&(e.myChecked?(CAICUI.render.isMyChecked=!0,n=!0):n=!1),e.myChecked&&(CAICUI.render.isMyChecked=!0)});else if("radio"==e||"checkbox"==e)n=!0,t.each(s[r].data,function(e,t){e.isChecked&&(n=!!e.myChecked),e.myChecked&&(CAICUI.render.isMyChecked=!0)});else if("blank"==e||"question"==e){var i=s[0].blank;n=i==s[0].myBlank,s[0].myBlank&&(CAICUI.render.isMyChecked=!0)}else"matrixBlank"==e&&(n=!0,t.each(s[r].data[0].items,function(e,t){var r=e.blank;r&&(n=r==e.myBlank),e.myBlank&&(CAICUI.render.isMyChecked=!0)}));return n},questionsStatusOther:function(e){var r="",n=CAICUI.render.pushContext;if("checkbox"==e||"radio"==e)r=!0,t.each(n,function(e,t){e.isChecked&&(r=!!e.myChecked),e.myChecked&&(CAICUI.render.isMyChecked=!0)});else if("question"==e||"blank"==e){var s=n[0].blank;r=s==n[0].myBlank,n[0].myBlank&&(CAICUI.render.isMyChecked=!0)}else"matrixRadio"==e||"matrixCheckbox"==e?(r=!0,t.each(n[0].items,function(e,t){e.isChecked&&(r=!!e.myChecked),e.myChecked&&(CAICUI.render.isMyChecked=!0)})):"matrixBlank"==e&&(r=!0,t.each(n[0].items,function(e,t){var n=e.blank;n&&(r=n==e.myBlank),e.myBlank&&(CAICUI.render.isMyChecked=!0)}));return r},removeAnimate:function(t){e("#animate").animate({height:"0",top:"50%"},300,function(){e("#animate").remove(),t&&t()})},toggleCards:function(t){var r=CAICUI.iGlobal.getThat(t);CAICUI.render.cardOpen?(CAICUI.render.cardOpen=!1,r.removeClass("active"),e("body .questions-cards").removeClass("active"),r.text("展开答题卡")):(CAICUI.render.cardOpen=!0,r.addClass("active"),e("body .questions-cards").addClass("active"),r.text("收起答题卡"))},exit:function(){this.undelegateEvents(),this.$el.find(".questions").remove(),this.removeAnimate(function(){})},analysis:function(e){var t=(CAICUI.iGlobal.getThat(e),this.$el.find(".questions-answerResolution"));"none"==t.css("display")?t.show():t.hide(),window.CAICUI.myScroll.refresh()},clockTime:function(){function e(e){var t=parseInt(e),r=Math.floor(t/86400),s=Math.floor((t-24*r*60*60)/3600),i=Math.floor((t-24*r*60*60-3600*s)/60),a=Math.floor(t-24*r*60*60-3600*s-60*i);return 10>s&&(s="0"+s),10>i&&(i="0"+i),10>a&&(a="0"+a),n.text(s+":"+i+":"+a),t}var t=null,r=CAICUI.render.ExerciseTotalTime,n=this.$el.find(".questions-times");n.text("00:00:00"),t=setInterval(function(){r++,CAICUI.render.ExerciseTotalTime=e(r)},1e3)},getExerciseId:function(e,t){this.createIframe(e),this.getIframeData(function(e){t&&t(e)})},createIframe:function(t){var r=e("<iframe>");e(r).attr("src",CAICUI.render.exerciseFilename),e(r).attr("name","iframe_name"),e(r).attr("id","iframe_name"),e("body .questions").append(r)},getIframeData:function(t){var r=[];e("#iframe_name").load(function(){var n=e("body").find("#iframe_name").contents().find("body").html();console.log(n.split("</script>")),r=n.split("</script>").length>1?e.trim(n.split("</script>").slice(2)[0].split(",")).split(","):n.split(","),t&&t(r)})}});return n});