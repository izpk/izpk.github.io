define(["jquery","underscore","backbone","views/node-list","views/node-desc-list","views/node-editor","layer"],function(e,t,r,o,n,a,d){"use strict";var i=r.View.extend({el:"body #right",template:t.template(e("#template-my-note").html()),events:{"click .node-list-title-a":"nodeListToggle","click .node-list-link":"addNodeLists","click .node-list-linkssss":"addNodedetail","click .node-select-a":"nodeSelectA","click .node-option-li":"addActive","click .node-desc-show":"nodeDescShow","click .node-desc-hide":"nodeDescHide","click .node-new":"nodeNew","click .option-li":"nodeChange","change #uploadForm-file":"uploadForm","click .add-photo-remove":"addPhotoRemove","click .node-editor-cancel":"editorCancel","click .node-editor-confirm":"editorConfirm","click .js-pagination-li":"paginationChange","click .js-pagination-prev":"paginationPrev","click .js-pagination-next":"paginationNext","click .node-lsit-editor":"nodeEditor","click .node-lsit-remove":"nodeRemove","click .node-lately":"nodeLately","click .node-list-desc-link":"nodeListDescLink","keyup .node-editor-textarea":"nodeContent","click .show-photo-li":"showPhoto","click .remove-load-confirm":"removeLoadConfirm"},render:function(t){this.$scroller=this.$("#scroller"),this.$nodeRight=this.$(".node-right"),this.$nodeDescContent=this.$("#scroller-node"),this.$nodeListLi=this.$(".node-list-one-li"),this.$nodeLately=this.$(".node-lately"),this.courseNavPreDefault=2,this.courseNavPre=2,this.courseNavAnimateTime=150,CAICUI.render.courseId="",CAICUI.render.$this=this,CAICUI.render.content="",CAICUI.render.clientType="pc",CAICUI.render.title="sdf",CAICUI.render.isPublic=1,CAICUI.render.subjectId="",CAICUI.render.categoryId="",CAICUI.render.chapterId="",CAICUI.render.subjectName="",CAICUI.render.categoryName="",CAICUI.render.courseName="",CAICUI.render.chapterName="",CAICUI.render.taskId="",CAICUI.render.taskProgress=0,CAICUI.render.taskName="sdf",CAICUI.render.imgPath="",CAICUI.render.imgPathArray=[],CAICUI.render.isLately=!0,CAICUI.render.noEditor=!0,CAICUI.render.charpterId="",CAICUI.render.nodeType=0,CAICUI.render.self=1,CAICUI.render.ordertype=1,CAICUI.render.pageNo=1,CAICUI.render.pageSize=20,CAICUI.render.totalCount=0,CAICUI.render.pageTotal=0,CAICUI.render.paginationType=0,CAICUI.render.serverTotal=1,CAICUI.render.serverNum=0,this.$myallcoursechapternodecount="",this.$myNoteCourseList="",this.myallcoursechapternodecount(),CAICUI.render.timer=setInterval(function(){CAICUI.render.serverTotal==CAICUI.render.serverNum&&(clearInterval(CAICUI.render.timer),CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId,myNoteCourseList:CAICUI.render.$this.$myNoteCourseList,nodelist:CAICUI.render.$this.$myallcoursechapternodecount}})),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),CAICUI.render.$this.$myallcoursechapternodecount.data&&e("body .node-lately").trigger("click"))},CAICUI.render.time)},myallcoursechapternodecount:function(e){CAICUI.Request.ajax({server:"myallcoursechapternodecount",data:{token:CAICUI.User.token},done:function(r){if(e)e(r);else{var o=[];t.each(r.data,function(e,t,r){e.nodeNum&&o.push({courseId:e.id,courseName:e.title})}),CAICUI.render.serverNum++,CAICUI.render.$this.$myNoteCourseList=o,CAICUI.render.$this.$myallcoursechapternodecount=r}},fail:function(t){e?e({}):(CAICUI.render.serverNum++,CAICUI.render.$this.$myNoteCourseList={},CAICUI.render.$this.$myallcoursechapternodecount={})}})},addNodelist:function(){CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh();var t=new o;this.myallcoursechapternodecount(function(r){e("body #scroller").html(t.render({data:{nodelist:r}}).el),window.CAICUI.myScroll.refresh()})},nodeList:function(e){CAICUI.Request.ajax({server:"nodelist",data:{token:CAICUI.User.token,charpterid:CAICUI.render.charpterId,self:CAICUI.render.self,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,ordertype:CAICUI.render.ordertype},done:function(t){CAICUI.render.pageTotal=Math.ceil(t.totalCount/t.pageSize),e(t)},fail:function(t){e({})}})},nodeListCourse:function(e){CAICUI.Request.ajax({server:"nodelist",data:{token:CAICUI.User.token,self:CAICUI.render.self,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,ordertype:CAICUI.render.ordertype},done:function(t){CAICUI.render.pageTotal=Math.ceil(t.totalCount/t.pageSize),e(t)},fail:function(t){e({})}})},courseBaseInfo:function(e){CAICUI.Request.ajax({server:"courseBaseInfo",data:{token:CAICUI.User.token,courseIds:CAICUI.render.courseId},done:function(t){var r=t.data[0];CAICUI.render.subjectId=r.subjectId,CAICUI.render.subjectName=r.subjectName,CAICUI.render.categoryId=r.categoryId,CAICUI.render.categoryName=r.categoryName,CAICUI.render.courseName=r.courseName,e&&e()},fail:function(e){d.msg("Sorry~ 网络错误，请刷新页面重试。",function(){})}})},addNodeLists:function(t){CAICUI.render.noEditor=!0,CAICUI.render.isLately=!1;var r=CAICUI.iGlobal.getThat(t);CAICUI.render.pageNo=1,CAICUI.render.paginationType=1,CAICUI.iGlobal.loading(".node-right"),e(".node-list-link").removeClass("active"),r.addClass("active"),CAICUI.render.courseId=r.attr("data-courseid"),CAICUI.render.chapterId=r.attr("data-chapterid"),CAICUI.render.chapterName=r.attr("data-chaptername"),CAICUI.render.charpterId=r.attr("data-chapterid"),this.courseBaseInfo(function(){var t=new n;CAICUI.render.$this.nodeList(function(r){e(".node-right").html(t.render({data:r.data,type:CAICUI.render.nodeType,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})})},nodeLately:function(t){CAICUI.render.noEditor=!1,CAICUI.render.isLately=!0;CAICUI.iGlobal.getThat(t);CAICUI.render.pageNo=1,CAICUI.render.paginationType=0,CAICUI.iGlobal.loading(".node-right"),e("body .node-list-link.active").removeClass("active");var r=new n;this.nodeListCourse(function(t){e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})},nodeDetail:function(e){CAICUI.Request.ajax({server:"nodedetail",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId},done:function(t){e(t)},fail:function(t){e({})}})},delmycontent:function(e){CAICUI.Request.ajax({server:"delmycontent",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId,type:"note"},done:function(t){e(t)},fail:function(t){e({})}})},addNodedetail:function(t){var r=CAICUI.iGlobal.getThat(t);if(!r.hasClass("active")){CAICUI.iGlobal.loading(".node-right"),e(".node-list-link").removeClass("active"),r.addClass("active");var o=r.attr("data-id"),a=new n;this.nodedetail(o,function(t){e(".node-right").html(a.render({data:t,type:0}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},getThat:function(t){return e(t.currentTarget)},nodeListRender:function(){var e=new o;this.$scroller.html(e.render().el)},nodeDescRender:function(e){function t(){console.log(this.y)}var r=new n;this.$nodeRight.html(r.render(e).el),window.CAICUI.nodeScroll=new IScroll("body #wrapper-node",{probeType:3,mouseWheel:!0,scrollbars:"custom"}),window.CAICUI.nodeScroll.on("scroll",t),document.addEventListener("touchmove",function(e){e.preventDefault()},!1)},nodeEditorRender:function(e){var t=new a;this.$(".node-right").html(t.render(e).el)},uploadForm:function(t){var r=new FormData(e("#uploadForm")[0]);e.ajax({url:"http://api.caicui.com/api/v2.1/commons/fileUpload",type:"POST",data:r,async:!1,cache:!1,contentType:!1,processData:!1,success:function(t){CAICUI.render.imgPathArray.push(t.data.path);var r=e('<div class="add-photo-show"><img class="add-photo-img" src="'+CAICUI.Common.host.img+t.data.path+'"><a class="add-photo-remove" data-src="'+t.data.path+'"  href="javascript:;"><i class="icon icon-add-remove"></i></a></div>');r.find("img");e("body #uploadForm").before(r),e("body .add-photo-show").length>=5&&e("body #uploadForm").hide()},error:function(e){}})},addPhotoRemove:function(t){for(var r=CAICUI.iGlobal.getThat(t),o=(r.prev(),r.attr("data-src")),n=0;n<CAICUI.render.imgPathArray.length;n++)if(CAICUI.render.imgPathArray[n]==o){CAICUI.render.imgPathArray.splice(n,1);break}var a=r.parent();a.remove(),e("body .add-photo-show").length<5&&e("body #uploadForm").show()},nodeListToggle:function(e){var t=this.getThat(e),r=t.parent();r.toggleClass("active"),window.CAICUI.myScroll.refresh()},addActive:function(e){var t=this.getThat(e);t.siblings().removeClass("active"),t.addClass("active")},nodeSelectA:function(e){var t=this.getThat(e);t.toggleClass("active"),t.next().toggleClass("active")},nodeListLink:function(t){var r=this.getThat(t);r.hasClass("active")||(e(".node-list-link").removeClass("active"),r.addClass("active"),this.nodeDescRender(r.parent().index()))},nodeDescShow:function(e){var t=this.getThat(e),r=t.parents("li");CAICUI.render.nodeId=r.attr("data-id"),this.nodeDetail(function(e){r.addClass("active"),window.CAICUI.nodeScroll.refresh()})},nodeDescHide:function(e){var t=this.getThat(e),r=t.parents("li");r.removeClass("active"),window.CAICUI.nodeScroll.refresh()},nodeNew:function(e){this.getThat(e);this.nodeEditorRender()},nodeEditor:function(e){var t=this.getThat(e),r=t.parents(".node-desc-li"),o=r.attr("data-updateTime"),n=r.attr("data-taskprogress"),a=r.attr("data-contentSummary");CAICUI.render.content=a;var d=r.attr("data-imgPath");d.length?CAICUI.render.imgPathArray=d.split(","):CAICUI.render.imgPathArray=[];var i=+r.attr("data-isPublic");CAICUI.render.isPublic=i,CAICUI.render.nodeId=r.attr("data-id"),CAICUI.render.charpterId=r.attr("data-charpterId"),this.nodeEditorRender({time:o,videoTime:n,content:a,imgPath:CAICUI.render.imgPathArray,isPublic:i})},editorConfirm:function(t){if(CAICUI.render.imgPath="",CAICUI.render.imgPathArray.length)for(var r=0;r<CAICUI.render.imgPathArray.length;r++)r?CAICUI.render.imgPath+=","+CAICUI.render.imgPathArray[r]:CAICUI.render.imgPath+=CAICUI.render.imgPathArray[r];else CAICUI.render.imgPath="";CAICUI.Request.ajax({server:"nodesave",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId,content:CAICUI.render.content,courseId:CAICUI.render.courseId,clientType:CAICUI.render.clientType,title:CAICUI.render.title,isPublic:CAICUI.render.isPublic,subjectId:CAICUI.render.subjectId,categoryId:CAICUI.render.categoryId,chapterId:CAICUI.render.chapterId,subjectName:CAICUI.render.subjectName,categoryName:CAICUI.render.categoryName,courseName:CAICUI.render.courseName,chapterName:CAICUI.render.chapterName,taskName:CAICUI.render.taskName,imgPath:CAICUI.render.imgPath},done:function(t){var r=e("body .node-list-link.active");CAICUI.render.isLately?e("body .node-lately").trigger("click"):r.trigger("click")},fail:function(e){d.msg("Sorry~ 笔记保存失败",function(){})}})},nodeContent:function(e){var t=CAICUI.iGlobal.getThat(e);CAICUI.render.content=t.val()},editorCancel:function(t){e("body .node-list-link.active").length?e("body .node-list-link.active").trigger("click"):e("body .node-lately").trigger("click")},nodeRemove:function(t){var r=this.getThat(t);CAICUI.render.removeNodeDescLi=r.parents(".node-desc-li"),CAICUI.render.nodeRemoveLoad=d.load(1,{type:1,title:!1,content:e("#remove-load"),closeBtn:0,shade:[.5,"#000"]}),e(".remove-load-cancel").on("click",function(){d.close(CAICUI.render.nodeRemoveLoad)})},removeLoadConfirm:function(t){CAICUI.render.nodeId=CAICUI.render.removeNodeDescLi.attr("data-id"),CAICUI.render.$this.delmycontent(function(t){CAICUI.render.removeNodeDescLi.remove();var r=e("body .node-list-link.active"),o=+r.attr("data-nodenum")-1;r.attr("data-nodenum",o),r.find(".node-list-num").text("["+o+"]");var n=r.parent().parent(),a=n.prev(),i=+a.attr("data-nodenum")-1;a.attr("data-nodenum",i),a.find(".node-list-num").text("["+i+"]"),d.close(CAICUI.render.nodeRemoveLoad),o?window.CAICUI.nodeScroll.refresh():r.trigger("click")})},nodeChange:function(t){var r=CAICUI.iGlobal.getThat(t),o=r.find(".option-a").text();r.siblings().removeClass("active"),r.addClass("active"),r.parent().removeClass("active"),r.parent().prev().removeClass("active"),r.parent().prev().find(".node-select-text").text(o),CAICUI.render.courseId=r.find(".option-a").attr("data-courseid"),e(".node-list-one-li").addClass("hide"),CAICUI.render.courseId?e("#node-list-"+CAICUI.render.courseId).removeClass("hide"):e(".node-list-one-li").removeClass("hide"),window.CAICUI.myScroll.refresh()},paginationChange:function(t){CAICUI.iGlobal.loading(".node-right");var r=CAICUI.iGlobal.getThat(t);if(CAICUI.render.pageNo=r.attr("data-pageno"),CAICUI.render.paginationType)this.nodeList(function(t){var r=new n;e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var o=new n;this.nodeListCourse(function(t){e(".node-right").html(o.render({data:t.data,type:0,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},paginationPrev:function(t){if(CAICUI.render.pageNo>1)if(CAICUI.iGlobal.loading(".node-right"),CAICUI.render.pageNo=+CAICUI.render.pageNo-1,CAICUI.render.paginationType)this.nodeList(function(t){var r=new n;e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var r=new n;this.nodeListCourse(function(t){e(".node-right").html(r.render({data:t.data,type:0,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},paginationNext:function(t){if(CAICUI.render.pageNo<=CAICUI.render.pageTotal-1)if(CAICUI.iGlobal.loading(".node-right"),CAICUI.render.pageNo=+CAICUI.render.pageNo+1,CAICUI.render.paginationType)this.nodeList(function(t){var r=new n;e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var r=new n;this.nodeListCourse(function(t){e(".node-right").html(r.render({data:t.data,type:0,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},nodeListDescLink:function(e){e.stopPropagation(),CAICUI.NavVideo=!1,CAICUI.domRender=!1;var t=CAICUI.iGlobal.getThat(e);window.location.hash=t.attr("link")},showPhoto:function(t){var r=CAICUI.iGlobal.getThat(t),o=r.find("img").attr("src"),n=e("body .show-photo-img-big");r.siblings().removeClass("active"),r.addClass("active"),n.attr("src",o),window.CAICUI.nodeScroll.refresh()}});return i});