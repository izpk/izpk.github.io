define(["jquery","underscore","backbone"],function(e,r,a){"use strict";return a.View.extend({el:"body #right",template:r.template(e("#template-course-resources").html()),events:{"click .js-course-resources-change":"courseChange","click .courseResources-li":"courseResourcesList"},render:function(r){CAICUI.render.this=this,CAICUI.render.courseId=r,CAICUI.render.subjectId="",CAICUI.render.versionId="",CAICUI.render.resources=[],CAICUI.render.courseBaseInfoAjaxCount=0,this.$el.html(this.template({data:""})),CAICUI.iGlobal.getTemplateCourseNav("body .courseIndex-header-right",{courseType:"classCourse",type:"resources",courseId:CAICUI.render.courseId}),CAICUI.render.this.coursesBaseInfoAjax(function(r){e("body .course-change").attr("title",CAICUI.render.courseName),e("body .course-name").text(CAICUI.render.courseName),CAICUI.render.versionId&&CAICUI.render.this.getListByIdAjax(function(r){var a=e("#template-course-resources-list").html(),t=CAICUI.iGlobal.getTemplate(a,{data:r});e("body #scroller").html(t),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")})})},courseChange:function(r){var a=CAICUI.iGlobal.getThat(r),t=a.attr("data-click");if(a.hasClass("active"))a.removeClass("active"),e("body .option-ul").removeClass("active");else if(CAICUI.render.learningcourseData&&CAICUI.render.learningcourseData.length){var s=e("#template-courseStudy-courseList").html(),o=CAICUI.iGlobal.getTemplate(s,{courseNameArray:CAICUI.render.courseNameArray});e("body .course-change-ul").html(o),a.addClass("active"),e("body .option-ul").addClass("active")}else"true"!=t&&(a.attr("data-click","true"),CAICUI.render.this.learningcourseAjax(function(){CAICUI.render.courseNameArray&&CAICUI.render.courseNameArray.length;var r=e("#template-courseStudy-courseList").html(),t=CAICUI.iGlobal.getTemplate(r,{courseNameArray:CAICUI.render.courseNameArray});e("body .course-change-ul").html(t),a.addClass("active"),e("body .option-ul").addClass("active")}))},coursesBaseInfoAjax:function(e){CAICUI.Request.ajax({server:"coursesBaseInfo",data:{idType:"0",courseId:CAICUI.render.courseId},done:function(r){if("success"==r.state){if(r.data&&r.data.length){var a=r.data[0];CAICUI.render.subjectId=a.subjectId,CAICUI.render.courseName=a.courseName,CAICUI.render.versionId=a.versionId}e&&e(r)}else CAICUI.render.courseBaseInfoAjaxCount<2?(CAICUI.render.courseBaseInfoAjaxCount++,CAICUI.render.this.coursesBaseInfoAjax(e)):layer.msg("Sorry~ 网络异常，请刷新页面重试。",function(){})},fail:function(r){CAICUI.render.courseBaseInfoAjaxCount<2?(CAICUI.render.courseBaseInfoAjaxCount++,CAICUI.render.this.coursesBaseInfoAjax(e)):layer.msg("Sorry~ 网络异常，请刷新页面重试。",function(){})}})},learningcourseAjax:function(e){CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(r){if(!r.data.courselist||!r.data.courselist.length)return!1;CAICUI.render.learningcourseData=r.data.courselist;var a=r.data.courselist;CAICUI.render.courseNameArray=[];for(var t=0;t<a.length;t++){var s=!0;if(CAICUI.render.courseNameArray&&CAICUI.render.courseNameArray.length)for(var o=0;o<CAICUI.render.courseNameArray.length;o++)CAICUI.render.courseNameArray[o].courseId==a[t].courseId&&(s=!1);s&&CAICUI.render.courseNameArray.push({courseId:a[t].courseId,courseName:a[t].courseName})}e&&e()},fail:function(){CAICUI.render.learningcourseData={},CAICUI.CACHE.RecentCourse={}}})},getListByIdAjax:function(e){var r=0,a="",t=[];CAICUI.Request.ajax({server:"getListById",data:{id:CAICUI.render.subjectId,type:"subject"},done:function(e){r++,CAICUI.render.subjectData=e.data}}),CAICUI.Request.ajax({server:"getListById",data:{id:CAICUI.render.versionId,type:"course"},done:function(e){r++,CAICUI.render.versionData=e.data}}),a=setInterval(function(){2==r&&(clearInterval(a),CAICUI.render.subjectData.forEach(function(e){t.push(e)}),CAICUI.render.versionData.forEach(function(e){t.push(e)}),CAICUI.render.resources=t,e&&e(t))},300)},getDetailByIdAjax:function(e){CAICUI.Request.ajax({server:"getDetailById",data:{resourceId:CAICUI.render.detailById},done:function(r){CAICUI.render.getDetailById=r.data,e&&e(r)},fail:function(r){CAICUI.render.getDetailById=r.data,e&&e(r)}})},courseResourcesList:function(r){CAICUI.iGlobal.loading("body .courseResources-right",{height:e("#wrapper").height()+"px"});var a=CAICUI.iGlobal.getThat(r),t=a.index();a.siblings().removeClass("active"),a.addClass("active"),CAICUI.render.detailById=CAICUI.render.resources[t].id,CAICUI.render.this.getDetailByIdAjax(function(r){var a=e("#template-course-resources-content").html(),t=CAICUI.iGlobal.getTemplate(a,r);e("body .courseResources-right").html(t),window.CAICUI.myScrollRight=CAICUI.iGlobal.iScroll("body #course-resources-wrapper")})}})});