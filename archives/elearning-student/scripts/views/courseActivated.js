define(["jquery","underscore","backbone","datetimepicker","datetimepickerZHCN"],function(e,t,r,a,o){"use strict";return r.View.extend({tagName:"div",className:"course-content",template:t.template(e("#template-course-activated").html()),events:{"click .studyin-content-subjects":"subjectClick","click .studyin-type":"typeClick","click .js-apply-hearing":"applyHearing","click .courseActivated-pop-close":"applyHearingClose","change .courseActivated-pop-select1":"changeCourseActivatedType","change .courseActivated-pop-select2":"changeExamTime","change .courseActivated-pop-select4":"changeNextExamTime","click .courseActivated-pop-button":"applyHearingBtn","change #uploadForm-file":"uploadFormFile","click .add-photo-remove":"removeUploadFormFile"},render:function(){return this.$el.html(this.template()),CAICUI.render.courseActivated=this,CAICUI.render.examState=1,CAICUI.render.clickCategoryId="",CAICUI.render.clickSubjectId="",CAICUI.render.courseActivatedLoading=!1,CAICUI.render.serverTotal=2,CAICUI.render.serverNum=0,this.expirationcourseAjax(),this.applyrestudylistAjax(),CAICUI.render.timer=setInterval(function(){if(CAICUI.render.serverTotal==CAICUI.render.serverNum){clearInterval(CAICUI.render.timer);for(var t=[],r=0;r<CAICUI.CACHE.expirationcourse.length;r++)t.push(CAICUI.CACHE.expirationcourse[r].courseId);CAICUI.render.courseActivated.actionGetCourseProgressAjax(t,function(){var t=CAICUI.render.courseActivated.filterExpirationcourse(),r=CAICUI.render.courseActivated.filterApplyrestudylist();console.log(t),console.log(r);var a=e("#template-course-activated-list").html(),o=CAICUI.iGlobal.getTemplate(a,{expirationcourse:t,applyrestudylist:r});e("body .course-content").html(o),e(".current-progress").each(function(){var t=e(this),r=parseInt(t.attr("data-progress"));r&&(t.addClass("active"),t.animate({width:r/100*90},1e3))}),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),CAICUI.render.courseActivated.memberAjax(),e("body .courseActivated-pop-select2").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0}).on("changeDate",function(e){CAICUI.render.testDate=parseInt(e.date.valueOf()/1e3)})})}},CAICUI.render.time),this},expirationcourseAjax:function(){CAICUI.Request.ajax({server:"expirationcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.expirationcourse=e.data.courselist}})},applyrestudylistAjax:function(){CAICUI.Request.ajax({server:"applyrestudylist",data:{memberId:CAICUI.User.memberId},done:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.applyrestudylist=e.data},fail:function(e){CAICUI.render.serverNum++,CAICUI.CACHE.actionGetCourseProgress=[]}})},actionGetCourseProgressAjax:function(e,t){CAICUI.Request.ajax({server:"actionGetCourseProgress",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,courseId:e.toString()},done:function(e){CAICUI.CACHE.actionGetCourseProgress=e.data,t&&t()}})},memberAjax:function(){CAICUI.Request.ajax({server:"member",data:{token:CAICUI.User.token},done:function(e){e.data.mobile?CAICUI.User.mobile=e.data.mobile:e.data.email&&(CAICUI.User.mobile=e.data.email)},fail:function(e){}})},filterExpirationcourse:function(){for(var e=0;e<CAICUI.CACHE.expirationcourse.length;e++)for(var r=0;r<CAICUI.CACHE.actionGetCourseProgress.length;r++)CAICUI.CACHE.expirationcourse[e].courseId==CAICUI.CACHE.actionGetCourseProgress[r].courseId&&(CAICUI.CACHE.expirationcourse[e].courseProgress=CAICUI.CACHE.actionGetCourseProgress[r].courseProgress,CAICUI.CACHE.expirationcourse[e].createDate=CAICUI.CACHE.actionGetCourseProgress[r].createDate,CAICUI.CACHE.expirationcourse[e].chapterId=CAICUI.CACHE.actionGetCourseProgress[r].chapterId,CAICUI.CACHE.expirationcourse[e].chapterName=CAICUI.CACHE.actionGetCourseProgress[r].chapterName,CAICUI.CACHE.expirationcourse[e].progress=CAICUI.CACHE.actionGetCourseProgress[r].progress,CAICUI.CACHE.expirationcourse[e].taskId=CAICUI.CACHE.actionGetCourseProgress[r].taskId,CAICUI.CACHE.expirationcourse[e].taskName=CAICUI.CACHE.actionGetCourseProgress[r].taskName);var a=CAICUI.CACHE.expirationcourse,o=t.chain(a).map(function(e){return e.categoryName}).uniq().value(),s=t.chain(a).map(function(e){return e.categoryIndex}).uniq().value(),i=[];for(e=0;e<o.length;e++)i.push({categoryName:o[e],categoryIndex:s[e],list:[]}),t.each(a,function(t,r,a){t.categoryName==o[e]&&(i&&i[e]&&i[e].list?i[e].list.push(t):i[e].list=[t])});for(e=0;e<i.length;e++){i[e].newList=[];var n=i[e].list,c=t.chain(n).map(function(e){return e.subjectName}).uniq().value(),d=t.chain(n).map(function(e){return e.subjectIndex}).uniq().value();for(r=0;r<c.length;r++)i[e].newList.push({subjectName:c[r],subjectIndex:d[r],list:[]}),t.each(i[e].list,function(a,o,s){if(a.subjectName==c[r])if(i[e].newList[r].list&&i[e].newList[r].list.length){var n=!0;t.each(i[e].newList[r].list,function(e,t,r){a.courseId==e.courseId&&(n=!1)}),n&&i[e].newList[r].list.push(a)}else i[e].newList[r].list=[a],i[e].newList[r].courseCategoryId=a.subjectID})}i=t.sortBy(i,"categoryIndex");return t.each(i,function(e,r){i[r].newList=t.sortBy(e.newList,"subjectIndex"),t.each(i[r].newList,function(e,a){i[r].newList[a].list=t.sortBy(e.list,"courseIndex")})}),{courseListNav:o,courseLists:i}},filterApplyrestudylist:function(){var e=[];if(CAICUI.CACHE.applyrestudylist&&CAICUI.CACHE.applyrestudylist.length)for(var t=0;t<CAICUI.CACHE.applyrestudylist.length;t++){var r=CAICUI.CACHE.applyrestudylist[t];if(1!=r.auditState)if(e.length){for(var a=!1,o=!1,s=0;s<e.length;s++){if(r.courseCategoryId==e[s].courseCategoryId){o=!0;break}a=!0;break}if(a&&e.push({courseCategoryId:r.courseCategoryId,auditState:r.auditState,auditTime:r.auditTime,list:[r]}),o){e[s].list.push(r);var i=0;(i=r.auditState?r.auditTime:r.createDate)>e[s].auditTime&&(e[s].auditTime=i)}}else e.push({courseCategoryId:r.courseCategoryId,auditState:r.auditState,auditTime:r.auditTime,list:[r]})}return e},newFilterApplyrestudylist:function(){var e=[];if(CAICUI.CACHE.applyrestudylist&&CAICUI.CACHE.applyrestudylist.length)for(var t=0;t<CAICUI.CACHE.applyrestudylist.length;t++){var r=CAICUI.CACHE.applyrestudylist[t];if(e.length){for(var a=-1,o=0,s=!1,i=0;i<e.length;i++){if(r.courseCategoryId==e[i].courseCategoryId){(r.auditState?r.auditTime:r.createDate)>=(e[i].auditState?e[i].auditTime:e[i].createDate)?(a=!0,o=i):s=!1;break}s=!0;break}"ff808081473905e701475d4ec4d60006"==r.courseCategoryId&&(console.log(s),console.log(o),console.log(r)),s?e.push(r):a&&(e[o]=r)}else e.push(r)}for(t=0;t<e.length;t++)"ff808081473905e701475d4ec4d60006"==e[t].courseCategoryId&&console.log(e[t]);return e},subjectEnter:function(t){var r=t.currentTarget,a=e(r),o=(a.index(),a.find(".subject-lf").find(".subject-mask")),s=a.find(".subject-rt");return o.stop(!0,!1).animate({left:"0"}),{mask:o,rt:s}},subjectLeave:function(e){this.subjectEnter(e).mask.stop(!0,!1).animate({left:"-160px"})},subjectClick:function(e){this.subjectEnter(e).rt.parent().parent().addClass("active").siblings().removeClass("active")},iconClick:function(t){var r=t.currentTarget,a=e(r);a.find(".subject-type-rt").toggleClass("stop"),a.next(".studyin-content-subject").toggleClass("stop"),CAICUI.myScroll.refresh()},typeClick:function(t){var r=t.currentTarget,a=e(r),o=a.index();a.addClass("active").siblings().removeClass("active"),e(".studyin-contents").removeClass("active").eq(o).addClass("active"),CAICUI.myScroll.refresh()},applyHearing:function(r){var a=CAICUI.iGlobal.getThat(r);a.data("subjectid");CAICUI.render.clickCategoryId=a.data("categoryid"),CAICUI.render.clickSubjectId=a.data("subjectid"),CAICUI.render.orderItemId=a.data("orderitemid"),layer.closeAll(),CAICUI.render.closeCourseActivatedPop=layer.open({type:1,title:!1,shade:!0,scrollbar:!1,closeBtn:0,skin:"layui-skin layui-courseActivation",area:["620px","580px"],content:e("#courseActivated-pop"),success:function(){CAICUI.Request.ajax({server:"subjectTimeList",data:{subjectId:CAICUI.render.clickSubjectId},done:function(r){if(r.data&&r.data.length>0){var a="";t.each(r.data,function(e,t){a+='<option class="courseActivated-pop-option" value="'+parseInt(e.time/1e3)+'">'+CAICUI.iGlobal.getDate(e.time)+"</option>"}),e("body #courseActivated-pop .courseActivated-pop-select2").html('<option class="courseActivated-pop-option" value="">请选择未通过考试的时间</option>'+a),e("body #courseActivated-pop .courseActivated-pop-select4").html('<option class="courseActivated-pop-option"  value="">请选择下次考试的时间</option>'+a)}}})}})},applyHearingClose:function(){CAICUI.render.examState=1,e("body .courseActivated-pop-select1").find("option").removeAttr("selected"),e("body .courseActivated-pop-select1").find("option").eq(0).attr("selected","selected"),e("body .courseActivated-pop-select2").find("option").removeAttr("selected"),e("body .courseActivated-pop-select2").removeClass("disabled").removeAttr("disabled"),e("body .courseActivated-pop-select2").find("option").eq(0).attr("selected","selected"),e("body .courseActivated-pop-select3").removeAttr("disabled"),e("body .courseActivated-pop-select3").val(""),e("body .courseActivated-pop-select4").find("option").removeAttr("selected"),e("body .courseActivated-pop-select4").find("option").eq(0).attr("selected","selected"),this.removeUploadFormFile(),layer.closeAll()},subjectTimeListAjax:function(e,t){CAICUI.Request.ajax({server:"subjectTimeList",data:{subjectId:e},done:function(e){t&&t(e.data)},fail:function(e){}})},changeCourseActivatedType:function(t){var r=CAICUI.iGlobal.getThat(t);CAICUI.render.examState=parseInt(r.val()),this.removeUploadFormFile(),2==CAICUI.render.examState?(e("body .courseActivated-pop-select2").attr("disabled","disabled"),e("body .courseActivated-pop-select2").addClass("disabled"),e("body .courseActivated-pop-select3").attr("disabled","disabled")):1==CAICUI.render.examState&&(e("body .courseActivated-pop-select2").removeAttr("disabled"),e("body .courseActivated-pop-select2").removeClass("disabled"),e("body .courseActivated-pop-select3").removeAttr("disabled"))},changeExamTime:function(e){var t=CAICUI.iGlobal.getThat(e);CAICUI.render.testDate=t.val()},changeNextExamTime:function(e){var t=CAICUI.iGlobal.getThat(e);CAICUI.render.nextExamDate=t.val()},applyHearingBtn:function(t){if(CAICUI.iGlobal.getThat(t).hasClass("active")){if(1==CAICUI.render.examState){if(CAICUI.render.score=e("body .courseActivated-pop-select3").val(),!CAICUI.render.testDate)return layer.msg("Sorry~ 请填写考试日期"),!1;if(!CAICUI.render.score)return layer.msg("Sorry~ 请输入您的考试分数"),!1}if(!CAICUI.render.scanningPath)return layer.msg("Sorry~ 请填写考试成绩证明附件"),!1;if(!CAICUI.render.nextExamDate)return layer.msg("Sorry~ 请输入下次考试的时间"),!1;this.applyrestudyAjax()}},applyrestudyAjax:function(t){e("body .courseActivated-pop-button").removeClass("active"),CAICUI.Request.ajax({server:"applyrestudy",data:{token:CAICUI.User.token,mobile:CAICUI.User.mobile,fullname:CAICUI.User.username,certificateId:CAICUI.render.clickCategoryId,subjectId:CAICUI.render.clickSubjectId,orderItemId:CAICUI.render.orderItemId,examState:CAICUI.render.examState,score:CAICUI.render.score,testDate:CAICUI.render.testDate,scanningPath:CAICUI.render.scanningPath,nextExamDate:CAICUI.render.nextExamDate},done:function(t){if(e("body .courseActivated-pop-button").addClass("active"),"success"==t.state){var r=e("body #courseActivated-"+CAICUI.render.clickSubjectId);r.addClass("auditState0"),r.find("a").removeClass("js-apply-hearing"),r.find(".mask-lf").text("审核中"),CAICUI.render.courseActivated.applyHearingClose(),layer.msg("申请成功~ ",{icon:1})}else layer.msg("Sorry~ 上传失败！")},fail:function(t){e("body .courseActivated-pop-button").addClass("active"),layer.msg("Sorry~ 上传失败！")}})},uploadFormFile:function(){CAICUI.iGlobal.fileUpload({formClass:"uploadForm"},function(t){CAICUI.render.scanningPath=CAICUI.Common.host.img+t.data[0].storeFileUrl,e("body .add-photo-form").addClass("hidden"),e("body .add-photo-show").removeClass("hidden"),e("body .add-photo-img").attr("src",CAICUI.render.scanningPath)})},removeUploadFormFile:function(){CAICUI.render.scanningPath="",e("body #uploadForm-file").val(""),e("body .add-photo-form").removeClass("hidden"),e("body .add-photo-show").addClass("hidden")}})});