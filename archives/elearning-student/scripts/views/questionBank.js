define(["jquery","underscore","backbone"],function(e,t,r){"use strict";return r.View.extend({el:"body",template:t.template(e("#template-question-bank").html()),events:{"click .question-bank-li":"selectQuestionBank","click .question-bank-right-li":"selectQuestionBankItem","click .question-bank-btn":"selectQuestionBankType"},render:function(){CAICUI.render.this=this,CAICUI.render.examenType="",CAICUI.render.examenTypeArray=["real","imitate"],CAICUI.render.certificateArray=[{certificateName:"ACCA",certificateId:"ff808081473905e701475cd3c2080001"},{certificateName:"CMA",certificateId:"ff808081486933e601489c4662f60851"}],CAICUI.render.certificate="ACCA",CAICUI.render.certificateId="ff808081473905e701475cd3c2080001",CAICUI.render.subject="F1",this.getcoursecategoryAjax(function(){CAICUI.render.coursecategoryIndex=0,CAICUI.render.subjectsActive=CAICUI.render.getcoursecategory.data[CAICUI.render.coursecategoryIndex].subjects[0],e("body #right").html(CAICUI.render.this.template(CAICUI.render.getcoursecategory));var t=CAICUI.render.this.getIdArray("courseCategoryId"),r=CAICUI.render.this.getIdArray("knowledgePointId"),n=[],a=[];t.forEach(function(e){CAICUI.render.this.courseCategoryExamenCountAjax({id:e},function(e){n.push(e.data[0])})}),r.forEach(function(e){CAICUI.render.this.exercisePointCountCacheAjax(e,function(e){a.push(e.data[0])})});var c=setInterval(function(){n.length==t.length&&(clearInterval(c),n.forEach(function(e){CAICUI.render.this.addCount&&CAICUI.render.this.addCount({key:"courseCategoryId",id:e.courseCategoryId,realCount:e.realCount,imitateCount:e.imitateCount})}),CAICUI.render.getcoursecategory.data.forEach(function(t,r){e("body .question-bank-"+CAICUI.render.getcoursecategory.data[r].certificateName+"-realCount").text(CAICUI.render.getcoursecategory.data[r].realCount),e("body .question-bank-"+CAICUI.render.getcoursecategory.data[r].certificateName+"-imitateCount").text(CAICUI.render.getcoursecategory.data[r].imitateCount)}))},300),o=setInterval(function(){a.length==r.length&&(clearInterval(o),a.forEach(function(e){e&&CAICUI.render.this.addCount&&CAICUI.render.this.addCount({key:"knowledgePointId",id:e.knowledge_point_id,count:+e.exercise_count})}),CAICUI.render.getcoursecategory.data.forEach(function(t,r){e("body .question-bank-"+CAICUI.render.getcoursecategory.data[r].certificateName+"-exerciseCount").text(CAICUI.render.getcoursecategory.data[r].exerciseCount)}))},300)})},getcoursecategoryAjax:function(e){CAICUI.Request.ajax({server:"getcoursecategory",done:function(t){CAICUI.render.getcoursecategory=t,e&&e()}})},courseCategoryExamenCountAjax:function(e,t){CAICUI.Request.ajax({server:"courseCategoryExamenCount",data:{courseCategoryId:e.id,examenType:e.type},done:function(e){CAICUI.render.courseCategoryExamenCount=e,t&&t(e)}})},exercisePointCountCacheAjax:function(e,t){CAICUI.Request.ajax({server:"exercisePointCountCache",data:{knowledge_points:e,type:4},done:function(e){CAICUI.render.courseCategoryExamenCount=e,t&&t(e)}})},getIdArray:function(e){var r=[];return t.each(CAICUI.render.getcoursecategory.data,function(t,n){for(var a=t[e].split(","),c=0;c<a.length;c++)r.push(a[c])}),r},addCount:function(e){t.each(CAICUI.render.getcoursecategory.data,function(t,r){for(var n=t[e.key].split(","),a=0;a<n.length;a++)n[a]==e.id&&("courseCategoryId"==e.key?(CAICUI.render.getcoursecategory.data[r].realCount+=e.realCount,CAICUI.render.getcoursecategory.data[r].imitateCount+=e.imitateCount):"knowledgePointId"==e.key&&(CAICUI.render.getcoursecategory.data[r].exerciseCount+=e.count))})},selectItem:function(e){var t=CAICUI.iGlobal.getThat(e),r=t.index();return t.hasClass("active")||(t.siblings().removeClass("active"),t.addClass("active")),{index:r}},selectQuestionBank:function(t){CAICUI.render.subject="",CAICUI.render.subjectsActive="",CAICUI.render.examenType="";var r=this.selectItem(t);CAICUI.render.coursecategoryIndex=r.index,CAICUI.render.certificate=CAICUI.render.certificateArray[r.index].certificateName,CAICUI.render.certificateId=CAICUI.render.certificateArray[r.index].certificateId;var n=e("#template-question-bank-right").html(),a=CAICUI.iGlobal.getTemplate(n,{name:CAICUI.render.getcoursecategory.data[r.index].certificateName,list:CAICUI.render.getcoursecategory.data[r.index].subjects});e("body .question-bank-right").html(a)},selectQuestionBankItem:function(t){var r=this.selectItem(t);CAICUI.render.subjectsActive=CAICUI.render.getcoursecategory.data[CAICUI.render.coursecategoryIndex].subjects[r.index],"ff808081486933e601489c799f0f0868"==CAICUI.render.subjectsActive.subjectId||"ff808081486933e601489c7a1aa20869"==CAICUI.render.subjectsActive.subjectId?e("body .question-bank-btn-imitate").addClass("hidden"):e("body .question-bank-btn-imitate").removeClass("hidden"),CAICUI.render.subject=CAICUI.render.getcoursecategory.data[CAICUI.render.coursecategoryIndex].subjects[r.index].subjectName,this.openQuestionBankList()},selectQuestionBankType:function(e){var t=this.selectItem(e);CAICUI.render.examenType=CAICUI.render.examenTypeArray[t.index],this.openQuestionBankList()},openQuestionBankList:function(){if(!CAICUI.render.subject)return e("body .question-bank-selectType-tips").removeClass("hidden").text("请选择你的练习科目"),!1;if(!CAICUI.render.examenType)return e("body .question-bank-selectType-tips").removeClass("hidden").text("请选择你的练习类型"),!1;var t=0,r="";"real"==CAICUI.render.examenType?(t=0,r=CAICUI.render.subjectsActive.courseCategoryId):"imitate"==CAICUI.render.examenType&&(t=1,r=CAICUI.render.subjectsActive.knowledgePointId);var n={categoryName:CAICUI.render.certificate,categoryId:CAICUI.render.certificateId,subjectName:CAICUI.render.subjectsActive.subjectName,subjectId:r};e.cookie("questionBankCookie",JSON.stringify(n),{path:"/",expires:36500});var a="#questionBankList/"+t+"/"+CAICUI.render.certificate+"/"+r;window.location.hash=a}})});