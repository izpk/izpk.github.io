define(["jquery","underscore","backbone","views/node-list","views/node-desc-list","views/node-editor","layer"],function(e,t,r,o,n,a,d){"use strict";return r.View.extend({el:"body #right",template:t.template(e("#template-my-note").html()),events:{"click .node-list-title-a":"nodeListToggle","click .node-list-link":"addNodeLists","click .node-list-linkssss":"addNodedetail","click .node-select-a":"nodeSelectA","click .node-option-li":"addActive","click .node-desc-show":"nodeDescShow","click .node-desc-hide":"nodeDescHide","click .node-new":"nodeNew","click .option-li":"nodeChange","change #uploadForm-file":"uploadForm","click .add-photo-remove":"addPhotoRemove","click .node-editor-cancel":"editorCancel","click .node-editor-confirm":"editorConfirm","click .js-pagination-li":"paginationChange","click .js-pagination-prev":"paginationPrev","click .js-pagination-next":"paginationNext","click .node-lsit-editor":"nodeEditor","click .node-lsit-remove":"nodeRemove","click .node-lately":"nodeLately","click .node-list-desc-link":"nodeListDescLink","keyup .node-editor-textarea":"nodeContent","click .show-photo-li":"showPhoto","click .remove-load-confirm":"removeLoadConfirm"},render:function(r){this.$el.html(this.template()),this.$scroller=this.$("#scroller"),this.$nodeRight=this.$(".node-right"),this.$nodeDescContent=this.$("#scroller-node"),this.$nodeListLi=this.$(".node-list-one-li"),this.$nodeLately=this.$(".node-lately"),this.courseNavPreDefault=2,this.courseNavPre=2,this.courseNavAnimateTime=150,CAICUI.render.courseId="",CAICUI.render.$this=this,CAICUI.render.content="",CAICUI.render.clientType="pc",CAICUI.render.title="sdf",CAICUI.render.isPublic=1,CAICUI.render.subjectId="",CAICUI.render.categoryId="",CAICUI.render.chapterId="",CAICUI.render.subjectName="",CAICUI.render.categoryName="",CAICUI.render.courseName="",CAICUI.render.chapterName="",CAICUI.render.taskId="",CAICUI.render.taskProgress=0,CAICUI.render.taskName="sdf",CAICUI.render.imgPath="",CAICUI.render.imgPathArray=[],CAICUI.render.isLately=!0,CAICUI.render.noEditor=!0,CAICUI.render.charpterId="",CAICUI.render.nodeType=0,CAICUI.render.self=1,CAICUI.render.ordertype=1,CAICUI.render.pageNo=1,CAICUI.render.pageSize=20,CAICUI.render.totalCount=0,CAICUI.render.pageTotal=0,CAICUI.render.paginationType=0,CAICUI.render.serverTotal=1,CAICUI.render.serverNum=0,this.$myallcoursechapternodecount="",this.$myNoteCourseList="",this.myallcoursechapternodecount(function(r){console.log(r),CAICUI.render.myNotecourseList=[],t.each(r,function(e,t,r){e.nodeNum&&CAICUI.render.myNotecourseList.push({courseId:e.id,courseName:e.title})});var o=e("#template-my-note-content").html(),n=CAICUI.iGlobal.getTemplate(o,{data:{courseId:CAICUI.render.courseId,myNoteCourseList:CAICUI.render.myNotecourseList,nodelist:CAICUI.render.myallcoursechapternodecountData}});e("body .node-left").html(n),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),CAICUI.render.myallcoursechapternodecountData.data&&e("body .node-lately").trigger("click")})},myallcoursechapternodecount:function(e){CAICUI.Request.ajax({server:"myallcoursechapternodecount",data:{token:CAICUI.User.token},done:function(r){if(console.log(r),CAICUI.render.myallcoursechapternodecountData=r,e)e(r.data);else{var o=[];t.each(r.data,function(e,t,r){e.nodeNum&&o.push({courseId:e.id,courseName:e.title})}),CAICUI.render.serverNum++,CAICUI.render.$this.$myNoteCourseList=o,CAICUI.render.$this.$myallcoursechapternodecount=r}},fail:function(t){e?e({}):(CAICUI.render.serverNum++,CAICUI.render.$this.$myNoteCourseList={},CAICUI.render.$this.$myallcoursechapternodecount={})}})},addNodelist:function(){CAICUI.iGlobal.loading("body #scroller",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh();var t=new o;this.myallcoursechapternodecount(function(r){e("body #scroller").html(t.render({data:{nodelist:r}}).el),window.CAICUI.myScroll.refresh()})},nodeList:function(e){CAICUI.Request.ajax({server:"nodelist",data:{token:CAICUI.User.token,charpterid:CAICUI.render.charpterId,self:CAICUI.render.self,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,ordertype:CAICUI.render.ordertype},done:function(t){CAICUI.render.pageTotal=Math.ceil(t.totalCount/t.pageSize),e(t)},fail:function(t){e({})}})},nodeListCourse:function(e){CAICUI.Request.ajax({server:"nodelist",data:{token:CAICUI.User.token,self:CAICUI.render.self,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,ordertype:CAICUI.render.ordertype},done:function(t){CAICUI.render.pageTotal=Math.ceil(t.totalCount/t.pageSize),e(t)},fail:function(t){e({})}})},courseBaseInfo:function(e){CAICUI.Request.ajax({server:"coursesBaseInfo",data:{idType:0,courseId:CAICUI.render.courseId},done:function(t){var r=t.data[0];CAICUI.render.subjectId=r.subjectId,CAICUI.render.subjectName=r.subjectName,CAICUI.render.categoryId=r.categoryId,CAICUI.render.categoryName=r.categoryName,CAICUI.render.courseName=r.courseName,e&&e()},fail:function(e){d.msg("Sorry~ 网络错误，请刷新页面重试。",function(){})}})},addNodeLists:function(t){CAICUI.render.noEditor=!0,CAICUI.render.isLately=!1;var r=CAICUI.iGlobal.getThat(t);CAICUI.render.pageNo=1,CAICUI.render.paginationType=1,CAICUI.iGlobal.loading(".node-right"),e(".node-list-link").removeClass("active"),r.addClass("active"),CAICUI.render.courseId=r.attr("data-courseid"),CAICUI.render.chapterId=r.attr("data-chapterid"),CAICUI.render.chapterName=r.attr("data-chaptername"),CAICUI.render.charpterId=r.attr("data-chapterid"),this.courseBaseInfo(function(){var t=new n;CAICUI.render.$this.nodeList(function(r){e(".node-right").html(t.render({data:r.data,type:CAICUI.render.nodeType,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})})},nodeLately:function(t){CAICUI.render.noEditor=!1,CAICUI.render.isLately=!0;CAICUI.iGlobal.getThat(t);CAICUI.render.pageNo=1,CAICUI.render.paginationType=0,CAICUI.iGlobal.loading(".node-right"),e("body .node-list-link.active").removeClass("active");var r=new n;this.nodeListCourse(function(t){e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})},nodeDetail:function(e){CAICUI.Request.ajax({server:"nodedetail",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId},done:function(t){e(t)},fail:function(t){e({})}})},delmycontent:function(e){CAICUI.Request.ajax({server:"delmycontent",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId,type:"note"},done:function(t){e(t)},fail:function(t){e({})}})},addNodedetail:function(t){var r=CAICUI.iGlobal.getThat(t);if(!r.hasClass("active")){CAICUI.iGlobal.loading(".node-right"),e(".node-list-link").removeClass("active"),r.addClass("active");var o=r.attr("data-id"),a=new n;this.nodedetail(o,function(t){e(".node-right").html(a.render({data:t,type:0}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},getThat:function(t){return e(t.currentTarget)},nodeListRender:function(){var e=new o;this.$scroller.html(e.render().el)},nodeDescRender:function(e){var t=new n;this.$nodeRight.html(t.render(e).el),window.CAICUI.nodeScroll=new IScroll("body #wrapper-node",{probeType:3,mouseWheel:!0,scrollbars:"custom"}),window.CAICUI.nodeScroll.on("scroll",function(){console.log(this.y)}),document.addEventListener("touchmove",function(e){e.preventDefault()},!1)},nodeEditorRender:function(e){var t=new a;this.$(".node-right").html(t.render(e).el)},uploadForm:function(e){CAICUI.iGlobal.fileUpload({formClass:"uploadForm"},function(e){CAICUI.iGlobal.fileUploadAddList("uploadForm",e)})},addPhotoRemove:function(t){for(var r=CAICUI.iGlobal.getThat(t),o=(r.prev(),r.attr("data-src")),n=0;n<CAICUI.render.imgPathArray.length;n++)if(CAICUI.render.imgPathArray[n]==o){CAICUI.render.imgPathArray.splice(n,1);break}r.parent().remove(),e("body .add-photo-show").length<5&&e("body #uploadForm").show()},nodeListToggle:function(e){this.getThat(e).parent().toggleClass("active"),window.CAICUI.myScroll.refresh()},addActive:function(e){var t=this.getThat(e);t.siblings().removeClass("active"),t.addClass("active")},nodeSelectA:function(e){var t=this.getThat(e);t.toggleClass("active"),t.next().toggleClass("active")},nodeListLink:function(t){var r=this.getThat(t);r.hasClass("active")||(e(".node-list-link").removeClass("active"),r.addClass("active"),this.nodeDescRender(r.parent().index()))},nodeDescShow:function(e){var t=this.getThat(e).parents("li");CAICUI.render.nodeId=t.attr("data-id"),this.nodeDetail(function(e){t.find(".node-desc-span").text(e.data.content),t.addClass("active"),window.CAICUI.nodeScroll.refresh()})},nodeDescHide:function(e){var t=this.getThat(e).parents("li"),r=CAICUI.iGlobal.cutstr(CAICUI.iGlobal.html_decode(t.attr("data-contentSummary")),120);t.find(".node-desc-span").text(r),t.removeClass("active"),window.CAICUI.nodeScroll.refresh()},nodeNew:function(e){this.getThat(e);this.nodeEditorRender()},nodeEditor:function(e){var t=this.getThat(e).parents(".node-desc-li"),r=t.attr("data-updateTime"),o=t.attr("data-taskprogress"),n=t.attr("data-contentSummary");CAICUI.render.content=n;var a=t.attr("data-imgPath");a.length?CAICUI.render.imgPathArray=a.split(","):CAICUI.render.imgPathArray=[];var d=+t.attr("data-isPublic");CAICUI.render.isPublic=d,CAICUI.render.nodeId=t.attr("data-id"),CAICUI.render.charpterId=t.attr("data-charpterId"),this.nodeEditorRender({time:r,videoTime:o,content:n,imgPath:CAICUI.render.imgPathArray,isPublic:d})},editorConfirm:function(t){if(CAICUI.render.imgPath="",CAICUI.render.imgPathArray.length)for(var r=0;r<CAICUI.render.imgPathArray.length;r++)CAICUI.render.imgPath+=r?","+CAICUI.render.imgPathArray[r]:CAICUI.render.imgPathArray[r];else CAICUI.render.imgPath="";CAICUI.Request.ajax({server:"nodesave",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId,content:CAICUI.render.content,courseId:CAICUI.render.courseId,clientType:CAICUI.render.clientType,title:CAICUI.render.title,isPublic:CAICUI.render.isPublic,subjectId:CAICUI.render.subjectId,categoryId:CAICUI.render.categoryId,chapterId:CAICUI.render.chapterId,subjectName:CAICUI.render.subjectName,categoryName:CAICUI.render.categoryName,courseName:CAICUI.render.courseName,chapterName:CAICUI.render.chapterName,taskName:CAICUI.render.taskName,imgPath:CAICUI.render.imgPath},done:function(t){var r=e("body .node-list-link.active");CAICUI.render.isLately?e("body .node-lately").trigger("click"):r.trigger("click")},fail:function(e){d.msg("Sorry~ 笔记保存失败",function(){})}})},nodeContent:function(e){var t=CAICUI.iGlobal.getThat(e);CAICUI.render.content=t.val()},editorCancel:function(t){e("body .node-list-link.active").length?e("body .node-list-link.active").trigger("click"):e("body .node-lately").trigger("click")},nodeRemove:function(t){var r=this.getThat(t);CAICUI.render.removeNodeDescLi=r.parents(".node-desc-li"),CAICUI.render.nodeRemoveLoad=d.load(1,{type:1,title:!1,content:e("#remove-load"),closeBtn:0,shade:[.5,"#000"]}),e(".remove-load-cancel").on("click",function(){d.close(CAICUI.render.nodeRemoveLoad)})},removeLoadConfirm:function(t){CAICUI.render.nodeId=CAICUI.render.removeNodeDescLi.attr("data-id"),CAICUI.render.$this.delmycontent(function(t){CAICUI.render.removeNodeDescLi.remove();var r=e("body .node-list-link.active"),o=+r.attr("data-nodenum")-1;r.attr("data-nodenum",o),r.find(".node-list-num").text("["+o+"]");var n=r.parent().parent().prev(),a=+n.attr("data-nodenum")-1;n.attr("data-nodenum",a),n.find(".node-list-num").text("["+a+"]"),d.close(CAICUI.render.nodeRemoveLoad),o?window.CAICUI.nodeScroll.refresh():r.trigger("click")})},nodeChange:function(t){var r=CAICUI.iGlobal.getThat(t),o=r.find(".option-a").text();r.siblings().removeClass("active"),r.addClass("active"),r.parent().removeClass("active"),r.parent().prev().removeClass("active"),r.parent().prev().find(".node-select-text").text(o),CAICUI.render.courseId=r.find(".option-a").attr("data-courseid"),e(".node-list-one-li").addClass("hide"),CAICUI.render.courseId?e("#node-list-"+CAICUI.render.courseId).removeClass("hide"):e(".node-list-one-li").removeClass("hide"),window.CAICUI.myScroll.refresh()},paginationChange:function(t){CAICUI.iGlobal.loading(".node-right");var r=CAICUI.iGlobal.getThat(t);if(CAICUI.render.pageNo=r.attr("data-pageno"),CAICUI.render.paginationType)this.nodeList(function(t){var r=new n;e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var o=new n;this.nodeListCourse(function(t){e(".node-right").html(o.render({data:t.data,type:0,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},paginationPrev:function(t){if(CAICUI.render.pageNo>1)if(CAICUI.iGlobal.loading(".node-right"),CAICUI.render.pageNo=+CAICUI.render.pageNo-1,CAICUI.render.paginationType)this.nodeList(function(t){var r=new n;e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var r=new n;this.nodeListCourse(function(t){e(".node-right").html(r.render({data:t.data,type:0,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},paginationNext:function(t){if(CAICUI.render.pageNo<=CAICUI.render.pageTotal-1)if(CAICUI.iGlobal.loading(".node-right"),CAICUI.render.pageNo=+CAICUI.render.pageNo+1,CAICUI.render.paginationType)this.nodeList(function(t){var r=new n;e(".node-right").html(r.render({data:t.data,type:CAICUI.render.nodeType,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var r=new n;this.nodeListCourse(function(t){e(".node-right").html(r.render({data:t.data,type:0,pageNo:t.pageNo,pageSize:t.pageSize,totalCount:t.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},nodeListDescLink:function(e){e.stopPropagation(),CAICUI.NavVideo=!1,CAICUI.domRender=!1;var t=CAICUI.iGlobal.getThat(e);window.location.hash=t.attr("link")},showPhoto:function(t){var r=CAICUI.iGlobal.getThat(t),o=r.find("img").attr("src"),n=e("body .show-photo-img-big");r.siblings().removeClass("active"),r.addClass("active"),n.attr("src",o),window.CAICUI.nodeScroll.refresh()}})});