define(["jquery","underscore","backbone","storage"],function(e,t,a,r){"use strict";return a.View.extend({tagName:"div",className:"course-detail-main",template:t.template(e("#template-class-course-detail-week-list").html()),events:{"click .courseDetail-weekList-chapterA":"showTaskList","click .js-toTask":"openVideo"},type:"",render:function(t){return CAICUI.render.thisCourseDetail=this,CAICUI.render.thisCourseDetail.$el.html(CAICUI.render.thisCourseDetail.template({teachingPlan:t})),setTimeout(function(){window.CAICUI.myScroller=CAICUI.iGlobal.iScroll("body #wrapper-courseStudy-list"),e("body .section-content").on("click",function(){var a=e(this).data("node").split("-"),r=t[a[0]].list[a[1]],s="#video/"+CAICUI.render.courseId+"/"+r.chapterId+"/"+r.tasks[0].taskId+"?return_link=classCourseStudy/"+CAICUI.render.courseId+"&return_hash=on";window.location.hash=s}),e("body .js-task-exam").on("click",function(){var e="#video/8a22cc685c3379ab015c3d51d8f50035/8a22cc685c3379ab015c3d5fcb1d003d/1c77eedfca7d5a6e4b06b13243b4b47f?return_link=classCourseStudy/"+CAICUI.render.courseId+"&return_hash=on";window.location.hash=e}),e("body .js-task-live").on("click",function(){})},50),this},teachingPlanAjax:function(e){CAICUI.Request.ajax({server:"node-teachingPlan",data:{courseId:"courseId"},done:function(t){e&&e(t)}})},isCourseDetailWeekPlan:function(e){CAICUI.render.previewInterval&&clearInterval(CAICUI.render.previewInterval),CAICUI.render.courseDetailList=[],CAICUI.render.courseDetailWeekList=[],CAICUI.render.weekTotalBeoverdue=0,CAICUI.render.taskTotal=0,CAICUI.render.taskTotalBeoverdue=0,CAICUI.render.taskTotalOngoing=0,CAICUI.render.taskTotalCompleted=0,CAICUI.render.taskTotalNotstarted=0,CAICUI.render.thisCourseDetail.filterData(e.chapters),e.taskProgress&&CAICUI.render.thisCourseDetail.addTaskProgress(e.taskProgress),CAICUI.render.courseDetailData="",e.weekList&&e.weekList.length?CAICUI.render.courseDetailData=this.getCourseDetailWeekPlanData(e):CAICUI.render.courseDetailData=this.getCourseDetailData(e)},getCourseDetailData:function(e){for(var t=[],a=CAICUI.render.courseDetailList,r=a.length,s=0,o="",n=0,i=0,d=0,l=0,C=0,c=0,I=(d=0,0),u=0,k=0;k<r;k++){0;var T=a[k];if(T.isTasks){n+=T.chapterTotalTime,i+=T.chapterStudyTime;var h=T.tasks.length;switch(s+=h,o){case"completed":CAICUI.render.taskTotalCompleted+=h;break;case"beoverdue":for(var p=0;p<h;p++)T.tasks[p].state?(C++,CAICUI.render.taskTotalCompleted++,I++):T.tasks[p].progress?(CAICUI.render.taskTotalOngoing++,d++):(CAICUI.render.taskTotalBeoverdue++,c++);break;case"ongoing":for(p=0;p<h;p++)T.tasks[p].state?(C++,CAICUI.render.taskTotalCompleted++,I++):T.tasks[p].progress?(CAICUI.render.taskTotalOngoing++,d++):(CAICUI.render.taskTotalNotstarted++,u++);break;case"notstarted":CAICUI.render.taskTotalNotstarted+=h}}t.push(T)}return s==C&&"notstarted"!==o&&(l=1,o="completed"),CAICUI.render.taskTotal+=s,CAICUI.render.courseDetailWeekList.push({list:t,tasksNum:s,weekStatus:o,weekTaskTime:n,weekStudyTime:i,weekIsFinish:l,weekTaskCompleted:I,weekTaskOngoing:d,weekTaskBeoverdue:c,weekTaskNotstarted:u}),{isPreview:e.isPreview,isPlan:!1,courseDetailWeekList:CAICUI.render.courseDetailWeekList,courseActiveState:e.courseActiveState,courseTaskTotal:CAICUI.render.taskTotal,courseTaskTotalBeoverdue:CAICUI.render.taskTotalBeoverdue,courseTaskTotalCompleted:CAICUI.render.taskTotalCompleted,courseTaskTotalOngoing:CAICUI.render.taskTotalOngoing,courseTaskTotalNotstarted:CAICUI.render.taskTotalNotstarted,coursePercentage:CAICUI.iGlobal.getPercentage(CAICUI.render.taskTotalCompleted,CAICUI.render.taskTotal),courseId:e.courseId,weekTotalBeoverdue:CAICUI.render.weekTotalBeoverdue}},getCourseDetailWeekPlanData:function(e){var a=0,r=(new Date).getTime();return t.each(e.weekList,function(e,t){var s=e.startCategoryId,o=e.endCategoryId,n=[],i=!1,d=CAICUI.render.courseDetailList,l=d.length,C=0,c="",I=0,u=0,k=0,T=0,h=0,p=0,A=(k=0,0),U=0;e.startDate<r&&e.endDate<r?(c="beoverdue",CAICUI.render.weekTotalBeoverdue++):e.startDate<r&&r<e.endDate&&(c="ongoing"),r<e.startDate&&r<e.endDate&&(c="notstarted");for(var v=a;v<l;v++){0;var g=d[v];if(s==g.chapterId&&(i=!0),i){if(g.isTasks){I+=g.chapterTotalTime,u+=g.chapterStudyTime;var m=g.tasks.length;switch(C+=m,c){case"completed":CAICUI.render.taskTotalCompleted+=m;break;case"beoverdue":for(var w=0;w<m;w++)g.tasks[w].state?(h++,CAICUI.render.taskTotalCompleted++,A++):g.tasks[w].progress?(CAICUI.render.taskTotalOngoing++,k++):(CAICUI.render.taskTotalBeoverdue++,p++);break;case"ongoing":for(w=0;w<m;w++)g.tasks[w].state?(h++,CAICUI.render.taskTotalCompleted++,A++):g.tasks[w].progress?(CAICUI.render.taskTotalOngoing++,k++):(CAICUI.render.taskTotalNotstarted++,U++);break;case"notstarted":CAICUI.render.taskTotalNotstarted+=m}}n.push(g)}if(o==g.chapterId){i=!1,a=v,v,v;break}}C==h&&"notstarted"!==c&&(T=1,c="completed"),CAICUI.render.taskTotal+=C,CAICUI.render.courseDetailWeekList.push({planId:e.id,title:e.planTitle,startDate:e.startDate,endDate:e.endDate,isFinish:e.isFinish,list:n,tasksNum:C,weekStatus:c,weekTaskTime:I,weekStudyTime:u,weekIsFinish:T,weekTaskCompleted:A,weekTaskOngoing:k,weekTaskBeoverdue:p,weekTaskNotstarted:U})}),{isPreview:e.isPreview,isPlan:!0,courseDetailWeekList:CAICUI.render.courseDetailWeekList,courseActiveState:e.courseActiveState,courseTaskTotal:CAICUI.render.taskTotal,courseTaskTotalBeoverdue:CAICUI.render.taskTotalBeoverdue,courseTaskTotalCompleted:CAICUI.render.taskTotalCompleted,courseTaskTotalOngoing:CAICUI.render.taskTotalOngoing,courseTaskTotalNotstarted:CAICUI.render.taskTotalNotstarted,coursePercentage:CAICUI.iGlobal.getPercentage(CAICUI.render.taskTotalCompleted,CAICUI.render.taskTotal),courseId:e.courseId,weekTotalBeoverdue:CAICUI.render.weekTotalBeoverdue}},filterData:function(e,a,r,s,o){if(a)a++;else a=1;t.each(e,function(e,o){var n="",i="";a>1?(n=s,i=r+"-"+o):(i=o.toString(),r=o.toString(),n=o.toString());var d=0;if(e.tasks&&e.tasks.length){var l=[],C=0,c=0,I=0;CAICUI.render.previewCourseTasksTotalNum+=e.tasks.length,t.each(e.tasks,function(e,t){"video"==e.taskType?(l.push(e),CAICUI.render.previewCourseTimeTotalNum+=+e.videoTime,d+=+e.videoTime):"exam"==e.taskType?(l.push(e),CAICUI.render.previewCourseTimeTotalNum+=60*+e.taskTime,d+=60*+e.taskTime):"knowledgePointExercise"==e.taskType?(l.push(e),CAICUI.render.previewCourseTimeTotalNum+=7200,d+=7200):"openCourse"==e.taskType&&(l.push(e),CAICUI.render.previewCourseTimeTotalNum+=+e.taskTime),e.state?C++:e.progress?c++:I++}),CAICUI.render.courseDetailList.push({level:a,rootNode:n,parentNode:r,node:i,isChildren:!1,isFree:e.isFree,chapterTitle:e.chapterTitle,chapterId:e.chapterId,isTasks:!0,tasks:l,completedNum:C,ongoingNum:c,notstartedNum:I,chapterTotalTime:d})}e.children&&e.children.length&&(CAICUI.render.courseDetailLevel++,CAICUI.render.courseDetailList.push({level:a,rootNode:n,parentNode:r,node:i,isChildren:!0,isFree:e.isFree,chapterTitle:e.chapterTitle,chapterId:e.chapterId,isTasks:!1}),CAICUI.render.thisCourseDetail.filterData(e.children,a,i,r,n))})},addTaskProgress:function(e){t.each(CAICUI.render.courseDetailList,function(a,r){if(a.isTasks){var s=0,o=0,n=0,i=0;a.tasks.length;t.each(a.tasks,function(a,r){var d="";t.each(e,function(e,t){a.taskId==e.taskId&&(d=e)}),d?(d.studyTime?s+=d.studyTime:s+=0,d.state?o++:d.progress&&n++,a.progress=d.progress,a.total=d.total,a.state=d.state,a.percentage=CAICUI.iGlobal.getPercentage(d.progress,d.total)):i++}),a.completedNum=o,a.ongoingNum=n,a.notstartedNum=i,a.chapterStudyTime=s}})},getStudyTime:function(e){var a=0;return e.taskStudyTimeList&&e.taskStudyTimeList.length&&t.each(e.taskStudyTimeList,function(e,t){a+=parseInt(e.studyTime)}),a},showTaskList:function(e){var t=CAICUI.iGlobal.getThat(e),a=t.parents(".courseDetail-weekList-chapterUl");if(t.data("istasks")){var r=t.parent();r.hasClass("active")?r.removeClass("active"):r.addClass("active")}else{var s=t.data("node"),o=t.data("checked"),n=t.data("level");o?(t.data("checked",!1),1==n?(a.find(".courseDetail-weekList-parentNode-"+s).parent().removeClass("active"),a.find(".courseDetail-weekList-parentNode-"+s).data("checked",!1),a.find(".courseDetail-weekList-rootNode-"+s).parent().removeClass("show active"),a.find(".courseDetail-weekList-rootNode-"+s).data("checked",!1)):(t.parent().removeClass("active"),t.parent().data("checked",!1),a.find(".courseDetail-weekList-parentNode-"+s).parent().removeClass("show active"),a.find(".courseDetail-weekList-parentNode-"+s).data("checked",!1))):(1==n?(a.find(".courseDetail-weekList-rootNode-"+s).parent().addClass("show active"),a.find(".courseDetail-weekList-rootNode-"+s).data("checked",!0)):(t.parent().addClass("active"),t.parent().data("checked",!0)),t.data("checked",!0),a.find(".courseDetail-weekList-parentNode-"+s).parent().addClass("show active"))}window.CAICUI.myScrollLearningPlanPreview?window.CAICUI.myScrollLearningPlanPreview.refresh():window.CAICUI.myScrollCourseStudyList&&window.CAICUI.myScrollCourseStudyList.refresh()},toTask:function(e){var t=CAICUI.iGlobal.getThat(e),a=t.attr("link");if(a){var r=t.attr("data-chapterid");CAICUI.render.openChapterId=r,window.location.hash=a}},openVideo:function(t){var a=CAICUI.render.courseDetail.courseActiveState,s=CAICUI.iGlobal.getThat(t),o=s.attr("link");if(o){var n=s.attr("data-chapterid"),i=s.attr("data-taskslength");CAICUI.render.openChapterId=n,CAICUI.render.openTasksNum=i,CAICUI.render.formCourseStudy=!0,CAICUI.NavVideo=!1,e("body .course-desc").attr("href",o),CAICUI.render.lastLearnChapterName=s.find(".course-list-desc").text(),CAICUI.render.lastLearnChapterLink=o,r.setsingle("playlist-index"+CAICUI.render.courseId,"c|"+s.attr("data-index")),window.location.hash=o}else 4==a?layer.msg("Sorry~ 您当前的课程已锁定",function(){}):2==a?layer.msg("Sorry~ 您当前的课程未激活",function(){}):1==a?layer.msg("Sorry~ 您当前的课程已过期",function(){}):0==a&&layer.msg("Sorry~ 您未购买当前的课程",function(){})}})});