define(["jquery","underscore","backbone","d3"],function(t,e,a,n){"use strict";return a.View.extend({tag:"div",template:e.template(t("#template-course-study-d3-stack").html()),events:{},type:"",render:function(t){return this.$el.html(this.template({data:t})),this},setStackData:function(t,a){var n=[{status:"completed",title:"已完成",total:a.courseTaskTotalCompleted,values:[]},{status:"beoverdue",title:"逾期",total:a.courseTaskTotalBeoverdue,values:[]},{status:"ongoing",title:"进行中",total:a.courseTaskTotalOngoing,values:[]},{status:"notstarted",title:"未完成",total:a.courseTaskTotalNotstarted,values:[]}],u=a.courseDetailWeekList;return e.each(u,function(a,u){var s=a.weekStatus;switch(e.each(n,function(t,e){n[e].values.push({week:"第-"+(u+1)+"-周",value:0})}),s){case"completed":n[0].values[u].value=a.tasksNum;break;case"beoverdue":var l=t.setListValue(a);n[2].values[u].value=l.ongoingTotalNum,n[0].values[u].value=l.completedTotalNum,n[1].values[u].value=l.notstartedTotalNum;break;case"ongoing":l=t.setListValue(a);n[2].values[u].value=l.ongoingTotalNum,n[0].values[u].value=l.completedTotalNum,n[3].values[u].value=l.notstartedTotalNum;break;case"notstarted":n[3].values[u].value=a.tasksNum}}),n},setListValue:function(t){var a=0,n=0,u=0;return e.each(t.list,function(t,e){t.completedNum&&(a+=t.completedNum),t.ongoingNum&&(n+=t.ongoingNum),t.notstartedNum&&(u+=t.notstartedNum)}),{completedTotalNum:a,ongoingTotalNum:n,notstartedTotalNum:u}},createD3Stack:function(t){var e=207,a=n.select("#d3-stack").append("svg").attr("width",335).attr("height",e),u=n.layout.stack().values(function(t){return t.values}).x(function(t){return t.week}).y(function(t){return t.value})(t),s=30,l=20,r=66,o=335-s-0,c=n.scale.ordinal().domain(u[0].values.map(function(t){return t.week})).rangeBands([0,o],.3),i=n.max(u[u.length-1].values,function(t){return t.y0+t.y}),d=e-l-r,v=n.scale.linear().domain([0,i]).rangeRound([0,d]),m=["#73c7c3","#f78e49","#566c88","#d0d0d0"],g=(a.selectAll("g").data(u).enter().append("g").style("fill",function(t,e){return m[e]}).selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("x",function(t){return c(t.week)+(c.rangeBand()-10)/2}).attr("y",function(t){return d-v(t.y0+t.y)}).attr("width",function(t){return 10}).attr("height",function(t){return v(t.y)}).attr("transform","translate("+s+","+l+")"),n.svg.axis().scale(c).orient("bottom"));v.range([d,0]);var p=n.svg.axis().scale(v).orient("left"),f=a.append("g").attr("class","axis").attr("transform","translate("+s+","+(e-r)+")").call(g).selectAll("text");f.text("");f.selectAll("tspan").data(function(t){return t.split("-")}).enter().append("tspan").attr("x",f.attr("x")).attr("dy","1em").text(function(t){return t});a.append("g").attr("class","axis").attr("transform","translate("+s+","+(e-r-d)+")").call(p)}})});