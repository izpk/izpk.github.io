define(["jquery","underscore","ajax","storage","layer","iMobile","views/questions-knowledge","views/questions-exam","views/questions-evaluation","slimscroll","jqueryUI"],function(e,o,r,t,n,s,i,a,l){return window.videoController={player:null,playerType:0,courseData:"",courseActiveState:0,ccSetConfig:{control_enable:0,bigbutton_enable:0,keyboard_enable:0,fullscreen_enable:1,on_player_seek:"on_player_seek",on_player_start:"on_player_start"},courseId:"",chapterId:"",taskId:"",taskProgress:"",load:"",payInfoDialog:"",init:function(e,o,r,t){videoController.addAnimate(function(){videoController.initCreateDom(function(){CAICUI.render.isFinish="0",videoController.courseId=e,CAICUI.render.courseId=e,CAICUI.render.chapterId=videoController.chapterId=o,CAICUI.render.isEnd="",CAICUI.render.taskReturn=!0,r&&("true"==r||"false"==r?CAICUI.render.isEnd=r:CAICUI.render.taskId=videoController.taskId=r),t&&(CAICUI.render.taskProgress=videoController.taskProgress=t),CAICUI.render.taskIndex=0,CAICUI.render.examenNum=0,videoController.courseNode={},videoController.courseNode.isPublic=1,videoController.courseNode.imgPathArray=[],videoController.courseId=e,CAICUI.render.formCourseStudy&&CAICUI.CACHE.courseDetail?videoController.initCourseDetail(CAICUI.CACHE.courseDetail):CAICUI.Request.ajax({server:"courseDetail",data:{courseId:e},done:function(e){videoController.initCourseDetail(e.data[0])}})})})},initCourseDetail:function(e){CAICUI.render.subjectId=e.subjectId,videoController.courseData=e,CAICUI.render.knowledgePointIdTotal=e.knowledgePointId;var r="";o.each(e.chapters,function(e,t,n){e.chapterId==CAICUI.render.chapterId?r=t:e.children&&o.each(e.children,function(e,n,s){e.chapterId==CAICUI.render.chapterId?r=t+"|"+n:e.children&&o.each(e.children,function(e,o){e.chapterId==CAICUI.render.chapterId&&(r=t+"|"+n+"|"+o)})})}),t.setsingle("playlist-index"+CAICUI.render.courseId,"c|"+r),videoController.courseActiveState(e.versionId,function(){videoController.initData(CAICUI.render.courseId,CAICUI.render.chapterId)})},initCreateDom:function(o){var r=e("#template-video-dom").html(),t=CAICUI.iGlobal.getTemplate(r);e("body #studycenter-video").remove(),e("body").append(t),e("body #animate").remove(),e("body .js-studycenter-video-close").one("click",function(){CAICUI.render.taskReturn=!1,e("body #studycenter-video").remove();var o=CAICUI.iGlobal.getUrlPara("return_link");"on"==CAICUI.iGlobal.getUrlPara("return_hash")?window.location.hash=o:window.location.href=o}),o&&o()},initData:function(e,o){if(t.get("playlist-index"+e)&&t.get("course-"+e)){if(videoController.indexList=t.get("playlist-index"+e).split("|"),videoController.courseData=t.get("course-"+e),4==videoController.indexList.length&&"c"==videoController.indexList[0]){videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]].children[videoController.indexList[2]].children[videoController.indexList[3]];var r=videoController.currentChapter.tasks.length,n=0,s=0;videoController.currentChapter.tasks[0].modifyDate&&(s=videoController.currentChapter.tasks[0].modifyDate);for(var i=1;i<r;i++)videoController.currentChapter.tasks[i].modifyDate&&videoController.currentChapter.tasks[i].modifyDate>s&&(n=i,s=videoController.currentChapter.tasks[i].modifyDate);videoController.lasttaskindex=n}else if(3==videoController.indexList.length&&"c"==videoController.indexList[0]){videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]].children[videoController.indexList[2]];r=videoController.currentChapter.tasks.length,n=0,s=0;videoController.currentChapter.tasks[0].modifyDate&&(s=videoController.currentChapter.tasks[0].modifyDate);for(i=1;i<r;i++)videoController.currentChapter.tasks[i].modifyDate&&videoController.currentChapter.tasks[i].modifyDate>s&&(n=i,s=videoController.currentChapter.tasks[i].modifyDate);videoController.lasttaskindex=n}else if(4==videoController.indexList.length&&"t"==videoController.indexList[0])videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]].children[videoController.indexList[2]],videoController.lasttaskindex=videoController.indexList[3];else if(2==videoController.indexList.length&&"c"==videoController.indexList[0]){videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]];r=videoController.currentChapter.tasks.length,n=0,s=0;videoController.currentChapter.tasks[0].modifyDate&&(s=videoController.currentChapter.tasks[0].modifyDate);for(i=1;i<r;i++)videoController.currentChapter.tasks[i].modifyDate&&videoController.currentChapter.tasks[i].modifyDate>s&&(n=i,s=videoController.currentChapter.tasks[i].modifyDate);videoController.lasttaskindex=n}else{if(3!=videoController.indexList.length||"t"!=videoController.indexList[0])return void(window.location.href="#/courseIndex/"+e);videoController.currentChapter=videoController.courseData.chapters[videoController.indexList[1]],videoController.lasttaskindex=videoController.indexList[2]}if(videoController.taskId)for(i=0;i<videoController.currentChapter.tasks.length;i++)videoController.currentChapter.tasks[i].taskId==videoController.taskId&&(videoController.lasttaskindex=i);CAICUI.render.taskIndex=videoController.lasttaskindex,videoController.currentTask=videoController.currentChapter.tasks[videoController.lasttaskindex],CAICUI.render.chapterName=videoController.currentChapter.chapterTitle,CAICUI.render.taskCount=videoController.currentChapter.tasks.length,CAICUI.render.taskCurrent=videoController.lasttaskindex;var a="",l=0,d=!1;if(CAICUI.render.knowledgePointId=videoController.currentChapter.knowledgePointId,CAICUI.render.knowledgepointid=videoController.currentChapter.knowledgePointId,CAICUI.render.knowledgePointId&&(d=!0,videoController.exercisePointCountCacheAjax(CAICUI.render.knowledgePointId,function(e){CAICUI.CACHE.exercisePointCountCache=e,l++})),CAICUI.render.knowledgePointId&&(d=!0,videoController.exerciseKnowledgeMemberStatusAjax(CAICUI.render.knowledgePointId,function(e){CAICUI.CACHE.exerciseKnowledgeMemberStatus=e,l++})),d)a=setInterval(function(){if(2==l){if(clearInterval(a),"openCourse"==videoController.currentTask.taskType){var e=(new Date).getTime();e<1e3*videoController.currentTask.openCourseStartTime?1:1e3*videoController.currentTask.openCourseStartTime<e&&e<1e3*videoController.currentTask.openCourseEndTime?2:1e3*videoController.currentTask.openCourseEndTime<e&&(3,""!=videoController.currentTask.openCourseCcid&&""!=videoController.currentTask.openCourseSiteId&&(videoController.currentTask.taskTypeOld="openCourse",videoController.currentTask.taskType="video",videoController.currentTask.videoCcid=videoController.currentTask.openCourseCcid,videoController.currentTask.videoSiteId=videoController.currentTask.openCourseSiteId))}videoController.initDom()}},300);else{if("openCourse"==videoController.currentTask.taskType){var c=(new Date).getTime();c<1e3*videoController.currentTask.openCourseStartTime?1:1e3*videoController.currentTask.openCourseStartTime<c&&c<1e3*videoController.currentTask.openCourseEndTime?2:1e3*videoController.currentTask.openCourseEndTime<c&&(3,""!=videoController.currentTask.openCourseCcid&&""!=videoController.currentTask.openCourseSiteId&&(videoController.currentTask.taskTypeOld="openCourse",videoController.currentTask.taskType="video",videoController.currentTask.videoCcid=videoController.currentTask.openCourseCcid,videoController.currentTask.videoSiteId=videoController.currentTask.openCourseSiteId))}videoController.initDom(),clearInterval(a)}}else window.location.href="#/courseIndex/"+e},initCourseActiveState:function(e){for(var o=0,r=0;r<e.length;r++)0==e[r].lockStatus&&o++;o||(CAICUI.render.lockStatus=!0),videoController.courseByInFo(e)},courseActiveState:function(e,o){CAICUI.render.formCourseStudy&&CAICUI.CACHE.coursestatus?(videoController.initCourseActiveState(CAICUI.CACHE.coursestatus),o&&o()):CAICUI.Request.ajax({server:"coursestatus",data:{token:CAICUI.User.token,versionId:e},done:function(e){"success"==e.state?(videoController.initCourseActiveState(e.data),o&&o()):(n.msg("Sorry~ 获取课程授权信息失败，请刷新页面重试。",function(){}),course.courseActiveState=999)}})},courseByInFo:function(o){var r=0;if(e.isArray(o))for(var n=Date.parse(new Date)/1e3,s=0;s<o.length;s++){if("acitve"==o[s].activeState&&o[s].expirationTime>n&&r<3){r=3;break}"init"==o[s].activeState&&r<2?r=2:"acitve"==o[s].activeState&&o[s].expirationTime<n&&r<1&&(r=1)}r&&CAICUI.render.lockStatus&&(r=4),videoController.courseData.courseActiveState=r,t.setsingle("course-"+videoController.courseId,videoController.courseData)},addAnimate:function(o){var r=e(window).width(),t=e(window).height();e("body").prepend('<div id="animate" style="width:'+r+'px;"></div>'),e("#animate").animate({height:t,top:"0"},300,function(){o&&o()})},removeAnimate:function(o){e("#animate").animate({height:"0",top:"50%"},300,function(){e("#animate").remove(),o&&o()})},tasksStars:function(o){var r=e(this),t=(r.index(),r.prevAll()),n=r.nextAll(),s=r.siblings();"mouseenter"==o.type?(t.addClass("active"),r.addClass("active"),n.removeClass("active")):"mouseleave"==o.type&&(s.removeClass("active"),r.removeClass("active"))},tasksStarsMouseenter:function(){e(this).index()},taskNext:function(){var o=e(this);if(o.hasClass("no-next"))return!1;videoController.cc_taskStatus(),CAICUI.render.action="changenexttask",videoController.saveProgress();var r=videoController.lasttaskindex+1;videoController.lasttaskindex=r;var t=e("body .studycenter-video-task-a").length;if(console.log(r),console.log(t),r==t){o.addClass("no-next"),e("body .js-studycenter-video-task-end").trigger("click");var n=0;e(".studycenter-video-task-a").each(function(){e(this).hasClass("task-done")&&n++}),n==t&&(e(".studycenter-video-tasks-center").addClass("active"),e(".video-icon-task-next").hide())}else e(".studycenter-video-task-a").eq(r).trigger("click")},tasksIsEnd:function(){var o=e(this);clearInterval(videoController.slideIntervalstop),e("body .studycenter-video-task-next").addClass("no-next box-visibility"),o.siblings().removeClass("active"),o.addClass("active"),e("body .studycenter-video-tasks-center").removeClass("hidden"),e("body .studycenter-video-tasks-unfinished").addClass("hidden"),e("body .studycenter-video-tasks-finished").addClass("hidden");for(var r=!0,t=0;t<videoController.currentChapter.tasks.length;t++)"0"==videoController.currentChapter.tasks[t].progressstate&&(r=!1);r?e(".studycenter-video-tasks-finished").removeClass("hidden"):e(".studycenter-video-tasks-unfinished").removeClass("hidden"),videoController.cc_pause()},taskChange:function(o){var r=(t=CAICUI.iGlobal.getThat(o)).attr("data-index");if(CAICUI.render.taskIndex==r){if(e("body .js-studycenter-video-task-end").hasClass("active"))return e("body .studycenter-video-tasks-center").addClass("hidden"),e("body .studycenter-video-tasks-finished").addClass("hidden"),e("body .studycenter-video-tasks-unfinished").addClass("hidden"),videoController.cc_play(),!1}else{if(CAICUI.render.QuestionsExtend&&CAICUI.render.QuestionsExtend.clearInitData(),videoController.cc_taskStatus(),0==videoController.playerType);else if(2==videoController.playerType)WINAPI.SetPlayerHide(1),WINAPI.SetPlayerPause();else if(3==videoController.playerType){cc_winplayer.SetIframePlayerHide(1);cc_winplayer.sendMessageToIframe(JSON.stringify({type:101}))}var t;if((t=e(this)).hasClass("active"))return!1;clearInterval(videoController.saveVideoProgressSetinterval),CAICUI.render.openCourse="",CAICUI.render.openCourseVideo=!1,CAICUI.render.myExamContinue={},CAICUI.render.viewResolution=!1,e("body .studycenter-video-task-next").removeClass("no-next"),clearInterval(videoController.slideIntervalstop),CAICUI.render.action="changetask",videoController.saveProgress(),t.siblings().removeClass("active"),e("studycenter-video-task-next").removeClass("box-visibility"),t.addClass("active"),e(".studycenter-video-tasks-center").addClass("hidden"),videoController.lasttaskindex=parseInt(e(t).attr("data-index")),videoController.currentTask=videoController.currentChapter.tasks[videoController.lasttaskindex],window.location.hash="#video/"+videoController.courseId+"/"+videoController.chapterId+"/"+videoController.currentTask.taskId+"?return_link=courseStudy/"+videoController.courseId+"&return_hash=on"}},taskMouseEnter:function(o){var r=e(this),t=parseInt(r.attr("data-index")),n=r.attr("id"),s=r.offset(),i=s.left-5,a=s.top+25,l=e("body #task-tips"),d=videoController.getTaskInfo(n,t);l.find(".task-tips-icon").attr("class",d.taskIcon),l.find(".task-tips-title").text(d.taskTitle),l.find(".task-tips-number").text(d.taskNum),l.css({display:"inline-block",top:a,left:i})},taskMouseLeave:function(){e("body #task-tips").css({display:"none",top:0,left:0})},getTaskInfo:function(e,o){var r=videoController.currentChapter.tasks[o],t="task-tips-icon task-tips-icon-no",n=r.title,s=0;if("video"==r.taskType){CAICUI.CACHE.getTasksProgress;"1"==r.state?(t="task-tips-icon task-tips-icon-done",s=videoController.formatSeconds(r.videoTime)):"0"==r.state?(t="task-tips-icon task-tips-icon-ing",s=videoController.formatSeconds(r.videoTime)):(t="task-tips-icon task-tips-icon-no",s=videoController.formatSeconds(r.videoTime))}else if("exam"==r.taskType){var i=0,a=0;for(var l in CAICUI.CACHE.getTasksProgress)CAICUI.CACHE.getTasksProgress[l].taskId==e&&(a=CAICUI.CACHE.getTasksProgress[l].progress);(i=(i=a)>r.totalCount?r.totalCount:i)&&(t=i==r.totalCount?"task-tips-icon task-tips-icon-done":"task-tips-icon task-tips-icon-ing"),s=r.totalCount}else if("openCourse"==r.taskType)s="";else if("knowledgePointExercise"==r.taskType){if(CAICUI.CACHE.exercisePointCountCache){for(l=0;l<CAICUI.CACHE.exercisePointCountCache.length;l++){var d=CAICUI.CACHE.exercisePointCountCache[l];videoController.currentChapter.knowledgePointId==d.knowledge_point_id&&(CAICUI.render.exerciseCount=d.exercise_count)}for(l=0;l<CAICUI.CACHE.exerciseKnowledgeMemberStatus.length;l++){d=CAICUI.CACHE.exerciseKnowledgeMemberStatus[l];videoController.currentChapter.knowledgePointId==d.knowledge_point_id&&(CAICUI.render.ExerciseProgress=d.progress)}CAICUI.render.ExerciseProgress||(CAICUI.render.ExerciseProgress=0),CAICUI.render.ExerciseProgress&&(t=CAICUI.render.ExerciseProgress==CAICUI.render.exerciseCount?"task-tips-icon task-tips-icon-done":"task-tips-icon task-tips-icon-ing")}s=CAICUI.render.exerciseCount}return{taskIcon:t,taskTitle:n,taskNum:s}},initDom:function(){var r=o.template(e("#video").html());e("body #studycenter-video").html(r({isEnd:CAICUI.render.isEnd,courseId:videoController.courseData.courseId,chapterId:videoController.currentChapter.chapterId,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,taskIndex:videoController.lasttaskindex,taskData:videoController.currentChapter})),videoController.initView(),videoController.initEvent(),videoController.initPower(),videoController.realUpdateProgress(),CAICUI.render.formCourseStudy&&CAICUI.CACHE.getTasksProgress?videoController.initTasksProgress(CAICUI.CACHE.getTasksProgress):CAICUI.Request.ajax({server:"actionGetTasksProgress",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,courseId:CAICUI.render.courseId},done:function(e){CAICUI.CACHE.getTasksProgress=e.data,videoController.initTasksProgress(CAICUI.CACHE.getTasksProgress)},fail:function(e){}})},initTasksProgress:function(r){CAICUI.render.studyTime=0,CAICUI.render.taskStudyTotalTime=0;for(var t=0;t<videoController.currentChapter.tasks.length;t++)o.each(r,function(o,r){o.taskId==videoController.currentChapter.tasks[t].taskId&&("1"==o.state&&(e("#"+o.taskId).removeClass(["active"]),e("#"+o.taskId).addClass("task-done")),CAICUI.render.studyTime=o.studyTime,CAICUI.render.taskStudyTotalTime=o.taskStudyTotalTime)});setTimeout(function(){"video"==videoController.currentTask.taskType&&(CAICUI.render.action="beginplay",videoController.saveProgress("init"))},30)},initView:function(){e(".studycenter-video-right-content").slimScroll({height:"100%",railOpacity:.4,wheelStep:10}),e("#playCtr").css("width","100%")},initPower:function(){var e=videoController.currentChapter.tasks[videoController.lasttaskindex];if("true"==videoController.currentChapter.isFree)videoController.cc_taskStatus(),videoController.showTask(e.taskType,e);else{if(4==videoController.courseData.courseActiveState)return videoController.payInfoDialog=n.confirm("你购买的此课程已锁定",{icon:3,closeBtn:!1},function(e){CAICUI.NavVideo=!0,CAICUI.domRender=!0,videoController.videoClose("courseActivated")},function(){videoController.videoClose()}),!1;if(3!=videoController.courseData.courseActiveState)return 2==videoController.courseData.courseActiveState?(videoController.payInfoDialog=n.confirm("你购买的该课程还没激活",{icon:3,closeBtn:!1},function(e){CAICUI.NavVideo=!0,CAICUI.domRender=!0,videoController.videoClose("courseNotActivated")},function(){videoController.videoClose()}),!1):1==videoController.courseData.courseActiveState?(videoController.payInfoDialog=n.confirm("你购买的此课程已过期",{icon:3,closeBtn:!1},function(e){CAICUI.NavVideo=!0,CAICUI.domRender=!0,videoController.videoClose("courseActivated")},function(){videoController.videoClose()}),!1):(videoController.payInfoDialog=n.confirm("你还没有购买此课程,现在购买？",{icon:3,closeBtn:!1},function(e){window.location.href=window.zbgedu.origin},function(){videoController.videoClose()}),!1);videoController.cc_taskStatus(),videoController.showTask(e.taskType,e)}},closeTask:function(){if(CAICUI.render.openCourse="",CAICUI.render.openCourseVideo=!1,CAICUI.render.myExamContinue={},CAICUI.render.viewResolution=!1,n.close(videoController.payInfoDialog),0==videoController.playerType);else if(2==videoController.playerType)WINAPI.SetPlayerHide(1),WINAPI.SetPlayerPause();else if(3==videoController.playerType){cc_winplayer.SetIframePlayerHide(1);cc_winplayer.sendMessageToIframe(JSON.stringify({type:101}))}e("#studycenter-video").remove(),videoController.removeAnimate(),CAICUI.render.action="closetask",videoController.saveProgress(),clearInterval(videoController.slideIntervalstop),clearInterval(videoController.saveVideoProgressSetinterval)},videoClose:function(e){videoController.closeTask();var o="";o=e||CAICUI.iGlobal.getUrlPara("return_link"),CAICUI.render.QuestionsExtend&&CAICUI.render.QuestionsExtend.exit(),"on"==CAICUI.iGlobal.getUrlPara("return_hash")?(CAICUI.render.thisCourseIndex&&(CAICUI.isNoneRender=!0,CAICUI.NavVideo=!1),window.location.hash=o):window.location.href=o},initEvent:function(){e(".openCourse-return").on("click",function(){videoController.videoClose()}),e(".openCourse-reservation-state").on("click",videoController.openCourseReservation),e(".js-studycenter-video-task-end").on("click",videoController.tasksIsEnd),e(".studycenter-video-tasks-stars").on("click mouseenter",videoController.tasksStars),e(".video-icon-task-courselist").on("click",function(){videoController.videoClose()}),e(".video-icon-task-continue").on("click",videoController.continuetask),e(".studycenter-video-task-a").on("click",videoController.taskChange),e(".studycenter-video-task-a").on("mouseenter",videoController.taskMouseEnter),e(".studycenter-video-task-a").on("mouseleave",videoController.taskMouseLeave),e(".studycenter-video-task-next").on("click",videoController.taskNext),e(".js-close-sidebar").on("click",videoController.closeSidebar),e(".js-open-sidebar").on("click",videoController.openSidebar),e(".js-handout-down-video").on("click",videoController.handoutDown),e(".speedCtrBtn").on("click",function(){var o=e(this).attr("data-speed");WINAPI.SetPlaySpeed(o),e(".speedCtrBtn").removeClass("active"),e(this).addClass("active")}),e(".soundIos").on("click",videoController.videoSound),e("#volumeCtrly").slider({orientation:"vertical",value:"50",range:"min",animate:"fast",max:100,change:function(o,r){if(r.value>0){if(e(this).parents(".volumeCtr").prev(".soundIos").html('<i class="glyphicon glyphicon-volume-down"></i>'),0==videoController.playerType)videoController.cc_setVolume(r.value/100);else if(2==videoController.playerType)WINAPI.SetPlayerVolume(120*r.value/100);else if(3==videoController.playerType){var t={type:110,data:{volume:r.value/100}};cc_winplayer.sendMessageToIframe(JSON.stringify(t))}}else if(0==r.value)if(e(this).parents(".volumeCtr").prev(".soundIos").html('<i class="glyphicon glyphicon-volume-off"></i>'),0==videoController.playerType)videoController.cc_setVolume(0);else if(2==videoController.playerType)WINAPI.SetPlayerVolume(0);else if(3==videoController.playerType){t={type:110,data:{volume:0}};cc_winplayer.sendMessageToIframe(JSON.stringify(t))}}}),videoController.playController(),e(".plays").on("click",function(){if(e(this).hasClass("glyphicon-pause")){if(e(this).addClass("glyphicon-play").removeClass("glyphicon-pause"),0==videoController.playerType)videoController.cc_pause();else if(2==videoController.playerType)WINAPI.SetPlayerPause();else if(3==videoController.playerType){var o={type:101};cc_winplayer.sendMessageToIframe(JSON.stringify(o))}}else if(e(this).addClass("glyphicon-pause").removeClass("glyphicon-play"),0==videoController.playerType)videoController.cc_play();else if(2==videoController.playerType)WINAPI.SetPlayerPlay();else if(3==videoController.playerType){o={type:102};cc_winplayer.sendMessageToIframe(JSON.stringify(o))}}),e(".js-save-quiz").on("click",function(){videoController.saveNoteAndQuiz(this,"quiz")}),e(".js-save-note").on("click",function(){videoController.saveNoteAndQuiz(this,"note")}),e(".node-editor-cancel").on("click",videoController.closeSidebar),e(".node-editor-confirm").on("click",function(){var o=e("#node-editor-textarea").val();if(!o)return n.msg("Sorry~ 请输入内容！",function(){}),!1;if(videoController.courseNode.imgPath="",videoController.courseNode.imgPathArray.length)for(var r=0;r<videoController.courseNode.imgPathArray.length;r++)videoController.courseNode.imgPath+=r?","+videoController.courseNode.imgPathArray[r]:videoController.courseNode.imgPathArray[r];else videoController.courseNode.imgPath="";CAICUI.Request.ajax({server:"nodesave",data:{token:CAICUI.User.token,id:"",content:o,clientType:CAICUI.render.clientType,title:videoController.currentChapter.tasks[videoController.lasttaskindex].title,isPublic:videoController.courseNode.isPublic,courseId:videoController.courseData.courseId,subjectId:videoController.courseData.subjectId,categoryId:videoController.courseData.categoryId,chapterId:videoController.currentChapter.chapterId,subjectName:videoController.courseData.subjectName,categoryName:videoController.courseData.categoryName,courseName:videoController.courseData.courseName,chapterName:videoController.currentChapter.chapterTitle,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,taskName:videoController.currentChapter.tasks[videoController.lasttaskindex].title,taskProgress:parseInt(videoController.currentChapter.tasks[videoController.lasttaskindex].progress),taskType:videoController.currentChapter.tasks[videoController.lasttaskindex].taskType,imgPath:videoController.courseNode.imgPath,clientType:"pc"},done:function(o){"success"==o.state&&(n.close(videoController.load),n.msg("保存成功！",{shade:!0,icon:1,time:500},function(){videoController.closeSidebar(),e(".right-title-input").val("")}))},fail:function(e){n.msg("Sorry~ 笔记保存失败",function(){})}})}),e(".add-photo-box").on("click",".add-photo-remove",videoController.addPhotoRemove),e("#uploadForm-file").on("change",function(){CAICUI.iGlobal.fileUpload({formClass:"uploadForm"},function(e){CAICUI.iGlobal.fileUploadAddList("uploadForm",e)})}),e(".node-editor-isOpen").on("click",".node-editor-isOpen-button",function(e){var o=CAICUI.iGlobal.getThat(e),r=o.prev();o.hasClass("active")?(o.removeClass("active"),r.text("私有"),videoController.courseNode.isPublic=1):(o.addClass("active"),r.text("公开"),videoController.courseNode.isPublic=0)}),e("body .js-correction").on("click",videoController.openFeedbackPop),document.onkeyup=function(e){e=e||window.event;var o=videoController.currentTask.progress;if(o){var r=0,t=0;"video"==videoController.currentTask.taskType&&(t=parseInt(videoController.currentTask.videoTime)),37==e.keyCode?(r=o-5)?videoController.cc_seek(r):videoController.cc_seek(0):39==e.keyCode&&((r=o+5)>t?videoController.cc_seek(t):videoController.cc_seek(r))}}},openFeedbackPop:function(){videoController.cc_pause(),CAICUI.render.feedbackType=["无法播放","音画不同步","播放卡顿","内容错误","其他错误"];var r=o.template(e("#template-feedback-video").html());e("body").append(r({currentTask:videoController.currentTask,feedbackType:CAICUI.render.feedbackType})),CAICUI.Request.ajax({server:"member",data:{token:CAICUI.User.token},done:function(o){"success"==o.state?(CAICUI.render.member=o.data,e("body .pop-input-tel").val(CAICUI.render.member.mobile?CAICUI.render.member.mobile:CAICUI.render.member.email)):console.log("member:"+o)},fail:function(e){console.log("member:"+e)}}),videoController.feedbackAnimate(".pop-html"),videoController.feedbackEvent()},feedbackAnimate:function(o){e(o).animate({opacity:1},1e3)},feedbackEvent:function(){var o=e("#help-feedback-pop");o&&(o.on("click",".pop-radio-label",function(){var o=e(this);o.siblings().removeClass("active"),o.addClass("active")}),o.on("focus",".pop-textarea",function(){e(this).removeAttr("placeholder")}),o.on("blur",".pop-textarea",function(){e(this).attr("placeholder",CAICUI.Common.correctionPlaceholder)}),o.on("click",".pop-button-confirm",function(){var o=e(".pop-radio-label.active").index(),r=CAICUI.render.feedbackType[o],t=e(".pop-textarea").val();if(t){var s=videoController.currentTask,i={categoryName:videoController.courseData.categoryName,categoryId:videoController.courseData.categoryId,subjectName:videoController.courseData.subjectName,subjectId:videoController.courseData.subjectId,courseName:videoController.courseData.courseName,courseId:videoController.courseData.courseId,chapterName:videoController.currentChapter.chapterTitle,chapterName:videoController.currentChapter.chapterName,taskName:videoController.currentTask.title,taskId:videoController.currentTask.taskId,id:videoController.currentTask.videoCcid},a="";a+='<a class="content-addDom" data-nameJson="'+JSON.stringify(i)+'" href="javascript:;" data-course-id="'+videoController.courseId+'" data-chapter-id="'+videoController.chapterId+'" data-task-id="'+s.taskId+'" ',a+='data-type="video" data-title="'+s.title+'" data-video-ccid="'+s.videoCcid+'" data-video-siteid="'+s.videoSiteId+'" data-progress="'+s.progress+'" data-video-time="'+s.videoTime+'"',a+=">视频："+CAICUI.iGlobal.formatSeconds(s.progress)+"</a>",console.log(a),t+=a;var l=e(".pop-input-tel").val();if(l){var d="MacIntel"==navigator.platform?"苹果":"",c=navigator.userAgent.split(" "),C=(c.length,c[c.length-2].split("/")[0]+"-"+c[c.length-1].split("/")[0]);videoController.feedbackAjax({memberId:CAICUI.User.memberId,memberName:CAICUI.User.nickname,cmptType:r,cmptContent:t,contactWay:l,deviceDesc:d+" "+C})}else n.msg("Sorry~ 请输入联系方式！",function(){})}else n.msg("Sorry~ 请输入内容！",function(){})}),o.on("click",".pop-button-cancel",function(){o.remove(),o.off(),videoController.cc_play()}))},feedbackAjax:function(o){CAICUI.Request.ajax({server:"addLMG",data:o,done:function(o){e(".pop-html").remove(),n.msg("提交成功",{icon:1,time:1e3},function(){e("#help-feedback-pop").remove(),e("#help-feedback-pop").off(),videoController.cc_play()})},fail:function(e){n.msg("Sorry~ ",function(){videoController.cc_play()})}})},addPhotoRemove:function(o){console.log(4);for(var r=CAICUI.iGlobal.getThat(o),t=(r.prev(),r.attr("data-src")),n=0;n<videoController.courseNode.imgPathArray.length;n++)if(videoController.courseNode.imgPathArray[n]==t){videoController.courseNode.imgPathArray.splice(n,1);break}r.parent().remove(),e("body .add-photo-show").length<5&&e("body #uploadForm").show()},saveNoteAndQuiz:function(o,t){var s=e(o).parents(".contentText").find("textarea"),i=s.val(),a=e(o).parents(".contentText").find(".right-time").html();if("video"==this.taskType)if(a.indexOf(":")>0){var l=a.split(":");a=0,2==l.length?a=parseInt(l[1])+60*parseInt(l[0]):3==l.length&&(a=parseInt(l[2])+60*parseInt(l[1])+60*parseInt(l[0])*60)}else a=parseInt(a);else"exam"==this.taskType&&(a=(a=a.replace(/第/g,"")).replace(/题/g,""),a=parseInt(a));if(""==i)return n.msg("内容不能为空",function(){}),!1;if(videoController.courseNode.imgPath="",videoController.courseNode.imgPathArray.length)for(var d=0;d<videoController.courseNode.imgPathArray.length;d++)videoController.courseNode.imgPath+=d?","+videoController.courseNode.imgPathArray[d]:videoController.courseNode.imgPathArray[d];else videoController.courseNode.imgPath="";var c={token:CAICUI.User.token,content:i,categoryId:videoController.courseData.categoryId,subjectId:videoController.courseData.subjectId,courseId:videoController.courseData.courseId,chapterId:videoController.currentChapter.chapterId,taskId:videoController.currentChapter.tasks[videoController.lasttaskindex].taskId,categoryName:videoController.courseData.categoryName,subjectName:videoController.courseData.subjectName,courseName:videoController.courseData.courseName,chapterName:videoController.currentChapter.chapterTitle,taskName:videoController.currentChapter.tasks[videoController.lasttaskindex].title,taskProgress:parseInt(videoController.currentChapter.tasks[videoController.lasttaskindex].progress),taskType:videoController.currentChapter.tasks[videoController.lasttaskindex].taskType,imgPath:videoController.courseNode.imgPath,clientType:"pc"};if("quiz"==t){c.title=e(o).parents(".contentText").find(".right-title-input").val(),c.task=videoController.currentChapter.tasks[videoController.lasttaskindex].title;var C="studytools/questionsave";if(""==c.title)return n.msg('"标题不能为空',function(){}),!1}else if("note"==t){c.title="笔记",c.isPublic=e(o).parents(".contentText").find('div.imgUpLoad input[type="checkbox"]').is(":checked")?0:1;C="studytools/nodesave"}videoController.load=n.load(1,{shade:[.5,"#000"]}),r.ajax({version:"2.1",server:C,type:"POST",data:c,done:function(o){"success"==o.state&&(n.close(videoController.load),n.msg("保存成功！",{shade:!0,icon:1,time:500},function(){videoController.closeSidebar(),e(".right-title-input").val(""),s.val("")}))},fail:function(e){n.msg("Sorry~ 笔记保存失败",function(){})}}),imgPath=""},showTask:function(r,t){if(CAICUI.render.isEnd)return e("body .studycenter-video-task-next").addClass("no-next box-visibility"),e("body .studycenter-video-task-a").siblings().removeClass("active"),e("body .studycenter-video-tasks-center").removeClass("hidden"),e("body .studycenter-video-tasks-unfinished").addClass("hidden"),e("body .studycenter-video-tasks-finished").addClass("hidden"),e("body .js-studycenter-video-task-end").addClass("active"),"true"==CAICUI.render.isEnd?e("body .studycenter-video-tasks-finished").removeClass("hidden"):"false"==CAICUI.render.isEnd&&e("body .studycenter-video-tasks-unfinished").removeClass("hidden"),e("body .studycenter-video-main").remove(),!1;switch(this.currenttaskType=r,r){case"video":e(".ctrLeft1").show(),e(".video-play").show(),e(".myExercises").hide(),e(".ctrLeft2").hide(),this.doVideo();break;case"exam":CAICUI.render.examId=t.id,CAICUI.render.examName=t.title,CAICUI.render.knowledgepointName=t.title,CAICUI.render.examExpress="1",t.express&&(CAICUI.render.examExpress=t.express),CAICUI.render.errorNum=0,CAICUI.render.lastExerciseNid=0,CAICUI.render.ExerciseProgress=0,CAICUI.render.ExerciseTotalTime=0,CAICUI.render.cacheKnowledgeLevel1Id=CAICUI.render.courseId,CAICUI.render.cacheKnowledgeLevel2Id=t.taskId,CAICUI.render.cacheKnowledgePath=CAICUI.render.courseId+","+t.taskId,e(".studycenter-video-main").remove(),videoController.exerciseKnowledgeMemberStatusAjax(CAICUI.render.examId,function(r){if(console.log(r),CAICUI.render.myExamContinue&&CAICUI.render.myExamContinue.examenNum)CAICUI.render.examenNum=CAICUI.render.myExamContinue.examenNum,CAICUI.render.isFinish=r[0].is_finish,CAICUI.render.errorNum=+r[0].error_num,CAICUI.render.lastExerciseNid=+r[0].last_exercise_nid;else if(r&&r.length){var n=o.max(r,function(e){return e.examenNum});n&&("core"==t.taskLevel?"0"==n.is_finish?CAICUI.render.examenNum=n.examenNum:"1"==n.is_finish&&(CAICUI.render.examenNum=parseInt(n.examenNum)+1):CAICUI.render.examenNum=parseInt(n.examenNum)+1)}console.log(t),"core"==t.taskLevel?(e("body .studycenter-video-task-content").addClass("hidden"),CAICUI.render.QuestionsExtend=new l,CAICUI.render.QuestionsExtend.render(CAICUI.render.examId)):(CAICUI.render.QuestionsExtend=new a,CAICUI.render.QuestionsExtend.render(CAICUI.render.examId))}),videoController.exercisePege();break;case"openCourse":console.log(t),"core"==t.taskLevel&&e("body .studycenter-video-task-content").addClass("hidden"),CAICUI.render.openCourseVideo?(e(".ctrLeft1").show(),e(".video-play").show(),e(".myExercises").hide(),e(".ctrLeft2").hide(),this.doVideo()):(CAICUI.render.openCourse=t,e(".studycenter-video-main").remove(),e(".studycenter-task-openCourse").removeClass("hidden"),videoController.getAppointmentState());break;case"knowledgePointExercise":if(console.log(t),console.log(CAICUI.CACHE.exercisePointCountCache),t.id&&CAICUI.CACHE.exercisePointCountCache){CAICUI.render.knowledgepointName=t.title;for(var s=0;s<CAICUI.CACHE.exercisePointCountCache.length;s++){var d=CAICUI.CACHE.exercisePointCountCache[s];videoController.currentChapter.knowledgePointId==d.knowledge_point_id&&(CAICUI.render.cacheKnowledgeLevel1Id=d.knowledge_path_level_one_id,CAICUI.render.cacheKnowledgeLevel2Id=d.knowledge_path_level_two_id,CAICUI.render.cacheKnowledgePath=d.knowledge_path_level_one_id+","+d.knowledge_path_level_two_id,CAICUI.render.exerciseFilename=d.exercise_filename,CAICUI.render.exerciseCount=d.exercise_count)}var c="";for(s=0;s<CAICUI.CACHE.exerciseKnowledgeMemberStatus.length;s++){d=CAICUI.CACHE.exerciseKnowledgeMemberStatus[s];videoController.currentChapter.knowledgePointId==d.knowledge_point_id&&(c=d)}c?(CAICUI.render.errorNum=d.error_num,CAICUI.render.lastExerciseNid=d.last_exercise_nid,CAICUI.render.ExerciseProgress=d.progress,CAICUI.render.ExerciseTotalTime=d.total_time):(CAICUI.render.errorNum=0,CAICUI.render.lastExerciseNid=0,CAICUI.render.ExerciseProgress=0,CAICUI.render.ExerciseTotalTime=0),e(".studycenter-video-main").remove(),CAICUI.render.QuestionsExtend=new i,CAICUI.render.QuestionsExtend.render()}else n.msg("sorry~没有知识点~",{time:3e3},function(){})}},exercisePointCountCacheAjax:function(e,o){CAICUI.Request.ajax({server:"exercisePointCountCache",data:{knowledge_points:e,type:4},done:function(e){o&&o(e.data)}})},exerciseKnowledgeMemberStatusAjax:function(e,o){var r="";CAICUI.render.myExamContinue&&(r=CAICUI.render.myExamContinue.examenNum),CAICUI.Request.ajax({server:"get_exercise_knowledge_member_status",data:{knowledge_points:e,type:4,member_id:CAICUI.User.memberId,examenNum:r},done:function(e){e&&e.data&&e.data.length?CAICUI.render.exerciseDoneCount=e.data[0].progress:CAICUI.render.exerciseDoneCount=0,o&&o(e.data)}})},getExerciseIds:function(e,o){CAICUI.Request.ajax({server:"getExerciseIds",data:{examenId:e},done:function(e){o&&o(e.data)}})},getAppointmentState:function(o){var r=0;if(CAICUI.render.openCourse){var t=(new Date).getTime();t<1e3*CAICUI.render.openCourse.openCourseStartTime?r=1:1e3*CAICUI.render.openCourse.openCourseStartTime<t&&t<1e3*CAICUI.render.openCourse.openCourseEndTime?r=2:1e3*CAICUI.render.openCourse.openCourseEndTime<t&&(r=3)}var n="",s="";switch(r){case 1:s="直播未开始";break;case 2:n="openCourse-reservation-enter",s="进入直播间";break;case 3:s="直播已结束";var i=CAICUI.render.openCourse.openCourseCcid,a=CAICUI.render.openCourse.openCourseSiteId;if(i&&""!=i&&a&&""!=a)return n="openCourse-reservation-video",s="直播回顾",CAICUI.render.openCourseVideo=!0,videoController.initDom(),!1;s="直播已结束";break;case 4:n="openCourse-reservation-open",s="课程已预约";break;case 5:n="openCourse-reservation-btn",s="预约报名"}e("body .studycenter-task-openCourse .loader-box").remove(),e("body .openCourse-reservation-state").addClass(n).html(s)},openCourseReservation:function(){var o=e(this);if(o.hasClass("openCourse-reservation-btn"))CAICUI.Request.ajax({server:"appointClick",data:{memberId:CAICUI.User.memberId,openCourseId:CAICUI.render.openCourse.id},done:function(o){"success"==o.state?(e("body .openCourse-reservation-state").removeClass("openCourse-reservation-btn").addClass("openCourse-reservation-open").text("课程已预约"),CAICUI.render.registrationAddress&&setTimeout(function(){window.open(CAICUI.render.registrationAddress)},300)):n.msg("Sorry~ "+o.msg,function(){})}});else if(o.hasClass("openCourse-reservation-open"))CAICUI.render.registrationAddress&&setTimeout(function(){window.open(CAICUI.render.registrationAddress)},300);else if(o.hasClass("openCourse-reservation-enter")){var r="";if(CAICUI.render.openCourse){var t=CAICUI.render.openCourse.openCourseLiveRoomId,s=CAICUI.render.openCourse.openCourseLiveManageId,i=CAICUI.render.openCourse.openCourseLiveRoomPassword;t&&s?(i?(r="https://view.csslcloud.net/api/view/login?",r+="roomid="+t,r+="&userid="+s,r+="&autoLogin=true",CAICUI.User.nickname&&""!=CAICUI.User.nickname?r+="&viewername="+CAICUI.User.nickname:r+="&viewername="+CAICUI.User.memberId,r+="&viewertoken="+i):(r="liveIframe.html?",r+="roomid="+t,r+="&userid="+s,r+="&version="+window.version),e("body .js-openCourse-main").addClass("hidden"),e("body #openCourse-iframe").attr("src",r),e("body #openCourse-iframe").removeClass("hidden")):CAICUI.render.registrationAddress&&setTimeout(function(){window.open(CAICUI.render.registrationAddress)},300)}else n.msg("Sorry~ 暂时不能进入直播间，请联系客服。",function(){})}else o.hasClass("openCourse-reservation-video")&&(CAICUI.render.openCourseVideo=!0,videoController.initDom())},doVideo:function(){if(this.player=null,nowcc_vid="",nowcc_objectID="","exe"==window.clientType){if(parseInt(1[5])>99){videoController.playerType=2;var o=WINAPI.GetProjectPath("#")+"playcode.txt";if(WINAPI.GetFileSize(o))if(1e5<WINAPI.GetFileSize(WINAPI.GetProjectPath()+"mainfile#download#"+parseInt(1[0])+".caicui"))"true"==(r=cc_winplayer.beginPlay(WINAPI.GetProjectPath()+"mainfile#download#"+parseInt(1[0])+".caicui",1))||1==r||(e(".video-play div.content").show(),e(".video-play div.content").html("<p style='color:#dddddd;text-align:left;margin-left:8px;'>您的授权已失效，无法播放缓存的视频文件。<br/>如有疑问，请联系客服。</p>"));else e(".video-play div.content").show(),e(".video-play div.content").html("<p style='color:#dddddd;text-align:left;margin-left:8px;'>您缓存的视频文件已不存在，请删除重新下载。<br/>如有疑问，请联系客服。</p>");else e(".video-play div.content").show(),e(".video-play div.content").html("<p style='color:#dddddd;text-align:left;margin-left:8px;'>您下载的财萃课堂还没有获得授权，无法播放本地缓存的视频文件。<br/>通常您的账号在第一次登录后的24小时之内自动获得授权。<br/>如有疑问，请联系客服。</p>")}else{videoController.playerType=3,e(".video-play div.content").hide();var r=cc_winplayer.beginPlay(window.zbgedu.origin+"/scripts/html/videoframe.html?videoCcid="+videoController.currentTask.videoCcid+"&videoSiteId="+videoController.currentTask.videoSiteId,2)}}else{"http://www.caicui.com"!==window.location.origin&&"http://elearning.zbgedu.com"!==window.location.origin?(videoController.currentTask.videoCcid="313A5C7994F57292",e(".video-play div.content").html('<script src="http://union.bokecc.com/player?vid=313A5C7994F57292&siteid=07552B247EACAED4&autoStart=false&width=848&height=450&playerid=55295D704B531A0D&playertype=1" type="text/javascript">')):CAICUI.render.openCourseVideo&&CAICUI.render.openCourse&&CAICUI.render.openCourse.openCourseCcid&&CAICUI.render.openCourse.openCourseSiteId?e(".video-play div.content").html('<script  src="http://p.bokecc.com/player?vid='+CAICUI.render.openCourse.openCourseCcid+"&siteid="+CAICUI.render.openCourse.openCourseSiteId+"&autoStart=true&width=100%&height=100%&playerid=cc_"+CAICUI.render.openCourse.openCourseCcid+'&playertype=1" > <\/script>'):e(".video-play div.content").html('<script  src="http://p.bokecc.com/player?vid='+videoController.currentTask.videoCcid+"&siteid="+videoController.currentTask.videoSiteId+"&autoStart=true&width=100%&height=100%&playerid=cc_"+videoController.currentTask.videoCcid+'&playertype=1" > <\/script>');for(var t=document.getElementsByTagName("script"),n=-1,s=0;s<t.length;s+=1){var i=t[s];-1!=i.src.indexOf("http://union.bokecc.com/player")&&-1!=i.src.indexOf("http://p.bokecc.com/player")||(-1!=n&&(t[n].src=""),n=s)}}CAICUI.render.videoCcid=videoController.currentTask.videoCcid,videoController.saveVideo()},doDoc:function(){},doVocabulary:function(){},saveVideo:function(e){"stop"==e?(CAICUI.render.action="stop",clearInterval(videoController.saveVideoProgressSetinterval)):"finish"==e?(clearInterval(videoController.saveVideoProgressSetinterval),videoController.oldProgress!=videoController.currentTask.progress&&(videoController.currentTask.progress=videoController.currentTask.videoTime,videoController.oldProgress=videoController.currentTask.progress,CAICUI.render.action="playfinish",videoController.saveProgress())):(videoController.oldProgress=0,videoController.saveVideoProgressSetinterval=setInterval(function(){videoController.oldProgress<videoController.currentTask.progress&&(videoController.oldProgress=videoController.currentTask.progress,CAICUI.render.action="play",videoController.saveProgress())},12e4))},saveProgress:function(e){if("true"==videoController.currentChapter.isFree||3==videoController.courseData.courseActiveState){var o=!0;if("openCourse"==videoController.currentTask.taskType||"openCourse"==videoController.currentTask.taskTypeOld)var r={token:CAICUI.User.token,memberId:CAICUI.User.memberId,progress:100,total:100,taskId:videoController.currentTask.taskId,chapterId:videoController.currentChapter.chapterId,courseId:videoController.courseData.courseId,subjectId:videoController.courseData.subjectId,categoryId:videoController.courseData.categoryId,taskName:videoController.currentTask.title,chapterName:videoController.currentChapter.chapterTitle,courseName:videoController.courseData.courseName,subjectName:videoController.courseData.subjectName,categoryName:videoController.courseData.categoryName,state:1};else if(videoController.currentTask.videoTime>0||videoController.currentTask.totalCount>0){var t=0;(videoController.currentTask.progress/videoController.currentTask.videoTime>.9||videoController.currentTask.progress/videoController.currentTask.totalCount>.9)&&("complate",t=1,videoController.currentTask.progressstate="1");var n=0;videoController.currentTask.progress&&(n=parseInt(videoController.currentTask.progress)),"init"!=e&&0!=n||(n=1);var s=0;"video"==videoController.currentTask.taskType?s=parseInt(videoController.currentTask.videoTime):"exam"==videoController.currentTask.taskType?s=parseInt(videoController.currentTask.totalCount):"knowledgePointExercise"==videoController.currentTask.taskType&&(s=parseInt(videoController.currentTask.totalCount)),(r={token:CAICUI.User.token,memberId:CAICUI.User.memberId,progress:n,total:s,taskId:videoController.currentTask.taskId,chapterId:videoController.currentChapter.chapterId,courseId:videoController.courseData.courseId,subjectId:videoController.courseData.subjectId,categoryId:videoController.courseData.categoryId,taskName:videoController.currentTask.title,chapterName:videoController.currentChapter.chapterTitle,courseName:videoController.courseData.courseName,subjectName:videoController.courseData.subjectName,categoryName:videoController.courseData.categoryName}).state=t}else o=!1;if(o){switch(r.action=CAICUI.render.action,r.memberName=CAICUI.User.nickname,r.isSupply=0,r.createDate=(new Date).getTime(),console.log(CAICUI.render.action),CAICUI.render.action){case"beginplay":case"seek":case"playresume":CAICUI.iGlobal.timer();break;case"stop":case"changenexttask":case"changetask":case"closetask":case"playfinish":CAICUI.iGlobal.clearTimer()}console.log(CAICUI.timer.time),CAICUI.timer.time?(r.studyTime=CAICUI.timer.time,r.taskStudyTotalTime=CAICUI.timer.time+CAICUI.render.taskStudyTotalTime):(r.studyTime=0,r.taskStudyTotalTime=CAICUI.render.taskStudyTotalTime),CAICUI.timer.time=0,CAICUI.Request.ajax({server:"actionTaskProgress",data:{token:CAICUI.User.token,message:JSON.stringify(r)},done:function(e){}})}}},saveExam:function(e){videoController.currentTask.progress=e,videoController.saveProgress()},exercisePege:function(){var o=e(".spans");ctrUl=e(".ctrRight"),iframeSite="http://www.caicui.com"+videoController.currentTask.examUrl,exerciseId=videoController.currentTask.taskId,spanLength=videoController.currentTask.totalCount;var r="1";videoController.currentTask.express&&(r=videoController.currentTask.express);var t=0;for(var n in CAICUI.CACHE.getTasksProgress)CAICUI.CACHE.getTasksProgress[n].taskId==videoController.currentTask.taskId&&(videoController.currentTask.progress=CAICUI.CACHE.getTasksProgress[n].progress);t=(t=videoController.currentTask.progress)>spanLength?spanLength:t,console.log("完成题数"+t+"/总题数"+spanLength),e("#exercisText").attr("src",iframeSite+"?analysis="+r),e("#exercisText").attr("data-analysis",r),o.children().remove();for(n=0;n<spanLength;n++){var s=e("<span>");s.html(n+1),o.append(s)}function i(){e(window).width()>1200?videoController.notAllowed():e(window).width()>768&&videoController.notAllowed()}o.css("width",33*spanLength),t>0?o.children("span").eq(t-1).addClass("active"):void 0!=t&&""!=t&&null!=t||o.children("span").first().addClass("active"),i(),e(window).resize(function(){e(".myExercises").is(":visible")&&i()}),e(".myExercises").is(":visible")?(e('.ctrOption[control="handout"]').hide(),e(".ctrRight").css("width","180px")):e('.ctrOption[control="handout"]').show();var a=document.getElementById("exercisText");a&&a.attachEvent?a.attachEvent("onload",function(){videoController.listIndex()}):a&&(a.onload=function(){videoController.listIndex()}),videoController.ExerciseController()},listIndex:function(){var o={type:201,data:{number:e(".spans span.active").index()}};document.getElementById("exercisText").contentWindow.postMessage(JSON.stringify(o),"http://www.caicui.com")},saveTest:function(){videoController.saveProgress(),e("#"+videoController.currentTask.taskId).addClass("task-done");document.getElementById("exercisText").contentWindow.postMessage(JSON.stringify({type:202}),"http://www.caicui.com")},correctNum:function(){},notAllowed:function(){0==e(".spans span.active").index()?(e(".prevs").addClass("disableBut").removeClass("readyBut"),e(".prev").addClass("disableBut").removeClass("readyBut"),e(".nexts").addClass("readyBut").removeClass("disableBut"),e(".nexts").css({display:"inline-block"}),e(".next").addClass("readyBut").removeClass("saveTest disableBut").html('下一题<i class="glyphicon glyphicon-chevron-right"></i>')):e(".spans span.active").index()==e(".spans span").length-1?(e(".nexts").addClass("disableBut").removeClass("readyBut"),e(".nexts").css({display:"none"}),e(".next").addClass("saveTest").removeClass("readyBut").html("交卷"),e(".prevs").addClass("readyBut").removeClass("disableBut"),e(".prev").addClass("readyBut").removeClass("disableBut")):0!=e(".spans span.active").index()&&e(".spans span.active").index()!=e(".spans span").length-1&&(e(".prevs").addClass("readyBut").removeClass("disableBut"),e(".prev").addClass("readyBut").removeClass("disableBut"),e(".nexts").addClass("readyBut").removeClass("disableBut"),e(".nexts").css({display:"inline-block"}),e(".next").removeClass("saveTest disableBut").addClass("readyBut").html('下一题<i class="glyphicon glyphicon-chevron-right"></i>')),1==e(".spans span").length&&(e(".prevs").addClass("disableBut").removeClass("readyBut"),e(".prev").addClass("disableBut").removeClass("readyBut"),e(".nexts").addClass("disableBut").removeClass("readyBut"),e(".nexts").css({display:"none"}),e(".next").removeClass("saveTest").addClass("disableBut").html('下一题<i class="glyphicon glyphicon-chevron-right"></i>'))},ExerciseController:function(){var o="test";function r(){var o=e(".spans span").length,r=e(".spans span").eq(0).outerWidth(!0),t=e(".spanIocn").width(),n=e(".spans span.active");t<r*o?0!=n.prev().length&&(e(".spans").animate({left:"+=37px"},"fast"),n.prev().addClass("active").siblings().removeClass("active")):0!=n.prev().length&&(n.removeClass("active"),n.prev().addClass("active"))}function t(){var o=e(".spans span").length,r=e(".spans span").eq(0).outerWidth(!0),t=e(".spanIocn").width(),n=e(".spans span.active");t<r*o?0!=n.next().length&&(e(".spans").animate({left:"-=37px"},"fast"),n.next().addClass("active").siblings().removeClass("active")):0!=n.next().length&&(n.removeClass("active"),n.next().addClass("active"))}function n(){return e(".spans .active").index()+1}function s(){var o=e(".spans").children(".active").index(),r=e(".spanIocn").width(),t=e(".spans span").eq(0).outerWidth(!0);e(".spans").width()>r?e(".spans").css("left",-o*t):e(".spans").css("left","")}e(".spans").on("click","span",function(){e(this).addClass("active").siblings().removeClass("active"),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(n())}),s(),e(window).resize(function(){s()}),e(".prevs").on("click",function(){"saveTest"==o?o="test":r(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(n())}),e(".nexts").on("click",function(){t(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(n())}),e(".ctrIocn .prev").click(function(){videoController.saveTest(),r(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(n())}),e(".ctrIocn .next").click(function(){e(this).hasClass("saveTest")?(o="saveTest",videoController.saveTest()):(videoController.saveTest(),t(),videoController.notAllowed(),videoController.listIndex(),videoController.saveExam(n()))}),e(document).on("keyup",function(e){39==e.keyCode&&(t(),videoController.notAllowed(),videoController.listIndex()),37==e.keyCode&&(r(),videoController.notAllowed(),videoController.listIndex())}),videoController.notAllowed(),e(".analysis-click").click(function(){var o={type:203,data:{number:e(".spans span.active").index()}};document.getElementById("exercisText").contentWindow.postMessage(JSON.stringify(o),"http://www.caicui.com")})},continuetask:function(){e(".studycenter-video-task-a").eq(videoController.lasttaskindex).click()},closeSidebar:function(){e(".studycenter-video-right").siblings().addClass("hidden"),videoController.cc_play(),videoController.animateSidebar(0,500),2!=videoController.playerType&&3!=videoController.playerType||cc_winplayer.ChangePlayerWH()},openSidebar:function(){CAICUI.render.action="stop",videoController.saveProgress();e(this);var o=e(this).index(),r=e(".studycenter-video-right").eq(o);if(videoController.cc_pause(),r.hasClass("hidden"))switch(r.siblings().addClass("hidden"),r.removeClass("hidden"),videoController.animateSidebar(400,500),CAICUI.render.taskId=videoController.currentTask.taskId,CAICUI.render.progerss=videoController.currentTask.progress,e(".right-time").html(videoController.formatSeconds(videoController.currentTask.progress)),o){case 0:break;case 1:videoController.showQuestions();break;case 2:videoController.showNode();break;case 3:2==videoController.playerType?e(".speedCtr").show():e(".speedCtr").hide()}else videoController.animateSidebar(0,500),r.addClass("hidden");2!=videoController.playerType&&3!=videoController.playerType||cc_winplayer.ChangePlayerWH()},animateSidebar:function(o,r){e(".studycenter-video-main").css({"padding-right":o}),e(".studycenter-video-main-right").css({right:-(400-o)})},showQuestions:function(){videoController.imgUpLoad("quiz"),e("#ac-new-video").attr("src","script/libs/xneditor/ac-new-video.html")},showNode:function(){e("body .node-editor-textarea").val(""),e("body .add-photo-show").remove(),videoController.imgUpLoad()},showHandout:function(){videoController.handout()},imgUpLoad:function(o){if(e("#imgUpLoadNote").html(""),e("#imgUpLoadQuiz").html(""),"quiz"==o);else;CAICUI.Common.fileUpload;e(".add_upload .uploadImg").text("+")},handout:function(){e("#scanImg").html(""),""==videoController.currentTask.attachmentPath?(e("#scanImg").next().html("当前视频暂无讲义下载"),e(".downloadList").html("")):(e("#scanImg").html('<img src="'+CAICUI.Common.host.IPLocation+"commons/qrCode?v="+CAICUI.Common.host.img+videoController.currentTask.attachmentPath+'" />'),e(".downloadList").html('<li><a href="'+CAICUI.Common.host.img+videoController.currentTask.attachmentPath+'" target="_blank"><span></span>'+videoController.currentTask.title+"</a></li>"))},handoutDown:function(e){CAICUI.iGlobal.getThat(e);var o=document.getElementById("handoutDown-video");CAICUI.render.handoutDown?o.click():videoController.currentTask&&videoController.currentTask.attachmentPath?(o.setAttribute("download","true"),o.setAttribute("href",CAICUI.Common.host.img+videoController.currentTask.attachmentPath),CAICUI.render.handoutDown=CAICUI.Common.host.img+videoController.currentTask.attachmentPath,o.click()):n.msg("Sorry~暂无讲义",{time:2e3},function(){})},handoutAjax:function(e){CAICUI.Request.ajax({server:"handout",data:{idType:0,courseId:CAICUI.render.courseId},done:function(o){CAICUI.CACHE.handout=o.data,CAICUI.render.handout=o.data,e&&e()},fail:function(e){CAICUI.CACHE.handout={},CAICUI.render.handout={}}})},videoSound:function(){var o=e(this).next(".volumeCtr");o.is(":hidden")?(o.show(),e(this).addClass("active"),setTimeout(function(){e(".volumeCtr").hide()},5e3)):(o.hide(),e(this).removeClass("active"))},playController:function(){e("#playCtr").slider({range:"min",animate:"fast",max:100,start:function(e,o){console.log("ctrl get start"),userOP=!0},stop:function(e,o){var r=videoController.currentTask.videoTime*(o.value/100);if(userOPTime=r,0==videoController.playerType)videoController.cc_seek(r);else if(2==videoController.playerType)WINAPI.log("设置视频指定播放时间："+r),WINAPI.SetPlayerBegin(r),on_player_seek(0,r);else if(3==videoController.playerType){WINAPI.log("设置视频指定播放时间："+r);var t={type:100,data:{time:r}};cc_winplayer.sendMessageToIframe(JSON.stringify(t))}CAICUI.render.action="drag",videoController.saveProgress(),console.log("ctrl get stop:"+r)}})},cc_player_init:function(o,r){e("head div[id^=cc_video_]").remove();var t=this.cc_getSWF(r);try{o==videoController.currentTask.videoCcid&&(t.length>1?videoController.player=t[t.length-1]:videoController.player=t,videoController.playerType=0,videoController.player.setConfig(videoController.ccSetConfig),videoController.cc_play(),videoController.currentTask.videoTime=videoController.player.getDuration())}catch(e){console.log("can't get player obj")}},cc_getSWF:function(e){return window.document[e]?window.document[e]:-1!=navigator.appName.indexOf("Microsoft")?document.getElementById(e):document.embeds&&document.embeds[e]?document.embeds[e]:void 0},cc_play:function(){CAICUI.render.action="play",videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.start()},cc_pause:function(){CAICUI.render.action="stop",videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.pause()},cc_setVolume:function(e){videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.setVolume(e)},cc_seek:function(e){CAICUI.render.action="seek",videoController.player&&"video"==videoController.currentTask.taskType&&videoController.player.seek(e)},exe_player_init:function(){videoController.playerType=2,videoController.currentTask.videoTime=WINAPI.PlayerDuration(),WINAPI.log("视频总时长："+videoController.currentTask.videoTime),videoController.currentTask.progress>20&&WINAPI.SetPlayerBegin(videoController.currentTask.progress)},cciframe_player_init:function(){if(videoController.playerType=3,videoController.currentTask.videoTime=window.videototaltime,WINAPI.log("视频总时长："+videoController.currentTask.videoTime),videoController.currentTask.progress>20){var e={type:100,data:{time:videoController.currentTask.progress}};cc_winplayer.sendMessageToIframe(JSON.stringify(e))}},cc_taskStatus:function(){videoController.slideIntervalstop&&clearInterval(videoController.slideIntervalstop);var o=this,r=1e3;videoController.slideIntervalstop=setInterval(function(){if(userOPTime!=userOPCCCallBackTime||userOP)return console.log("slideIntervalstop:"+userOPTime+"|"+userOPCCCallBackTime),void(r=5e3);switch(r=1e3,videoController.currentTask.taskType){case"video":if("finish"==e(".video-play div.dummy").html()&&0==videoController.playerType&&(videoController.cc_player_init(nowcc_vid,nowcc_objectID),e(".video-play div.dummy").html("play")),"finish"==e(".video-play div.dummy").html()&&3==videoController.playerType&&(videoController.cciframe_player_init(),e(".video-play div.dummy").html("play")),"exe"==window.clientType&&"load"==e(".video-play div.dummy").html()&&2==videoController.playerType)WINAPI.GetPlayTime()>1&&(videoController.exe_player_init(),e(".video-play div.dummy").html("play"));if("stop"==e(".video-play div.dummy").html()&&(videoController.saveVideo("finish"),e("#"+videoController.currentTask.taskId).removeClass(["active"]),e("#"+videoController.currentTask.taskId).addClass("task-done"),clearInterval(videoController.videoSetinterval)),0==videoController.playerType&&null==videoController.player&&""!=videoController.currentTask.videoCcid&&""!=videoController.currentTask.videoSiteId){o.initvideo(videoController.currentTask.videoCcid,videoController.currentTask.videoSiteId);break}var t=0,n=100;0==videoController.playerType?(videoController.player.getPosition&&(t=videoController.player.getPosition()),videoController.player.getDuration&&(n=videoController.player.getDuration())):2==videoController.playerType?(t=WINAPI.GetPlayTime(),n=WINAPI.PlayerDuration()):3==videoController.playerType&&(t=window.videocurrentime,n=window.videototaltime),"number"==typeof t&&"number"==typeof n?videoController.currentTask.progress=t:(console.log("获取视频时间异常ct:"+t),console.log("获取视频时间异常tt:"+n)),o.cc_slide()}},r)},initvideo:function(o,r){e("head div[id^=cc_video_]").remove(),videoController.player=document.getElementById("cc_"+o),videoController.player&&(videoController.player.controls=!1,videoController.playerType=0)},cc_slide:function(){var o=videoController.currentTask.progress,r=videoController.currentTask.videoTime,t=parseInt(o/r*100),n=e("#playCtr").slider("option","value");n-t>0&&n-t<5?console.log("playerCTLValue:"+n+"|"+t):e("#playCtr").slider("value",t),e("div.ControlBar span.beforeTime").html(this.formatSeconds(o)),e("div.ControlBar span.afterTime").html(this.formatSeconds(r))},automaticSwitch:function(){var o=this,r=e("li[data-id='"+o.taskTypeId+"']").attr("taskTotal");if(e("li[data-id='"+o.taskTypeId+"']").attr("taskNum")==r)var t="下章节任务",s=e("span.nextChapter");else t="下一任务",s=e("li[data-id='"+o.taskTypeId+"']").next();n.confirm('当前任务结束,<span class="layerConfirm">5秒后自动进入下一个任务</span>',{title:["信息","background: #ffffff"],btn:["重学本任务",t],closeBtn:1,time:5e3},function(e){n.close(e)},function(e){n.close(e)});e(".layui-layer-btn0").on("click",function(){console.log(1),e("li[data-id='"+o.taskTypeId+"']").trigger("click")}),e(".layui-layer-btn1").on("click",function(){s.trigger("click")}),e(".layui-layer-setwin .layui-layer-close1").html('<div style="color:#b9b9b9;font-size:18px; line-height: 15px;">X</div>'),e(".layerConfirm").css("color","#00a085"),e(".layui-layer-btn").css("background","#fafafa"),e(".layui-layer-btn0").css({background:"#ffffff",color:"#515151",border:"1px #d8d8d8 ridge","line-height":"27px"}),e(".layui-layer-btn1").css({background:"#169f81",color:"#ffffff","line-height":"29px"}),e(".layui-layer-btn a").css({"-moz-border-radius":"3px","-webkit-border-radius":"3px","border-radius":"3px","font-weight":"normal"})},formatSeconds:function(e){var o=parseInt(e),r=0,t=0;o>60&&(r=parseInt(o/60),o=parseInt(o%60),r>60&&(t=parseInt(r/60),r=parseInt(r%60)));var n="";return n=o>9?parseInt(o):o>0?"0"+parseInt(o):"00",t>0&&(r+=60*t),n=r>9?parseInt(r)+":"+n:r>0?"0"+parseInt(r)+":"+n:"00:"+n},realUpdateProgress:function(){videoController.getTasksProgress(function(){})},getTasksProgress:function(e){var r=CAICUI.CACHE.getTasksProgress,t=videoController.courseData;o.each(t.chapters,function(e,n){e.children&&o.each(e.children,function(e,s){e.tasks&&o.each(e.tasks,function(e,i){o.each(r,function(o,r){e.taskId==o.taskId&&(t.chapters[n].children[s].tasks[i].progress=o.progress,t.chapters[n].children[s].tasks[i].total=o.total,t.chapters[n].children[s].tasks[i].state=o.state)})})})}),CAICUI.render.newCourseDetail=t,e&&e()},intervalTasksProgress:function(){CAICUI.render.intervalTasksProgress=setInterval(function(){var e=CAICUI.render.newCourseDetail;console.log(e);var r=parseInt(videoController.currentTask.progress),t=0;if("video"==videoController.currentTask.taskType?t=parseInt(videoController.currentTask.videoTime):"exam"==videoController.currentTask.taskType?t=parseInt(videoController.currentTask.totalCount):"knowledgePointExercise"==videoController.currentTask.taskType&&(t=parseInt(videoController.currentTask.totalCount)),r&&t){var n=e;o.each(n.chapters,function(e,s){e.children?o.each(e.children,function(e,i){e.children?o.each(e.children,function(e,a){e.tasks&&o.each(e.tasks,function(e,o){if(e.taskId==videoController.currentTask.taskId){var l=n.chapters[s].children[i].children[a].tasks[o].progress;(!l||l<r)&&(n.chapters[s].children[i].children[a].tasks[o].progress=r),n.chapters[s].children[i].children[a].tasks[o].total=t}})}):e.tasks&&o.each(e.tasks,function(e,o){if(e.taskId==videoController.currentTask.taskId){var a=n.chapters[s].children[i].tasks[o].progress;(!a||a<r)&&(n.chapters[s].children[i].tasks[o].progress=r),n.chapters[s].children[i].tasks[o].total=t}})}):e.tasks&&o.each(e.tasks,function(e,o){if(e.taskId==videoController.currentTask.taskId){var i=n.chapters[s].tasks[o].progress;(!i||i<r)&&(n.chapters[s].tasks[o].progress=r),n.chapters[s].tasks[o].total=t}})})}},3e3)}},{init:videoController.init}});var nowcc_vid="",nowcc_objectID="";function on_cc_player_init(e,o){nowcc_vid=e,nowcc_objectID=o,$(".video-play div.dummy").html("finish"),WINAPI.log("获得iframe发送的消息视频初始化完成:---on_cc_player_init")}function on_spark_player_pause(){CAICUI.render.action="stop",videoController.saveProgress(),$(".glyphicon.plays.glyphicon-pause").addClass("glyphicon-play").removeClass("glyphicon-pause")}function on_spark_player_resume(){CAICUI.render.action="playresume",videoController.saveProgress(),$(".glyphicon.plays.glyphicon-play").addClass("glyphicon-pause").removeClass("glyphicon-play")}function on_spark_player_stop(){$(".glyphicon.plays.glyphicon-pause").addClass("glyphicon-play").removeClass("glyphicon-pause"),$(".video-play div.dummy").html("stop")}function on_player_seek(e,o){console.log("on_player_seek:"+e+"|"+o+"|"+userOPTime),$(".video-play div.dummy").html("seek"),parseInt(o)==parseInt(userOPTime)&&(userOPCCCallBackTime=userOPTime,userOP=!1)}function on_player_start(){if(console.log(videoController),videoController.taskProgress)videoController.currentTask.videoTime==videoController.taskProgress?videoController.cc_seek(1):videoController.cc_seek(videoController.taskProgress);else for(var e in CAICUI.CACHE.getTasksProgress)CAICUI.CACHE.getTasksProgress[e].taskId==videoController.currentTask.taskId&&(videoController.currentTask.progress=CAICUI.CACHE.getTasksProgress[e].progress,console.log(CAICUI.CACHE.getTasksProgress[e].progress),CAICUI.CACHE.getTasksProgress[e].progress==CAICUI.CACHE.getTasksProgress[e].videoTime?videoController.cc_seek(1):videoController.cc_seek(CAICUI.CACHE.getTasksProgress[e].progress))}userOP=!1,userOPTime=0,userOPCCCallBackTime=0,imgPath="",window.addEventListener("message",function(e){var o=e.data,r=JSON.parse(o);switch(r.type){case 1:window.videototaltime=r.data.totaltime,on_cc_player_init(r.data.vid,r.data.objectID),WINAPI.log("获得iframe发送的消息视频初始化完成:"+r.data.totaltime);break;case 5:on_player_seek(r.data.from,r.data.to),WINAPI.log("获得iframe发送的消息 定点播放完成");break;case 10:window.videocurrentime=r.data.second;break;case 20:$("span.active").addClass("over");break;case 21:$("span.active").removeClass("over")}},!1);