define(["jquery","underscore","backbone","storage","views/questions","views/courseDetail","views/activationCourse","views/d3-stack","layer"],function(e,r,a,t,n,s,o,i,I){"use strict";return a.View.extend({el:"body #right",template:r.template(e("#template-course-courseStudy").html()),events:{"click .js-course-list-link":"openVideo","click .js-course-questions":"openQuestions","click .course-list-title-a":"courseNavToggle","click .js-course-study-change":"courseChange","click .option-a":"optionCourse","click .courseVersion-list-a":"courseVersionListA","click .courseVersion-show-btn":"courseVersionListShow","click .js-handout-down":"handoutDown","click .courseUpdate-close":"courseUpdateClose","click .courseUpdate-submit":"courseUpdateAjax","click .js-apply-editor-learningPlan":"applyEditorLearningPlan"},render:function(r){if(CAICUI.render.$this=this,CAICUI.render.thisCourseIndex=this,this.courseNavPreDefault=0,this.courseNavPre=0,this.courseNavAnimateTime=300,CAICUI.render.subjectId="",CAICUI.render.subjectName="",CAICUI.render.categoryId="",CAICUI.render.categoryName="",CAICUI.render.courseId=r,CAICUI.render.courseName="",CAICUI.render.chapterId="",CAICUI.render.chapterName="",CAICUI.render.isCoursePay=!1,CAICUI.render.questions=n,CAICUI.render.getTasksProgress="",CAICUI.render.handout="",CAICUI.render.course_info="",CAICUI.render.courseInfoExamTime="",CAICUI.render.courseInfoDueTime="",CAICUI.render.versionId="",CAICUI.render.courseInfo="",CAICUI.render.courseVersion="",CAICUI.render.courseActiveTime="",CAICUI.render.courseExpirationTime="",CAICUI.render.lastLearnChapter="",CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink="",CAICUI.render.percentage=0,CAICUI.render.lockStatus=!1,CAICUI.render.chaptersIdArray=[],CAICUI.render.handoutDown="",CAICUI.render.exerciseKnowledgeMemberStatus={},CAICUI.render.knowledgepointid="",CAICUI.render.lastExerciseNid=0,CAICUI.render.ExerciseProgress=0,CAICUI.render.ExerciseTotalTime=0,CAICUI.render.cacheKnowledgeLevel1Id="",CAICUI.render.cacheKnowledgeLevel2Id="",CAICUI.render.cacheKnowledgePath="",CAICUI.render.errorNum=0,CAICUI.render.exerciseFilename="",CAICUI.render.questionsIndex=0,CAICUI.render.exerciseCount=0,CAICUI.render.weekMaxBeoverdue=2,CAICUI.render.taskReturn){if(CAICUI.render.openCourse="",CAICUI.render.openCourseVideo=!1,CAICUI.render.myExamContinue={},CAICUI.render.viewResolution=!1,I.close(videoController.payInfoDialog),0==videoController.playerType);else if(2==videoController.playerType)WINAPI.SetPlayerHide(1),WINAPI.SetPlayerPause();else if(3==videoController.playerType){cc_winplayer.SetIframePlayerHide(1);cc_winplayer.sendMessageToIframe(JSON.stringify({type:101}))}e("#studycenter-video").remove(),videoController.removeAnimate(),CAICUI.render.action="closetask",videoController.saveProgress(),clearInterval(videoController.slideIntervalstop),clearInterval(videoController.saveVideoProgressSetinterval)}CAICUI.isNoneRender||(CAICUI.render.courseDetailRenderData=[],CAICUI.render.courseDetailRenderData.courseId=r,CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId}})),CAICUI.iGlobal.getTemplateCourseNav("body .courseIndex-header-right",{courseType:"course",type:"study",courseId:CAICUI.render.courseId})),CAICUI.render.$this.refreshHtml()},refreshHtml:function(){CAICUI.isNoneRender?(CAICUI.render.$this.getTasksProgressAjax(function(r){CAICUI.render.$this.courseDetailRender(),CAICUI.render.lastLearnChapterName?(e(".lastLearn").attr("href",CAICUI.render.lastLearnChapterLink),e(".continue-learning").attr("href",CAICUI.render.lastLearnChapterLink),e(".lastLearn").html(CAICUI.render.lastLearnChapterName)):(e(".lastLearn").attr("href","javascript:;"),e(".continue-learning").attr("href","javascript:;"),e(".lastLearn").html("开始学习本课程"))}),CAICUI.isNoneRender=!1):(CAICUI.render.$this.courseInfoAjax(function(){e("body .course-info-examTime").html(CAICUI.render.courseInfoExamTime)}),CAICUI.render.$this.courseDetailAjax(function(){e("body .course-change").attr("title",CAICUI.render.courseName),e("body .course-name").html(CAICUI.render.courseName);var r=e("#template-courseStudy-availability").html(),a=CAICUI.iGlobal.getTemplate(r,{data:{availability:CAICUI.render.courseDetail.availability}});e("body .courseIndex-content-left-box").append(a),CAICUI.render.$this.courseActiveStateAjax(function(){CAICUI.render.courseExpirationTime?e("body .course-info-dueTime").html(CAICUI.iGlobal.getDate(CAICUI.render.courseExpirationTime)):e("body .course-info-dueTime").html("-- : --"),CAICUI.render.$this.getTasksProgressAjax(function(){CAICUI.render.$this.memberGetplanAjax(function(r){CAICUI.render.courseDetailRenderData.weekList=r;var a=JSON.parse(CAICUI.render.courseDetail.courseModel);a&&a.length&&(e("body .courseIndex").append('<a class="courseIndex-baseInfo-btn" href="javascript:;">课程介绍<span class="courseIndex-baseInfo-btn-shadow"></span></a>'),e("body .courseIndex-baseInfo-btn").on("click",function(){var r=e("#template-course-baseInfo").html(),a=CAICUI.iGlobal.getTemplate(r);e("body #layout").append(a),e("body .courseIndex-baseInfo-btn").addClass("hidden"),e("body .course-baseInfo-closeBtn").on("click",function(){e("body .course-baseInfo").remove(),e("body .courseIndex-baseInfo-btn").removeClass("hidden")}),CAICUI.render.activationCourse=new o,e("body .course-baseInfo-content").append(CAICUI.render.activationCourse.render({coursesBaseInfo:CAICUI.render.courseDetail,isActivationCourse:!1,isPlan:CAICUI.render.courseDetailRenderData.weekList}).el),e("body .course-activation-acca-content").find("img").each(function(r){var a=e(this).attr("src"),t=a.substr(-3);"jpg"!=t&&"png"!=t&&"gif"!=t&&"svg"!=t||(a=window.static+a),e(this).attr("src",a)}),setTimeout(function(){window.CAICUI.myScrollCourseModel=CAICUI.iGlobal.iScroll("body #wrapper-courseModel")},50),window.CAICUI.myScrollActivationAcca=CAICUI.iGlobal.iScroll("body #wrapper-activation-acca")})),CAICUI.render.$this.courseDetailRender(),CAICUI.render.courseDetailData.weekTotalBeoverdue>=CAICUI.render.weekMaxBeoverdue&&(e("body .js-apply-editor-learningPlan").removeClass("hidden"),e("body .learningPlan-info").removeClass("hidden"),e("body .learningPlan-info-weekTotalBeoverdue").html(CAICUI.render.courseDetailData.weekTotalBeoverdue)),window.CAICUI.myScrollCourseStudyRight=CAICUI.iGlobal.iScroll("body #wrapper-courseStudy-right")}),CAICUI.render.$this.courseUpdate(),CAICUI.render.lastLearnChapterName?(e(".lastLearn").attr("href",CAICUI.render.lastLearnChapterLink),e(".continue-learning").attr("href",CAICUI.render.lastLearnChapterLink),e(".lastLearn").html(""+CAICUI.render.lastLearnChapterName),e(".continue-learning").html("继续学习")):(e(".lastLearn").attr("href","javascript:;"),e(".continue-learning").attr("href","javascript:;"),e(".lastLearn").html("开始学习本课程"))})})}))},courseDetailRender:function(){if(CAICUI.render.courseDetailRender=new s,e("body #scroller-courseStudy-list").html(CAICUI.render.courseDetailRender.render(CAICUI.render.courseDetailRenderData).el),window.CAICUI.myScrollCourseStudyList=CAICUI.iGlobal.iScroll("body #wrapper-courseStudy-list"),CAICUI.render.courseDetailData&&(CAICUI.render.courseDetailData.isPlan&&r.each(CAICUI.render.courseDetailData.courseDetailWeekList,function(e,r){e.weekIsFinish&&e.isFinish||CAICUI.render.$this.updateplanAjax(e)}),e("body .tasks-info-totalNum").html(CAICUI.render.courseDetailData.courseTaskTotal),e("body .tasks-info-progress").html(CAICUI.render.courseDetailData.coursePercentage),e("body .tasks-info-doneNum").html(CAICUI.render.courseDetailData.courseTaskTotalCompleted)),CAICUI.render.courseDetailData.isPlan){e("body #d3-stack").empty(),CAICUI.render.d3StackRender=new i;var a=CAICUI.render.d3StackRender.setStackData(CAICUI.render.d3StackRender,CAICUI.render.courseDetailData);CAICUI.render.d3StackRender.createD3Stack(a),e("body #d3-stack").append(CAICUI.render.d3StackRender.render(a).el)}},changeTasksProgress:function(a){var t=[];r.each(a,function(e,r){e.chapterId==CAICUI.render.openChapterId&&t.push(e)}),r.each(t,function(r,a){var t="#video/"+r.courseId+"/"+r.chapterId+"/"+r.taskId;r.progress&&(t+="/"+r.progress);var n=0;(n=r.state&&1==r.state?100:CAICUI.iGlobal.getPercentage(r.progress,r.total))?100==n?(e("body #courseDetail-weekList-taskA-"+r.taskId).attr("class","js-toTask courseDetail-weekList-taskA task-completed"),e("body .tasks-info-progress").html(CAICUI.render.courseDetailData.coursePercentage),e("body .tasks-info-doneNum").html(CAICUI.render.courseDetailData.courseTaskTotalCompleted)):e("body #courseDetail-weekList-taskA-"+r.taskId).attr("class","js-toTask courseDetail-weekList-taskA task-ongoing"):e("body #courseDetail-weekList-taskA-"+r.taskId).attr("class","js-toTask courseDetail-weekList-taskA task-notstarted"),t+="?return_link=courseStudy/"+r.courseId+"&return_hash=on",e("body #courseDetail-weekList-taskA-"+r.taskId).attr("link",t),e("body #task-progressBar-width-"+r.taskId).css("width",n+"%"),e("body #task-progress-number-"+r.taskId).html(n+"%")})},updateplanAjax:function(e,r){e.weekTaskBeoverdue,e.weekTaskCompleted,e.weekTaskNotstarted,e.weekTaskOngoing;CAICUI.Request.ajax({server:"updateplan",data:{token:CAICUI.User.token,id:e.planId,taskTime:e.weekTaskTime,taskSum:e.tasksNum,learnTime:e.weekStudyTime,learnSum:e.weekTaskCompleted,ingSum:e.weekTaskOngoing,isFinish:e.weekIsFinish},done:function(e){r&&r()},fail:function(e){}})},getMaxOverplanAjax:function(e){CAICUI.Request.ajax({server:"getMaxOverplan",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.subjectId},done:function(r){e&&e()},fail:function(e){}})},courseUpdate:function(){CAICUI.render.$this.searchCourseAlterationsByVersionId()},searchCourseAlterationsByVersionId:function(e,r){CAICUI.Request.ajax({server:"searchCourseAlterationsByVersionId",data:{versionId:CAICUI.render.versionId},done:function(e){if(e.data&&e.data.length){var r=CAICUI.render.$this.formatCourseUpdate(e.data);r&&CAICUI.render.$this.createcourseUpdate(r)}},fail:function(e){}})},createcourseUpdate:function(r){var a=.618*e(window).width(),t=605.64;a<t?a=t:a>988.8&&(a=988.8),CAICUI.render.courseUpdate=I.open({type:1,title:!1,shade:!0,scrollbar:!1,area:[a+"px","auto"],closeBtn:0,content:e("#courseUpdate"),success:function(){e("body #courseUpdate .courseUpdate-content").html(r)}})},formatCourseUpdate:function(e){var r="",a=0;CAICUI.render.courseProgress&&CAICUI.render.courseProgress.createDate?a=parseInt(CAICUI.render.courseProgress.createDate):CAICUI.render.courseActiveTime&&(a=CAICUI.render.courseActiveTime);for(var t=0;t<e.length;t++)a<e[t].createDate&&(r+=e[t].message,r+='<p class="courseUpdate-time">变更时间 '+CAICUI.iGlobal.getDate(e[t].createDate)+"</p>");return r},courseUpdateClose:function(){I.close(CAICUI.render.courseUpdate)},courseUpdateAjax:function(e){I.close(CAICUI.render.courseUpdate)},handoutDown:function(e){CAICUI.iGlobal.getThat(e);var r=document.getElementById("handoutDown");CAICUI.render.handoutDown?r.click():CAICUI.render.$this.handoutAjax(function(){CAICUI.render.handout&&CAICUI.render.handout[0]&&CAICUI.render.handout[0].handoutFilePath?(r.setAttribute("download","true"),r.setAttribute("href",CAICUI.Common.host.img+CAICUI.render.handout[0].handoutFilePath),CAICUI.render.handoutDown=CAICUI.Common.host.img+CAICUI.render.handout[0].handoutFilePath,r.click()):I.msg("Sorry~暂无讲义",{time:2e3},function(){})})},actionGetCourseProgress:function(e){CAICUI.Request.ajax({server:"actionGetCourseProgress",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,courseId:CAICUI.render.courseId},done:function(r){CAICUI.render.courseProgress=r.data[0],r.data[0]&&(CAICUI.render.percentage=r.data[0].courseProgress),e&&e()}})},courseChange:function(r){var a=CAICUI.iGlobal.getThat(r),t=a.attr("data-click");if(a.hasClass("active"))a.removeClass("active"),e("body .option-ul").removeClass("active");else if(CAICUI.render.learningcourseData&&CAICUI.render.learningcourseData.length){var n=e("#template-courseStudy-courseList").html(),s=CAICUI.iGlobal.getTemplate(n,{courseNameArray:CAICUI.render.courseNameArray});e("body .course-change-ul").html(s),a.addClass("active"),e("body .option-ul").addClass("active")}else"true"!=t&&(a.attr("data-click","true"),CAICUI.render.$this.learningcourseAjax(function(){var r=e("#template-courseStudy-courseList").html(),t=CAICUI.iGlobal.getTemplate(r,{courseNameArray:CAICUI.render.courseNameArray});e("body .course-change-ul").html(t),a.addClass("active"),e("body .option-ul").addClass("active")}))},learningcourseAjax:function(e){CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(r){if(!r.data.courselist||!r.data.courselist.length)return!1;CAICUI.render.learningcourseData=r.data.courselist;var a=r.data.courselist;CAICUI.render.courseNameArray=[];for(var t=0;t<a.length;t++){var n=!0;if(CAICUI.render.courseNameArray&&CAICUI.render.courseNameArray.length)for(var s=0;s<CAICUI.render.courseNameArray.length;s++)CAICUI.render.courseNameArray[s].courseId==a[t].courseId&&(n=!1);n&&CAICUI.render.courseNameArray.push({courseId:a[t].courseId,courseName:a[t].courseName})}e&&e()},fail:function(){CAICUI.render.learningcourseData={},CAICUI.CACHE.RecentCourse={}}})},courseDetailAjax:function(e){CAICUI.Request.ajax({server:"courseDetail",data:{courseId:CAICUI.render.courseId},done:function(r){var a=r.data[0];CAICUI.render.courseDetailRenderData.chapters=a.chapters,CAICUI.CACHE.courseDetail=a,CAICUI.render.courseDetail=a,CAICUI.render.knowledgePointIdTotal=CAICUI.render.courseDetail.knowledgePointId,CAICUI.render.$this.courseDetailDone&&CAICUI.render.$this.courseDetailDone(CAICUI.render.courseDetail,e)}})},courseDetailDone:function(e,r){CAICUI.render.versionId=e.versionId,CAICUI.render.subjectId=e.subjectId,CAICUI.render.subjectName=e.subjectName,CAICUI.render.categoryId=e.categoryId,CAICUI.render.categoryName=e.categoryName,CAICUI.render.courseId=e.courseId,CAICUI.render.courseName=e.courseName,CAICUI.render.chapterId=e.chapterId,CAICUI.render.chapterName=e.chapterName,r&&r()},memberGetplanAjax:function(e){CAICUI.Request.ajax({server:"memberGetplan",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.courseDetail.subjectId,courseId:CAICUI.render.courseId},done:function(r){e&&e(r.data)},fail:function(r){e&&e(r.data)}})},getChaptersIdArray:function(e){e.chapterNum;r.each(e.chapters,function(e,a){CAICUI.render.chaptersIdArray.push(e.chapterId),e.children&&e.children.length&&r.each(e.children,function(e,a){CAICUI.render.chaptersIdArray.push(e.chapterId),e.children&&e.children.length&&r.each(e.children,function(e,r){CAICUI.render.chaptersIdArray.push(e.chapterId)})})}),CAICUI.render.chaptersIdArray=CAICUI.render.chaptersIdArray.toString()},exercisePointCountCacheAjax:function(e){CAICUI.Request.ajax({server:"exercisePointCountCache",data:{knowledge_points:CAICUI.render.knowledgePointIdTotal,type:6},done:function(r){e&&e(r.data)}})},exerciseKnowledgeMemberStatusAjax:function(e){CAICUI.Request.ajax({server:"exerciseKnowledgeMemberStatus",data:{knowledge_points:CAICUI.render.knowledgePointIdTotal,type:4,member_id:CAICUI.User.memberId},done:function(r){e&&e(r.data)}})},courseActiveStateAjax:function(e){CAICUI.Request.ajax({server:"coursestatus",data:{token:CAICUI.User.token,versionId:CAICUI.render.versionId},done:function(r){if(r.data){for(var a=0,t=0;t<r.data.length;t++)0===r.data[t].lockStatus&&a++;a||(CAICUI.render.lockStatus=!0)}CAICUI.render.coursestatus=r.data,CAICUI.render.$this.courseByInFo(r.data),e&&e()},fail:function(e){I.msg("Sorry~ 获取课程授权信息失败，请刷新页面重试。",function(){})}})},courseVersionDataAjax:function(e){CAICUI.Request.ajax({server:"version",data:{versionId:CAICUI.render.versionId},done:function(r){if(!r.data||!r.data.length)return!1;CAICUI.render.courseVersion=r.data,e&&e()},fail:function(e){I.msg("Sorry~ 网络错误，请刷新页面重试。",function(){})}})},getTasksProgressAjax:function(e){CAICUI.Request.ajax({server:"actionGetTasksProgress",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,courseId:CAICUI.render.courseId},done:function(a){a.data;if(CAICUI.render.courseDetailRenderData.taskProgress=a.data,CAICUI.CACHE.getTasksProgress=a.data,CAICUI.render.getTasksProgress=a.data,CAICUI.render.getTasksProgress&&CAICUI.render.getTasksProgress.length){CAICUI.render.lastLearnChapter=r.max(CAICUI.render.getTasksProgress,function(e){return e.createDate});var t="",n="";CAICUI.render.lastLearnChapter&&!CAICUI.render.lastLearnChapterName?(t="#video/"+CAICUI.render.courseId+"/"+CAICUI.render.lastLearnChapter.chapterId+"/"+CAICUI.render.lastLearnChapter.taskId+"/"+CAICUI.render.lastLearnChapter.progress+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on",n='上次学到：<span class="lastLearn-chapterName">'+CAICUI.render.lastLearnChapter.chapterName+' </span><i class="icon icon-course-arrow-right"></i>'):(t=CAICUI.render.lastLearnChapterLink?a.lastLearnChapterLink:CAICUI.render.courseDetail.chapters[0].children?"#video/"+CAICUI.render.courseId+"/"+CAICUI.render.courseDetail.chapters[0].children[0].chapterId+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on":"#video/"+CAICUI.render.courseId+"/"+CAICUI.render.courseDetail.chapters[0].chapterId+"?return_link=courseStudy/"+CAICUI.render.courseId+"&return_hash=on",n=CAICUI.render.lastLearnChapterName?'上次学到：<span class="lastLearn-chapterName">'+CAICUI.render.lastLearnChapterName+' </span><i class="icon icon-course-arrow-right"></i>':'<i class="icon icon-course-arrow-right"></i><span class="lastLearn-chapterName">开始学习本课程</span>'),CAICUI.render.lastLearnChapterLink=t,CAICUI.render.lastLearnChapterName=n}e&&e(a.data)},fail:function(){CAICUI.CACHE.getTasksProgress={},CAICUI.render.getTasksProgress={}}})},courseInfoAjax:function(e){CAICUI.Request.ajax({server:"getExamDate",data:{memberId:CAICUI.User.memberId},done:function(r){var a=-1;if(r.data&&r.data.length)for(var t=0;t<r.data.length;t++)CAICUI.render.subjectId,r.data[t].courseCategoryId,CAICUI.render.courseId==r.data[t].id&&(r=r.data[t],a=parseInt(((new Date).getTime()-r.examinationDate)/864e5));CAICUI.CACHE.course_info=r.data,CAICUI.render.course_info=r.data,CAICUI.render.courseInfoExamTime=a<0?"本科目考试时间未确定":0===a?"请留意,本科目<strong>今天</strong>开始考试":"距本科目考试还有<strong>"+a+"</strong>天",e&&e()},fail:function(e){CAICUI.CACHE.course_info={},CAICUI.render.course_info={}}})},handoutAjax:function(e){CAICUI.Request.ajax({server:"handout",data:{idType:0,courseId:CAICUI.render.courseId},done:function(r){CAICUI.CACHE.handout=r.data,CAICUI.render.handout=r.data,e&&e()},fail:function(e){CAICUI.CACHE.handout={},CAICUI.render.handout={}}})},setTasksProgress:function(e){CAICUI.render.getTasksProgress;r.each(e.chapters,function(a,t){a.children&&a.children.length?r.each(a.children,function(a,n){a.children&&a.children.length?r.each(a.children,function(a,s){a.tasks&&a.tasks.length&&r.each(a.tasks,function(a,o){r.each(CAICUI.CACHE.getTasksProgress,function(r,i){a.taskId==r.taskId&&(e.chapters[t].children[n].children[s].tasks[o].progress=r.progress,e.chapters[t].children[n].children[s].tasks[o].total=r.total,e.chapters[t].children[n].children[s].tasks[o].state=r.state)})})}):a.tasks&&a.tasks.length&&r.each(a.tasks,function(a,s){r.each(CAICUI.CACHE.getTasksProgress,function(r,o){a.taskId==r.taskId&&(e.chapters[t].children[n].tasks[s].progress=r.progress,e.chapters[t].children[n].tasks[s].total=r.total,e.chapters[t].children[n].tasks[s].state=r.state)})})}):a.tasks&&a.tasks.length&&r.each(a.tasks,function(a,n){r.each(CAICUI.CACHE.getTasksProgress,function(r,s){a.taskId==r.taskId&&(e.chapters[t].tasks[n].progress=r.progress,e.chapters[t].tasks[n].total=r.total,e.chapters[t].tasks[n].state=r.state)})})}),CAICUI.render.courseDetail=e,t.setsingle("courseProgress-"+CAICUI.render.courseId,e)},updateTasksProgress:function(){CAICUI.render.courseDetail;var a=[];r.each(CAICUI.render.getTasksProgress,function(e,r){e.chapterId==CAICUI.render.openChapterId&&a.push(e)});var t="no",n=0,s=0,o="icon-course-list-default";if(a)if(o="icon-course-list-learning",a.length==CAICUI.render.openTasksNum){switch(r.each(a,function(e,r){"1"==e.state?n++:"0"==e.state&&s++}),n==CAICUI.render.openTasksNum?t="end":(s||n)&&(t="ing"),t){case"no":o="icon-course-list-default";break;case"ing":o="icon-course-list-learning";break;case"end":o="icon-course-list-completed"}e("body #icon-progress-"+CAICUI.render.openChapterId).attr("class","icon icon-left "+o)}else e("body #icon-progress-"+CAICUI.render.openChapterId).attr("class","icon icon-left "+o);else e("body #icon-progress-"+CAICUI.render.openChapterId).attr("class","icon icon-left "+o)},courseByInFo:function(r){var a=0;if(e.isArray(r)){for(var t=r.length,n=0;n<t;n++)"false"==r[n].isExpiration&&"acitve"==r[n].activeState&&(CAICUI.render.courseActiveTime=1e3*r[n].activeTime,CAICUI.render.courseExpirationTime=r[n].expirationTime);for(var s=Date.parse(new Date)/1e3,o=0;o<t;o++){if("acitve"==r[o].activeState&&r[o].expirationTime>s&&a<3){a=3;break}"init"==r[o].activeState&&a<2?a=2:"acitve"==r[o].activeState&&r[o].expirationTime<s&&a<1&&(a=1)}}a&&CAICUI.render.lockStatus&&(a=4),CAICUI.render.courseDetailRenderData.courseActiveState=a,CAICUI.render.courseDetail.courseActiveState=a},openVideo:function(r){var a=CAICUI.render.courseDetail.courseActiveState,n=CAICUI.iGlobal.getThat(r),s=n.attr("link"),o=n.attr("data-chapterid"),i=n.attr("data-taskslength");"javascript:;"!==s?(CAICUI.render.openChapterId=o,CAICUI.render.openTasksNum=i,CAICUI.render.formCourseStudy=!0,CAICUI.NavVideo=!1,e("body .course-desc").attr("href",s),CAICUI.render.lastLearnChapterName=n.find(".course-list-desc").text(),CAICUI.render.lastLearnChapterLink=s,t.setsingle("playlist-index"+CAICUI.render.courseId,"c|"+n.attr("data-index")),window.location.hash=s):4==a?I.msg("Sorry~ 您当前的课程已锁定",function(){}):2==a?I.msg("Sorry~ 您当前的课程未激活",function(){}):1==a?I.msg("Sorry~ 您当前的课程已过期",function(){}):0===a&&I.msg("Sorry~ 您未购买当前的课程",function(){})},openQuestions:function(e){e.stopPropagation();var r=CAICUI.iGlobal.getThat(e);CAICUI.render.chapterId=r.attr("data-chapterId"),CAICUI.render.chapterName=r.attr("data-chapterName"),CAICUI.render.knowledgepointid=r.attr("data-knowledgepointid"),CAICUI.render.cacheKnowledgeLevel1Id=r.attr("data-cache-knowledge-level1-id"),CAICUI.render.cacheKnowledgeLevel2Id=r.attr("data-cache-knowledge-level2-id"),CAICUI.render.cacheKnowledgePath=r.attr("data-cache-knowledge-path"),CAICUI.render.exerciseFilename=r.attr("data-exercise-filename"),CAICUI.render.errorNum=+r.attr("data-errornum")||0,CAICUI.render.lastExerciseNid=+r.attr("data-last-exercise-nid")||0,CAICUI.render.ExerciseProgress=+r.attr("data-exercise-progress")||0,CAICUI.render.ExerciseTotalTime=+r.attr("data-exercise-total-time")||0,CAICUI.render.exerciseCount=+r.attr("data-exercise-count"),this.addAnimate(function(){(new n).render()})},addAnimate:function(r){var a=e(window).width(),t=e(window).height();e("body").prepend('<div id="animate" style="width:'+a+'px;"></div>'),e("#animate").animate({height:t,top:"0"},300,function(){r&&r()})},addRecentCourse:function(e){if(CAICUI.render.learningcourseData&&CAICUI.CACHE.RecentCourse)for(var r=0;r<CAICUI.render.learningcourseData.length;r++)if(CAICUI.render.learningcourseData[r].courseId==e){for(var a=!0,t=0;t<CAICUI.CACHE.RecentCourse.length;t++)CAICUI.CACHE.RecentCourse[t].courseId==e&&(a=!1);return a&&CAICUI.CACHE.RecentCourse.push(CAICUI.render.learningcourseData[r]),void(CAICUI.CACHE.RecentCourse.length>2&&CAICUI.CACHE.RecentCourse.splice(0,1))}},filterLearningcourse:function(e){for(var a=r.chain(e).map(function(e){return e.categoryName}).uniq().value(),t=r.chain(e).map(function(e){return e.categoryIndex}).uniq().value(),n=[],s=0;s<a.length;s++)n.push({categoryName:a[s],categoryIndex:t[s],list:[]}),r.each(e,function(e,r,t){e.categoryName==a[s]&&(n&&n[s]&&n[s].list?n[s].list.push(e):n[s].list=[e])});for(s=0;s<n.length;s++){n[s].newList=[];for(var o=n[s].list,i=r.chain(o).map(function(e){return e.subjectName}).uniq().value(),I=r.chain(o).map(function(e){return e.subjectIndex}).uniq().value(),d=0;d<i.length;d++)n[s].newList.push({subjectName:i[d],subjectIndex:I[d],list:[]}),r.each(n[s].list,function(e,a,t){if(e.subjectName==i[d])if(n[s].newList[d].list){var o=!0;r.each(n[s].newList[d].list,function(r,a,t){e.courseId==r.courseId&&(o=!1)}),o&&n[s].newList[d].list.push(e)}else n[s].newList[d].list=[e]})}n=r.sortBy(n,"categoryIndex");return r.each(n,function(e,a){n[a].newList=r.sortBy(e.newList,"subjectIndex"),r.each(n[a].newList,function(e,t){n[a].newList[t].list=r.sortBy(e.list,"courseIndex")})}),n},courseVersionListShow:function(r){var a=CAICUI.iGlobal.getThat(r),t=e(".courseVersion-list"),n=a.attr("data-click");if(t.hasClass("active"))t.removeClass("active");else if(CAICUI.render.versionId)if(CAICUI.render.courseVersion&&CAICUI.render.courseVersion.length){var s=e("#template-courseStudy-courseVersionList").html(),o=CAICUI.iGlobal.getTemplate(s,{courseVersion:CAICUI.render.courseVersion,courseActiveTime:CAICUI.render.courseActiveTime,categoryName:CAICUI.render.courseDetail.categoryName});e("body .courseVersion-list").html(o),t.addClass("active")}else"true"!=n&&(a.attr("data-click","true"),CAICUI.render.$this.courseVersionDataAjax(function(){var r=e("#template-courseStudy-courseVersionList").html(),a=CAICUI.iGlobal.getTemplate(r,{courseVersion:CAICUI.render.courseVersion,courseActiveTime:CAICUI.render.courseActiveTime,categoryName:CAICUI.render.courseDetail.categoryName});e("body .courseVersion-list").html(a),t.addClass("active")}))},courseVersionListA:function(r){var a=CAICUI.iGlobal.getThat(r);a.hasClass("active")||(a.siblings().removeClass("active"),a.addClass("active"));e(".courseVersion-list").removeClass("active")},optionCourse:function(e){CAICUI.iGlobal.getThat(e);CAICUI.render.lastLearnChapterName="",CAICUI.render.lastLearnChapterLink=""},courseNavToggle:function(r){var a=r.currentTarget,t=e(a),n=t.parent();CAICUI.render.courseId=t.attr("data-courseid"),n.toggleClass("active"),window.CAICUI.myScrollCourseStudyList.refresh()},courseNavUlLeave:function(e){CAICUI.iGlobal.getThat(e);this.courseNavPreAnimate(this.courseNavPre),this.courseNavPre=this.courseNavPreDefault,CAICUI.render.$this.$(".courseIndex-li").eq(this.courseNavPre).addClass("hover"),this.courseNavAnimate(this.$(".courseIndex-active-box").eq(this.courseNavPre),this.courseNavPre),CAICUI.render.$this.$(".courseIndex-ul").removeClass("hover")},courseNavLiLeave:function(e){},courseNavLiEnter:function(e){var r=CAICUI.iGlobal.getThat(e),a=r.index(),t=r.find(".courseIndex-active-box");if(a==this.courseNavPre)return!1;r.addClass("hover"),this.courseNavPreAnimate(this.courseNavPre),this.courseNavAnimate(t,a),this.courseNavPre=a},courseNavPreAnimate:function(e){var r=this.$(".courseIndex-li").eq(e),a=!1;CAICUI.render.$this.$(".courseIndex-ul").hasClass("hover")||(a=!0),this.$(".courseIndex-active-box").eq(e).stop(!0,!1).animate({width:34,marginLeft:0},this.courseNavAnimateTime,function(){r.removeClass("hover"),a&&(CAICUI.render.$this.$(".courseIndex-ul").addClass("hover"),a=!1)})},courseNavAnimate:function(e,r){e.stop(!0,!1).animate({width:"148px"},this.courseNavAnimateTime)},openCourseBaseInfo:function(){var r=e("#template-course-baseInfo").html(),a=CAICUI.iGlobal.getTemplate(r);e("body #layout").append(a),e("body .courseIndex-baseInfo-btn").addClass("hidden"),e("body .course-baseInfo-closeBtn").on("click",function(){e("body .course-baseInfo").remove(),e("body .courseIndex-baseInfo-btn").removeClass("hidden")}),CAICUI.render.activationCourse=new o,e("body .course-baseInfo-content").append(CAICUI.render.activationCourse.render({coursesBaseInfo:CAICUI.render.courseDetail,isActivationCourse:!1,isPlan:CAICUI.render.courseDetailRenderData.weekList}).el),e("body .course-activation-acca-content").find("img").each(function(r){var a=e(this).attr("src"),t=a.substr(-3);"jpg"!=t&&"png"!=t&&"gif"!=t&&"svg"!=t||(a=window.static+a),e(this).attr("src",a)}),setTimeout(function(){window.CAICUI.myScrollCourseModel=CAICUI.iGlobal.iScroll("body #wrapper-courseModel")},50),window.CAICUI.myScrollActivationAcca=CAICUI.iGlobal.iScroll("body #wrapper-activation-acca")},applyEditorLearningPlan:function(){var r=e("#template-apply-editor-learningPlan").html(),a=CAICUI.iGlobal.getTemplate(r);e("body #right").append(a),CAICUI.render.applyEditorLearningPlanCheckbox=!0,e("body .apply-editor-learningPlan-checkbox").on("click",function(){var r=e(this);r.hasClass("active")?(r.removeClass("active"),CAICUI.render.applyEditorLearningPlanCheckbox=!1):(r.addClass("active"),CAICUI.render.applyEditorLearningPlanCheckbox=!0)}),e("body .apply-editor-learningPlan-cancel").on("click",function(){I.close(CAICUI.render.applyEditorLearningPlan),e("body .apply-editor-learningPlan").remove()}),e("body .apply-editor-learningPlan-confirm").on("click",function(){I.close(CAICUI.render.applyEditorLearningPlan),e("body .apply-editor-learningPlan").remove(),CAICUI.Request.ajax({server:"saveExtension",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.courseDetail.subjectId,courseId:CAICUI.render.courseId},done:function(e){I.msg("申请成功~",{icon:1})},fail:function(e){I.msg("Sorry~申请失败")}})}),CAICUI.render.applyEditorLearningPlan=I.open({type:1,title:!1,shade:!0,scrollbar:!1,closeBtn:0,skin:"layui-skin layui-apply-editor-learningPlan",area:["425px","250px"],content:e("#apply-editor-learningPlan"),success:function(){}})}})});