define(["jquery","underscore","backbone"],function(e,r,t){"use strict";return t.View.extend({el:"body #right",template:r.template(e("#template-studycenterIndex").html()),events:{"mouseenter .studyin-content-subjects":"subjectEnter","mouseleave .studyin-content-subjects":"subjectLeave","click .contarner-start":"list","click .index-course-a":"changeNav","click .courseIntro-nextShow-btn":"courseIntroNextShow","click .courseIntro-close":"courseIntroClose","click .courseIntro-email-a":"courseIntroEmail","click .courseIntro-default":"wileyCourseStudy","click .js-index-live":"indexLive","mouseenter .js-index-live":"indexLiveEnter","mouseleave .js-index-live":"indexLiveLeave","click .teachingPlan-a":"changeClass","click .teachingPlan-course-a":"changeClassCourse"},render:function(){CAICUI.render.$this=this,CAICUI.render.indexOpenCourse="",CAICUI.render.classIndex=0,CAICUI.render.classCourseIndex=0,CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{mycount:"",capabilityAssessment:"",RecentCourse:"",slideList:"",loginloglist:"",getExamDate:"",experience:""}})),CAICUI.render.$this.classCourseListAjax(function(e){e.classCourseList.studyIn&&e.classCourseList.studyIn.length&&(CAICUI.render.classCourseList=e.classCourseList.studyIn,CAICUI.render.$this.classRender())}),this.mycount(),this.slideList(),this.loginloglist(),this.getExamDate(function(){CAICUI.render.$this.learningcourse()}),CAICUI.render.$this.getappointmentlist(function(r){if(r){var t=e("#template-index-live").html(),n=CAICUI.iGlobal.getTemplate(t,{data:r});e("body .index-top").append(n)}}),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")},classCourseListAjax:function(e){CAICUI.Request.ajax({server:"node-classCourseList",data:{token:CAICUI.nodeToken},done:function(r){e&&e(r)}})},classCourseDetailAjax:function(e){CAICUI.Request.ajax({server:"node-classCourseDetail",data:{token:CAICUI.nodeToken,memberId:CAICUI.nodeMemberId,courseId:CAICUI.render.classCourseList[CAICUI.render.classIndex].classCourse[CAICUI.render.classCourseIndex].courseId},done:function(r){e&&e(r)}})},classCourseDetailDom:function(){CAICUI.render.$this.classCourseDetailAjax(function(r){var t=r.planInfo[parseInt(r.weekIngNum)];console.log(t);var n=e("#template-teachingPlan-info-left").html(),a=CAICUI.iGlobal.getTemplate(n,{classCourseId:r.courseInfo.courseId,classCourseDetail:t,isClassCourseStart:!0,isStudycenterIndex:!0});e("body .index-teachingPlan-info").html(a),window.CAICUI.myScroll.refresh()})},classRender:function(){var r=e("#template-teachingPlan-nav").html(),t=CAICUI.iGlobal.getTemplate(r,{classIndex:CAICUI.render.classIndex,classCourseIndex:CAICUI.render.classCourseIndex,classCourseList:CAICUI.render.classCourseList});e("body .index-teachingPlan").html(t),CAICUI.render.$this.classCourseDetailDom()},changeClass:function(e){var r=CAICUI.iGlobal.getThat(e);if(r.hasClass("active"))return!1;var t=r.index();r.siblings().removeClass("active"),r.addClass("active"),CAICUI.render.classIndex=t,CAICUI.render.classCourseIndex=0,this.classRender()},changeClassCourse:function(e){var r=CAICUI.iGlobal.getThat(e);if(r.hasClass("active"))return!1;var t=r.index();r.siblings().removeClass("active"),r.addClass("active"),CAICUI.render.classCourseIndex=t,this.classRender()},indexLive:function(){if(CAICUI.render.isLiveClick){var e=CAICUI.render.indexOpenCourse.liveRoomId,r=CAICUI.render.indexOpenCourse.liveManageId,t=CAICUI.render.indexOpenCourse.liveRoomPassword?CAICUI.render.indexOpenCourse.liveRoomPassword:"0";"roomid="+e,"&userid="+r,"&autoLogin=true",CAICUI.User.nickname&&""!=CAICUI.User.nickname?"&viewername="+CAICUI.User.nickname:"&viewername="+CAICUI.User.memberId,"&viewertoken="+t,CAICUI.iGlobal.addLiveAnimate(function(){console.log("#live/"+CAICUI.render.indexOpenCourse.id+"/"+e+"/"+r+"/"+t+"?return_link=#studycenterIndex&return_hash=on"),window.location.hash="#live/"+CAICUI.render.indexOpenCourse.id+"?return_hash=on&from=0"})}},indexLiveEnter:function(e){var r=CAICUI.iGlobal.getThat(e);CAICUI.render.$this.isLiveTime(CAICUI.render.indexOpenCourse.startTime,CAICUI.render.indexOpenCourse.endTime)?CAICUI.render.isLiveClick=!0:r.addClass("active")},indexLiveLeave:function(e){CAICUI.iGlobal.getThat(e).removeClass("active")},getappointmentlist:function(e){CAICUI.render.indexOpenCourse?e&&e(CAICUI.render.indexOpenCourse):CAICUI.Request.ajax({server:"getappointmentlist",data:{memberId:CAICUI.User.memberId},done:function(t){CAICUI.render.appointmentlist=t.data;for(var n="",a=[],s=(new Date).getTime(),o=0;o<t.data.length;o++){n=t.data[o];var i=CAICUI.render.$this.isToday(n.startTime,n.endTime);console.log(i),i&&s<n.endTime&&a.push(n)}if(a&&a.length){var I=r.min(a,function(e){return e.startTime});console.log(I),CAICUI.render.indexOpenCourse=I}e&&e(CAICUI.render.indexOpenCourse)},fail:function(e){CAICUI.render.indexOpenCourse={}}})},isToday:function(e,r){var t=(new Date).getFullYear(),n=(new Date).getMonth(),a=(new Date).getDate(),s=new Date(e).getFullYear(),o=new Date(e).getMonth(),i=new Date(e).getDate(),I=new Date(r).getFullYear(),C=new Date(r).getMonth(),d=new Date(r).getDate(),l=!1;return console.log(t+"-"+n+"-"+a),console.log(s+"-"+o+"-"+i),console.log(I+"-"+C+"-"+d),t===s&&n===o&&a===i&&(l=!0),t===I&&n===C&&a===d&&(l=!0),l},isLiveTime:function(){var e=!1;if(CAICUI.render.indexOpenCourse){var r=(new Date).getTime(),t=CAICUI.render.indexOpenCourse.startTime,n=CAICUI.render.indexOpenCourse.endTime;t<r&&r<n&&(e=!0),r<t&&(CAICUI.render.isLiveTimeBefore=!0),n<r&&(CAICUI.render.isLiveTimeAfter=!0)}return e},mycount:function(){CAICUI.render.mycount&&CAICUI.render.mycount.length?(e("body .nodeNum").html(CAICUI.render.mycount.nodeNum),e("body .acNum").html(CAICUI.render.mycount.questionNum+CAICUI.render.mycount.discuss)):CAICUI.Request.ajax({server:"mycount",data:{token:CAICUI.User.token},done:function(r){CAICUI.render.mycount=r.data,e("body .nodeNum").html(r.data.nodeNum),e("body .acNum").html(r.data.questionNum+r.data.discuss)},fail:function(e){CAICUI.render.mycount={}}})},capabilityAssessment:function(){CAICUI.Request.ajax({server:"capabilityAssessment",data:{token:CAICUI.User.token,id:CAICUI.User.memberId},done:function(r){CAICUI.render.capabilityAssessment=r.data[0];var t=r.data[0]?r.data[0].total:"0";e("body .examNum").html(t)},fail:function(e){CAICUI.render.capabilityAssessment={}}})},learningcourse:function(){CAICUI.render.filterLastProgress?CAICUI.render.$this.learningcourseRender(CAICUI.render.filterLastProgress):CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:1,pageSize:CAICUI.defaultPageSize},done:function(e){CAICUI.CACHE.Learningcourse=e.data.courselist;for(var r=e.data.courselist,t=[],n=0;n<r.length;n++)t.push(r[n].courseId);t&&t.length?CAICUI.Request.ajax({server:"actionGetCourseProgress",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,courseId:t.toString()},done:function(e){for(var t={RecentCourse:[]},n=0;n<r.length;n++)for(var a=0;a<e.data.length;a++)if(r[n].courseId==e.data[a].courseId&&t.RecentCourse.courseId!=e.data[a].courseId){var s=!0;if(t.RecentCourse&&t.RecentCourse.length)for(var o=0;o<t.RecentCourse.length;o++)t.RecentCourse[o].courseId==e.data[a].courseId&&(s=!1);s&&(r[n].courseProgress=e.data[a].courseProgress,r[n].createDate=e.data[a].createDate,r[n].chapterId=e.data[a].chapterId,r[n].chapterName=e.data[a].chapterName,r[n].progress=e.data[a].progress,r[n].taskId=e.data[a].taskId,r[n].taskName=e.data[a].taskName,t.RecentCourse.push(r[n]))}n=0;var i,I=(C=t.RecentCourse).length;for(n=0;n<I;n++)for(a=0;a<I;a++)parseInt(C[n].createDate)>parseInt(C[a].createDate)&&(i=C[a],C[a]=C[n],C[n]=i);if(C.length>3)var C=C.slice(0,3);for(n=0;n<C.length;n++)for(a=0;a<CAICUI.render.examDateData.length;a++)C[n].subjectID==CAICUI.render.examDateData[a].categoryId&&(C[n].examinationDate=CAICUI.render.examDateData[a].examinationDate);CAICUI.render.filterLastProgress=C,CAICUI.render.$this.learningcourseRender(C)}}):CAICUI.render.$this.learningcourseRender([])},fail:function(e){CAICUI.CACHE.Learningcourse={},CAICUI.CACHE.RecentCourse={},CAICUI.render.filterLastProgress={}}})},learningcourseRender:function(r){var t=e("#template-studycenterIndex-courseList").html(),n=CAICUI.iGlobal.getTemplate(t,{RecentCourse:r});e("body .index-course-ul").html(n),e("body .index-course-li").each(function(e){CAICUI.iGlobal.canvasRound("progress-round-"+e)}),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")},slideList:function(){if(CAICUI.render.slideList&&CAICUI.render.slideList.length){var r=e("#template-studycenterIndex-activityList").html(),t=CAICUI.iGlobal.getTemplate(r,{slideList:CAICUI.render.slideList});e("body .index-activity-ul").html(t),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")}else CAICUI.Request.ajax({server:"slide-list",data:{tag:"0",valid:"true",count:"4"},done:function(r){CAICUI.render.slideList=r.data;var t=e("#template-studycenterIndex-activityList").html(),n=CAICUI.iGlobal.getTemplate(t,{slideList:r.data});e("body .index-activity-ul").html(n),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")},fail:function(e){CAICUI.render.slideList={}}})},loginloglist:function(){CAICUI.render.loginloglist&&CAICUI.render.loginloglist.length?e("body .loginloglist").html(CAICUI.render.loginloglist):CAICUI.Request.ajax({server:"loginloglist",data:{memberid:CAICUI.User.memberId,pageNo:1,pageSize:1},done:function(r){var t=r.data[0]?CAICUI.iGlobal.stringData(r.data[0].loginTime/1e3):"第一次登录";CAICUI.render.loginloglist=t,e("body .loginloglist").html(t)},fail:function(e){CAICUI.render.loginloglist={}}})},getExamDate:function(r){if(CAICUI.render.examDateData&&CAICUI.render.examDateData.length){var t=CAICUI.render.examDateData[0],n=t?t.categorySign+" "+CAICUI.iGlobal.getDate(t.examinationDate):"暂无考试";e("body .getExamDate").html(n),r&&r()}else CAICUI.Request.ajax({server:"getExamDate",data:{memberId:CAICUI.User.memberId},done:function(t){CAICUI.render.examDateData=t.data;var n=(t=t.data[0])?t.categorySign+" "+CAICUI.iGlobal.getDate(t.examinationDate):"暂无考试";CAICUI.render.examDate=n,e("body .getExamDate").html(n),r&&r()},fail:function(e){CAICUI.render.examDate={}}})},changeNav:function(e){var r=CAICUI.iGlobal.getThat(e);CAICUI.isNav=!0,r.hasClass("js-coursestudy")&&this.courseStudy(r)},courselistFilter:function(e){var t=[];if(e&&e.length)for(var n=r.chain(e).uniq("courseId").pick(function(e){return e.lastTaskdate}).sortBy("lastTaskdate").reverse().value(),a=0;a<n.length&&!(a>2);a++)n[a]&&n[a].lastTaskdate&&t.push(n[a]);return{RecentCourse:t}},subjectEnter:function(r){var t=r.currentTarget,n=e(t),a=(n.index(),n.find(".subject-lf").find(".subject-mask")),s=n.find(".subject-rt");return a.stop(!0,!1).animate({left:"0"}),{mask:a,rt:s}},subjectLeave:function(e){this.subjectEnter(e).mask.stop(!0,!1).animate({left:"-160px"})},courseStudy:function(r){CAICUI.render.courseIdActive=r.attr("data-courseId");var t=e.cookie("courseIntro-"+CAICUI.User.memberId),n=!0;if(t&&t.length){t=JSON.parse(t);for(var a=0;a<t.length;a++)t[a]==CAICUI.render.courseIdActive&&(n=!1)}if(CAICUI.render.orderItemId=r.attr("data-orderItemId"),n){if(CAICUI.render.courseName=r.attr("data-courseName"),CAICUI.render.courseSource=r.attr("data-courseSource"),CAICUI.render.expirationTime=r.attr("data-expirationTime"),"wiley"==CAICUI.render.courseSource){var s=.618*e(window).width();s<605.64?s=605.64:s>988.8&&(s=988.8),CAICUI.render.firstOpenCourseSourcePop=e.cookie("firstOpenCourseSourcePop"),"true"!=CAICUI.render.firstOpenCourseSourcePop&&(e.cookie("firstOpenCourseSourcePop",!0,{path:"/",expires:36500}),e("body").append('<iframe class="wiley-iframe" src="https://app.efficientlearning.com/pv5/v8/1/app/cfa2017/level2.html?auth=wj5FSziNSkafKB4OI%2BURB3bovRo%3D" width="0" height="0" frameborder="0"></iframe>')),CAICUI.render.closeIntro=layer.open({type:1,title:!1,shade:!0,scrollbar:!1,area:[s+"px","auto"],closeBtn:0,content:e("#courseIntro"),success:function(){e(".layui-layer-shade").css("filter","alpha(opacity=50)"),e(".courseIntro-time").removeClass("hidden"),e(".courseIntro-time-span").text(CAICUI.iGlobal.getDate(CAICUI.render.expirationTime)),CAICUI.render.member&&!CAICUI.render.memberReset?CAICUI.render.$this.popInit():CAICUI.render.$this.getMember(function(){CAICUI.render.memberReset=!1,CAICUI.render.$this.popInit()})}})}}else this.wileyCourseStudyAjax()},getMember:function(e){CAICUI.Request.ajax({server:"member",data:{token:CAICUI.User.token},done:function(r){"success"==r.state?(CAICUI.render.member=r.data,e&&e()):console.log("member:"+r)},fail:function(e){console.log("member:"+e)}})},wileyCourseStudy:function(e){var r=CAICUI.iGlobal.getThat(e);r.removeClass("courseIntro-default").addClass("courseIntro-disabled"),this.wileyCourseStudyAjax(function(){r.removeClass("courseIntro-disabled").addClass("courseIntro-default"),layer.close(CAICUI.render.closeIntro)})},wileyCourseStudyAjax:function(r){layer.close(CAICUI.render.closeIntro),CAICUI.render.introLoading=layer.open({type:1,title:!1,shade:!0,scrollbar:!1,area:["350px","auto"],closeBtn:0,content:e("#courseIntroLoading"),success:function(){CAICUI.render.wileyCourseStudyTimeStart=(new Date).getTime(),CAICUI.Request.ajax({server:"wileyCourseStudy",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseIdActive,orderItemId:CAICUI.render.orderItemId,courseSource:"wiley"},done:function(t){if("success"==t.state&&"302"==t.data.status&&""!=t.data.url){r&&r();var n={token:CAICUI.User.token,memberId:CAICUI.User.memberId,memberName:CAICUI.User.nickname,progress:1,total:1,taskId:CAICUI.render.courseIdActive,chapterId:CAICUI.render.courseIdActive,courseId:CAICUI.render.courseIdActive,subjectId:CAICUI.render.courseIdActive,categoryId:CAICUI.render.courseIdActive,taskName:CAICUI.render.courseName,chapterName:CAICUI.render.courseName,courseName:CAICUI.render.courseName,subjectName:CAICUI.render.courseName,categoryName:CAICUI.render.courseName,state:0,isSupply:0};n.createDate=(new Date).getTime(),CAICUI.render.wileyCourseStudyTimeEnd=n.createDate,CAICUI.Request.ajax({server:"actionTaskProgress",data:{token:CAICUI.User.token,message:JSON.stringify(n)},done:function(e){console.log(e)}}),CAICUI.render.$this.popLoadingInit(),CAICUI.render.$this.addAnimate(function(){var r=e("#template-course-wiley-iframe").html(),n=CAICUI.iGlobal.getTemplate(r,{title:CAICUI.render.courseName,wileyUrl:t.data.url});e("#animate").html(n),e(".js-wiley-iframe-close").on("click",function(){CAICUI.render.$this.removeAnimate()})})}else console.log("wileyCourseStudy:"+t),CAICUI.render.$this.wileyCourseStudyLoading()},fail:function(e){console.log("wileyCourseStudy:"+e),CAICUI.render.$this.wileyCourseStudyLoading()}})}})},wileyCourseStudyLoading:function(){e(".courseIntroLoading").addClass("active");var r=5;CAICUI.render.introLoadingTimes=setInterval(function(){--r?e(".courseIntroLoading-time").text(r):(r=0,clearInterval(CAICUI.render.introLoadingTimes),CAICUI.render.$this.popLoadingInit())},1e3)},popInit:function(){e(".courseIntro-footer").css("opacity",1),CAICUI.render.emailState="",CAICUI.render.member.email?CAICUI.iGlobal.isChineseChar(CAICUI.render.member.email)&&(CAICUI.render.emailState="邮箱里面有中文"):CAICUI.render.emailState="邮箱为空",CAICUI.render.emailState&&(e(".courseIntro-email").css("opacity",1),e(".courseIntro-email-info").text(CAICUI.render.emailState),e(".courseIntro-btn").removeClass("courseIntro-default").addClass("courseIntro-disabled"))},popLoadingInit:function(){if("true"!=CAICUI.render.firstOpenCourseSourcePop&&CAICUI.render.wileyCourseStudyTimeEnd){var r=CAICUI.render.wileyCourseStudyTimeEnd-CAICUI.render.wileyCourseStudyTimeStart;if(console.log(r),r<3e3)return setTimeout(function(){e(".courseIntro-btn").removeClass("courseIntro-disabled").addClass("courseIntro-default"),e(".courseIntroLoading").removeClass("active"),e(".courseIntroLoading-time").text(5),layer.close(CAICUI.render.introLoading)},3-r),!1}e(".courseIntro-btn").removeClass("courseIntro-disabled").addClass("courseIntro-default"),e(".courseIntroLoading").removeClass("active"),e(".courseIntroLoading-time").text(5),layer.close(CAICUI.render.introLoading)},courseIntroNextShow:function(r){var t=CAICUI.iGlobal.getThat(r),n=e.cookie("courseIntro-"+CAICUI.User.memberId);if(t.hasClass("active")){if(n&&n.length){n=JSON.parse(n);for(var a=0;a<n.length;a++)n[a]==CAICUI.render.courseIdActive&&n.splice(a,1)}t.removeClass("active")}else n&&n.length?(n=JSON.parse(n)).push(CAICUI.render.courseIdActive):n=[CAICUI.render.courseIdActive],t.addClass("active");e.cookie("courseIntro-"+CAICUI.User.memberId,JSON.stringify(n),{path:"/",expires:36500})},courseIntroClose:function(){layer.close(CAICUI.render.closeIntro)},courseIntroEmail:function(){CAICUI.render.memberReset=!0,layer.close(CAICUI.render.closeIntro)},addAnimate:function(r){var t=e(window).width(),n=e(window).height();e("body").prepend('<div id="animate" style="width:'+t+'px;"></div>'),e("#animate").animate({height:n,top:"0"},300,function(){r&&r()})},removeAnimate:function(r){e("#animate").animate({height:"0",top:"50%"},300,function(){e("#animate").remove(),r&&r()})}})});