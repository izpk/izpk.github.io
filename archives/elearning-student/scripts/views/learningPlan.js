define(["jquery","underscore","backbone","views/learningPlanPreview","datetimepicker","datetimepickerZHCN"],function(e,n,a,r,i,t){"use strict";return a.View.extend({tagName:"div",className:"learning-plan-main",template:n.template(e("#template-learning-plan").html()),events:{"click .learning-plan-select-checkbox":"selectCourseItem","click .learning-plan-course-li":"changeCycle","click .learning-plan-preview-open":"learningPlanPreviewOpen","click .learning-plan-activation":"learningPlanActivation","click .js-learning-plan-close":"learningPlanClose","change .learning-plan-examTime-input":"changeCourseExamTime"},type:"",render:function(a){return CAICUI.render.thisLearningPlan=this,CAICUI.render.weekToSecond=6048e5,CAICUI.render.learningPlanTimeTotal=0,CAICUI.render.learningPlanList=[],CAICUI.render.learningPlanExamTime=[],CAICUI.render.courseExamTime="",this.$el.html(this.template()),CAICUI.render.thisLearningPlan.subjectTimeListAjax(CAICUI.render.subjectID,function(e){CAICUI.render.learningPlanExamTime=e,CAICUI.render.thisLearningPlan.computedWeek()}),CAICUI.render.thisLearningPlan.courselistAjax(function(a){console.log(a),CAICUI.render.learningPlanCourseItem=a.length;var r=e("#template-learning-plan-step1-main").html(),i=CAICUI.iGlobal.getTemplate(r,{courselist:a});e("body .learning-plan-step1-main").html(i),CAICUI.render.myScrollLearningPlanStep1.refresh(),CAICUI.render.planList=[],CAICUI.render.hasPlanList=!1,CAICUI.render.planListAjaxTotal=a.length,CAICUI.render.planListAjaxNum=0,CAICUI.render.planListInterval="",n.each(a,function(e,n){CAICUI.render.planList.push({title:e.title,courseId:e.id,planList:[]}),CAICUI.render.thisLearningPlan.getplanAjax(e.id,function(e){e&&e.length&&(CAICUI.render.hasPlanList=!0),CAICUI.render.planList[n].planList=e,CAICUI.render.planListAjaxNum++})}),CAICUI.render.planListInterval=setInterval(function(){if(CAICUI.render.planListAjaxNum==CAICUI.render.planListAjaxTotal){clearInterval(CAICUI.render.planListInterval);var n=e("#template-learning-plan-step2-main").html(),a=CAICUI.iGlobal.getTemplate(n,{hasPlanList:CAICUI.render.hasPlanList,planList:CAICUI.render.planList});e("body .learning-plan-step2-main").html(a),CAICUI.render.myScrollLearningPlanStep2.refresh(),CAICUI.render.thisLearningPlan.computedWeek(),e("body .learning-plan-startTime-input").datetimepicker({language:"zh-CN",weekStart:1,todayBtn:1,autoclose:1,todayHighlight:1,startView:2,minView:2,forceParse:0}).on("changeDate",function(e){var n=e.date.valueOf();CAICUI.render.learningPlanActiveTimePicker=n,CAICUI.render.thisLearningPlan.computedWeek(n)})}},300)}),this},courselistAjax:function(e){CAICUI.Request.ajax({server:"courselist",data:{courseGroupId:CAICUI.render.courseGroupId,courseCategoryId:CAICUI.render.subjectID},done:function(n){n.data&&n.data.length&&e&&e(n.data)}})},getplanAjax:function(e,n){CAICUI.Request.ajax({server:"getplan",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.subjectID,courseId:e},done:function(e){n&&n(e.data)},fail:function(e){}})},timeListAjax:function(e,n){CAICUI.Request.ajax({server:"timeList",data:{courseId:e},done:function(e){n&&n(e.data)},fail:function(e){}})},subjectTimeListAjax:function(e,n){CAICUI.render.planListInterval&&clearInterval(CAICUI.render.planListInterval),CAICUI.Request.ajax({server:"subjectTimeList",data:{subjectId:e},done:function(e){n&&n(e.data)},fail:function(e){}})},saveplanAjax:function(e){CAICUI.Request.ajax({server:"saveplan",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.subjectID,orderItemId:CAICUI.render.orderItemId,planIds:CAICUI.render.planIds.toString(),examinationDate:CAICUI.iGlobal.getDate(CAICUI.render.learningPlanList[0].examinationDate,"-"),activeTime:CAICUI.iGlobal.getDate(CAICUI.render.learningPlanActiveTime,"-")},done:function(n){e&&e(n.data)},fail:function(e){}})},courseActive:function(n){CAICUI.Request.ajax({server:"active",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseId,isU:CAICUI.render.isU,orderItemId:CAICUI.render.orderItemId,examTime:CAICUI.iGlobal.getDate(CAICUI.render.courseExamTime,"-")},done:function(n){"success"==n.state?window.location.hash="#courseStudy/"+CAICUI.render.courseId:layer.msg("Sorry~ 课程激活失败！",function(){e("body .learning-plan-activation").removeClass("hidden"),e("body .learning-plan-activationing").addClass("hidden")})},fail:function(n){layer.msg("Sorry~ 课程激活失败！",function(){e("body .learning-plan-activation").removeClass("hidden"),e("body .learning-plan-activationing").addClass("hidden")})}})},memberGetplanAjax:function(e){CAICUI.Request.ajax({server:"memberGetplan",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.subjectID,courseId:CAICUI.render.learningPlanList[0].courseId},done:function(n){e&&e(n.data)},fail:function(e){}})},selectCourseItem:function(n){var a=CAICUI.iGlobal.getThat(n),r=a.index();a.hasClass("active")?(CAICUI.render.learningPlanCourseItem--,a.removeClass("active"),e("body .learning-plan-course-item").eq(r).removeClass("active")):(CAICUI.render.learningPlanCourseItem++,a.addClass("active"),e("body .learning-plan-course-item").eq(r).addClass("active")),this.computedWeek()},computedWeek:function(n){CAICUI.render.learningPlanList=[];var a=[],r=0;r=CAICUI.render.learningPlanActiveTimePicker?CAICUI.render.learningPlanActiveTimePicker:(new Date).getTime(),CAICUI.render.learningPlanActiveTime=r,e("body .learning-plan-course-item").each(function(){var n=e(this);if(n.hasClass("active")){var i="";n.find(".learning-plan-course-li").each(function(){var n=e(this),t=n.data("node").split("-"),l=CAICUI.render.planList[t[0]],I=l.planList[t[1]],s=I.weeksNum*CAICUI.render.weekToSecond,C=CAICUI.iGlobal.getDate(r),d=CAICUI.iGlobal.getDate(r+s);a.push({planId:I.id,courseId:l.courseId,courseName:l.title,weeksNum:I.weeksNum,cycle:C+"-"+d,cycleStart:r,cycleEnd:r+s,activeTime:CAICUI.render.learningPlanActiveTime}),n.hasClass("active")&&(i=s,CAICUI.render.learningPlanList.push({planId:I.id,courseId:l.courseId,courseName:l.title,weeksNum:I.weeksNum,cycle:C+"-"+d,cycleStart:r,cycleEnd:r+s,activeTime:CAICUI.render.learningPlanActiveTime}))}),r+=i}}),this.computedWeekRender(a)},computedWeekRender:function(a){CAICUI.render.learningPlanList.length&&CAICUI.render.hasPlanList?e("body .learning-plan-preview-open").addClass("active"):e("body .learning-plan-preview-open").removeClass("active"),CAICUI.render.myScrollLearningPlanStep2.refresh();var r="";n.each(a,function(n,a){r=n.cycleEnd,e("body .learning-plan-course-time").eq(a).html(n.cycle)});var i=[];n.each(CAICUI.render.learningPlanExamTime,function(e,n){e.time>=r&&i.push(e)});var t=e("#template-learning-plan-examTime").html(),l=CAICUI.iGlobal.getTemplate(t,{timeList:i});i&&i.length&&(CAICUI.render.courseExamTime=i[0].time),e("body .learning-plan-examTime-input").html(l),e("body .learning-plan-examTime-input").find("option").eq(0).attr("selected",!0);var I=0;CAICUI.render.planIds=[],n.each(CAICUI.render.learningPlanList,function(e,n){CAICUI.render.planIds.push(e.planId),I+=parseInt(e.weeksNum),CAICUI.render.learningPlanList[n].examinationDate=CAICUI.render.courseExamTime}),CAICUI.render.learningPlanTimeTotal=7*I*24,e("body .learning-plan-time").html(7*I*24);var s=e("body .learning-plan-activation");i.length?s.addClass("active"):s.removeClass("active")},changeCourseExamTime:function(e){var n=CAICUI.iGlobal.getThat(e);CAICUI.render.courseExamTime=n.val()},changeCycle:function(e){var n=CAICUI.iGlobal.getThat(e);n.siblings().removeClass("active"),n.addClass("active"),this.computedWeek()},learningPlanPreviewOpen:function(){CAICUI.render.hasPlanList&&(e("#learning-plan-startTime-input").datetimepicker("hide"),CAICUI.render.learningPlanPreview=new r,e("body .right").append(CAICUI.render.learningPlanPreview.render(CAICUI.render.learningPlanList).el))},learningPlanActivation:function(n){CAICUI.iGlobal.getThat(n).hasClass("active")&&(e("body .learning-plan-activation").addClass("hidden"),e("body .learning-plan-activationing").removeClass("hidden"),CAICUI.render.hasPlanList?this.saveplanAjax(function(e){CAICUI.render.thisLearningPlan.courseActive()}):this.courseActive())},learningPlanClose:function(){CAICUI.render.learningPlan?CAICUI.render.learningPlan.remove():e("body .learning-plan-main").remove()}})});