define(["jquery","underscore","backbone","views/message","views/message-list","views/message-desc","views/ac-desc","layer"],function(e,a,s,t,i,n,o,r){"use strict";return s.View.extend({el:"body",template:a.template(e("#template-layout").html()),events:{"click .nav-li":"addActive","click .exit":"exitOptionShow","click .message-close":"messageClose","click .message-unread-close":"messageUnreadClose","click .sign-out":"signOut","click .js-pagination-li":"paginationChange","click .js-pagination-prev":"paginationPrev","click .js-pagination-next":"paginationNext","click .message-notice-a":"allRead","click .message-read-all":"allReadPop","click .message-unread-number":"messageUnreadNumber"},render:function(a){this.$el.find("#layout").length&&this.$el.find("#layout").remove(),this.$el.html(this.template({nav:a})),this.getappdownloadinfoAjax("aPhoneCourse",function(a){var s=window.static+a.appUrl;e("body .download-mobile-android").attr("href",s),e("body .download-mobile-android").attr("download","true")}),this.getappdownloadinfoAjax("aPadCourse",function(a){var s=window.static+a.appUrl;e("body .download-pad-android").attr("href",s),e("body .download-pad-android").attr("download","true")}),CAICUI.render.navAnimateTime=250,CAICUI.render.this=this,CAICUI.render.messageThis=this,CAICUI.render.thisLayout=this,CAICUI.render.pageNo=1,CAICUI.render.pageSize=20,CAICUI.render.$layout=this.$("#layout"),CAICUI.render.isRead=!1,CAICUI.render.isNoReadNum=0,this.$messageMain=this.$(".message-main"),this.$exitOption=this.$(".exit-option"),this.messageRender(),this.messageListRender(),setTimeout(function(){e(".message").on("click",function(a){e("body .message-main").hasClass("active")?e("body .message-main").removeClass("active"):(CAICUI.render.isRead=!0,e("body .message-main").addClass("active"),CAICUI.render.messageThis.messageRender(),CAICUI.render.messageThis.messageListRender())})},30)},signOut:function(a){CAICUI.iGlobal.getThat(a);CAICUI.Request.ajax({server:"logout",data:{token:CAICUI.User.token},done:function(a){CAICUI.render={},window.localStorage.clear(),e.removeCookie("User",{path:"/"}),e.removeCookie("loginInfo",{path:"/"}),e.removeCookie("Token",{path:"/"}),e.removeCookie("isDemo",{path:"/"}),e.removeCookie("token",{path:"/",expires:-1}),CAICUI.isNav=!0,window.location.href=window.zbgedu.login},fail:function(a){window.localStorage.clear(),e.removeCookie("User",{path:"/"}),e.removeCookie("loginInfo",{path:"/"}),e.removeCookie("Token",{path:"/"}),e.removeCookie("isDemo",{path:"/"}),e.removeCookie("token",{path:"/",expires:-1}),CAICUI.isNav=!0,window.location.href=window.zbgedu.login}})},getappdownloadinfoAjax:function(e,a){CAICUI.Request.ajax({server:"getappdownloadinfo",data:{appId:e},done:function(e){a&&a(e)},fail:function(e){a&&a(e)}})},messageList:function(e){CAICUI.render.isRead?CAICUI.Request.ajax({server:"message-list",data:{token:CAICUI.User.token,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize},done:function(a){CAICUI.render.messageList=a.data,e&&e(a)},fail:function(a){e&&e(a)}}):CAICUI.Request.ajax({server:"message-list",data:{token:CAICUI.User.token,isRead:"0",pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize},done:function(a){CAICUI.render.isNoReadAjax=!0,a.totalCount&&(CAICUI.render.isNoReadNum=a.totalCount),CAICUI.render.thisLayout.messageUnRead(a.data[0]),e&&e(a)},fail:function(a){e&&e(a)}})},bbsdetail:function(e){CAICUI.Request.ajax({server:"bbsdetail",data:{token:CAICUI.User.token,id:CAICUI.render.replayId,pageNo:1,pageSize:20},done:function(a){CAICUI.render.messageBbsDetail=a.data,e&&e(a.data)},fail:function(e){r.msg("Sorry~ 获取信息失败，请刷新页面重试。",function(){})}})},updateStatus:function(a){CAICUI.Request.ajax({server:"updateStatus",data:{token:CAICUI.User.token,messageId:CAICUI.render.messageId,isall:CAICUI.render.isAll},done:function(s){CAICUI.render.isNoReadNum&&(CAICUI.render.isNoReadNum--,CAICUI.render.isNoReadNum||e("body .message").removeClass("redRead"),e("body .message-noRead-number").html(CAICUI.render.isNoReadNum),e("body .message-isReadNum").html(CAICUI.render.isNoReadNum),e("body #message-list-"+CAICUI.render.messageId).find(".message-unread-tips").remove()),a&&a()},fail:function(e){console.log(e)}})},messageUnRead:function(a){if(!a)return!1;var s=0;"1"==a.msgType&&"意见反馈"==a.title?s=2:"1"==a.msgType&&"意见反馈"!=a.title?s=1:"0"==a.msgType&&(s=3),CAICUI.render.messageType=s,e("body .message-noRead-number").html(CAICUI.render.isNoReadNum),e("body .top-right .message").addClass("redRead");var t=e("#template-message-unread").html(),i=CAICUI.iGlobal.getTemplate(t,{data:a,messageType:CAICUI.render.messageType});e("body .main").append(i)},messageRender:function(){var a=new t;this.$(".message-content").html(a.render().el),this.$messageLeftContent=this.$(".message-left-content"),this.$messageListContent=this.$("#scroller-message-list"),this.$messageRight=this.$(".message-right"),e("body .message-noRead-number").html(CAICUI.render.isNoReadNum)},messageListRender:function(){var a=this;this.messageList(function(s){var t=new i;a.$messageLeftContent.html(t.render({data:{messageList:s.data,pageNo:s.pageNo,pageSize:s.pageSize,totalCount:s.totalCount}}).el),CAICUI.render.isNoReadAjax&&e("body .message-noRead-number").html(CAICUI.render.isNoReadNum),window.CAICUI.scrollMessageList=CAICUI.iGlobal.iScroll("body #wrapper-message-list")})},messageListLi:function(a){CAICUI.iGlobal.loading("body .message-right",{height:e(".message-right").height()+"px"});var s=this.getThat(a);s.siblings().removeClass("active"),s.addClass("active");var t=s.index(),i=CAICUI.render.messageList[t];CAICUI.render.messageId=i.id;var d=i.status,C=0;if("1"==i.msgType&&"意见反馈"==i.title?C=2:"1"==i.msgType&&"意见反馈"!=i.title?C=1:"0"==i.msgType&&(C=3),CAICUI.render.messageType=C,3==C){var l={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"',"#39":"'"},I="<div>"+i.content.replace(/&(lt|gt|nbsp|amp|quot|#39);/gi,function(e,a){return l[a]})+"<div>";CAICUI.render.replayId=e(I).find(".bbsid").val()}if("0"==d&&(s.attr("data-status","1"),i.status="1",CAICUI.render.isAll="0",this.updateStatus()),CAICUI.render.replayId)this.bbsdetail(function(a){var s=new o;e("body .message-right").html(s.render({data:a}).el),setTimeout(function(){window.CAICUI.acScroll=CAICUI.iGlobal.iScroll("body #wrapper-ac"),CAICUI.render.messageBbsDetail.imgPath&&"imgpath"!==CAICUI.render.messageBbsDetail.imgPath&&r.photos({photos:".discussQA-imgPath",shift:0})},300)});else{var g=new n;e("body .message-right").html(g.render(i).el),window.CAICUI.messageDesc=new IScroll("body #wrapper-message-desc",{probeType:3,mouseWheel:!0,scrollbars:"custom"})}},getThat:function(a){return e(a.currentTarget)},addActive:function(e){CAICUI.iGlobal.getThat(e).siblings().removeClass("active").end().addClass("active")},navEnter:function(){this.$(".main").stop(!0,!1).animate({"padding-left":"180px"},CAICUI.render.navAnimateTime),this.$(".left").stop(!0,!1).animate({width:"180px"},CAICUI.render.navAnimateTime,function(){})},navLeave:function(){this.$(".main").stop(!0,!1).animate({"padding-left":"60px"},CAICUI.render.navAnimateTime),this.$(".left").stop(!0,!1).animate({width:"60px"},CAICUI.render.navAnimateTime,function(){})},exitOptionShow:function(e){this.getThat(e);this.$exitOption.toggleClass("active")},messageShow:function(e){this.$messageMain.hasClass("active")?this.$messageMain.addClass("active"):(CAICUI.render.isRead=!0,this.$messageMain.addClass("active"),this.messageRender(),this.messageListRender())},allRead:function(){CAICUI.render.isNoReadNum&&(CAICUI.render.isNoReadNum=0,CAICUI.render.messageId="",CAICUI.render.isAll="1",CAICUI.render.this.updateStatus())},allReadPop:function(){CAICUI.render.isNoReadNum=0,CAICUI.render.messageId="",CAICUI.render.isAll="1",CAICUI.render.this.updateStatus(function(){e("body .message-unread").remove()})},messageUnreadNumber:function(){e("body .message").trigger("click"),e("body .message-unread").remove()},messageClose:function(e){this.getThat(e).parents(".message-main").removeClass("active")},messageUnreadClose:function(a){var s=this.getThat(a);CAICUI.render.messageId=s.parent().attr("data-id"),CAICUI.render.isAll="0",this.updateStatus(function(){e("body .message-unread").remove()})},paginationChange:function(a){CAICUI.iGlobal.loading("body #scroller-message-list",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh();var s=CAICUI.iGlobal.getThat(a);CAICUI.render.pageNo=s.attr("data-pageno"),this.messageListRender()},paginationPrev:function(a){this.pageNo>1&&(CAICUI.iGlobal.loading("body #scroller-message-list",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh(),CAICUI.render.pageNo=CAICUI.render.pageNo--,this.messageListRender())},paginationNext:function(a){this.pageNo<this.pageTotal-1&&(CAICUI.iGlobal.loading("body #scroller-message-list",{height:e("#wrapper").height()+"px"}),window.CAICUI.myScroll.refresh(),CAICUI.render.pageNo=CAICUI.render.pageNo++,this.messageListRender())}})});