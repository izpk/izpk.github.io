define(["jquery","underscore","backbone","layer"],function(e,r,i,n){"use strict";return i.View.extend({el:"body",template:r.template(e("#template-live").html()),events:{"click .js-live-gift":"liveGift","click .js-live-close":"liveClose"},type:"",render:function(r,i,n,t){CAICUI.render.this=this,CAICUI.render.openCourseId=r,CAICUI.render.roomid=i,CAICUI.render.userid=n,CAICUI.render.viewertoken=t,CAICUI.render.isToday=!1,CAICUI.render.isLiveTime=!1,CAICUI.render.isLiveTimeBefore=!1,CAICUI.render.isLiveTimeAfter=!1,CAICUI.render.isBuyLive=!1,CAICUI.render.freeWatchTotalTime=900,CAICUI.render.freeWatchTime=0,CAICUI.render.freeTotalTime=0,CAICUI.render.freeWatchInterval="",CAICUI.render.freeWatchTimingInterval="",CAICUI.render.endTimeInterval="",CAICUI.render.giftId=0,CAICUI.render.liveGiftNumber=1,CAICUI.render.liveGiftPosition=[105,205,305,405],CAICUI.render.liveGiftAnimaterTime=5,CAICUI.render.liveGiftAnimaterTimer="",CAICUI.render.ajaxCount=0,CAICUI.render.ajaxTotalNum=3,CAICUI.render.ajaxInterval="",CAICUI.render.isLiveGiftClick=!0,CAICUI.render.giftTotal=e.cookie("liveGift-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId)?e.cookie("liveGift-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId):20,this.$el.html(this.template({title:"直播",giftTotal:CAICUI.render.giftTotal})),CAICUI.render.this.init()},init:function(){CAICUI.render.this.getappointmentlist(function(r){CAICUI.render.isLiveTime?(CAICUI.render.this.includeopencoursegroup(),CAICUI.render.this.memberbuycategorylist(),CAICUI.render.this.memberbuylist(),CAICUI.render.ajaxTimeout=setInterval(function(){CAICUI.render.ajaxCount===CAICUI.render.ajaxTotalNum&&(clearInterval(CAICUI.render.ajaxTimeout),CAICUI.render.isBuyLive=CAICUI.render.this.isBuyLiveAjax(),CAICUI.render.isBuyLive?CAICUI.render.this.playLive():CAICUI.render.this.getTotalTime(function(r){var i=!0,n=0;CAICUI.render.getTotalTime&&CAICUI.render.getTotalTime.totalTime&&(n=CAICUI.render.getTotalTime.totalTime);var t=e.cookie("freeWatchTime-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId)?e.cookie("freeWatchTime-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId):0;n<t&&(n=t),n>=CAICUI.render.freeWatchTotalTime&&(i=!1),CAICUI.render.freeWatchTime=n,i?CAICUI.render.this.playLive():CAICUI.render.this.stopLive()}))},500)):CAICUI.render.isLiveTimeBefore?(e("body .studycenter-video-main").html('<p class="no-live-title">直播未开始</p>'),e("body .js-live-close").show()):CAICUI.render.isLiveTimeAfter?(e("body .studycenter-video-main").html('<p class="no-live-title">直播已结束</p>'),e("body .js-live-close").show()):CAICUI.render.this.getopencoursedetailAjax(function(r){CAICUI.render.this.isLiveTime(r.startTime,r.endTime),CAICUI.render.isLiveTimeState<1?CAICUI.render.this.appointmentAjax(function(r){"success"==r.state?CAICUI.render.this.init():e("body .studycenter-video-main").html('<p class="no-live-title">'+r.msg+"</p>")}):r.ccid?(CAICUI.render.helpVideoCcid=r.ccid,e("body #studycenter-video-main").html('<div class="studycenter-video-main-iframebox"><iframe allowtransparency="true" width="100%" height="100%" scrolling="no" frameborder="0" src="player.html?ccid='+r.ccid+'"></iframe></div>')):e("body .studycenter-video-main").html('<p class="no-live-title">直播已结束</p>'),e("body .js-live-close").show()})})},getopencoursedetailAjax:function(r){CAICUI.Request.ajax({server:"getopencoursedetail",data:{openCourseId:CAICUI.render.openCourseId},done:function(e){r&&r(e.data[0])},fail:function(r){e("body .studycenter-video-main").html('<p class="no-live-title">'+r.msg+"</p>"),e("body .js-live-close").show()}})},appointmentAjax:function(e){CAICUI.Request.ajax({server:"appointment",data:{memberId:CAICUI.User.memberId,openCourseId:CAICUI.render.openCourseId},done:function(r){e&&e(r)},fail:function(r){e&&e(r)}})},getappointmentlist:function(e){if(CAICUI.render.indexOpenCourse){var r=CAICUI.render.indexOpenCourse;CAICUI.render.isToday=CAICUI.render.this.isToday(r.startTime,r.endTime),CAICUI.render.isToday&&CAICUI.render.openCourseId==r.id&&(CAICUI.render.indexOpenCourse=r,CAICUI.render.isLiveTime=CAICUI.render.this.isLiveTime(r.startTime,r.endTime)),e&&e(CAICUI.render.indexOpenCourse)}else CAICUI.Request.ajax({server:"getappointmentlist",data:{memberId:CAICUI.User.memberId},done:function(r){if(CAICUI.render.this.openCourseTest,CAICUI.render.appointmentlist=r.data,r.data&&r.data.length)for(var i=0;i<r.data.length;i++){var n=r.data[i];CAICUI.render.openCourseId==n.id&&(CAICUI.render.isToday=CAICUI.render.this.isToday(n.startTime,n.endTime),CAICUI.render.indexOpenCourse=n,CAICUI.render.isLiveTime=CAICUI.render.this.isLiveTime(n.startTime,n.endTime))}e&&e(CAICUI.render.indexOpenCourse)},fail:function(e){CAICUI.render.indexOpenCourse={}}})},isToday:function(e,r){var i=(new Date).getFullYear(),n=(new Date).getMonth(),t=(new Date).getDate(),I=new Date(e).getFullYear(),C=new Date(e).getMonth(),d=new Date(e).getDate(),o=new Date(r).getFullYear(),a=new Date(r).getMonth(),s=new Date(r).getDate(),l=!1;return console.log(i+"-"+n+"-"+t),console.log(I+"-"+C+"-"+d),console.log(o+"-"+a+"-"+s),i===I&&n===C&&t===d&&(l=!0),i===o&&n===a&&t===s&&(l=!0),l},isLiveTime:function(e,r){var i=!1,n=(new Date).getTime();return e<n&&n<r&&(i=!0,CAICUI.render.isLiveTimeState=0),n<e&&(CAICUI.render.isLiveTimeBefore=!0,CAICUI.render.isLiveTimeState=-1),r<n&&(CAICUI.render.isLiveTimeAfter=!0,CAICUI.render.isLiveTimeState=1),i},includeopencoursegroup:function(e){CAICUI.Request.ajax({server:"includeopencoursegroup",data:{openCourseId:CAICUI.render.openCourseId},done:function(r){CAICUI.render.ajaxCount++,r.data&&r.data.length&&0!=parseInt(r.data[0].price)?CAICUI.render.includeopencoursegroup=r.data[0]:CAICUI.render.isFreePlayLive=!0,e&&e()},fail:function(e){}})},memberbuycategorylist:function(e){CAICUI.Request.ajax({server:"memberbuycategorylist",data:{memberId:CAICUI.User.memberId},done:function(r){CAICUI.render.ajaxCount++,CAICUI.render.memberbuycategorylist=r.data,e&&e()},fail:function(e){}})},memberbuylist:function(e){CAICUI.Request.ajax({server:"memberbuylist",data:{memberId:CAICUI.User.memberId},done:function(r){CAICUI.render.ajaxCount++,CAICUI.render.memberbuylist=r.data,e&&e()},fail:function(e){}})},settotaltime:function(e){CAICUI.Request.ajax({server:"settotaltime",data:{openCourseId:CAICUI.render.openCourseId,memberId:CAICUI.User.memberId,totalTime:CAICUI.render.freeWatchTime},done:function(r){CAICUI.render.settotaltime=r.data,e&&e()},fail:function(e){}})},getTotalTime:function(e){CAICUI.Request.ajax({server:"getTotalTime",data:{openCourseId:CAICUI.render.openCourseId,memberId:CAICUI.User.memberId},done:function(r){CAICUI.render.getTotalTime=r.data,e&&e()},fail:function(e){}})},setgift:function(e){CAICUI.Request.ajax({server:"setgift",data:{openCourseId:CAICUI.render.openCourseId,memberId:CAICUI.User.memberId,giftId:CAICUI.render.gift,name:CAICUI.render.member.nickName,mobile:CAICUI.render.member.mobile,email:CAICUI.render.member.email},done:function(r){e&&e()},fail:function(e){}})},payment:function(e){CAICUI.Request.ajax({server:"payment",data:{token:CAICUI.User.token,couponId:"",courseGroupIds:CAICUI.render.includeopencoursegroup.id,returnUrl:window.location.origin+"/studycenter/payCallback.html"},done:function(r){e&&e(r.data)},fail:function(e){}})},isBuyLiveAjax:function(){var e=!1;if(CAICUI.render.isFreePlayLive)e=!0;else{for(var r=0;r<CAICUI.render.memberbuycategorylist.length;r++){var i=CAICUI.render.memberbuycategorylist[r];console.log(i.id+";"+CAICUI.render.indexOpenCourse.subjectId),i.id==CAICUI.render.indexOpenCourse.subjectId&&(e=!0)}for(r=0;r<CAICUI.render.memberbuylist.length;r++){CAICUI.render.memberbuylist[r].id===CAICUI.render.includeopencoursegroup.id&&(e=!0)}}return e},playLive:function(){var r="",i=(CAICUI.render.indexOpenCourse.liveRoomId,CAICUI.render.indexOpenCourse.liveManageId,CAICUI.render.indexOpenCourse.liveRoomPassword);i?(r="https://view.csslcloud.net/api/view/login?",r+="roomid="+CAICUI.render.indexOpenCourse.liveRoomId,r+="&userid="+CAICUI.render.indexOpenCourse.liveManageId,r+="&autoLogin=true",CAICUI.User.nickname&&""!=CAICUI.User.nickname?(CAICUI.User.nickname,r+="&viewername="+CAICUI.User.nickname):(CAICUI.User.memberId,r+="&viewername="+CAICUI.User.memberId),r+="&viewertoken="+i):(r=e.cookie("isDemo")&&"false"==e.cookie("isDemo")?window.zbgedu.origin+"/liveIframe.html?":"http://demo.caicui.com/studycenter/liveIframe.html?",r+="roomid="+CAICUI.render.indexOpenCourse.liveRoomId,r+="&userid="+CAICUI.render.indexOpenCourse.liveManageId),console.log(r),e("body #studycenter-video-main").html('<iframe id="live-iframe" class="live-iframe" allowtransparency="true" width="100%" height="100%" scrolling="no" frameborder="0" src="'+r+'" ></iframe>'),document.getElementById("live-iframe").onload=function(){CAICUI.render.isLiveTime&&(e("body .live-gift-giving").show(),CAICUI.render.liveGiftAnimaterTimer=setInterval(function(){var r=e("body #live-gift-show-content .live-gift-show");if(r&&r.length){for(var i=[],n=0;n<r.length;n++){var t=r.eq(n),I=parseInt(t.attr("data-time"));--I?t.attr("data-time",I):i.push(n)}for(n=0;n<i.length;n++){var C=i[n];r.eq(C).animate({opacity:"0"},500,function(){r.eq(C).remove();for(var i=e("body #live-gift-show-content .live-gift-show"),n=0;n<i.length;n++){var t=i.length-1-n;i.eq(n).animate({bottom:CAICUI.render.liveGiftPosition[t]},500)}})}}},1e3)),e("body .js-live-close").show(),CAICUI.render.this.timerLive()}},stopLive:function(){e("body #live-iframe").remove(),e("body .live-gift-giving").hide(),clearInterval(CAICUI.render.liveGiftAnimaterTimer),e("body .js-live-close").show(),this.payLivePop()},payLivePop:function(){var r=e("#template-live-pay").html(),i=CAICUI.iGlobal.getTemplate(r,{openCourse:CAICUI.render.indexOpenCourse,price:CAICUI.render.includeopencoursegroup.price});e("body #studycenter-video-main").html(i),this.payment(function(r){e("body .live-pay-QRcode").html('<iframe id="live-pay-QRcode-iframe" class="live-pay-QRcode-iframe" src="'+r.alipayurl+'" width="100%" height="100%" frameborder="0"></iframe>'),document.getElementById("live-pay-QRcode-iframe").onload=function(){document.getElementById("live-pay-QRcode-iframe").contentWindow.document.getElementById("payCallback").innerHTML&&(console.log(document.getElementById("live-pay-QRcode-iframe").contentWindow.document.getElementById("payCallback").innerHTML),CAICUI.render.this.render(CAICUI.render.openCourseId))}})},timerLive:function(){CAICUI.render.isLiveTime&&(CAICUI.render.isBuyLive?CAICUI.render.endTimeInterval=setInterval(function(){var r=(new Date).getTime();CAICUI.render.indexOpenCourse.endTime<r&&CAICUI.Request.ajax({server:"getappointmentlist",data:{memberId:CAICUI.User.memberId},done:function(r){var i="";if(r.data&&r.data.length){for(var n="",t=0;t<r.data.length;t++)i=r.data[t],CAICUI.render.openCourseId==i.id&&(n=i);if(n){var I=(new Date).getTime();n.endTime<I?(clearInterval(CAICUI.render.endTimeInterval),e("body .studycenter-video-main").html('<p class="no-live-title">直播已结束</p>'),e("body .live-gift-giving").hide(),clearInterval(CAICUI.render.liveGiftAnimaterTimer)):CAICUI.render.indexOpenCourse=i}else clearInterval(CAICUI.render.endTimeInterval),e("body .studycenter-video-main").html('<p class="no-live-title">直播已结束</p>'),e("body .live-gift-giving").hide(),clearInterval(CAICUI.render.liveGiftAnimaterTimer)}else clearInterval(CAICUI.render.endTimeInterval),e("body .studycenter-video-main").html('<p class="no-live-title">直播已结束</p>'),e("body .live-gift-giving").hide(),clearInterval(CAICUI.render.liveGiftAnimaterTimer)},fail:function(e){CAICUI.render.indexOpenCourse={}}})},12e4):(CAICUI.render.freeWatchTimingInterval=setInterval(function(){CAICUI.render.freeWatchTime++,CAICUI.render.freeWatchTime<=CAICUI.render.freeWatchTotalTime?e.cookie("freeWatchTime-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId,CAICUI.render.freeWatchTime,{path:"/",expires:36500}):(clearInterval(CAICUI.render.freeWatchInterval),CAICUI.render.this.settotaltime(),clearInterval(CAICUI.render.freeWatchTimingInterval),CAICUI.render.this.stopLive())},1e3),CAICUI.render.freeWatchInterval=setInterval(function(){CAICUI.render.this.settotaltime()},12e4)))},liveGift:function(r){if(CAICUI.render.isLiveGiftClick){CAICUI.render.isLiveGiftClick=!1;var i=CAICUI.iGlobal.getThat(r);CAICUI.render.liveGiftIndex=i.attr("data-index"),CAICUI.render.gift=i.attr("data-gift"),CAICUI.render.giftTotal=parseInt(e.cookie("liveGift-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId)?e.cookie("liveGift-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId):20),0===CAICUI.render.giftTotal?(CAICUI.render.isLiveGiftClick=!0,layer.msg("Sorry~您没有金币了！",function(){})):CAICUI.render.giftTotal<CAICUI.render.gift?(CAICUI.render.isLiveGiftClick=!0,layer.msg("Sorry~您的金币不足！",function(){})):CAICUI.Request.ajax({server:"member",data:{token:CAICUI.User.token},done:function(r){"success"==r.state?(CAICUI.render.member=r.data,CAICUI.render.this.setgift(function(){CAICUI.render.isLiveGiftClick=!0,CAICUI.render.giftLave=parseInt(CAICUI.render.giftTotal)-parseInt(CAICUI.render.gift),e("body .live-gift-Total-span").text("X "+CAICUI.render.giftLave),e.cookie("liveGift-"+CAICUI.User.memberId+"-"+CAICUI.render.openCourseId,CAICUI.render.giftLave),CAICUI.render.this.addLiveGiftAnimater()})):console.log("member:"+r)},fail:function(e){console.log("member:"+e)}})}else layer.msg("Sorry~请稍候再赠送！",function(){})},addLiveGiftAnimater:function(){var r=e("body #live-gift-show-content"),i=r.find(".live-gift-show"),n=!0;if(i&&i.length)for(var t=0;t<i.length;t++){var I=i.eq(t);if(I.attr("data-id")==CAICUI.render.liveGiftIndex){n=!1,CAICUI.render.liveGiftNumber=parseInt(I.attr("data-number"));var C=CAICUI.render.liveGiftNumber+1;I.attr("data-number",C),I.attr("data-time",CAICUI.render.liveGiftAnimaterTime),I.find(".live-gift-show-span").text("X "+C)}}if(n){CAICUI.render.liveGiftNumber=1;var d=e("#template-live-gift").html(),o=CAICUI.iGlobal.getTemplate(d,{liveGiftTime:CAICUI.render.liveGiftAnimaterTime,liveGiftIndex:CAICUI.render.liveGiftIndex,liveGiftNumber:CAICUI.render.liveGiftNumber});r.append(o),i.each(function(e){var r=i.eq(e),n=parseInt(r.css("bottom"));r.css({bottom:n+100},500)}),e("body #live-gift-show-"+CAICUI.render.liveGiftIndex).animate({opacity:"1",bottom:CAICUI.render.liveGiftPosition[0]},500)}},liveClose:function(){var e=CAICUI.iGlobal.getUrlPara("return_link");e?"#"==e.substr(0,1)?window.location.hash=e:window.location.href=e:window.location.hash="#studycenterIndex"}})});