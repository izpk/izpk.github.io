define(["jquery","underscore","backbone","views/node-list","views/node-desc-list","views/node-editor","layer"],function(e,r,t,n,o,a,d){"use strict";return t.View.extend({el:"body #right",template:r.template(e("#template-course-courseNote").html()),events:{"click .node-list-title-a":"nodeListToggle","click .node-list-link":"addNodeLists","click .node-list-linkssss":"addNodedetail","click .node-lsit-remove":"nodeRemove","click .node-select-a":"nodeSelectA","click .node-option-li":"addActive","click .node-desc-show":"nodeDescShow","click .node-desc-hide":"nodeDescHide","click .node-new":"nodeNew","click .node-lsit-editor":"nodeEditor","click .js-course-note-change":"courseChange","change #uploadForm-file":"uploadForm","click .add-photo-remove":"addPhotoRemove","keyup .node-editor-textarea":"nodeContent","click .node-editor-cancel":"editorCancel","click .node-editor-confirm":"editorConfirm","click .js-pagination-li":"paginationChange","click .js-pagination-prev":"paginationPrev","click .js-pagination-next":"paginationNext","click .node-lately":"nodeLately","click .node-list-desc-link":"nodeListDescLink","click .show-photo-li":"showPhoto","click .remove-load-confirm":"removeLoadConfirm"},render:function(r){this.$header=this.$(".courseIndex-header"),this.$courseNavUl=this.$(".courseIndex-ul"),this.$courseNavLi=this.$(".courseIndex-li"),this.$courseIndexActiveBox=this.$(".courseIndex-active-box"),this.$scroller=this.$("#scroller"),this.$nodeRight=this.$(".node-right"),this.$nodeDescContent=this.$("#scroller-node"),this.courseNavPreDefault=2,this.courseNavPre=2,this.courseNavAnimateTime=300,CAICUI.render.courseId=r,CAICUI.render.$this=this,CAICUI.render.content="",CAICUI.render.clientType="pc",CAICUI.render.title="sdf",CAICUI.render.isPublic=1,CAICUI.render.subjectId="",CAICUI.render.categoryId="",CAICUI.render.chapterId="",CAICUI.render.subjectName="",CAICUI.render.categoryName="",CAICUI.render.courseName="",CAICUI.render.chapterName="",CAICUI.render.taskName="sdf",CAICUI.render.imgPath="",CAICUI.render.imgPathArray=[],CAICUI.render.isLately=!0,CAICUI.render.noEditor=!0,CAICUI.render.nodeId="",CAICUI.render.nodeType=1,CAICUI.render.self=0,CAICUI.render.ordertype=1,CAICUI.render.pageNo=1,CAICUI.render.pageSize=20,CAICUI.render.totalCount=0,CAICUI.render.pageTotal=0,CAICUI.render.paginationType=0,CAICUI.render.serverTotal=3,CAICUI.render.serverNum=0,this.$learningcourse="",this.learningcourse(),this.$coursechapternodecount="",this.coursechapternodecount(),this.$courseBaseInfo="",CAICUI.render.timer=setInterval(function(){if(CAICUI.render.serverTotal==CAICUI.render.serverNum){clearInterval(CAICUI.render.timer);var r=CAICUI.render.$this.filterLearningcourse(CAICUI.CACHE.Learningcourse);CAICUI.render.$this.$el.html(CAICUI.render.$this.template({data:{courseId:CAICUI.render.courseId,learningcourse:r,courseBaseInfo:CAICUI.render.$this.$courseBaseInfo,nodelist:CAICUI.render.$this.$coursechapternodecount}})),CAICUI.iGlobal.getTemplateCourseNav("body .courseIndex-header-right",{courseType:"classCourse",type:"note",courseId:CAICUI.render.courseId}),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),e("body .node-lately").trigger("click")}},CAICUI.render.time)},learningcourse:function(e){if(CAICUI.CACHE.Learningcourse&&CAICUI.CACHE.Learningcourse.length){var t=!0;r.each(CAICUI.CACHE.Learningcourse,function(e,r){e.courseId==CAICUI.render.courseId&&(t=!1,CAICUI.render.subjectId=e.subjectID,CAICUI.render.categoryId=e.categoryId,CAICUI.render.chapterId=e.chapterId,CAICUI.render.subjectName=e.subjectName,CAICUI.render.categoryName=e.categoryName,CAICUI.render.courseName=e.courseName,CAICUI.render.chapterName=e.chapterName,CAICUI.render.taskName="sdf")}),t?CAICUI.render.$this.courseBaseInfo(CAICUI.render.courseId):CAICUI.render.serverNum++,CAICUI.render.serverNum++}else CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:1,pageSize:CAICUI.defaultPageSize},done:function(e){var t=!0;r.each(e.data.courselist,function(e,r){e.courseId==CAICUI.render.courseId&&(t=!1,CAICUI.render.subjectId=e.subjectID,CAICUI.render.categoryId=e.categoryId,CAICUI.render.chapterId=e.chapterId,CAICUI.render.subjectName=e.subjectName,CAICUI.render.categoryName=e.categoryName,CAICUI.render.courseName=e.courseName,CAICUI.render.chapterName=e.chapterName,CAICUI.render.taskName="sdf")}),t?CAICUI.render.$this.courseBaseInfo(CAICUI.render.courseId):CAICUI.render.serverNum++,CAICUI.render.serverNum++,CAICUI.CACHE.Learningcourse=e.data.courselist,CAICUI.CACHE.RecentCourse=e.data.courselist.slice(0,2)},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.serverNum++,CAICUI.CACHE.Learningcourse={},CAICUI.CACHE.RecentCourse={}}})},courseBaseInfo:function(e){CAICUI.Request.ajax({server:"coursesBaseInfo",data:{token:CAICUI.User.token,courseIds:e},done:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$courseBaseInfo=e.data[0]},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$courseBaseInfo={}}})},courseNode:function(e){CAICUI.Request.ajax({server:"course-node",data:{token:CAICUI.User.token,id:CAICUI.render.courseId,type:"course"},done:function(r){e(r)},fail:function(r){e({})}})},coursechapternodecount:function(e){CAICUI.Request.ajax({server:"coursechapternodecount",data:{token:CAICUI.User.token,courseid:CAICUI.render.courseId,self:0},done:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$coursechapternodecount=e},fail:function(e){CAICUI.render.serverNum++,CAICUI.render.$this.$coursechapternodecount={data:{}}}})},addCourseNode:function(){var r=new n;this.coursechapternodecount(function(t){e("body #scroller").html(r.render({data:{nodelist:t}}).el),window.CAICUI.myScroll.refresh()})},nodeList:function(e){CAICUI.Request.ajax({server:"nodelist",data:{token:CAICUI.User.token,charpterid:CAICUI.render.chapterId,self:CAICUI.render.self,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,ordertype:CAICUI.render.ordertype},done:function(r){CAICUI.render.pageTotal=Math.ceil(r.totalCount/r.pageSize),e(r)},fail:function(r){e({})}})},nodeListCourse:function(e){CAICUI.Request.ajax({server:"nodelist",data:{token:CAICUI.User.token,courseid:CAICUI.render.courseId,self:CAICUI.render.self,pageNo:CAICUI.render.pageNo,pageSize:CAICUI.render.pageSize,ordertype:CAICUI.render.ordertype},done:function(r){CAICUI.render.pageTotal=Math.ceil(r.totalCount/r.pageSize),e(r)},fail:function(r){e({})}})},addNodeLists:function(r){CAICUI.render.noEditor=!0,CAICUI.render.isLately=!1;var t=CAICUI.iGlobal.getThat(r);CAICUI.render.pageNo=1,CAICUI.render.paginationType=1,CAICUI.iGlobal.loading(".node-right"),e(".node-list-link").removeClass("active"),t.addClass("active"),CAICUI.render.chapterId=t.attr("data-id"),CAICUI.render.chapterName=t.attr("data-title");var n=new o;this.nodeList(function(r){e(".node-right").html(n.render({data:r.data,type:CAICUI.render.nodeType,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})},nodeLately:function(r){CAICUI.render.noEditor=!1,CAICUI.render.isLately=!0;CAICUI.iGlobal.getThat(r);CAICUI.render.pageNo=1,CAICUI.render.paginationType=0,CAICUI.iGlobal.loading(".node-right"),e("body .node-list-link.active").removeClass("active");var t=new o;this.nodeListCourse(function(r){e(".node-right").html(t.render({data:r.data,type:0,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})},nodeDetail:function(e){CAICUI.Request.ajax({server:"nodedetail",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId},done:function(r){e(r)},fail:function(r){e({})}})},delmycontent:function(e){CAICUI.Request.ajax({server:"delmycontent",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId,type:"note"},done:function(r){e(r)},fail:function(r){e({})}})},addNodedetail:function(r){var t=CAICUI.iGlobal.getThat(r);if(!t.hasClass("active")){CAICUI.iGlobal.loading(".node-right"),e(".node-list-link").removeClass("active"),t.addClass("active");var n=t.attr("data-id"),a=new o;this.nodedetail(n,function(r){e(".node-right").html(a.render({data:r,type:1}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},nodeListLink:function(r){var t=this.getThat(r);if(!t.hasClass("active")){e(".node-list-link").removeClass("active"),t.addClass("active");var n=t.attr("data-id");this.addNodedetail(n)}},getThat:function(r){return e(r.currentTarget)},nodeListRender:function(){var e=new n;this.$scroller.html(e.render().el)},nodeEditorRender:function(e){var r=new a;this.$(".node-right").html(r.render(e).el)},uploadForm:function(e){CAICUI.iGlobal.fileUpload({formClass:"uploadForm"},function(e){CAICUI.iGlobal.fileUploadAddList("uploadForm",e)})},addPhotoRemove:function(r){for(var t=this.getThat(r),n=(t.prev(),t.attr("data-src")),o=0;o<CAICUI.render.imgPathArray.length;o++)if(CAICUI.render.imgPathArray[o]==n){CAICUI.render.imgPathArray.splice(o,1);break}t.parent().remove(),e("body .add-photo-show").length<5&&e("body #uploadForm").show()},nodeContent:function(e){var r=CAICUI.iGlobal.getThat(e);CAICUI.render.content=r.val()},editorCancel:function(r){e("body .node-list-link.active").length?e("body .node-list-link.active").trigger("click"):e("body .node-lately").trigger("click")},editorConfirm:function(r){if(CAICUI.render.imgPath="",CAICUI.render.imgPathArray.length)for(var t=0;t<CAICUI.render.imgPathArray.length;t++)CAICUI.render.imgPath+=t?","+CAICUI.render.imgPathArray[t]:CAICUI.render.imgPathArray[t];else CAICUI.render.imgPath="";CAICUI.Request.ajax({server:"nodesave",data:{token:CAICUI.User.token,id:CAICUI.render.nodeId,content:CAICUI.render.content,courseId:CAICUI.render.courseId,clientType:CAICUI.render.clientType,title:CAICUI.render.title,isPublic:CAICUI.render.isPublic,subjectId:CAICUI.render.subjectId,categoryId:CAICUI.render.categoryId,chapterId:CAICUI.render.chapterId,subjectName:CAICUI.render.subjectName,categoryName:CAICUI.render.categoryName,courseName:CAICUI.render.courseName,chapterName:CAICUI.render.chapterName,taskName:CAICUI.render.taskName,imgPath:CAICUI.render.imgPath},done:function(r){var t=e("body .node-list-link.active");if(!CAICUI.render.isPublic&&!CAICUI.render.nodeId){var n=+t.attr("data-nodenum")+1;t.attr("data-nodenum",n),t.find(".node-list-num").text("["+n+"]");var o=t.parents(".node-list-three-ul").prev(),a=+o.attr("data-nodenum")+1;o.attr("data-nodenum",a),o.find(".node-list-num").text("["+a+"]")}CAICUI.render.isLately?e("body .node-lately").trigger("click"):t.trigger("click")},fail:function(e){d.msg("Sorry~ 笔记保存失败",function(){})}})},courseNavAnimate:function(e,r){e.stop(!0,!1).animate({width:"148px"},this.courseNavAnimateTime)},courseNavPreAnimate:function(e){var r=this.$(".courseIndex-li").eq(e),t=!1;CAICUI.render.$this.$(".courseIndex-ul").hasClass("hover")||(t=!0),this.$(".courseIndex-active-box").eq(e).stop(!0,!1).animate({width:34,marginLeft:0},this.courseNavAnimateTime,function(){r.removeClass("hover"),t&&(CAICUI.render.$this.$(".courseIndex-ul").addClass("hover"),t=!1)})},courseNavLiEnter:function(e){var r=CAICUI.iGlobal.getThat(e),t=r.index(),n=r.find(".courseIndex-active-box");if(t==this.courseNavPre)return!1;r.addClass("hover"),this.courseNavPreAnimate(this.courseNavPre),this.courseNavAnimate(n,t),this.courseNavPre=t},courseNavUlLeave:function(e){CAICUI.iGlobal.getThat(e);this.courseNavPreAnimate(this.courseNavPre),this.courseNavPre=this.courseNavPreDefault,this.$courseNavLi.eq(this.courseNavPre).addClass("hover"),this.courseNavAnimate(this.$(".courseIndex-active-box").eq(this.courseNavPre),this.courseNavPre),CAICUI.render.$this.$(".courseIndex-ul").removeClass("hover")},courseNavLiLeave:function(e){},nodeListToggle:function(e){this.getThat(e).parent().toggleClass("active"),window.CAICUI.myScroll.refresh()},addActive:function(e){var r=this.getThat(e);r.siblings().removeClass("active"),r.addClass("active")},nodeSelectA:function(e){var r=this.getThat(e);r.toggleClass("active"),r.next().toggleClass("active")},nodeDescShow:function(e){var r=this.getThat(e).parents(".node-desc-li");CAICUI.render.nodeId=r.attr("data-id"),this.nodeDetail(function(e){r.find(".node-desc-span").text(e.data.content),r.addClass("active"),window.CAICUI.nodeScroll.refresh()})},nodeDescHide:function(e){var r=this.getThat(e).parents("li"),t=CAICUI.iGlobal.cutstr(CAICUI.iGlobal.html_decode(r.attr("data-contentSummary")),120);r.find(".node-desc-span").text(t),r.removeClass("active"),window.CAICUI.nodeScroll.refresh()},nodeNew:function(e){if(this.$courseBaseInfo)d.msg("Sorry~ 您没有当前课程的发帖权限",function(){});else{CAICUI.render.imgPath="",CAICUI.render.imgPathArray=[];this.getThat(e);this.nodeEditorRender()}},nodeEditor:function(e){var r=this.getThat(e).parents(".node-desc-li"),t=r.attr("data-updateTime"),n=r.attr("data-taskprogress"),o=r.attr("data-contentSummary");CAICUI.render.content=o;var a=r.attr("data-imgPath");a&&a.length?CAICUI.render.imgPathArray=a.split(","):CAICUI.render.imgPathArray=[],console.log(CAICUI.render.imgPathArray);var d=+r.attr("data-isPublic");CAICUI.render.isPublic=d,CAICUI.render.charpterId=r.attr("data-charpterId"),CAICUI.render.nodeId=r.attr("data-id"),this.nodeEditorRender({time:t,videoTime:n,content:o,imgPath:CAICUI.render.imgPathArray,isPublic:d})},nodeRemove:function(r){var t=this.getThat(r);CAICUI.render.removeNodeDescLi=t.parents(".node-desc-li"),CAICUI.render.nodeRemoveLoad=d.load(1,{type:1,title:!1,content:e("#remove-load"),closeBtn:0,shade:[.5,"#000"]}),e(".remove-load-cancel").on("click",function(){d.close(CAICUI.render.nodeRemoveLoad)})},removeLoadConfirm:function(r){CAICUI.render.nodeId=CAICUI.render.removeNodeDescLi.attr("data-id"),CAICUI.render.$this.delmycontent(function(r){CAICUI.render.removeNodeDescLi.remove();var t=e("body .node-list-link.active"),n=+t.attr("data-nodenum")-1;t.attr("data-nodenum",n),t.find(".node-list-num").text("["+n+"]");var o=t.parent().parent().prev(),a=+o.attr("data-nodenum")-1;o.attr("data-nodenum",a),o.find(".node-list-num").text("["+a+"]"),d.close(CAICUI.render.nodeRemoveLoad),n?window.CAICUI.nodeScroll.refresh():t.trigger("click")})},courseChange:function(r){this.getThat(r).toggleClass("active"),e(".option-ul").toggleClass("active")},paginationChange:function(r){CAICUI.iGlobal.loading(".node-right");var t=CAICUI.iGlobal.getThat(r);if(CAICUI.render.pageNo=t.attr("data-pageno"),CAICUI.render.paginationType)this.nodeList(function(r){var t=new o;e(".node-right").html(t.render({data:r.data,type:CAICUI.render.nodeType,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var n=new o;this.nodeListCourse(function(r){e(".node-right").html(n.render({data:r.data,type:0,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},paginationPrev:function(r){if(CAICUI.render.pageNo>1)if(CAICUI.iGlobal.loading(".node-right"),CAICUI.render.pageNo=+CAICUI.render.pageNo-1,CAICUI.render.paginationType)this.nodeList(function(r){var t=new o;e(".node-right").html(t.render({data:r.data,type:CAICUI.render.nodeType,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var t=new o;this.nodeListCourse(function(r){e(".node-right").html(t.render({data:r.data,type:0,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},paginationNext:function(r){if(CAICUI.render.pageNo<=CAICUI.render.pageTotal-1)if(CAICUI.iGlobal.loading(".node-right"),CAICUI.render.pageNo=+CAICUI.render.pageNo+1,CAICUI.render.paginationType)this.nodeList(function(r){var t=new o;e(".node-right").html(t.render({data:r.data,type:CAICUI.render.nodeType,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")});else{var t=new o;this.nodeListCourse(function(r){e(".node-right").html(t.render({data:r.data,type:0,pageNo:r.pageNo,pageSize:r.pageSize,totalCount:r.totalCount}).el),window.CAICUI.nodeScroll=CAICUI.iGlobal.iScroll("body #wrapper-node")})}},nodeListDescLink:function(e){e.stopPropagation(),CAICUI.NavVideo=!1,CAICUI.domRender=!1;var r=CAICUI.iGlobal.getThat(e);window.location.hash=r.attr("link")},showPhoto:function(r){var t=CAICUI.iGlobal.getThat(r),n=t.find("img").attr("src"),o=e("body .show-photo-img-big");t.siblings().removeClass("active"),t.addClass("active"),o.attr("src",n),window.CAICUI.nodeScroll.refresh()},filterLearningcourse:function(e){for(var t=r.chain(e).map(function(e){return e.categoryName}).uniq().value(),n=r.chain(e).map(function(e){return e.categoryIndex}).uniq().value(),o=[],a=0;a<t.length;a++)o.push({categoryName:t[a],categoryIndex:n[a],list:[]}),r.each(e,function(e,r,n){e.categoryName==t[a]&&(o&&o[a]&&o[a].list?o[a].list.push(e):o[a].list=[e])});for(a=0;a<o.length;a++){o[a].newList=[];for(var d=o[a].list,i=r.chain(d).map(function(e){return e.subjectName}).uniq().value(),C=r.chain(d).map(function(e){return e.subjectIndex}).uniq().value(),I=0;I<i.length;I++)o[a].newList.push({subjectName:i[I],subjectIndex:C[I],list:[]}),r.each(o[a].list,function(e,t,n){if(e.subjectName==i[I])if(o[a].newList[I].list){var d=!0;r.each(o[a].newList[I].list,function(r,t,n){e.courseId==r.courseId&&(d=!1)}),d&&o[a].newList[I].list.push(e)}else o[a].newList[I].list=[e]})}o=r.sortBy(o,"categoryIndex");return r.each(o,function(e,t){o[t].newList=r.sortBy(e.newList,"subjectIndex"),r.each(o[t].newList,function(e,n){o[t].newList[n].list=r.sortBy(e.list,"courseIndex")})}),o}})});