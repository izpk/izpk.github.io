define(["jquery","underscore","backbone"],function(e,r,t){"use strict";return t.View.extend({tagName:"div",className:"course-content",template:r.template(e("#template-course-studyIn").html()),events:{"click .studyin-content-subjects":"subjectClick","click .studyin-type":"typeClick","click .js-coursestudy":"courseStudy","click .courseIntro-nextShow-btn":"courseIntroNextShow","click .courseIntro-close":"courseIntroClose","click .updateCourse-close":"updateCourseClose","click .courseIntro-email-a":"courseIntroEmail","click .courseIntro-default":"wileyCourseStudy","click .js-locking-tipsPop":"lockingTipsPop","click .updateCourse-btn":"updateCourseAjax"},render:function(){return this.$el.html(this.template()),CAICUI.render.courseStudyIn=this,this.learningcourse(function(r){var t=e("#template-course-studyIn-list").html(),o=CAICUI.iGlobal.getTemplate(t,{data:r});e("body .course-content").html(o),e(".current-progress").each(function(){var r=e(this),t=parseInt(r.attr("data-progress"));t&&(r.addClass("active"),r.animate({width:t/100*90},1e3))}),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper"),setTimeout(function(){CAICUI.render.updateCourseIndex=0,CAICUI.render.courseStudyIn.updateCourse&&CAICUI.render.courseStudyIn.updateCourse()},50)}),this},updateCourse:function(){var e=0;if(CAICUI.render.updateCourseIndex&&(e=CAICUI.render.updateCourseIndex),CAICUI.render.updateCourseIndex++,e>=CAICUI.render.Learningcourse.length)return!1;CAICUI.render.courseGroupId=CAICUI.render.Learningcourse[e].courseGroupId,CAICUI.render.orderItemId=CAICUI.render.Learningcourse[e].orderID_item_id,CAICUI.render.courseStudyIn.getmembernotprocnoticelist(CAICUI.render.courseGroupId,CAICUI.render.orderItemId)},getmembernotprocnoticelist:function(e,r){CAICUI.Request.ajax({server:"getmembernotprocnoticelist",data:{courseGroupId:e,orderItemId:r},done:function(e){e.data&&e.data.length?CAICUI.render.courseStudyIn.createUpdateCourse(e.data[0]):CAICUI.render.courseStudyIn.updateCourse()},fail:function(e){console.log(e)}})},createUpdateCourse:function(r){var t=.618*e(window).width(),o=605.64;t<o?t=o:t>988.8&&(t=988.8),CAICUI.render.updateCourse=layer.open({type:1,title:!1,shade:!0,scrollbar:!1,area:[t+"px","auto"],closeBtn:0,content:e("#updateCourse"),success:function(){e("body #updateCourse .updateCourse-content").text(r.content)}})},updateCourseClose:function(){layer.close(CAICUI.render.updateCourse),CAICUI.render.courseStudyIn.updateCourse()},updateCourseAjax:function(r){var t=CAICUI.iGlobal.getThat(r);console.log(t.attr("class"));var o=0;t.hasClass("updateCourse-default")&&(o=1),e("body .updateCourse").find(".loader-box").removeClass("hidden"),CAICUI.Request.ajax({server:"membercheck",data:{courseGroupId:CAICUI.render.courseGroupId,itemId:CAICUI.render.orderItemId,state:o},done:function(r){console.log(r),e("body .updateCourse").find(".loader-box").addClass("hidden"),layer.close(CAICUI.render.updateCourse),CAICUI.render.courseStudyIn.updateCourse()},fail:function(e){console.log(e)}})},learningcourse:function(e){CAICUI.Request.ajax({server:"learningcourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(r){CAICUI.render.Learningcourse=r.data.courselist,CAICUI.CACHE.Learningcourse=r.data.courselist;for(var t=[],o=0;o<r.data.courselist.length;o++)t.push(r.data.courselist[o].courseId);CAICUI.Request.ajax({server:"actionGetCourseProgress",data:{token:CAICUI.User.token,memberId:CAICUI.User.memberId,courseId:t.toString()},done:function(r){for(var t=0;t<CAICUI.CACHE.Learningcourse.length;t++)for(var o=0;o<r.data.length;o++)CAICUI.CACHE.Learningcourse[t].courseId==r.data[o].courseId&&(CAICUI.CACHE.Learningcourse[t].courseProgress=r.data[o].courseProgress,CAICUI.CACHE.Learningcourse[t].createDate=r.data[o].createDate,CAICUI.CACHE.Learningcourse[t].chapterId=r.data[o].chapterId,CAICUI.CACHE.Learningcourse[t].chapterName=r.data[o].chapterName,CAICUI.CACHE.Learningcourse[t].progress=r.data[o].progress,CAICUI.CACHE.Learningcourse[t].taskId=r.data[o].taskId,CAICUI.CACHE.Learningcourse[t].taskName=r.data[o].taskName);var n=CAICUI.render.courseStudyIn.filterLearningcourseData(CAICUI.CACHE.Learningcourse);e&&e({courseListNav:n.courseListNav,courseLists:n.courseLists})}})},fail:function(r){e({courseListNav:{},courseLists:{}})}})},filterLearningcourseData:function(e){for(var t=e,o=r.chain(t).map(function(e){return e.categoryName}).uniq().value(),n=r.chain(t).map(function(e){return e.categoryIndex}).uniq().value(),s=[],a=0;a<o.length;a++)s.push({categoryName:o[a],categoryIndex:n[a],list:[]}),r.each(t,function(e,r,t){e.categoryName==o[a]&&(s&&s[a]&&s[a].list?s[a].list.push(e):s[a].list=[e])});for(a=0;a<s.length;a++){s[a].newList=[];for(var i=s[a].list,u=r.chain(i).map(function(e){return e.subjectName}).uniq().value(),c=r.chain(i).map(function(e){return e.subjectIndex}).uniq().value(),I=0;I<u.length;I++)s[a].newList.push({subjectName:u[I],subjectIndex:c[I],list:[]}),r.each(s[a].list,function(e,t,o){if(e.subjectName==u[I])if(s[a].newList[I].list){var n=!0;r.each(s[a].newList[I].list,function(r,t,o){e.courseId==r.courseId&&(n=!1)}),n&&s[a].newList[I].list.push(e)}else s[a].newList[I].list=[e]})}s=r.sortBy(s,"categoryIndex");return r.each(s,function(e,t){s[t].newList=r.sortBy(e.newList,"subjectIndex"),r.each(s[t].newList,function(e,o){s[t].newList[o].list=r.sortBy(e.list,"courseIndex")})}),{courseListNav:o,courseLists:s}},subjectEnter:function(r){var t=r.currentTarget,o=e(t),n=(o.index(),o.find(".subject-lf").find(".subject-mask")),s=o.find(".subject-rt");return n.stop(!0,!1).animate({left:"0"}),{mask:n,rt:s}},subjectLeave:function(e){this.subjectEnter(e).mask.stop(!0,!1).animate({left:"-160px"})},subjectClick:function(e){this.subjectEnter(e).rt.parent().parent().addClass("active").siblings().removeClass("active")},iconClick:function(r){var t=r.currentTarget,o=e(t);o.find(".subject-type-rt").toggleClass("stop"),o.next(".studyin-content-subject").toggleClass("stop"),CAICUI.myScroll.refresh()},typeClick:function(r){var t=r.currentTarget,o=e(t),n=o.index();o.addClass("active").siblings().removeClass("active"),e(".studyin-contents").removeClass("active").eq(n).addClass("active"),CAICUI.myScroll.refresh()},courseStudy:function(r){var t=CAICUI.iGlobal.getThat(r);CAICUI.render.courseIdActive=t.attr("data-courseId");var o=e.cookie("courseIntro-"+CAICUI.User.memberId),n=!0;if(o&&o.length){o=JSON.parse(o);for(var s=0;s<o.length;s++)o[s]==CAICUI.render.courseIdActive&&(n=!1)}if(CAICUI.render.orderItemId=t.attr("data-orderItemId"),n){if(CAICUI.render.courseName=t.attr("data-courseName"),CAICUI.render.courseSource=t.attr("data-courseSource"),CAICUI.render.expirationTime=t.attr("data-expirationTime"),"wiley"==CAICUI.render.courseSource){var a=.618*e(window).width();a<605.64?a=605.64:a>988.8&&(a=988.8),CAICUI.render.firstOpenCourseSourcePop=e.cookie("firstOpenCourseSourcePop"),console.log(CAICUI.render.firstOpenCourseSourcePop),"true"!=CAICUI.render.firstOpenCourseSourcePop&&(e.cookie("firstOpenCourseSourcePop",!0,{path:"/",expires:36500}),e("body").append('<iframe class="wiley-iframe" src="https://app.efficientlearning.com/pv5/v8/1/app/cfa2017/level2.html?auth=wj5FSziNSkafKB4OI%2BURB3bovRo%3D" width="0" height="0" frameborder="0"></iframe>')),CAICUI.render.closeIntro=layer.open({type:1,title:!1,shade:!0,scrollbar:!1,area:[a+"px","auto"],closeBtn:0,content:e("#courseIntro"),success:function(){e(".layui-layer-shade").css("filter","alpha(opacity=50)"),e(".courseIntro-time").removeClass("hidden"),e(".courseIntro-time-span").text(CAICUI.iGlobal.getDate(CAICUI.render.expirationTime)),CAICUI.render.member&&!CAICUI.render.memberReset?CAICUI.render.courseStudyIn.popInit():CAICUI.render.courseStudyIn.getMember(function(){CAICUI.render.memberReset=!1,CAICUI.render.courseStudyIn.popInit()})}})}}else this.wileyCourseStudyAjax()},getMember:function(e){CAICUI.Request.ajax({server:"member",data:{token:CAICUI.User.token},done:function(r){"success"==r.state?(CAICUI.render.member=r.data,e&&e()):console.log("member:"+r)},fail:function(e){layer.msg("Sorry~ 课程激活失败！",function(){})}})},wileyCourseStudy:function(e){var r=CAICUI.iGlobal.getThat(e);r.removeClass("courseIntro-default").addClass("courseIntro-disabled"),this.wileyCourseStudyAjax(function(){r.removeClass("courseIntro-disabled").addClass("courseIntro-default"),layer.close(CAICUI.render.closeIntro)})},wileyCourseStudyAjax:function(r){layer.close(CAICUI.render.closeIntro),CAICUI.render.introLoading=layer.open({type:1,title:!1,shade:!0,scrollbar:!1,area:["350px","auto"],closeBtn:0,content:e("#courseIntroLoading"),success:function(){CAICUI.render.wileyCourseStudyTimeStart=(new Date).getTime(),CAICUI.Request.ajax({server:"wileyCourseStudy",data:{token:CAICUI.User.token,courseId:CAICUI.render.courseIdActive,orderItemId:CAICUI.render.orderItemId,courseSource:"wiley"},done:function(t){if("success"==t.state&&"302"==t.data.status&&""!=t.data.url){r&&r();var o={token:CAICUI.User.token,memberId:CAICUI.User.memberId,memberName:CAICUI.User.nickname,progress:1,total:1,taskId:CAICUI.render.courseIdActive,chapterId:CAICUI.render.courseIdActive,courseId:CAICUI.render.courseIdActive,subjectId:CAICUI.render.courseIdActive,categoryId:CAICUI.render.courseIdActive,taskName:CAICUI.render.courseName,chapterName:CAICUI.render.courseName,courseName:CAICUI.render.courseName,subjectName:CAICUI.render.courseName,categoryName:CAICUI.render.courseName,state:0,isSupply:0};o.createDate=(new Date).getTime(),CAICUI.render.wileyCourseStudyTimeEnd=o.createDate,CAICUI.Request.ajax({server:"actionTaskProgress",data:{token:CAICUI.User.token,message:JSON.stringify(o)},done:function(e){console.log(e)}}),CAICUI.render.courseStudyIn.popLoadingInit(),CAICUI.render.courseStudyIn.addAnimate(function(){var r=e("#template-course-wiley-iframe").html(),o=CAICUI.iGlobal.getTemplate(r,{title:CAICUI.render.courseName,wileyUrl:t.data.url});e("#animate").html(o),e(".js-wiley-iframe-close").on("click",function(){CAICUI.render.courseStudyIn.removeAnimate()})})}else console.log("wileyCourseStudy:"+JSON.stringify(t)),CAICUI.render.courseStudyIn.wileyCourseStudyLoading()},fail:function(e){console.log("wileyCourseStudy:"+JSON.stringify(e)),CAICUI.render.courseStudyIn.wileyCourseStudyLoading()}})}})},wileyCourseStudyLoading:function(){e(".courseIntroLoading").addClass("active");var r=5;CAICUI.render.introLoadingTimes=setInterval(function(){--r?e(".courseIntroLoading-time").text(r):(r=0,clearInterval(CAICUI.render.introLoadingTimes),CAICUI.render.courseStudyIn.popLoadingInit())},1e3)},popInit:function(){e(".courseIntro-footer").css("opacity",1),CAICUI.render.emailState="",CAICUI.render.member.email?CAICUI.iGlobal.isChineseChar(CAICUI.render.member.email)&&(CAICUI.render.emailState="邮箱里面有中文"):CAICUI.render.emailState="邮箱为空",CAICUI.render.emailState&&(e(".courseIntro-email").css("opacity",1),e(".courseIntro-email-info").text(CAICUI.render.emailState),e(".courseIntro-btn").removeClass("courseIntro-default").addClass("courseIntro-disabled"))},popLoadingInit:function(){if("true"!=CAICUI.render.firstOpenCourseSourcePop&&CAICUI.render.wileyCourseStudyTimeEnd){var r=CAICUI.render.wileyCourseStudyTimeEnd-CAICUI.render.wileyCourseStudyTimeStart;if(console.log(r),r<3e3)return setTimeout(function(){e(".courseIntro-btn").removeClass("courseIntro-disabled").addClass("courseIntro-default"),e(".courseIntroLoading").removeClass("active"),e(".courseIntroLoading-time").text(5),layer.close(CAICUI.render.introLoading)},3-r),!1}e(".courseIntro-btn").removeClass("courseIntro-disabled").addClass("courseIntro-default"),e(".courseIntroLoading").removeClass("active"),e(".courseIntroLoading-time").text(5),layer.close(CAICUI.render.introLoading)},courseIntroNextShow:function(r){var t=CAICUI.iGlobal.getThat(r),o=e.cookie("courseIntro-"+CAICUI.User.memberId);if(t.hasClass("active")){if(o&&o.length){o=JSON.parse(o);for(var n=0;n<o.length;n++)o[n]==CAICUI.render.courseIdActive&&o.splice(n,1)}t.removeClass("active")}else o&&o.length?(o=JSON.parse(o)).push(CAICUI.render.courseIdActive):o=[CAICUI.render.courseIdActive],t.addClass("active");e.cookie("courseIntro-"+CAICUI.User.memberId,JSON.stringify(o),{path:"/",expires:36500})},courseIntroClose:function(){layer.close(CAICUI.render.closeIntro)},courseIntroEmail:function(){CAICUI.render.memberReset=!0,layer.close(CAICUI.render.closeIntro)},addAnimate:function(r){var t=e(window).width(),o=e(window).height();e("body").prepend('<div id="animate" style="width:'+t+'px;"></div>'),e("#animate").animate({height:o,top:"0"},300,function(){r&&r()})},removeAnimate:function(r){e("#animate").animate({height:"0",top:"50%"},300,function(){e("#animate").remove(),r&&r()})},lockingTipsPop:function(){layer.open({title:"分期付款未完成",content:"缴费后即可解锁，缴费后若课程依然锁定联系分部老师解锁即可。"})}})});