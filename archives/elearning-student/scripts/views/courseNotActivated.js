define(["jquery","underscore","backbone","views/activationCourse","views/learningPlan","layer"],function(e,t,r,n,o,a){"use strict";return r.View.extend({tagName:"div",className:"course-content",template:t.template(e("#template-course-notActivated").html()),events:{"click .studyin-content-subjects":"subjectClick","click .studyin-type":"typeClick","click .js-course-notActivated":"acivated","click .ca-btn-no":"closeAcivated","click .courseActivation-close":"closeAcivated","click .courseIntro-nextShow-btn":"courseIntroNextShow","click .courseIntro-close":"courseIntroClose","click .courseIntro-email-a":"courseIntroEmail","click .js-locking-tipsPop":"lockingTipsPop","click .course-activation-acca-btn":"selectLearningPlan"},render:function(){return this.$el.html(this.template()),CAICUI.render.$this=this,CAICUI.render.closeActbut="",CAICUI.render.courseId="",CAICUI.render.orderItemId="",CAICUI.render.isU=0,CAICUI.render.title="",CAICUI.render.effectiveDay="",CAICUI.render.expirationDate="",CAICUI.render.memberReset=!1,this.noActivecourse(function(t){var r=e("#template-course-notActivated-list").html(),n=CAICUI.iGlobal.getTemplate(r,{data:t});e("body .course-content").html(n),window.CAICUI.myScroll=CAICUI.iGlobal.iScroll("body #wrapper")}),this},noActivecourse:function(e){CAICUI.Request.ajax({server:"noActivecourse",data:{token:CAICUI.User.token,pageNo:0,pageSize:CAICUI.defaultPageSize},done:function(t){if(CAICUI.render.$this&&CAICUI.render.$this.filterNoActivecourse){var r=CAICUI.render.$this.filterNoActivecourse(t.data.courselist);CAICUI.render.courseNotActivatedList=r,e({courseListNav:r.courseListNav,courseLists:r.courseLists})}},fail:function(t){e({courseListNav:{},courseLists:{}})}})},filterNoActivecourse:function(e){for(var r=e,n=t.chain(r).map(function(e){return e.categoryName}).uniq().value(),o=t.chain(r).map(function(e){return e.categoryIndex}).uniq().value(),a=[],i=0;i<n.length;i++)a.push({categoryName:n[i],categoryIndex:o[i],list:[]}),t.each(r,function(e,t,r){e.categoryName==n[i]&&(a&&a[i]&&a[i].list?a[i].list.push(e):a[i].list=[e])});for(i=0;i<a.length;i++){a[i].newList=[];for(var s=a[i].list,c=t.chain(s).map(function(e){return e.subjectName}).uniq().value(),d=t.chain(s).map(function(e){return e.subjectIndex}).uniq().value(),I=0;I<c.length;I++)a[i].newList.push({subjectName:c[I],subjectIndex:d[I],list:[]}),t.each(a[i].list,function(e,r,n){if(e.subjectName==c[I])if(a[i].newList[I].list){var o=!0;t.each(a[i].newList[I].list,function(t,r,n){e.courseId==t.courseId&&(e.shopCategoryExtendName&&(t.shopCategoryExtendName=e.shopCategoryExtendName),o=!1)}),o&&a[i].newList[I].list.push(e)}else a[i].newList[I].list=[e]})}a=t.sortBy(a,"categoryIndex");return t.each(a,function(e,r){a[r].newList=t.sortBy(e.newList,"subjectIndex"),t.each(a[r].newList,function(e,n){a[r].newList[n].list=t.sortBy(e.list,"courseIndex")})}),{courseListNav:n,courseLists:a}},subjectEnter:function(t){var r=t.currentTarget,n=e(r),o=(n.index(),n.find(".subject-lf").find(".subject-mask")),a=n.find(".subject-rt");return o.stop(!0,!1).animate({left:"0"}),{mask:o,rt:a}},subjectLeave:function(e){this.subjectEnter(e).mask.stop(!0,!1).animate({left:"-160px"})},subjectClick:function(e){this.subjectEnter(e).rt.parent().parent().addClass("active").siblings().removeClass("active")},iconClick:function(t){var r=t.currentTarget,n=e(r);n.find(".subject-type-rt").toggleClass("stop"),n.next(".studyin-content-subject").toggleClass("stop"),CAICUI.myScroll.refresh()},typeClick:function(t){var r=t.currentTarget,n=e(r),o=n.index();n.addClass("active").siblings().removeClass("active"),e(".studyin-contents").removeClass("active").eq(o).addClass("active"),CAICUI.myScroll.refresh()},courseActive:function(t){CAICUI.Request.ajax({server:"active",data:{token:t.token,courseId:t.courseId,isU:t.isU,orderItemId:t.orderItemId,examTime:t.examTime},done:function(t){"success"==t.state?(e(".layui-layer-shade").remove(),window.location.hash="#courseStudy/"+CAICUI.render.courseId):a.msg("Sorry~ 课程激活失败！",function(){e("body .courseActivation-btn-action").removeClass("hidden"),e("body .js-course-activationing").addClass("hidden")})},fail:function(t){a.msg("Sorry~ 课程激活失败！",function(){e("body .courseActivation-btn-action").removeClass("hidden"),e("body .js-course-activationing").addClass("hidden")})}})},wileyCourseActive:function(t){CAICUI.Request.ajax({server:"wileyCourseActive",data:t,done:function(t){"success"==t.state?(e(".layui-layer-shade").remove(),window.location.hash="#courseStudyIn"):(console.log("wileyCourseActive:"+t),a.msg("Sorry~ 课程激活失败！",function(){e("body .courseActivation-btn-action").removeClass("hidden"),e("body .js-course-activationing").addClass("hidden")}))},fail:function(t){a.msg("Sorry~ 课程激活失败！",function(){e("body .courseActivation-btn-action").removeClass("hidden"),e("body .js-course-activationing").addClass("hidden")})}})},acivated:function(e){var r=CAICUI.iGlobal.getThat(e);if(CAICUI.render.courseGroupId=r.attr("data-coursegroupid"),CAICUI.render.orderItemId=r.attr("data-orderitemid"),CAICUI.render.categoryName=r.attr("data-categoryname"),CAICUI.render.subjectID=r.attr("data-subjectid"),CAICUI.render.subjectName=r.attr("data-subjectName"),CAICUI.render.courseId=r.attr("data-courseid"),CAICUI.render.courseName=r.attr("data-coursename"),CAICUI.render.effectiveDay=r.attr("data-effectiveday"),CAICUI.render.actimode=r.attr("data-actimode"),CAICUI.render.isU="true",CAICUI.render.title=r.attr("data-title"),CAICUI.render.expirationDate=r.attr("data-expirationDate"),CAICUI.render.courseSource=r.attr("data-courseSource"),CAICUI.render.isCoursePlan=!1,CAICUI.render.isCourseModel=!1,"ACCA"==CAICUI.render.categoryName||"财经词典"==CAICUI.render.categoryName){var n=[];return t.each(CAICUI.render.courseNotActivatedList.courseLists,function(e,r){e.categoryName==CAICUI.render.categoryName&&t.each(e.newList,function(e,r){e.subjectName==CAICUI.render.subjectName&&t.each(e.list,function(e,t){n.push(e.courseId)})})}),CAICUI.render.$this.getplanAjax(CAICUI.render.courseId,function(e){"success"==e.state&&e.data&&e.data.length&&(CAICUI.render.isCoursePlan=!0),CAICUI.render.$this.isCourseDetail()}),!1}CAICUI.render.$this.acivatedLayer()},isCourseDetail:function(){CAICUI.Request.ajax({server:"coursesBaseInfo",data:{courseId:CAICUI.render.courseId},done:function(t){if("success"==t.state)if(t.data&&t.data[0].courseModel){var r=JSON.parse(t.data[0].courseModel);r&&r.length?(CAICUI.render.isCourseModel=!0,CAICUI.render.activationCourse=new n,e("body #right").append(CAICUI.render.activationCourse.render({coursesBaseInfo:t.data[0],isActivationCourse:!0}).el),e("body .course-activation-acca-content").find("img").each(function(t){var r=e(this).attr("src"),n=r.substr(-3);"jpg"!=n&&"png"!=n&&"gif"!=n&&"svg"!=n||(r=window.static+r),e(this).attr("src",r)}),setTimeout(function(){window.CAICUI.myScrollCourseModel=CAICUI.iGlobal.iScroll("body #wrapper-courseModel")},50),window.CAICUI.myScrollActivationAcca=CAICUI.iGlobal.iScroll("body #wrapper-activation-acca")):CAICUI.render.$this.acivatedLayer()}else CAICUI.render.$this.acivatedLayer();else CAICUI.render.$this.acivatedLayer()},fail:function(e){CAICUI.render.$this.acivatedLayer()}})},acivatedLayer:function(){var r=e("#template-course-courseActivation").html(),n=CAICUI.iGlobal.getTemplate(r,{categoryName:CAICUI.render.categoryName});e("body").append(n),e("body .course-activation-acca-btn").one("click",function(){CAICUI.render.$this.selectLearningPlan()}),e("body .courseActivation-close").one("click",function(){CAICUI.render.$this.closeAcivated()}),e("body .js-course-activation").one("click",function(){CAICUI.render.$this.courseActivation()}),CAICUI.render.closeActbut=a.open({type:1,title:!1,shade:!0,scrollbar:!1,closeBtn:0,skin:"layui-skin layui-courseActivation",area:["588px","400px"],content:e("#courseActivation"),success:function(){"1"==CAICUI.render.actimode?e("#courseActivation .courseActivation-notes").removeClass("hidden"):e("#courseActivation .courseActivation-notes").addClass("hidden"),CAICUI.render.isCoursePlan||CAICUI.render.isCourseModel||CAICUI.Request.ajax({server:"subjectTimeList",data:{subjectId:CAICUI.render.subjectID},done:function(r){if(r.data&&r.data.length>0){var n='<select  class="courseActivation-select">';t.each(r.data,function(e,t){n+='<option class="courseActivation-option">'+CAICUI.iGlobal.getDate(e.time)+"</option>"}),n+="</select>",e("body #courseActivation .courseActivation-select-time").html(n)}}}),e(".layui-layer-shade").css("filter","alpha(opacity=50)"),e("#courseActivation .courseActivation-courseName").html("&nbsp;"+CAICUI.render.title),e("#courseActivation .courseActivation-subjectName").html("&nbsp;"+CAICUI.render.subjectName),e("#courseActivation .courseActivation-effectiveDay").text(CAICUI.render.expirationDate),"wiley"==CAICUI.render.courseSource&&(CAICUI.render.member&&!CAICUI.render.memberReset?CAICUI.render.$this.popInit():CAICUI.render.$this.getMember(function(){CAICUI.render.memberReset=!1,CAICUI.render.$this.popInit()}))}})},closeAcivated:function(){a.close(CAICUI.render.closeActbut),e("body #courseActivation").remove()},getplanAjax:function(e,t){CAICUI.Request.ajax({server:"getplan",data:{token:CAICUI.User.token,courseCategoryId:CAICUI.render.subjectID,courseId:e},done:function(e){t&&t(e)},fail:function(e){}})},selectLearningPlan:function(){a.close(CAICUI.render.closeActbut),CAICUI.render.learningPlan=new o,e("body #right").append(CAICUI.render.learningPlan.render().el),window.CAICUI.render.myScrollLearningPlanStep1=CAICUI.iGlobal.iScroll("body #wrapper-learning-plan-step1"),window.CAICUI.render.myScrollLearningPlanStep2=CAICUI.iGlobal.iScroll("body #wrapper-learning-plan-step2"),window.CAICUI.render.myScrollLearningPlanStep3=CAICUI.iGlobal.iScroll("body #wrapper-learning-plan-step3")},courseActivation:function(){a.close(CAICUI.render.closeActbut);var t=e("body .courseActivation-select").val();if(0==t)return a.msg("请选择考试时间",function(){}),!1;if("-1"==t&&(t=""),e("body .courseActivation-btn-action").addClass("hidden"),e("body .js-course-activationing").removeClass("hidden"),"wiley"==CAICUI.render.courseSource){var r={token:CAICUI.User.token,courseId:CAICUI.render.courseId,examTime:t,isU:CAICUI.render.isU,orderItemId:CAICUI.render.orderItemId,address:"",mobile:"",courseSource:"wiley"};this.wileyCourseActive(r)}else{r={token:CAICUI.User.token,courseId:CAICUI.render.courseId,isU:CAICUI.render.isU,orderItemId:CAICUI.render.orderItemId,examTime:t};this.courseActive(r)}},getMember:function(e){CAICUI.Request.ajax({server:"member",data:{token:CAICUI.User.token},done:function(t){"success"==t.state?(CAICUI.render.member=t.data,e&&e()):console.log("member:"+t)},fail:function(e){a.msg("Sorry~ 课程激活失败！",function(){})}})},popInit:function(){var t="";CAICUI.render.member.email?CAICUI.iGlobal.isChineseChar(CAICUI.render.member.email)&&(t="邮箱里面有中文"):t="邮箱为空",t&&(e(".courseIntro-email").css("opacity",1),e(".js-course-activation").removeClass("js-course-activation"),e(".courseIntro-email-info").text(t),e(".courseIntro-btn").removeClass("courseIntro-default").addClass("courseIntro-disabled"))},courseIntroNextShow:function(e){var t=CAICUI.iGlobal.getThat(e);t.hasClass("active")?t.removeClass("active"):t.addClass("active")},courseIntroClose:function(){a.close(CAICUI.render.closeIntro)},courseIntroEmail:function(){CAICUI.render.memberReset=!0,a.close(CAICUI.render.closeIntro)},lockingTipsPop:function(){a.open({title:"分期付款未完成",content:"缴费后即可解锁，缴费后若课程依然锁定联系分部老师解锁即可。"})}})});